<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMI BURGERS - ¬°EL SABOR QUE MANDA!</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Roboto:wght@300;400;500;700;900&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="preload" as="image" href="./CERRADO_OFF.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
 <style>
    :root {
        --gold: #FFD700; 
        --accent: #FF6600; /* Naranja */
        --bg-special: #F0EBEB;
        --text-main: #000000;
        --border: #d1d5db;
        --z-map: 0; --z-ui: 10; --z-fab: 2000; --z-modal: 5000; --z-toast: 6000; --z-loader: 10000;
    }
    
    /* RESET - TEMA CLARO */
    body { 
        background-color: var(--bg-special); 
        background-image: url('FONDO_APP.png'); /* IMAGEN DE FONDO */
        background-size: cover; 
        background-attachment: fixed;
        color: var(--text-main); 
        font-family: 'Roboto', sans-serif; 
        margin: 0; overflow: hidden; height: 100vh; width: 100vw; 
    }
    
    /* MALLA DECORATIVA */
    .mesh-bg {
        background-image: radial-gradient(#ccc 1px, transparent 1px);
        background-size: 20px 20px;
    }

    #root { height: 100%; width: 100%; overflow: hidden; display: flex; flex-direction: column; background: rgba(255,255,255,0.7); backdrop-filter: blur(3px); }
    .font-brand { font-family: 'Bangers', cursive; letter-spacing: 1.5px; }
    
    /* TARJETAS Y CONTENEDORES */
    .card { 
        background-color: white; 
        border: 1px solid var(--border); 
        border-radius: 0.75rem; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
    }
    
    /* INPUTS */
    .input-std, .input-special { 
        background-color: #ffffff !important; 
        border: 1px solid #ccc !important; 
        color: black !important; 
        padding: 0.75rem; width: 100%; outline: none; border-radius: 0.5rem; font-weight: 500;
    }
    .input-std::placeholder { color: #888; }
    
    /* INPUT ESPECIFICO OSCURO (Si se requiere en alguna vista especial) */
    .input-dark-force {
        background-color: #222 !important; color: white !important; border: 1px solid #444 !important;
    }

    /* BOTONES */
    .btn-gold { background: linear-gradient(180deg, var(--gold) 0%, #e6c200 100%); color: black; font-weight: 900; border-radius: 0.75rem; padding: 0.8rem; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 0.5rem; }
    .btn-orange { background: var(--accent); color: white; font-weight: bold; border-radius: 0.5rem; padding: 0.8rem; border: none; cursor: pointer; }

    /* MEDIA */
    .banner-container { width: 100%; height: 15vh; min-height: 120px; background-color: #000; position: relative; overflow: hidden; }
    .mobile-banner { width: 100%; height: 100%; object-fit: contain; display: block; }
    .mobile-video-container { position: fixed; bottom: 70px; left: 0; width: 100%; height: 15vh; z-index: 50; pointer-events: none; background: black; border-top: 2px solid var(--gold); }
    .mobile-video-container video { width: 100%; height: 100%; object-fit: contain; opacity: 0.9; }

    /* MAPA */
    .leaflet-container { background: #e5e3df; width: 100%; height: 100%; z-index: 0; }
    
    /* PUNTOS MAPA */
    .user-gps-dot { width: 18px; height: 18px; background-color: #4285F4; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.3); position: relative; }
    .user-gps-dot::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; background-color: rgba(66, 133, 244, 0.4); border-radius: 50%; animation: gps-pulse 2s infinite; z-index: -1; }
    @keyframes gps-pulse { 0% {transform: translate(-50%, -50%) scale(0.5); opacity: 1;} 100% {transform: translate(-50%, -50%) scale(1.5); opacity: 0;} }

    /* UTILIDADES */
    .admin-fab { position: fixed; bottom: 20px; right: 20px; z-index: var(--z-fab); display: flex; flex-direction: column; align-items: end; gap: 10px; }
    .admin-fab-menu { display: flex; flex-direction: column; align-items: end; gap: 10px; margin-bottom: 10px; }
    .gods-eye { position: fixed; bottom: 100px; left: 20px; opacity: 0.8; transform: scale(0.9); z-index: var(--z-fab); }
    .logout-ghost { position: fixed; top: 10px; left: 10px; opacity: 0.8; z-index: var(--z-fab); }
    
    body.client-mode .gods-eye, body.client-mode .admin-fab, body.client-mode .logout-ghost { display: none !important; }

    /* MODALES Y PANELES */
    .driver-modal { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px; box-shadow: 0 -10px 30px rgba(0,0,0,0.2); z-index: 6000; animation: slide-up 0.3s; padding-bottom: 80px; }
    .ticket-logo-lg { width: 85px !important; display: block; margin: 0 auto 10px; } 
    
    /* ANIMACIONES */
    @keyframes slide-up { from {transform: translateY(100%);} to {transform: translateY(0);} }
    @keyframes pulse-load { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
    .app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; z-index: var(--z-loader); display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--gold); font-family: 'Bangers', cursive; }
    .loader-logo { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--gold); object-fit: cover; animation: pulse-load 1s infinite; margin-bottom: 20px; }
    
    /* LAYOUTS */
    .grid-cockpit { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 1rem; height: 90vh; }
    @media (max-width: 1024px) { .grid-cockpit { grid-template-columns: 1fr; overflow-y: auto; display: flex; flex-direction: column; height: auto; } }
    .gestion-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    
    /* UI ELEMENTS */
    .mode-btn { padding: 1rem; border-radius: 0.5rem; font-weight: bold; margin-bottom: 0.5rem; border: 1px solid #ccc; background: white; color: black; width: 100%; text-align: left; }
    .mode-btn.active { background-color: var(--gold); border-color: black; transform: scale(1.02); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .bill-btn { background-size: cover; background-position: center; border-radius: 4px; height: 60px; width: 100%; border: 1px solid #ddd; cursor: pointer; background-color: white; }
    .closed-store-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: black; background-image: url('./CERRADO_OFF.png'); background-size: contain; background-repeat: no-repeat; background-position: center; z-index: 10000; }
    
    .driver-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #eee; z-index: 1000; }
    .driver-nav-btn { display: flex; flex-direction: column; align-items: center; color: #999; background: none; border: none; font-size: 10px; font-weight: bold; flex: 1; }
    .driver-nav-btn.active { color: var(--accent); }
    .logo-pulse { animation: pulse-load 1.5s infinite; object-fit: cover !important; }
</style>
</head>
<body class="white">
    <div id="root"></div>
 <script type="text/babel" data-type="module">
        import { 
            Utensils, Truck, LayoutDashboard, LogOut, Plus, Minus, Search, MapPin, Printer, CreditCard, DollarSign, 
            Smartphone, User, QrCode, Clock, CheckCircle, AlertTriangle, FileText, Settings, Menu as MenuIcon, X, 
            Save, Trash2, ShoppingBag, Camera, Users, BarChart3, Bell, Ticket, TrendingUp, Lock, Eye, Send, Map, Navigation, 
            Wallet, Receipt, ArrowRight, Banknote, Power, Wifi, WifiOff, RefreshCw, Crosshair, Home, UserCheck, Calendar, Globe, QrCode as QRIcon,
            Package, Percent, Edit, Phone, Table, ArrowLeft, MessageCircle, Sun, Moon, Video, Copy, ClipboardList, PieChart, Link as LinkIcon, PenTool, Share2, MoreVertical, Download, Cloud, Info, Image, Ban, EyeOff,
            ChefHat, Bike, History, Unlock, Layers, MessageSquare, Box
        } from 'https://esm.sh/lucide-react@0.344.0';

        const React = window.React;
        const ReactDOM = window.ReactDOM;
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- 1. CONFIGURACI√ìN GLOBAL ---
        const STORE_COORDS = [27.446895, -109.943874]; 
        const CITY_SUFFIX = ", Ciudad Obreg√≥n, Sonora, Mexico";
        const SUPER_USER_PASS = "OBR1995@";
        const STORE_PHONE = "526443366197"; 
        
        const LOGO_URL = "./LOGO_1.png";
        const BANNER_URL = "./BANNER_MENU.jpg"; 
        const VIDEO_URL = "./WEB_PROMOCIONES.mp4";
        const CLOSED_IMG = "./CERRADO_OFF.png"; 

        // URL DE TU SCRIPT DE GOOGLE
        const API_URL = "https://script.google.com/macros/s/AKfycby7u7Y41wSQKuCTVn0WlI_uw3MbPf5bKXGAOddp7MpO_DBTJ8lwV1VEfMN7y7zAXH9cog/exec";
        
        // --- NUEVO ID DE BASE DE DATOS ---
        const DB_ID = "emi_db_v87_supreme_3";

        // --- UTILIDADES GLOBALES (DEFINIDAS UNA SOLA VEZ) ---
        const generateId = () => Math.random().toString(36).substr(2, 9).toUpperCase();
        const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(val || 0);

        const showToast = (msg) => {
            const div = document.createElement('div');
            div.className = 'custom-toast';
            div.innerHTML = `<span>üîî ${msg}</span>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        };

        const playSound = () => {
             try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, ctx.currentTime); 
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.2);
             } catch(e) { console.log("Audio not supported"); }
        };

        const copyToClipboard = (text) => {
            // Intento inteligente de crear link de men√∫ si es la URL base
            try {
                const urlObj = new URL(text);
                if(urlObj.href.includes(window.location.host)) {
                    urlObj.searchParams.set('menu', 'true');
                    text = urlObj.toString();
                }
            } catch(e) {}

            // M√©todo compatible
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => showToast("Copiado")).catch(() => fallbackCopy(text));
            } else {
                fallbackCopy(text);
            }
        };

        const fallbackCopy = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";  
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try { document.execCommand('copy'); showToast('Copiado'); } catch (err) {}
            document.body.removeChild(textArea);
        };

        const printTicket = (html) => {
            const win = window.open('', '', 'width=300,height=600');
            if(win){
                const currentUrl = window.location.href;
                const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
                win.document.write(`<html><head><base href="${baseUrl}"><style>body{font-family:monospace;font-size:12px;width:280px;margin:0;padding:10px;} .center{text-align:center;} .bold{font-weight:bold;} hr{border-top:1px dashed #000;} img{display:block;margin:0 auto;}</style></head><body>${html}</body></html>`);
                win.document.close(); setTimeout(() => { win.print(); win.close(); }, 500);
            } else { showToast("Permite popups para imprimir"); }
        };

        // --- 2. FUNCIONES DE CONEXI√ìN A NUBE (API) ---
        const fetchCloudDB = async () => {
            try {
                const res = await fetch(`${API_URL}?action=read&id=${DB_ID}&t=${Date.now()}`);
                if (!res.ok) throw new Error("Network response was not ok");
                return await res.json();
            } catch (e) { console.error("Error fetch", e); return null; }
        };

        const saveCloudDB = async (data) => {
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'update', id: DB_ID, data: data })
                });
            } catch (e) { console.error("Error save", e); }
        };

        // --- 3. BASE DE DATOS INICIAL ---
        const initialDB = {
            settings: {
                storeOpen: true,
                deliveryEnabled: true,
                pickupEnabled: true,
                deliveryRadius: 10,
                deliveryTable: [{min:0, max:3, price:30}, {min:3.1, max:5, price:40}, {min:5.1, max:8, price:50}, {min:8.1, max:10, price:60}],
                notification: { id: null, message: '', target: 'all' },
                paymentMethods: { cash: true, card: true },
                driverAssign: 'manual',
                supervisorKey: 'ADMIN123',
                cashLimit: 2000,
                providers: [], 
                platforms: ['Uber Eats', 'DiDi Food', 'Rappi'],
                ticketConfig: { header: 'EMI BURGERS\nCD. OBREGON', footer: '¬°GRACIAS POR SU COMPRA!' }
            },
            products: [], 
            orders: [],
            coupons: [],
            supplies: [],
            cashDrawer: { current: 0, initial: 0 },
            expenses: [],
            users: [
                {id: '1', name: 'Cajero Principal', role: 'cajero', username: 'caja', password: '123'},
                {id: '2', name: 'Cocina Master', role: 'cocina', username: 'cocina', password: '123'},
                {id: '3', name: 'Repartidor 1', role: 'repartidor', username: 'moto1', password: '123'}
            ]
        };

        // --- 4. HERRAMIENTAS GEOGR√ÅFICAS ---
        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            if(!lat1 || !lon1 || !lat2 || !lon2) return 0;
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180; 
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        const getDeliveryPrice = (dist, table) => {
            if (!table) return 0;
            const sorted = [...table].sort((a,b) => a.min - b.min);
            const rule = sorted.find(r => dist >= r.min && dist <= r.max);
            return rule ? rule.price : (sorted[sorted.length-1]?.price || 0);
        };

        const getCirclePoints = (center, radiusKm) => {
            const points = [];
            const earthRadius = 6371;
            for (let i = 0; i < 360; i += 5) {
                const lat1 = center[0] * Math.PI / 180;
                const lon1 = center[1] * Math.PI / 180;
                const brng = i * Math.PI / 180;
                const dist = radiusKm / earthRadius;
                const lat2 = Math.asin(Math.sin(lat1) * Math.cos(dist) + Math.cos(lat1) * Math.sin(dist) * Math.cos(brng));
                const lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(dist) * Math.cos(lat1), Math.cos(dist) - Math.sin(lat1) * Math.sin(lat2));
                points.push([lat2 * 180 / Math.PI, lon2 * 180 / Math.PI]);
            }
            return points;
        };
     
        const ModalAlert = ({ message, type, onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-black/90 z-[12000] flex items-center justify-center p-4 animate-in fade-in">
                <div className={`bg-[#1a1a1a] border-2 ${type==='confirm'?'border-[var(--gold)]':'border-red-500'} p-6 rounded-xl w-full max-w-sm text-center shadow-2xl`}>
                    <div className="mb-4 flex justify-center text-4xl">{type==='confirm'?'‚ùì':'‚ö†Ô∏è'}</div>
                    <p className="text-white text-lg font-bold mb-6 whitespace-pre-wrap">{message}</p>
                    <div className="flex gap-3">
                        {type === 'confirm' && <button onClick={onCancel} className="flex-1 bg-gray-700 text-white py-3 rounded-lg font-bold">CANCELAR</button>}
                        <button onClick={onConfirm} className={`flex-1 ${type==='confirm'?'btn-gold':'bg-red-600 text-white'} py-3 rounded-lg font-bold`}>{type==='confirm'?'ACEPTAR':'ENTENDIDO'}</button>
                    </div>
                </div>
            </div>
        );

/* --- MAPA AVANZADO: RUTA OSRM Y COBERTURA --- */
const LeafletMap = ({ center, markers, zoom = 14, onClickMap, showHeatmap, route, radius, onMarkerClick }) => {
    const containerRef = useRef(null);
    const mapInstance = useRef(null);

    useEffect(() => {
        if (!containerRef.current || typeof L === 'undefined') return;

        const safeCenter = (center && center[0]) ? center : STORE_COORDS;
        const reliefUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}';

        if (!mapInstance.current) {
            mapInstance.current = L.map(containerRef.current, { zoomControl: false, attributionControl: false }).setView(safeCenter, zoom);
            L.tileLayer(reliefUrl).addTo(mapInstance.current);
            if(onClickMap) mapInstance.current.on('click', (e) => onClickMap([e.latlng.lat, e.latlng.lng]));
        } else {
            mapInstance.current.setView(safeCenter, zoom);
            setTimeout(() => mapInstance.current.invalidateSize(), 200);
        }

        mapInstance.current.eachLayer(layer => {
            if (layer instanceof L.Marker || layer instanceof L.Circle || layer instanceof L.Polyline || layer instanceof L.Polygon) mapInstance.current.removeLayer(layer);
        });

        // --- ZONA DE COBERTURA (DONA GRIS) ---
        if (radius) {
            const world = [[90, -360], [90, 360], [-90, 360], [-90, -360]];
            const hole = getCirclePoints(STORE_COORDS, radius);
            L.polygon([world, hole], { color: 'transparent', fillColor: '#333', fillOpacity: 0.5 }).addTo(mapInstance.current);
            L.circle(STORE_COORDS, { color: '#00e676', fillColor: 'transparent', weight: 2, radius: radius * 1000 }).addTo(mapInstance.current);
        }

        // --- MARCADORES ---
        markers.forEach((m) => {
            if(m.pos && m.pos[0]) {
                const el = document.createElement('div');
                if (m.isMyLoc) el.className = 'user-gps-dot';
                else if (m.isStore) {
                    el.className = 'custom-pin';
                    el.innerHTML = `<img src="${LOGO_URL}" style="width:40px;height:40px;border-radius:50%;border:2px solid gold;background:white;">`;
                } else if (m.type === 'driver') {
                    el.className = 'driver-pin';
                    el.innerHTML = 'üèçÔ∏è';
                } else if (showHeatmap) {
                     // ZONAS CALIENTES (PUNTOS ROJOS)
                     return L.circleMarker(m.pos, { radius: 10, color: 'red', fillColor: '#f00', fillOpacity: 0.5 }).addTo(mapInstance.current).bindPopup("Venta registrada aqu√≠");
                } else {
                    el.className = 'custom-pin';
                    el.innerHTML = m.emoji || 'üìç';
                }

                if (!showHeatmap) {
                    const iconSize = m.isMyLoc ? [20,20] : [40,40];
                    const icon = L.divIcon({ className: 'bg-transparent', html: el, iconSize: iconSize, iconAnchor: [iconSize[0]/2, iconSize[1]/2] });
                    const marker = L.marker(m.pos, { icon }).addTo(mapInstance.current);
                    if(m.data && onMarkerClick) marker.on('click', () => onMarkerClick(m.data));
                    else if(m.popup) marker.bindPopup(m.popup);
                }
            }
        });

        // --- RUTA REAL POR CALLES (OSRM) ---
        if(route && route.length >= 2) {
             const start = route[0];
             const end = route[route.length-1];
             if(start && end && start[0] && end[0]) {
                 // Fetch a OSRM para ruta de manejo
                 fetch(`https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`)
                 .then(r => r.json())
                 .then(d => {
                     if(d.routes && d.routes[0]) {
                         const coords = d.routes[0].geometry.coordinates.map(c => [c[1], c[0]]); // Invertir a LatLng
                         L.polyline(coords, {color: '#4285F4', weight: 6, opacity: 0.8}).addTo(mapInstance.current);
                     } else {
                         // Fallback linea recta si falla
                         L.polyline([start, end], {color: '#4285F4', weight: 6, opacity: 0.8, dashArray:'5,5'}).addTo(mapInstance.current);
                     }
                 }).catch(() => {
                     L.polyline([start, end], {color: '#4285F4', weight: 6, opacity: 0.8, dashArray:'5,5'}).addTo(mapInstance.current);
                 });
             }
        }
    }, [center, markers, route, radius]);

    return <div ref={containerRef} className="h-full w-full bg-white z-0 relative"></div>;
};
        const QRScanner = ({ onScan, onClose }) => {
             useEffect(() => {
                const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }, false);
                scanner.render((decodedText) => {
                    onScan(decodedText);
                    scanner.clear();
                }, (error) => {});
                return () => { try { scanner.clear(); } catch(e){} };
            }, []);

            return (
                <div id="reader" style={{width:'100%', height:'100%'}}></div>
            ); 
        };

        const AdminAuthModal = ({ onClose, onSuccess, db }) => {
            const [pass, setPass] = useState('');
            const check = () => {
                if(pass === SUPER_USER_PASS || pass === db.settings.supervisorKey) {
                    onSuccess();
                } else {
                    showToast("Contrase√±a incorrecta");
                }
            };
            return (
                <div className="fixed inset-0 bg-black/90 z-[10000] flex items-center justify-center p-4">
                    <div className="bg-[var(--bg-card)] p-6 rounded border border-[var(--gold)] w-full max-w-xs text-center">
                        <h3 className="text-xl font-bold text-white mb-4"><Lock className="inline mb-1"/> AUTORIZACI√ìN</h3>
                        <input type="password" className="input-std text-center text-xl mb-4" placeholder="Clave Admin/Supervisor" value={pass} onChange={e=>setPass(e.target.value)} autoFocus/>
                        <div className="flex gap-2">
                            <button onClick={onClose} className="flex-1 bg-gray-600 text-white py-2 rounded">CANCELAR</button>
                            <button onClick={check} className="flex-1 btn-gold py-2 rounded">ACEPTAR</button>
                        </div>
                    </div>
                </div>
            );
        };

const Dashboard = ({ db }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);
            const [selectedZone, setSelectedZone] = useState(null);
            const [showMermas, setShowMermas] = useState(false);
            const [viewMap, setViewMap] = useState(false);

            const validOrders = db.orders.filter(o => o.status !== 'cancelled');
            const cancelledOrders = db.orders.filter(o => o.status === 'cancelled');

            const sales = validOrders.reduce((a,b)=>a+b.total,0);
            const expenses = db.expenses.reduce((a,b)=>a+b.amount,0);
            
            const activeOrders = db.orders.filter(o => o.status === 'delivering' || o.status === 'pending');
            const drivers = db.users.filter(u => u.role === 'repartidor' && u.online);
            
            const liveMarkers = [
                { pos: STORE_COORDS, emoji: 'üè™', isStore: true },
                ...activeOrders.map(o => ({ pos: o.clientLoc || STORE_COORDS, emoji: 'üçî', popup: `Pedido #${o.orderNum}` })),
                ...drivers.map(d => ({ pos: d.location || STORE_COORDS, emoji: 'üèçÔ∏è', label: d.name, type: 'driver' }))
            ];

            useEffect(() => {
                if(!canvasRef.current) return;
                if(chartRef.current) chartRef.current.destroy();

                const ctx = canvasRef.current.getContext('2d');
                const salesByDate = {};
                validOrders.forEach(o => {
                    const date = new Date(o.createdAt).toLocaleDateString();
                    salesByDate[date] = (salesByDate[date] || 0) + o.total;
                });
                const labels = Object.keys(salesByDate).slice(-7);
                const data = Object.values(salesByDate).slice(-7);

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.length ? labels : ['Hoy'],
                        datasets: [{ label: 'Ventas ($)', data: data.length ? data : [0], borderColor: '#FFD700', backgroundColor: 'rgba(255, 215, 0, 0.2)', tension: 0.4, fill: true }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: 'white' } } }, scales: { y: { ticks: { color: 'white' }, grid: { color: '#333' } }, x: { ticks: { color: 'white' }, grid: { color: '#333' } } } }
                });
                return () => { if(chartRef.current) chartRef.current.destroy(); }
            }, [db.orders]);

            const platformStats = validOrders.reduce((acc, o) => { const key = o.source === 'web' ? 'WEB' : (o.source === 'platform' ? (o.platformName || 'APP') : 'TIENDA'); acc[key] = (acc[key] || 0) + 1; return acc; }, {});
            const expired = db.supplies.filter(s => new Date(s.expiry) < new Date());
            const actualTopProducts = Object.entries(validOrders.reduce((acc, o) => {
                o.items.forEach(i => acc[i.name] = (acc[i.name] || 0) + i.qty);
                return acc;
            }, {})).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const topProducts = actualTopProducts.length > 0 ? actualTopProducts : [['Producto 1', 0], ['Producto 2', 0], ['Producto 3', 0]];
            const maxProdVal = actualTopProducts.length > 0 ? actualTopProducts[0][1] : 1;

            const handleMapClick = (markerData) => {
                 if (markerData && markerData.isStore) {
                 } else if (actualTopProducts.length > 0) {
                    const topItem = actualTopProducts[0][0];
                    const topQty = actualTopProducts[0][1];
                    showToast(`Zona Caliente: ${topItem} (${topQty} ventas)`);
                    setSelectedZone({ name: "Zona Centro", topItem: topItem, summary: `${topItem} lidera con ${topQty} unidades` });
                    setTimeout(() => setSelectedZone(null), 5000);
                } else {
                    showToast("Sin datos de ventas para mostrar zonas.");
                }
            };
            
            const hotZoneMarkers = [
                { pos: STORE_COORDS, emoji: 'üè™', popup: 'Tienda', isStore: true, data: {isStore: true} }, 
                ...validOrders.filter(o=>o.clientLoc).map(o=>({pos:o.clientLoc}))
            ];

            if (viewMap) {
                return (
                    <div className="h-full flex flex-col p-4">
                         <div className="flex justify-between items-center mb-4">
                             <h2 className="text-2xl font-bold text-[var(--gold)]">RASTREO EN VIVO</h2>
                             <button onClick={()=>setViewMap(false)} className="bg-red-600 text-white px-4 py-2 rounded">CERRAR MAPA</button>
                         </div>
                         <div className="flex-1 rounded border border-[var(--gold)] overflow-hidden">
                             <LeafletMap center={STORE_COORDS} markers={liveMarkers} zoom={13}/>
                         </div>
                         <div className="mt-2 flex gap-4 text-sm text-gray-400">
                             <span className="flex items-center gap-1">üçî Pedidos Activos</span>
                             <span className="flex items-center gap-1">üèçÔ∏è Repartidores</span>
                         </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6 animate-in fade-in pb-20 overflow-y-auto h-full">
                    {/* BOT√ìN RASTREO FLOTANTE (RESTAURADO) */}
                    <button className="dash-map-btn" onClick={()=>setViewMap(true)}>
                        <Map size={24}/> RASTREO
                    </button>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="card p-4 border-l-4 border-[var(--gold)]"><p className="text-gray-400 text-xs font-bold uppercase">Ventas</p><p className="text-3xl font-black text-[var(--text-main)]">{formatCurrency(sales)}</p></div>
                        <div className="card p-4 border-l-4 border-red-500"><p className="text-gray-400 text-xs font-bold uppercase">Gastos</p><p className="text-3xl font-black text-[var(--text-main)]">{formatCurrency(expenses)}</p></div>
                        <div className="card p-4 border-l-4 border-green-500"><p className="text-gray-400 text-xs font-bold uppercase">Utilidad</p><p className="text-3xl font-black text-[var(--text-main)]">{formatCurrency(sales - expenses)}</p></div>
                        <div className="card p-4 border-l-4 border-blue-500"><p className="text-gray-400 text-xs font-bold uppercase">Pedidos</p><p className="text-3xl font-black text-[var(--text-main)]">{validOrders.length}</p></div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="flex flex-col gap-4">
                            <div className="card p-6 h-64 flex-shrink-0">
                                <h3 className="font-bold text-[var(--text-main)] mb-2 flex items-center gap-2"><BarChart3 size={20}/> Historial de Ventas</h3>
                                <div className="w-full h-full pb-6"><canvas ref={canvasRef}></canvas></div>
                            </div>
                            <div className="card p-4 bg-[#222] border-l-4 border-red-800 h-64 overflow-y-auto custom-scroll">
                                <h3 className="font-bold text-red-500 mb-2 flex items-center gap-2"><Ban size={16}/> √ìrdenes Canceladas ({cancelledOrders.length})</h3>
                                {cancelledOrders.map(o => (
                                    <div key={o.id} className="border-b border-[#444] py-2 text-xs">
                                        <div className="flex justify-between text-white font-bold"><span>#{o.orderNum}</span><span>{formatCurrency(o.total)}</span></div>
                                        <p className="text-gray-400">{new Date(o.createdAt).toLocaleString()}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="card p-6 relative h-96 md:h-auto min-h-[300px] overflow-hidden"> 
                            <h3 className="font-bold text-[var(--text-main)] mb-4 flex items-center gap-2"><Map size={20}/> Zonas Calientes</h3>
                            <div className="h-full w-full absolute inset-0 pt-16 px-6 pb-6 rounded border border-[var(--border)]">
                                <LeafletMap center={STORE_COORDS} markers={hotZoneMarkers} showHeatmap={true} zoom={12} onMarkerClick={handleMapClick}/>
                                {selectedZone && <div className="absolute bottom-4 left-4 right-4 bg-black/90 text-white p-4 rounded z-[500] animate-in slide-in-from-bottom border border-[var(--gold)] text-center shadow-2xl">
                                    <h4 className="font-bold text-[var(--gold)] text-lg mb-1">üî• RESUMEN DE ZONA</h4>
                                    <p className="text-sm">{selectedZone.summary}</p>
                                </div>}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6">
                        <div className="card p-6">
                            <h3 className="font-bold text-[var(--gold)] mb-4 flex items-center gap-2"><TrendingUp size={20}/> Productos M√°s Vendidos</h3>
                            {topProducts.map(([name, qty], i) => (
                                <div key={i} className="mb-2">
                                    <div className="flex justify-between text-sm mb-1"><span className="text-[var(--text-main)]">{name}</span><span className="text-[var(--gold)]">{qty}</span></div>
                                    <div className="progress-bar"><div className="progress-fill bg-[var(--gold)]" style={{width: `${(qty/maxProdVal)*100}%`}}></div></div>
                                </div>
                             ))}
                        </div>

                        <div className="space-y-4">
                            <div className="card p-6">
                                <h3 className="font-bold text-[var(--text-main)] mb-4">Ventas por Canal</h3>
                                {Object.keys(platformStats).length === 0 ? <p className="text-gray-500 text-sm">Sin datos</p> : Object.entries(platformStats).map(([key, val]) => (
                                     <div key={key} className="flex justify-between items-center py-2 border-b border-[var(--border)]">
                                          <span className="text-[var(--text-main)]">{key}</span><span className="bg-[var(--input-bg)] px-2 rounded text-[var(--text-main)] text-xs">{val}</span>
                                     </div>
                                ))}
                            </div>
                            <div className="card p-6 border-l-4 border-red-500 cursor-pointer hover:bg-[var(--input-bg)]" onClick={()=>setShowMermas(true)}>
                                <h3 className="font-bold text-red-500 mb-2 flex items-center gap-2"><AlertTriangle size={16}/> P√©rdidas / Caducados</h3>
                                <div className="text-4xl font-black text-[var(--text-main)] mb-2">{expired.length}</div>
                            </div>
                        </div>
                    </div>

                    {showMermas && (
                        <div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4">
                            <div className="card w-full max-w-2xl bg-[var(--bg-card)] p-6">
                                <h3 className="text-2xl font-bold text-red-500 mb-4">DETALLE DE MERMAS</h3>
                                <table className="w-full text-left text-sm text-[var(--text-main)]">
                                    <thead><tr className="border-b border-[var(--border)]"><th>Producto</th><th>Entrada</th><th>Caducidad</th><th>Stock Perdido</th></tr></thead>
                                    <tbody>
                                        {expired.map(s => (
                                            <tr key={s.id} className="border-b border-[#333]">
                                                <td className="p-2">{s.name}</td>
                                                <td className="p-2">{s.entryDate || '-'}</td>
                                                <td className="p-2 text-red-500 font-bold">{s.expiry}</td>
                                                <td className="p-2">{s.stock} {s.unit}</td>
                                            </tr>
                                        ))}
                                        {expired.length === 0 && <tr><td colSpan="4" className="p-4 text-center text-gray-500">No hay registros de caducidad.</td></tr>}
                                    </tbody>
                                </table>
                                <button onClick={()=>setShowMermas(false)} className="mt-6 btn-gold w-full">CERRAR</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        const ProductManager = ({ db, updateDB }) => {
            const [modal, setModal] = useState(null);
            const [form, setForm] = useState({ name:'', price:0, cat:'', img:'', desc:'', ingredients:'', isComplement: false, active: true });
            
            const handleCSV = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = ev => {
                        const lines = ev.target.result.split('\n').slice(1);
                        const newProds = lines.map(l => {
                            const [name, price, cat, desc, img] = l.split(',');
                            return name ? {id:generateId(), name, price:parseFloat(price), cat, desc, img, active:true} : null;
                        }).filter(Boolean);
                        updateDB({...db, products: [...db.products, ...newProds]});
                    };
                    r.readAsText(f);
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setForm({...form, img: reader.result});
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            const save = () => {
                let products = [...db.products];
                if(form.id) products = products.map(p => p.id === form.id ? form : p);
                else products.push({ ...form, id: generateId() });
                updateDB({...db, products}); setModal(null);
            };
            
            const remove = (id) => { if(confirm("¬øEliminar?")) updateDB({...db, products: db.products.filter(p=>p.id!==id)}); };
            const toggleActive = (p) => { updateDB({...db, products: db.products.map(x=>x.id===p.id?{...x, active:!x.active}:x)}); };

            const groupedProducts = useMemo(() => {
                const groups = {};
                db.products.forEach(p => {
                    const cat = p.cat || 'Otros';
                    if (!groups[cat]) groups[cat] = [];
                    groups[cat].push(p);
                });
                return groups;
            }, [db.products]);

            return (
                <div className="space-y-6 overflow-y-auto h-full pb-20">
                    <div className="flex gap-2 sticky top-0 bg-[var(--bg-body)] z-20 pb-2">
                        <button onClick={()=>{setForm({name:'', price:0, cat:'', img:'', desc:'', ingredients:'', isComplement:false, active:true}); setModal(true);}} className="btn-gold z-10">NUEVO PRODUCTO</button>
                        <label className="btn-gold cursor-pointer bg-blue-600 text-white z-10">CARGAR CSV <input type="file" hidden onChange={handleCSV}/></label>
                        <button onClick={()=>{
                            const csv = "Nombre,Precio,Categoria,Descripcion,Imagen\nHamburguesa,100,Burgers,Rica,url";
                            const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv); a.download='plantilla.csv'; a.click();
                        }} className="btn-gold bg-green-600 text-white z-10">PLANTILLA</button>
                    </div>
                    
                    {Object.entries(groupedProducts).map(([cat, prods]) => (
                        <div key={cat} className="mb-6">
                            <h3 className="text-2xl font-bold text-[var(--gold)] mb-3 border-b border-[var(--border)]">{cat}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {prods.map(p => (
                                    <div key={p.id} className={`card p-3 flex gap-3 items-center group ${!p.active ? 'opacity-50' : ''}`}>
                                                <img src={p.img} className="w-16 h-16 rounded object-cover"/>
                                                <div className="flex-1">
                                                    <p className="font-bold text-[var(--text-main)]">{p.name}</p>
                                                    <p className="text-[var(--gold)] font-bold">{formatCurrency(p.price)}</p>
                                                    {p.isComplement && <span className="text-[10px] bg-blue-900 text-blue-200 px-1 rounded">Complemento</span>}
                                                </div>
                                                <div className="flex gap-2 z-10">
                                                    <button onClick={()=>toggleActive(p)} className={`p-2 rounded ${p.active?'text-green-500':'text-red-500'}`}>{p.active?<Eye size={16}/>:<EyeOff size={16}/>}</button>
                                                    <button onClick={()=>{
                                                        setForm({
                                                            id: p.id,
                                                            name: p.name || '', 
                                                            price: p.price || 0,
                                                            cat: p.cat || '',
                                                            img: p.img || '',
                                                            desc: p.desc || '',
                                                            ingredients: p.ingredients || '',
                                                            isComplement: p.isComplement || false,
                                                            active: p.active !== undefined ? p.active : true
                                                        }); 
                                                        setModal(true);
                                                    }} className="text-blue-500 p-2 rounded"><Edit size={16}/></button>
                                                    <button onClick={()=>remove(p.id)} className="text-red-600 p-2 rounded"><Trash2 size={16}/></button>
                                                </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}

                    {modal && (
                        <div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4">
                            <div className="card w-full max-w-lg bg-[var(--bg-card)] p-6">
                                <h3 className="text-[var(--text-main)] font-bold mb-4">{form.id?'EDITAR':'NUEVO'} PRODUCTO</h3>
                                <div className="grid grid-cols-2 gap-2 mb-4">
                                    <input className="input-std" placeholder="Nombre" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})}/>
                                    <input className="input-std" type="number" placeholder="Precio" value={form.price||''} onChange={e=>setForm({...form,price:parseFloat(e.target.value)})}/>
                                    <input className="input-std" placeholder="Categor√≠a" value={form.cat||''} onChange={e=>setForm({...form,cat:e.target.value})}/>
                                    <div className="flex gap-1">
                                        <input className="input-std" placeholder="URL Imagen" value={form.img||''} onChange={e=>setForm({...form,img:e.target.value})}/>
                                        <label className="btn-gold cursor-pointer flex items-center justify-center"><Image size={16}/><input type="file" hidden accept="image/*" onChange={handleImageUpload}/></label>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 mb-2">
                                    <input type="checkbox" checked={form.isComplement} onChange={e=>setForm({...form, isComplement:e.target.checked})}/>
                                    <span className="text-[var(--text-main)] text-sm">¬øEs un complemento? (Aparecer√° al pagar)</span>
                                </div>
                                <input className="input-std mb-2" placeholder="Ingredientes (Separa por comas)" value={form.ingredients||''} onChange={e=>setForm({...form,ingredients:e.target.value})}/>
                                <textarea className="input-std mb-4" placeholder="Descripci√≥n" value={form.desc||''} onChange={e=>setForm({...form,desc:e.target.value})}/>
                                <div className="flex justify-end gap-2">
                                    <button onClick={()=>setModal(null)} className="text-gray-500">CANCELAR</button>
                                    <button onClick={save} className="btn-gold">GUARDAR</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const InventoryManager = ({ db, updateDB }) => {
            const [newItem, setNewItem] = useState({ name:'', stock:'', unit:'PZ', expiry:'' });
            const [editItem, setEditItem] = useState(null);
            const save = () => {
                if(editItem) { updateDB({...db, supplies: db.supplies.map(s=>s.id===editItem.id?editItem:s)}); setEditItem(null); } 
                else if(newItem.name) { updateDB({...db, supplies: [...db.supplies, {...newItem, id: generateId()}]}); setNewItem({ name:'', stock:'', unit:'PZ', expiry:'' }); }
            };
            return (
                <div className="space-y-4 overflow-y-auto h-full pb-20">
                    <div className="card p-4 border-l-4 border-green-500 flex gap-2 items-end"><div className="flex-1"><label className="text-xs text-gray-500">Insumo</label><input className="input-std" value={newItem.name} onChange={e=>setNewItem({...newItem, name:e.target.value})}/></div><div className="w-20"><label className="text-xs text-gray-500">Stock</label><input className="input-std" type="number" value={newItem.stock} onChange={e=>setNewItem({...newItem, stock:e.target.value})}/></div><div className="w-32"><label className="text-xs text-gray-500">Caducidad</label><input className="input-std" type="date" value={newItem.expiry} onChange={e=>setNewItem({...newItem, expiry:e.target.value})}/></div><button onClick={save} className="btn-gold h-[46px]"><Plus/></button></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{db.supplies.map(s => { const days = s.expiry ? Math.ceil((new Date(s.expiry) - new Date()) / 86400000) : 99; const isLow = s.stock < 5 || days < 3; return (<div key={s.id} className={`card p-4 flex justify-between items-center cursor-pointer relative group ${isLow?'border-red-500 border':''}`} onClick={()=>setEditItem(s)}><div><p className="font-bold text-[var(--text-main)]">{s.name}</p><p className={`text-xs ${days<3?'text-red-500 font-bold':'text-gray-400'}`}>Exp: {s.expiry}</p></div><div className="flex items-center gap-2"><p className="text-[var(--gold)] font-bold">{s.stock} {s.unit}</p><button onClick={(e)=>{e.stopPropagation(); updateDB({...db, supplies: db.supplies.filter(x=>x.id!==s.id)})}} className="text-red-500 hover:scale-110 z-10"><Trash2/></button></div></div>); })}</div>
                    {editItem && <div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4"><div className="card bg-[var(--bg-card)] p-6"><h3 className="font-bold mb-4 text-[var(--text-main)]">EDITAR</h3><input className="input-std mb-2" value={editItem.name} onChange={e=>setEditItem({...editItem, name:e.target.value})}/><input className="input-std mb-2" type="number" value={editItem.stock} onChange={e=>setEditItem({...editItem, stock:e.target.value})}/><input className="input-std mb-4" type="date" value={editItem.expiry} onChange={e=>setEditItem({...editItem, expiry:e.target.value})}/><div className="flex justify-end gap-2"><button onClick={()=>setEditItem(null)} className="text-gray-500">CANCELAR</button><button onClick={save} className="btn-gold">GUARDAR</button></div></div></div>}
                </div>
            );
        };

        const StaffManager = ({ db, updateDB }) => {
            const [editing, setEditing] = useState(null);
            const [mode, setMode] = useState('list');
            const [checadorUser, setChecadorUser] = useState('');
            const days = ['Lun','Mar','Mie','Jue','Vie','Sab','Dom'];

            const copyMonday = (u) => {
                const mon = u.schedule?.['Lun'];
                if(!mon) return showToast("Configura Lunes primero");
                const newSch = {};
                days.forEach(d => newSch[d] = {...mon});
                const updated = db.users.map(x=>x.id===u.id?{...x, schedule: newSch}:x);
                updateDB({...db, users:updated});
                setEditing({...editing, schedule: newSch});
            };

            const calculatePayroll = (u) => {
                const dailyRate = u.salary / 7;
                const workedDays = days.filter(d => u.schedule?.[d]?.in).length; 
                return formatCurrency(dailyRate * workedDays);
            };

            const handleCheckInOut = (u) => {
                const last = (u.attendance || []).length > 0 ? u.attendance[u.attendance.length-1] : null;
                const now = new Date();
                let newAtt;
                if(last && !last.out) {
                    newAtt = [...u.attendance];
                    newAtt[newAtt.length-1].out = now.toISOString();
                } else {
                    newAtt = [...(u.attendance || []), {in: now.toISOString(), out: null}];
                }
                updateDB({...db, users: db.users.map(x=>x.id===u.id?{...x, attendance: newAtt}:x)});
                showToast(`Registro Exitoso: ${u.name}`);
            };
            
            const handleChecadorSubmit = () => {
                const u = db.users.find(u => u.username === checadorUser);
                if(u) {
                    handleCheckInOut(u);
                    setChecadorUser('');
                } else showToast("Usuario no encontrado");
            };

            const deleteUser = (id) => {
                if(confirm("¬øEliminar empleado?")) {
                    updateDB({...db, users: db.users.filter(u=>u.id!==id)});
                    setEditing(null);
                }
            };

            const printSchedule = (u) => {
                const sched = days.map(d=>`${d}: ${u.schedule?.[d]?.in||'-'} - ${u.schedule?.[d]?.out||'-'}`).join('<br>');
                const att = (u.attendance || []).map(a=>`${new Date(a.in).toLocaleDateString()}: ${new Date(a.in).toLocaleTimeString()} - ${a.out?new Date(a.out).toLocaleTimeString():'...'}`).join('<br>');
                printTicket(`<b>${u.name}</b><br><hr>HORARIO:<br>${sched}<br><hr>ASISTENCIA:<br>${att}`);
            };

            if(mode === 'checador') return (
                <div className="h-full flex flex-col items-center justify-center p-6">
                    <h2 className="text-3xl font-brand text-[var(--gold)] mb-8">RELOJ CHECADOR</h2>
                    <div className="card p-8 w-full max-w-md bg-[var(--bg-card)] text-center">
                        <QrCode size={128} className="mx-auto mb-4 text-white"/>
                        <p className="mb-4 text-gray-400">Ingresa tu usuario para registrar entrada/salida</p>
                        <input className="input-std text-center mb-4 text-xl uppercase" placeholder="USUARIO" value={checadorUser} onChange={e=>setChecadorUser(e.target.value)}/>
                        <button onClick={handleChecadorSubmit} className="btn-gold w-full text-xl shadow-lg">REGISTRAR</button>
                    </div>
                    <button onClick={()=>setMode('list')} className="mt-8 text-gray-500 underline">Volver a Lista</button>
                </div>
            );

            return (
                <div className="space-y-6 overflow-y-auto h-full pb-20">
                      <div className="flex justify-between items-center mb-4">
                        <button onClick={()=>setEditing({name:'', role:'cajero', username:'', password:'', schedule:{}, salary:0})} className="btn-gold">AGREGAR EMPLEADO</button>
                        <button onClick={()=>setMode('checador')} className="bg-blue-600 text-white px-4 py-2 rounded font-bold flex gap-2"><Clock/> CHECADOR</button>
                      </div>
                      
                      <div className="overflow-x-auto">
                          <table className="w-full text-left text-sm text-[var(--text-main)]">
                              <thead><tr className="border-b border-[var(--border)]"><th className="p-2">Nombre</th><th className="p-2 w-full text-center">Horario / Progreso</th><th className="p-2">N√≥mina</th><th className="p-2">Acci√≥n</th></tr></thead>
                              <tbody>
                                  {db.users.filter(u=>u.role!=='admin').map(u=>{
                                      const attendance = u.attendance || [];
                                      const last = attendance.length > 0 ? attendance[attendance.length-1] : null;
                                      const isWorking = last && !last.out;
                                      const startTime = isWorking ? new Date(last.in).toLocaleTimeString() : '';
                                      return (
                                      <tr key={u.id} className="border-b border-[var(--border)] hover:bg-[var(--input-bg)] cursor-pointer" onClick={()=>setEditing(u)}>
                                          <td className="p-2 font-bold whitespace-nowrap">{u.name}<br/><span className="text-xs text-gray-500">{u.role}</span></td>
                                          <td className="p-2">
                                              <div className="flex flex-col gap-1">
                                                  <div className="grid grid-cols-7 gap-1">
                                                      {days.map(d=><div key={d} className={`h-6 rounded flex items-center justify-center text-[10px] text-white ${u.schedule?.[d] ? 'bg-green-600' : 'bg-[#333]'}`}>{d[0]}</div>)}
                                                  </div>
                                                  {isWorking && (
                                                      <div className="w-full bg-[#333] h-4 rounded mt-1 relative overflow-hidden">
                                                          <div className="absolute top-0 left-0 h-full bg-yellow-500 animate-pulse w-full"></div>
                                                          <span className="absolute inset-0 flex items-center justify-center text-[10px] text-black font-bold">TRABAJANDO DESDE {startTime}</span>
                                                      </div>
                                                  )}
                                              </div>
                                          </td>
                                          <td className="p-2 font-mono">{calculatePayroll(u)}</td>
                                          <td className="p-2"><button onClick={(e)=>{e.stopPropagation(); printSchedule(u);}} className="text-[var(--gold)]"><Printer size={16}/></button></td>
                                      </tr>
                                  )})}
                              </tbody>
                          </table>
                      </div>

                      {editing && (
                          <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                              <div className="card w-full max-w-4xl bg-[var(--bg-card)] p-6 max-h-[90vh] overflow-y-auto">
                                  <h3 className="font-bold text-xl mb-4 text-[var(--text-main)]">{editing.id ? 'EDITAR' : 'NUEVO'} EMPLEADO</h3>
                                  <div className="grid grid-cols-4 gap-4 mb-4">
                                      <input className="input-std" placeholder="Nombre" value={editing.name} onChange={e=>setEditing({...editing, name:e.target.value})}/>
                                      <input className="input-std" placeholder="Usuario" value={editing.username} onChange={e=>setEditing({...editing, username:e.target.value})}/>
                                      <input className="input-std" placeholder="Contrase√±a" value={editing.password} onChange={e=>setEditing({...editing, password:e.target.value})}/>
                                      <select className="input-std" value={editing.role} onChange={e=>setEditing({...editing, role:e.target.value})}><option value="cajero">Cajero</option><option value="cocina">Cocina</option><option value="repartidor">Repartidor</option></select>
                                  </div>
                                  <div className="flex gap-4 mb-2 items-center">
                                      <div className="w-32"><label className="text-xs text-gray-500">Sueldo Semanal</label><input type="number" className="input-std" value={editing.salary} onChange={e=>setEditing({...editing, salary:parseFloat(e.target.value)})}/></div>
                                      <button onClick={()=>copyMonday(editing)} className="bg-blue-600 text-white px-4 py-2 rounded text-xs font-bold flex gap-2"><Copy size={14}/> COPIAR LUNES A SEMANA</button>
                                  </div>
                                  
                                  <div className="grid grid-cols-7 gap-2 mb-6">
                                      {days.map(d=>(
                                          <div key={d} className="bg-[#222] p-2 rounded text-center border border-[#333]">
                                              <p className="text-[var(--gold)] font-bold text-xs mb-1">{d}</p>
                                              <input className="bg-black text-white w-full text-xs text-center mb-1 border border-[#333]" placeholder="Entrada" value={editing.schedule?.[d]?.in||''} onChange={e=>setEditing({...editing, schedule:{...editing.schedule, [d]:{...(editing.schedule?.[d]||{}), in:e.target.value}}})}/>
                                              <input className="bg-black text-white w-full text-xs text-center border border-[#333]" placeholder="Salida" value={editing.schedule?.[d]?.out||''} onChange={e=>setEditing({...editing, schedule:{...editing.schedule, [d]:{...(editing.schedule?.[d]||{}), out:e.target.value}}})}/>
                                          </div>
                                      ))}
                                  </div>
                                  
                                  <div className="mb-4 bg-[#222] p-2 rounded">
                                      <p className="text-xs font-bold mb-1 text-white">Editar √öltimo Registro (Admin)</p>
                                      <div className="flex gap-2">
                                            <input type="datetime-local" className="input-std text-xs" value={(editing.attendance || []).length > 0 ? new Date(editing.attendance[editing.attendance.length-1].in).toISOString().slice(0,16) : ''} onChange={(e)=>{
                                                const newAtt = [...(editing.attendance || [])];
                                                if(newAtt.length > 0) newAtt[newAtt.length-1].in = new Date(e.target.value).toISOString();
                                                setEditing({...editing, attendance: newAtt});
                                            }}/>
                                            <input type="datetime-local" className="input-std text-xs" value={(editing.attendance || []).length > 0 && editing.attendance[editing.attendance.length-1].out ? new Date(editing.attendance[editing.attendance.length-1].out).toISOString().slice(0,16) : ''} onChange={(e)=>{
                                                const newAtt = [...(editing.attendance || [])];
                                                if(newAtt.length > 0) newAtt[newAtt.length-1].out = new Date(e.target.value).toISOString();
                                                setEditing({...editing, attendance: newAtt});
                                            }}/>
                                      </div>
                                  </div>

                                  <div className="flex justify-between">
                                      {editing.id && <button onClick={()=>deleteUser(editing.id)} className="text-red-500 font-bold border border-red-500 p-2 rounded">ELIMINAR USUARIO</button>}
                                      <div className="flex gap-2">
                                          <button onClick={()=>setEditing(null)} className="text-gray-500">CANCELAR</button>
                                          <button onClick={()=>{
                                              let users = [...db.users];
                                              if(editing.id) users = users.map(u=>u.id===editing.id?editing:u);
                                              else users.push({...editing, id:generateId()});
                                              updateDB({...db, users}); setEditing(null);
                                          }} className="btn-gold">GUARDAR CAMBIOS</button>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      )}
                </div>
            );
        };

        const CouponManager = ({ db, updateDB }) => {
            const [coup, setCoup] = useState({ code:'', val:'', type:'percent', limit:100 });
            return (
                <div className="space-y-4">
                    <div className="card p-6"><div className="flex gap-2"><input className="input-std uppercase" placeholder="CODIGO" value={coup.code} onChange={e=>setCoup({...coup, code:e.target.value})}/><select className="input-std w-32" value={coup.type} onChange={e=>setCoup({...coup, type:e.target.value})}><option value="percent">% Desc</option><option value="amount">$ Desc</option><option value="shipping">Env√≠o Gratis</option></select><input className="input-std w-20" type="number" placeholder="L√≠mite" value={coup.limit} onChange={e=>setCoup({...coup, limit:e.target.value})}/>{coup.type !== 'shipping' && <input className="input-std w-24" type="number" placeholder="Valor" value={coup.val} onChange={e=>setCoup({...coup, val:e.target.value})}/>}<button onClick={()=>{if(!coup.code) return; updateDB({...db, coupons: [...db.coupons, {...coup, id:generateId()}]});}} className="btn-gold flex-1">CREAR</button></div></div>
                    <div className="space-y-2">{db.coupons.map(c => <div key={c.id} className="card p-4 flex justify-between items-center border-l-4 border-purple-500"><div><p className="font-bold text-xl text-[var(--text-main)]">{c.code}</p><p className="text-gray-500 text-sm">{c.type==='shipping'?'ENV√çO GRATIS':`-${c.val}${c.type==='percent'?'%':'$'}`} (Disponibles: {c.limit})</p></div><button onClick={()=>updateDB({...db, coupons: db.coupons.filter(x=>x.id!==c.id)})} className="text-red-500"><Trash2/></button></div>)}</div>
                </div>
            );
        };
        const SettingsManager = ({ db, updateDB }) => {
            const [notif, setNotif] = useState('');
            const [target, setTarget] = useState('all');
            const [tabItem, setTabItem] = useState({min:'', max:'', price:''});
            const [newItem, setNewItem] = useState({prov:'', plat:''});
            
            const sendPush = () => {
                if(!notif) return showToast("Escribe un mensaje");
                const newNotif = { id: Date.now(), message: notif, target };
                updateDB({...db, settings: {...db.settings, notification: newNotif}});
                playSound();
                showToast(`Notificaci√≥n enviada: ${notif}`);
                setNotif('');
            };

            const handleCSV = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = ev => {
                        const lines = ev.target.result.split('\n').slice(1);
                        const table = lines.map(l=>{
                             const [min,max,price] = l.split(',');
                             return min ? {min:parseFloat(min), max:parseFloat(max), price:parseFloat(price)} : null;
                        }).filter(Boolean);
                        updateDB({...db, settings:{...db.settings, deliveryTable: table}});
                    };
                    r.readAsText(f);
                }
            };

            const addItem = (list, val) => { if(val) { updateDB({...db, settings: {...db.settings, [list]: [...(db.settings[list]||[]), val]}}); setNewItem({...newItem, [list==='providers'?'prov':'plat']: ''}); }};
            const delItem = (list, idx) => { const n = [...db.settings[list]]; n.splice(idx,1); updateDB({...db, settings: {...db.settings, [list]: n}}); };

            const addRate = () => {
                if(tabItem.price){
                    const newTable = [...db.settings.deliveryTable, {
                        min: parseFloat(tabItem.min), 
                        max: parseFloat(tabItem.max), 
                        price: parseFloat(tabItem.price)
                    }].sort((a,b)=>a.min-b.min);
                    updateDB({...db, settings:{...db.settings, deliveryTable: newTable}}); 
                    setTabItem({min:'',max:'',price:''});
                }
            };

            const updateRadius = (val) => {
                 updateDB({...db, settings: {...db.settings, deliveryRadius: parseInt(val)}});
            };

            // CORRECCI√ìN: 'overflow-y-auto' a√±adido al contenedor principal para scroll general
            return (
                <div className="h-full flex flex-col gap-4 overflow-y-auto pb-32">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="card p-4 border-l-4 border-purple-500 bg-[var(--bg-card)]">
                            <h3 className="font-bold mb-2 flex gap-2 text-[var(--text-main)]"><Bell/> NOTIFICACIONES</h3>
                            <div className="flex gap-2">
                                <select className="input-std w-40" value={target} onChange={e=>setTarget(e.target.value)}>
                                    <option value="all">TODOS</option>
                                    <option value="kitchen">COCINA</option>
                                    <option value="delivery">REPARTIDORES</option>
                                    <option value="cashier">CAJA</option>
                                </select>
                                <input className="input-std" placeholder="Mensaje..." value={notif} onChange={e=>setNotif(e.target.value)}/>
                                <button onClick={sendPush} className="btn-gold px-6">ENVIAR</button>
                            </div>
                            <p className="text-xs text-gray-500 mt-2">* Esto mostrar√° una alerta en pantalla completa a los usuarios seleccionados.</p>
                        </div>
                        
                        {/* CORRECCI√ìN: Indicador de KM claro y visible al mover */}
                        <div className="card p-4 border-l-4 border-[var(--gold)] bg-[var(--bg-card)]">
                            <h3 className="font-bold mb-2 flex gap-2 text-[var(--text-main)]"><MapPin/> ZONA DE REPARTO</h3>
                            <div className="flex flex-col gap-2 mb-4">
                                <div className="flex justify-between items-center">
                                    <span className="text-[var(--text-main)] text-sm font-bold">Cobertura Actual:</span>
                                    <span className="text-[var(--gold)] text-xl font-black bg-black/50 px-3 py-1 rounded">{db.settings.deliveryRadius} KM</span>
                                </div>
                                <input type="range" min="1" max="50" step="1" value={db.settings.deliveryRadius} onChange={(e)=>updateRadius(e.target.value)} className="w-full h-4 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[var(--gold)]"/>
                                <div className="flex justify-between text-[10px] text-gray-500"><span>1 km</span><span>25 km</span><span>50 km</span></div>
                            </div>
                            <div className="h-64 rounded border border-gray-600 overflow-hidden relative">
                                <LeafletMap center={STORE_COORDS} markers={[{pos:STORE_COORDS, emoji:'üè™', isStore:true}]} zoom={11} radius={db.settings.deliveryRadius} />
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="card p-4 border-t-4 border-blue-500 space-y-4">
                            <h3 className="font-bold flex gap-2 text-[var(--text-main)]"><Globe/> WEB & PAGOS</h3>
                            <div className="flex justify-between items-center bg-[#222] p-3 rounded"><div><p className="text-white text-sm font-bold">Estado Tienda</p></div><button onClick={()=>updateDB({...db, settings: {...db.settings, storeOpen: !db.settings.storeOpen}})} className={`px-4 py-1 rounded font-black text-xs uppercase ${db.settings.storeOpen?'bg-green-500 text-black':'bg-red-500 text-white'}`}>{db.settings.storeOpen?'ABIERTA':'CERRADA'}</button></div>
                            <div className="bg-[#222] p-3 rounded space-y-2">
                                <p className="text-white text-sm font-bold">M√©todos de Pago Web</p>
                                <div className="flex justify-between items-center"><span className="text-gray-400 text-xs">Efectivo</span><button onClick={()=>updateDB({...db, settings:{...db.settings, paymentMethods:{...db.settings.paymentMethods, cash:!db.settings.paymentMethods.cash}}})} className={`w-8 h-4 rounded-full relative ${db.settings.paymentMethods.cash?'bg-green-500':'bg-gray-600'}`}><div className={`w-2 h-2 bg-white rounded-full absolute top-1 ${db.settings.paymentMethods.cash?'right-1':'left-1'}`}></div></button></div>
                                <div className="flex justify-between items-center"><span className="text-gray-400 text-xs">Tarjeta</span><button onClick={()=>updateDB({...db, settings:{...db.settings, paymentMethods:{...db.settings.paymentMethods, card:!db.settings.paymentMethods.card}}})} className={`w-8 h-4 rounded-full relative ${db.settings.paymentMethods.card?'bg-green-500':'bg-gray-600'}`}><div className={`w-2 h-2 bg-white rounded-full absolute top-1 ${db.settings.paymentMethods.card?'right-1':'left-1'}`}></div></button></div>
                                <div className="flex justify-between items-center"><span className="text-gray-400 text-xs">Permitir Recoger</span><button onClick={()=>updateDB({...db, settings: {...db.settings, pickupEnabled: !db.settings.pickupEnabled}})} className={`w-8 h-4 rounded-full relative ${db.settings.pickupEnabled?'bg-green-500':'bg-gray-600'}`}><div className={`w-2 h-2 bg-white rounded-full absolute top-1 ${db.settings.pickupEnabled?'right-1':'left-1'}`}></div></button></div>
                                <div className="flex justify-between items-center"><span className="text-gray-400 text-xs">Permitir Domicilio</span><button onClick={()=>updateDB({...db, settings: {...db.settings, deliveryEnabled: !db.settings.deliveryEnabled}})} className={`w-8 h-4 rounded-full relative ${db.settings.deliveryEnabled!==false?'bg-green-500':'bg-gray-600'}`}><div className={`w-2 h-2 bg-white rounded-full absolute top-1 ${db.settings.deliveryEnabled!==false?'right-1':'left-1'}`}></div></button></div>
                            </div>
                        </div>
                        <div className="card p-4 border-t-4 border-[var(--gold)] space-y-4">
                            <h3 className="font-bold mb-2 text-[var(--text-main)]"><Lock/> SEGURIDAD & LISTAS</h3>
                            <div><label className="text-xs text-gray-500">Clave Supervisor (QR)</label><div className="bg-white p-2 mt-2 w-fit rounded"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=SUPERVISOR:${db.settings.supervisorKey}`} className="w-24 h-24"/></div><input className="input-std text-sm mt-2" value={db.settings.supervisorKey} onChange={e=>updateDB({...db, settings:{...db.settings, supervisorKey:e.target.value}})}/></div>
                            <hr className="border-[#333]"/>
                            <div><p className="text-[var(--text-main)] text-xs font-bold mb-1">PLATAFORMAS</p><div className="flex gap-1 mb-2"><input className="input-std text-xs" value={newItem.plat} onChange={e=>setNewItem({...newItem, plat:e.target.value})}/><button onClick={()=>addItem('platforms',newItem.plat)} className="btn-gold">+</button></div><div className="h-24 overflow-y-auto bg-[#222] p-2 rounded custom-scroll">{db.settings.platforms.map((p,i)=><div key={i} className="flex justify-between text-gray-400 text-xs border-b border-[#333] py-1"><span>{p}</span><button onClick={()=>delItem('platforms',i)} className="text-red-500">x</button></div>)}</div></div>
                        </div>
                        
                        {/* TABLA DE PRECIOS AL FINAL CON SCROLL VISIBLE */}
                        <div className="card p-4 border-t-4 border-green-500 flex flex-col h-80">
                            <div className="flex justify-between items-center mb-2"><h3 className="text-white font-bold flex gap-2"><Table/> TABULADOR ENV√çOS</h3><label className="text-[10px] text-blue-400 cursor-pointer">Cargar CSV<input type="file" hidden onChange={handleCSV}/></label></div>
                            <div className="flex gap-1 mb-2 bg-[#222] p-1 rounded"><input className="bg-transparent text-white text-xs w-12 border-b border-[#444] text-center" placeholder="Min" type="number" value={tabItem.min} onChange={e=>setTabItem({...tabItem, min:e.target.value})}/><input className="bg-transparent text-white text-xs w-12 border-b border-[#444] text-center" placeholder="Max" type="number" value={tabItem.max} onChange={e=>setTabItem({...tabItem, max:e.target.value})}/><input className="bg-transparent text-white text-xs w-12 border-b border-[#444] text-center" placeholder="$" type="number" value={tabItem.price} onChange={e=>setTabItem({...tabItem, price:e.target.value})}/><button className="text-green-500 font-bold px-2" onClick={addRate}>+</button></div>
                            <div className="flex-1 bg-[#222] rounded overflow-y-auto p-2 space-y-1 custom-scroll">{db.settings.deliveryTable.map((r,i)=><div key={i} className="flex justify-between text-xs text-gray-300 border-b border-[#333] pb-1"><span>{r.min} - {r.max} KM</span><span className="text-[var(--gold)] font-bold">${r.price}</span></div>)}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const TicketPreview = ({ db, updateDB }) => {
            const [header, setHeader] = useState(db.settings.ticketConfig.header);
            const [footer, setFooter] = useState(db.settings.ticketConfig.footer);
            const saveConfig = () => { updateDB({...db, settings: {...db.settings, ticketConfig: { header, footer }}}); showToast("Guardado"); };
            
            const generateHTML = (type) => {
                 const base = `<div class="center bold"><img src="${LOGO_URL}" style="width:50px;display:block;margin:0 auto 10px;">${header.replace(/\n/g, '<br>')}</div><hr>`;
                const end = `<hr><div class="center">${footer.replace(/\n/g, '<br>')}</div>`;
                const date = new Date().toLocaleString();
                if(type === 'sale') return `${base}<div class="center">VENTA #1234</div><div class="center">${date}</div><hr><div>1x Burger Cl√°sica ... $95</div><div>1x Papas ........... $55</div><hr><div class="bold right">TOTAL: $150</div>${end}`;
                if(type === 'cut') return `${base}<div class="center bold">CORTE DE CAJA</div><div class="center">${date}</div><hr><div>Fondo Inicial: $1,000</div><div>+ Ventas Efec: $2,500</div><div>- Gastos/Retiros: $500</div><hr><div class="bold right">TOTAL EN CAJA: $3,000</div><br><br><div class="center">_______________________<br>Firma Cajera</div>${end}`;
                if(type === 'driver_liq') return `${base}<div class="center bold">LIQUIDACI√ìN DRIVER</div><div class="center">Juan Moto</div><hr><div>Pedidos Entregados: 5</div><div>Total Cobrado: $800</div><div>Ganancia Env√≠os: -$150</div><hr><div class="bold right">A ENTREGAR: $650</div><br><br><div class="center">_______________________<br>Firma Driver</div>${end}`;
                if(type === 'platform') return `${base}<div class="center">PLATAFORMA (UBER)</div><div class="center">#9999</div><div class="center">${date}</div><hr><div>1x Burger ... $95</div><div class="bold right">TOTAL: $95</div>${end}<br><br>‚úÇÔ∏è --- CORTE AQU√ç ---<br><br>${base}<div class="center">COPIA CLIENTE/DRIVER</div><div class="center">${date}</div><hr><div>1x Burger ... $0.00</div><div class="bold right">TOTAL A PAGAR: $0.00</div><div class="center">PROPINAS NO INCLUIDAS</div>${end}`;
                return "";
            };

            const printDirect = (type) => printTicket(generateHTML(type));

            return (
                <div className="h-full overflow-y-auto pb-20">
                    <div className="card p-6 mb-4">
                        <h3 className="font-bold text-[var(--gold)] mb-4 flex gap-2"><Printer/> CONFIGURACI√ìN TICKETS</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label className="text-xs text-gray-500">Cabecera</label><textarea className="input-std h-24" value={header} onChange={e=>setHeader(e.target.value)}/></div>
                            <div><label className="text-xs text-gray-500">Pie de P√°gina</label><textarea className="input-std h-24" value={footer} onChange={e=>setFooter(e.target.value)}/></div>
                        </div>
                        <button onClick={saveConfig} className="btn-gold w-full">GUARDAR CAMBIOS</button>
                    </div>
                    <div className="card p-6">
                        <h3 className="font-bold text-white mb-4">VISTA PREVIA Y PRUEBA</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            {['sale','cut','driver_liq','platform'].map(t => (
                                <div key={t} className="bg-white text-black p-2 rounded text-xs font-mono border border-gray-300 relative group">
                                    <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition"><button onClick={()=>printDirect(t)} className="bg-black text-white p-1 rounded"><Printer size={16}/></button></div>
                                    <div dangerouslySetInnerHTML={{__html: generateHTML(t)}} />
                                    <button onClick={()=>printDirect(t)} className="w-full bg-[var(--gold)] mt-2 py-1 font-bold rounded">IMPRIMIR</button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ db, updateDB }) => {
            const [tab, setTab] = useState('dash');
            return (
                <div className="h-full flex flex-col bg-[var(--bg-body)]">
                    <div className="flex gap-2 p-4 bg-[var(--bg-card)] border-b border-[var(--border)] overflow-x-auto scroll-hide">
                        {['dash','menu','inv','staff','coup','conf','tickets'].map(t => <button key={t} onClick={()=>setTab(t)} className={`px-4 py-2 rounded font-bold uppercase whitespace-nowrap ${tab===t?'bg-[var(--gold)] text-black':'text-gray-500 bg-[#222]'}`}>{t}</button>)}
                    </div>
                    <div className="flex-1 p-6 overflow-hidden">
                        {tab==='dash' && <Dashboard db={db}/>}
                        {tab==='menu' && <ProductManager db={db} updateDB={updateDB}/>}
                        {tab==='inv' && <InventoryManager db={db} updateDB={updateDB}/>}
                        {tab==='staff' && <StaffManager db={db} updateDB={updateDB}/>}
                        {tab==='coup' && <CouponManager db={db} updateDB={updateDB}/>}
                        {tab==='conf' && <SettingsManager db={db} updateDB={updateDB}/>}
                        {tab==='tickets' && <TicketPreview db={db} updateDB={updateDB}/>}
                    </div>
                </div>
            );
        };

/* --- POS: CAJA, GESTI√ìN Y ENTREGAS --- */
const POS = ({ db, updateDB, user }) => {
    const [tab, setTab] = useState('pos'); 
    const [cart, setCart] = useState([]);
    const [modal, setModal] = useState(null); 
    const [catFilter, setCatFilter] = useState('Todos');
    const [searchQuery, setSearchQuery] = useState(''); 
    
    // --- ESTADOS COCKPIT ---
    const [orderType, setOrderType] = useState('takeaway'); 
    const [orderDetails, setOrderDetails] = useState({ name:'', phone:'', address:'', references:'', table:'', platform:'', platformOrderId:'', refs:'' });
    const [payMethod, setPayMethod] = useState('cash');
    const [cashReceived, setCashReceived] = useState(0);
    const [voucher, setVoucher] = useState('');
    const [deliveryCoords, setDeliveryCoords] = useState(null);
    const [couponCode, setCouponCode] = useState('');
    const [discount, setDiscount] = useState(0);
    const [isLocating, setIsLocating] = useState(false);
    const [bottomMenuOpen, setBottomMenuOpen] = useState(false);
    
    // Modales de Administraci√≥n
    const [liquidationModal, setLiquidationModal] = useState(false);
    const [corteModal, setCorteModal] = useState(false);
    const [retiroModal, setRetiroModal] = useState(false);
    const [driverToLiq, setDriverToLiq] = useState(null);
    const [liqSummary, setLiqSummary] = useState(null);
    const [newExpense, setNewExpense] = useState({desc:'', amount:''});
    const [manualDriverId, setManualDriverId] = useState('');
    const [viewMap, setViewMap] = useState(false);
    const [selectedWebOrder, setSelectedWebOrder] = useState(null);
    const [selectedGroup, setSelectedGroup] = useState(null);
    const [selectedReady, setSelectedReady] = useState([]);
    const [viewGroupMap, setViewGroupMap] = useState(null);
    const [countedCash, setCountedCash] = useState('');
    const [countedCard, setCountedCard] = useState('');
    const [cutResult, setCutResult] = useState(null);
    const [deliveryFilter, setDeliveryFilter] = useState('all');
    const [ingredientsProduct, setIngredientsProduct] = useState(null);

    const uniqueCategories = ['Todos', ...new Set(db.products.filter(p=>p.active).map(p => p.cat).filter(Boolean))];
    const webOrders = db.orders.filter(o => o.source === 'web' && o.status === 'web_pending_payment');
    const readyOrders = db.orders.filter(o => o.status === 'ready' && o.address !== 'RECOGER' && !o.groupId);
    const uniqueGroups = [...new Set(db.orders.filter(o => o.groupId && o.status === 'ready').map(o => o.groupId))];
    const activeOrders = db.orders.filter(o => o.status === 'delivering' || o.status === 'pending');
    const drivers = db.users.filter(u => u.role === 'repartidor' && u.online);
    
    const liveMarkers = [{ pos: STORE_COORDS, emoji: 'üè™' }, ...activeOrders.map(o => ({ pos: o.clientLoc || STORE_COORDS, emoji: 'üçî' })), ...drivers.map(d => ({ pos: d.location || STORE_COORDS, emoji: 'üèçÔ∏è' }))];
    const subtotal = cart.reduce((a,b)=>a+b.price*b.qty,0);
    const total = subtotal - discount;

    const addToCart = (p) => setCart(prev => { const ex = prev.find(i=>i.id===p.id); return ex ? prev.map(i=>i.id===p.id?{...i,qty:i.qty+1}:i) : [...prev,{...p,qty:1}]; });
    const removeFromCart = (idx) => { const n = [...cart]; n.splice(idx,1); setCart(n); };
    const updateCartNote = (idx, note) => { const n = [...cart]; n[idx].note = note; setCart(n); };
    const switchPayMethod = (method) => { setPayMethod(method); setPaymentStatus(''); };

    // --- COCKPIT LOGIC ---
    const updateAddress = async (addr) => {
        setOrderDetails(prev => ({...prev, address: addr}));
        if(addr.length > 5) {
            setIsLocating(true);
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr + CITY_SUFFIX)}&limit=1&addressdetails=1`);
                const data = await res.json();
                if(data && data[0]) setDeliveryCoords([parseFloat(data[0].lat), parseFloat(data[0].lon)]);
            } catch(e){}
            setIsLocating(false);
        }
    };

    const finalizeOrder = () => {
        if(payMethod==='cash' && (!cashReceived || cashReceived < total)) return showToast("Monto insuficiente");
        const order = {
            id: generateId(), orderNum: Math.floor(Math.random()*9000)+1000,
            items: cart, total, method: payMethod, status: 'pending', createdAt: new Date().toISOString(),
            address: orderType==='delivery' ? `${orderDetails.address} (${orderDetails.references})` : orderType.toUpperCase(),
            clientName: orderDetails.name || 'Cliente', clientLoc: deliveryCoords, source: orderType==='platform'?'platform':'store', 
            paymentStatus: 'paid'
        };
        updateDB({...db, orders: [...db.orders, order], cashDrawer: {...db.cashDrawer, current: db.cashDrawer.current + (payMethod==='cash'?total:0)}});
        setCart([]); setModal(null); setCashReceived(0); showToast("Venta registrada");
    };
    
    // --- GESTI√ìN WEB LOGIC ---
    const handleWebOrder = (o) => setSelectedWebOrder(o);
    const cancelWebOrder = (id) => { updateDB({...db, orders: db.orders.map(o => o.id === id ? {...o, status: 'cancelled'} : o)}); setSelectedWebOrder(null); };
    const acceptWebOrder = () => { 
        if(!selectedWebOrder) return;
        // Convertir orden web a orden activa y pasar a POS para procesar o auto-aceptar
        // Aqu√≠ asumimos auto-aceptar y mandar a cocina (pending)
        updateDB({...db, orders: db.orders.map(o => o.id === selectedWebOrder.id ? {...o, status: 'pending'} : o)}); 
        setSelectedWebOrder(null);
        showToast("Pedido Aceptado");
    };

    // --- ENTREGA LOGIC ---
    const generateGroupQR = () => { const gid = generateId(); updateDB({...db, orders: db.orders.map(o=>selectedReady.includes(o.id)?{...o, groupId:gid}:o)}); setSelectedReady([]); };
    const undoGroup = (gid) => updateDB({...db, orders: db.orders.map(o=>o.groupId===gid?{...o, groupId:null}:o)});
    const handleManualDispatch = (orders) => { if(confirm("¬øDespachar?")) updateDB({...db, orders: db.orders.map(o=>orders.find(x=>x.id===o.id)?{...o, status:'delivering'}:o)}); };
    const toggleSelect = (id) => setSelectedReady(prev => prev.includes(id) ? prev.filter(x=>x!==id) : [...prev, id]);

    // Admin Modals Logic
    const performBlindCut = () => {
        const cCash = parseFloat(countedCash) || 0; const cCard = parseFloat(countedCard) || 0;
        const systemCash = db.cashDrawer.current;
        const systemCard = db.orders.filter(o => o.method === 'card' && o.status !== 'cancelled').reduce((a,b)=>a+b.total,0);
        setCutResult({ systemCash, systemCard, cCash, cCard, diffCash: systemCash - cCash, diffCard: systemCard - cCard });
    };
    const printBlindCut = () => { printTicket(`<div class="center bold">CORTE CAJA</div><hr><div>EFECTIVO: ${formatCurrency(cutResult.cCash)}</div><div>DIF: ${formatCurrency(cutResult.diffCash)}</div>`); };
    const confirmLiquidation = () => {
        if(!driverToLiq || !liqSummary) return;
        updateDB({...db, users: db.users.map(u => u.id === driverToLiq.id ? {...u, cashOnHand: 0} : u), orders: db.orders.map(o => liqSummary.deliveredOrders.find(do_ => do_.id === o.id) ? {...o, settled: true} : o), cashDrawer: {...db.cashDrawer, current: db.cashDrawer.current + liqSummary.netToPay}});
        setLiquidationModal(false); setDriverToLiq(null);
    };
    const handleScanDriver = (txt) => {
        const did = txt.replace("LIQ:", "");
        const drv = db.users.find(u => u.id === did);
        if(drv) {
            const dels = db.orders.filter(o => o.driver === drv.username && o.status === 'delivered' && !o.settled);
            const totalC = drv.cashOnHand || 0;
            const totalE = dels.reduce((a,b)=>a+(b.deliveryFee||0), 0);
            setDriverToLiq(drv); setLiqSummary({ deliveredOrders: dels, totalCash: totalC, totalEarnings: totalE, netToPay: totalC - totalE });
        }
    };
    const addExpense = () => { updateDB({...db, expenses: [...db.expenses, {id:generateId(), desc:newExpense.desc, amount:parseFloat(newExpense.amount)}], cashDrawer:{...db.cashDrawer, current: db.cashDrawer.current - parseFloat(newExpense.amount)}}); setRetiroModal(false); };

    return (
        <div className="h-full flex flex-col bg-[var(--bg-body)] mesh-bg">
            <div className="flex bg-white border-b border-gray-300 shadow-sm shrink-0 sticky top-0 z-20">
                <button onClick={()=>setTab('pos')} className={`flex-1 p-3 font-bold border-r border-gray-200 transition ${tab==='pos'?'bg-[var(--gold)] text-black shadow-inner':'text-gray-500 hover:bg-gray-100'}`}>PUNTO DE VENTA</button>
                <button onClick={()=>setTab('gestion')} className={`flex-1 p-3 font-bold border-r border-gray-200 transition flex items-center justify-center gap-2 ${tab==='gestion'?'bg-blue-600 text-white shadow-inner':'text-gray-500 hover:bg-gray-100'}`}>GESTI√ìN (WEB) {webOrders.length>0 && <span className="bg-red-500 text-white text-[10px] px-2 rounded-full animate-pulse">{webOrders.length}</span>}</button>
                <button onClick={()=>setTab('entrega')} className={`flex-1 p-3 font-bold transition flex items-center justify-center gap-2 ${tab==='entrega'?'bg-green-600 text-white shadow-inner':'text-gray-500 hover:bg-gray-100'}`}>ENTREGA</button>
            </div>

            <div className="flex-1 flex overflow-hidden relative">
                {/* TAB POS */}
                {tab === 'pos' && (
                    <div className="w-full flex h-full">
                        <div className="flex-1 flex flex-col relative">
                            <div className="p-2 border-b bg-white flex gap-2"><input className="input-std pl-2" placeholder="Buscar..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)}/><div className="flex-1 flex gap-2 overflow-x-auto">{uniqueCategories.map(c=><button key={c} onClick={()=>setCatFilter(c)} className={`px-4 py-1 rounded-full text-xs font-bold whitespace-nowrap ${catFilter===c?'bg-black text-white':'bg-gray-100 text-black'}`}>{c}</button>)}</div></div>
                            <div className="flex-1 p-4 grid grid-cols-4 gap-3 overflow-y-auto content-start">{db.products.filter(p=>p.active && (catFilter==='Todos'||p.cat===catFilter) && p.name.toLowerCase().includes(searchQuery.toLowerCase())).map(p=>(<div key={p.id} onClick={()=>addToCart(p)} className="card h-32 relative overflow-hidden cursor-pointer group hover:shadow-lg transition"><img src={p.img} className="absolute inset-0 w-full h-full object-cover opacity-80"/><div className="absolute bottom-0 p-2 w-full bg-gradient-to-t from-black to-transparent"><p className="text-white font-bold text-sm">{p.name}</p><p className="text-[var(--gold)] font-bold text-xs">{formatCurrency(p.price)}</p></div></div>))}</div>
                        </div>
                        <div className="w-96 bg-white border-l shadow-xl flex flex-col z-10">
                            <div className="flex-1 p-4 overflow-y-auto space-y-2">{cart.map((item,idx)=>(<div key={idx} className="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-200"><div><span className="font-bold">{item.qty}x</span> {item.name}</div><button onClick={()=>removeFromCart(idx)} className="text-red-500">x</button></div>))}</div>
                            <div className="p-4 border-t bg-gray-50"><div className="flex justify-between text-2xl font-black mb-4"><span>TOTAL</span><span>{formatCurrency(total)}</span></div><button onClick={()=>setModal('cockpit')} className="btn-gold w-full text-xl py-4 shadow-lg">COBRAR</button></div>
                        </div>
                    </div>
                )}
                
                {/* TAB GESTI√ìN WEB */}
                {tab === 'gestion' && <div className="h-full w-full overflow-y-auto p-4">{webOrders.map(o=>(<div key={o.id} className="card p-4 border-l-4 border-blue-500 mb-2 cursor-pointer" onClick={()=>setSelectedWebOrder(o)}><div className="flex justify-between font-bold"><span>WEB #{o.orderNum}</span><span>{formatCurrency(o.total)}</span></div><p className="text-sm">{o.clientName}</p></div>))}</div>}
                
                {/* TAB ENTREGA */}
                {tab === 'entrega' && (
                    <div className="h-full w-full overflow-y-auto p-4">
                        <div className="flex gap-2 mb-4"><button className="btn-gold text-xs" onClick={generateGroupQR} disabled={selectedReady.length<2}>CREAR RUTA</button></div>
                        <div className="gestion-grid">
                            {uniqueGroups.map(gid=>(<div key={gid} className="card p-4 border-l-4 border-purple-500 bg-purple-50 cursor-pointer" onClick={()=>setSelectedGroup({id:gid, orders:db.orders.filter(o=>o.groupId===gid), qr:`GROUP:${db.orders.filter(o=>o.groupId===gid).map(x=>x.id).join(',')}`})}><h3 className="font-bold">RUTA {gid.substring(0,4)}</h3></div>))}
                            {readyOrders.map(o=>(<div key={o.id} className={`card p-4 border-l-4 cursor-pointer ${selectedReady.includes(o.id)?'border-gold bg-yellow-50':'border-green-500'}`} onClick={()=>toggleSelect(o.id)}><h3 className="font-bold">#{o.orderNum}</h3><p>{o.address}</p><button onClick={(e)=>{e.stopPropagation(); handleManualDispatch([o]);}} className="bg-gray-800 text-white text-xs px-2 py-1 rounded mt-2">DESPACHAR</button></div>))}
                        </div>
                    </div>
                )}
            </div>

            {/* BOTONES FLOTANTES */}
            <div className="admin-fab">
                {bottomMenuOpen && (
                    <div className="admin-fab-menu">
                        <button onClick={()=>setCorteModal(true)} className="bg-red-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2">CORTE</button>
                        <button onClick={()=>setRetiroModal(true)} className="bg-orange-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2">RETIRO</button>
                        <button onClick={()=>setLiquidationModal(true)} className="bg-green-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2">LIQUIDAR</button>
                        <button onClick={()=>setViewMap(true)} className="bg-blue-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2">GPS</button>
                    </div>
                )}
                <button className="bg-[var(--gold)] text-black p-4 rounded-full shadow-xl border-2 border-white" onClick={()=>setBottomMenuOpen(!bottomMenuOpen)}><Plus size={24}/></button>
            </div>

            {/* MODAL COBRO (COCKPIT) */}
            {modal === 'cockpit' && (
                <div className="fixed inset-0 bg-black/90 z-50 p-6 flex items-center justify-center animate-in zoom-in">
                    <div className="bg-white w-full max-w-7xl h-[90vh] rounded-xl shadow-2xl grid grid-cols-3 overflow-hidden">
                        <div className="p-6 bg-gray-50 border-r border-gray-200">
                            <h3 className="font-black text-2xl mb-6 text-black">1. TIPO</h3>
                            <div className="space-y-3">
                                {['TAKEAWAY','DINEIN','DELIVERY','PLATFORM'].map(t => (
                                    <button key={t} onClick={()=>setOrderType(t.toLowerCase())} className={`w-full p-4 text-left font-bold border rounded ${orderType===t.toLowerCase()?'bg-[var(--gold)] border-black shadow-md text-black':'bg-white border-gray-300 text-gray-500'}`}>{t}</button>
                                ))}
                            </div>
                            <button onClick={()=>setModal(null)} className="mt-8 w-full border-2 border-red-500 text-red-500 font-bold py-3 rounded hover:bg-red-50">CANCELAR</button>
                        </div>

                        <div className="p-6 bg-white overflow-y-auto">
                            <h3 className="font-black text-2xl mb-6 text-black">2. DATOS</h3>
                            <input className="input-std mb-4 text-lg bg-[#F0EBEB]" placeholder="Nombre Cliente" value={orderDetails.name} onChange={e=>setOrderDetails({...orderDetails, name:e.target.value})}/>
                            {orderType === 'delivery' && (
                                <div className="space-y-4">
                                    <div className="flex gap-2">
                                        <input className="input-std flex-1 bg-[#F0EBEB]" placeholder="Calle y N√∫mero" value={orderDetails.address} onChange={e=>updateAddress(e.target.value)}/>
                                        <button className="bg-orange-500 text-white font-bold px-4 rounded shadow">UBICACI√ìN</button>
                                    </div>
                                    <div className="h-48 rounded-lg border-2 border-gray-300 overflow-hidden shadow-inner">
                                        <LeafletMap center={deliveryCoords || STORE_COORDS} markers={[{pos:deliveryCoords||STORE_COORDS}]} zoom={15}/> 
                                    </div>
                                    <input className="input-std bg-[#F0EBEB]" placeholder="Referencias..."/>
                                </div>
                            )}
                        </div>

                        <div className="p-6 bg-gray-50 border-l border-gray-200 flex flex-col">
                            <h3 className="font-black text-2xl mb-2 text-center text-black">TOTAL: {formatCurrency(total)}</h3>
                            <div className="flex gap-2 mb-4">
                                <button onClick={()=>setPayMethod('cash')} className={`flex-1 py-3 rounded font-bold ${payMethod==='cash'?'bg-green-600 text-white':'bg-white border text-gray-500'}`}>EFECTIVO</button>
                                <button onClick={()=>setPayMethod('card')} className={`flex-1 py-3 rounded font-bold ${payMethod==='card'?'bg-blue-600 text-white':'bg-white border text-gray-500'}`}>TARJETA</button>
                            </div>
                            {payMethod==='cash' && <div className="grid grid-cols-3 gap-2 mb-auto">{[50,100,200,500].map(v=><button key={v} onClick={()=>setCashReceived(v)} className="bg-white border py-4 font-bold rounded shadow-sm text-black hover:bg-gray-100">${v}</button>)}</div>}
                            <button onClick={finalizeOrder} className="btn-gold w-full py-5 text-2xl shadow-xl mt-auto">COBRAR</button>
                        </div>
                    </div>
                </div>
            )}
            
            {/* Modal Detalles Web */}
            {selectedWebOrder && (
                <div className="fixed inset-0 bg-black/80 z-[6000] flex flex-col items-center justify-center p-4">
                    <div className="bg-white w-full max-w-lg p-6 border-l-8 border-blue-500 rounded-r-xl shadow-2xl">
                         <div className="flex justify-between mb-4"><h3 className="font-bold text-xl text-blue-900">PEDIDO WEB #{selectedWebOrder.orderNum}</h3><button onClick={()=>setSelectedWebOrder(null)}><X/></button></div>
                         <p className="text-gray-800 font-bold mb-4">{selectedWebOrder.clientName} - <span className="text-gray-500">{selectedWebOrder.address}</span></p>
                         <div className="h-64 rounded mb-4 overflow-hidden"><LeafletMap center={selectedWebOrder.clientLoc||STORE_COORDS} markers={[{pos:selectedWebOrder.clientLoc||STORE_COORDS, emoji:'üìç'}]} route={[STORE_COORDS, selectedWebOrder.clientLoc||STORE_COORDS]}/></div>
                         <div className="flex gap-2"><button onClick={()=>cancelWebOrder(selectedWebOrder.id)} className="flex-1 bg-red-100 text-red-600 py-3 rounded font-bold">RECHAZAR</button><button onClick={acceptWebOrder} className="flex-1 bg-blue-600 text-white py-3 rounded font-bold shadow">ACEPTAR</button></div>
                    </div>
                </div>
            )}
            
            {/* MODALES ADICIONALES (Corte, Retiro, Liq) REUTILIZADOS */}
            {corteModal && <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4"><div className="bg-white p-6 rounded-xl w-full max-w-md"><h3 className="text-red-600 font-bold text-2xl mb-4">CORTE CAJA</h3><input className="input-special mb-2 text-center text-xl" placeholder="Efectivo" value={countedCash} onChange={e=>setCountedCash(e.target.value)}/><button onClick={performBlindCut} className="btn-gold w-full">CALCULAR</button>{cutResult && <div className="mt-4"><p>DIF: {formatCurrency(cutResult.diffCash)}</p><button onClick={printBlindCut} className="bg-black text-white w-full p-2 mt-2 rounded">IMPRIMIR</button></div>}<button onClick={()=>setCorteModal(false)} className="w-full text-gray-500 mt-4">CERRAR</button></div></div>}
            {liquidationModal && <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4"><div className="bg-white p-6 rounded-xl w-full max-w-md"><h3 className="text-black font-bold mb-4">LIQUIDACI√ìN</h3><input className="input-special mb-2 text-center" placeholder="ID DRIVER" onChange={e=>setManualDriverId(e.target.value)}/><button onClick={()=>handleScanDriver("LIQ:"+manualDriverId)} className="btn-gold w-full mb-4">BUSCAR</button>{driverToLiq && <div><p className="font-bold">{driverToLiq.name}</p><p>A Pagar: {formatCurrency(liqSummary.netToPay)}</p><button onClick={confirmLiquidation} className="btn-gold w-full mt-2">CONFIRMAR</button></div>}<button onClick={()=>setLiquidationModal(false)} className="w-full text-gray-500 mt-4">CERRAR</button></div></div>}
            {viewMap && <div className="fixed inset-0 bg-white z-[6000] p-4"><button onClick={()=>setViewMap(false)} className="absolute top-4 right-4 bg-red-600 text-white px-4 py-2 rounded font-bold z-[7000]">CERRAR</button><LeafletMap center={STORE_COORDS} markers={liveMarkers} zoom={13}/></div>}
        </div>
    );
};
/* --- CLIENT APP CORREGIDA --- */
const ClientApp = ({ db, updateDB }) => {
    const [view, setView] = useState('menu');
    const [cart, setCart] = useState([]);
    const [form, setForm] = useState({name:'', phone:'', type:'delivery', address:'', references:'', pay:'card', payAmount:0});
    const [activeOrder, setActiveOrder] = useState(null);
    const [clientCoords, setClientCoords] = useState(null);
    const [deliveryCoords, setDeliveryCoords] = useState(null);
    const [isLocating, setIsLocating] = useState(false);
    
    // --- EFECTO: AUTO-REDIRECT TRACKING ---
    useEffect(() => {
        if(activeOrder) {
            const fresh = db.orders.find(o => o.id === activeOrder.id);
            if (fresh && fresh.status !== activeOrder.status) {
                setActiveOrder(fresh);
                // Si ya no es pending web, ir a track
                if (fresh.status !== 'web_pending_payment' && view !== 'track') setView('track');
            }
        }
    }, [db.orders, activeOrder]);

    const submit = () => {
        const order = { id: generateId(), orderNum: Math.floor(Math.random()*9000)+1000, items: cart, total: cart.reduce((a,b)=>a+b.price*b.qty,0), status: 'web_pending_payment', method: form.pay, address: form.address, clientName: form.name, clientLoc: deliveryCoords, source: 'web', createdAt: new Date().toISOString() };
        updateDB({...db, orders: [...db.orders, order]});
        setActiveOrder(order);
    };

    const updateLocation = (addr) => { setForm({...form, address: addr}); };
    const useGPS = () => { navigator.geolocation.getCurrentPosition(pos => { const c=[pos.coords.latitude, pos.coords.longitude]; setDeliveryCoords(c); setClientCoords(c); }); };

    if(view === 'menu') return (
        <div className="h-full flex flex-col bg-white overflow-hidden">
            <div className="banner-container"><img src={BANNER_URL} className="mobile-banner"/></div>
            
            {/* BOT√ìN LATERAL FLOTANTE */}
            <div className="side-share-btn" onClick={()=>copyToClipboard(window.location.href)}>COMPARTIR <Share2 size={16}/></div>

            {activeOrder && activeOrder.status === 'web_pending_payment' && <div className="bg-yellow-400 p-4 text-center font-bold text-black animate-pulse cursor-pointer" onClick={()=>setView('track')}>‚è≥ ESPERANDO CONFIRMACI√ìN...</div>}

            <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
                {db.products.filter(p=>p.active).map(p=>(<div key={p.id} className="card p-3 flex gap-3 shadow-sm bg-white"><img src={p.img} className="w-24 h-24 rounded object-cover"/><div className="flex-1"><p className="font-bold">{p.name}</p><div className="flex justify-between items-center mt-2"><span className="text-[var(--accent)] font-bold">{formatCurrency(p.price)}</span><button onClick={()=>setCart([...cart, {...p, qty:1}])} className="bg-[var(--gold)] px-4 py-1 rounded-full text-xs font-bold shadow">AGREGAR</button></div></div></div>))}
            </div>
            {cart.length > 0 && <div className="fixed bottom-0 w-full p-4 bg-white border-t z-50"><button onClick={()=>setView('checkout')} className="btn-gold w-full shadow-lg">IR A PAGAR</button></div>}
        </div>
    );

    if(view === 'checkout') return (
        <div className="h-full bg-white p-4 overflow-y-auto pb-32">
            <h2 className="font-bold text-xl mb-6">FINALIZAR PEDIDO</h2>
            <div className="mb-6">
                <label className="text-xs font-bold text-gray-500 mb-1 block">DIRECCI√ìN DE ENTREGA</label>
                {/* INPUT DIDI STYLE */}
                <div className="didi-wrapper mb-2">
                    <input className="didi-input-internal" placeholder="Calle y N√∫mero..." value={form.address} onChange={e=>updateLocation(e.target.value)}/>
                    <button className="didi-btn-internal" onClick={useGPS}>UBICACI√ìN</button>
                </div>
                <div className="h-40 rounded border overflow-hidden relative shadow-inner"><LeafletMap center={deliveryCoords || STORE_COORDS} markers={[{pos:deliveryCoords||STORE_COORDS, emoji:'üìç', isMyLoc:true}]} zoom={15}/></div>
            </div>
            <input className="input-std mb-2" placeholder="Nombre" value={form.name} onChange={e=>setForm({...form,name:e.target.value})}/>
            <button onClick={submit} className="btn-gold w-full mt-4 py-3 shadow-lg">ENVIAR PEDIDO</button>
        </div>
    );

    if(view === 'track') {
        const isWaiting = activeOrder.status === 'web_pending_payment';
        return (
            <div className="h-full bg-white flex flex-col items-center pt-10 px-4 text-center">
                <div className="w-32 h-32 rounded-full border-4 border-[var(--gold)] p-1 mb-6 relative"><img src={LOGO_URL} className={`w-full h-full rounded-full object-cover ${isWaiting?'logo-pulse':''}`}/></div>
                {isWaiting ? <><h2 className="text-2xl font-black mb-2">¬°ESPERA!</h2><p className="font-bold text-red-600 bg-red-50 p-4 rounded mb-4">CONFIRMANDO...</p></> : <><h2 className="text-2xl font-black text-green-600 mb-2">¬°ACEPTADO!</h2><div className="h-64 w-full rounded-xl overflow-hidden border shadow-lg relative"><LeafletMap center={STORE_COORDS} markers={[{pos:STORE_COORDS, isStore:true}, {pos:deliveryCoords||STORE_COORDS, emoji:'üìç', isClient:true}]} zoom={13}/></div></>}
            </div>
        );
    }
};
/* --- DRIVER APP FINAL --- */
const DriverApp = ({ db, updateDB, user }) => {
    const [tab, setTab] = useState('map'); 
    const [showScanner, setShowScanner] = useState(false);
    const [selectedOrder, setSelectedOrder] = useState(null); 
    const [driverLoc, setDriverLoc] = useState(STORE_COORDS);
    const [blockTime, setBlockTime] = useState(0); 
    const [paymentConfirm, setPaymentConfirm] = useState(null); 

    const myOrders = db.orders.filter(o => o.driver === user.username && o.status === 'delivering');

    // Cron√≥metro Bloqueo
    useEffect(() => {
        const check = setInterval(() => {
            const blockedUntil = localStorage.getItem(`driver_block_${user.id}`);
            if(blockedUntil) {
                const diff = Math.ceil((parseInt(blockedUntil) - Date.now()) / 1000);
                if(diff > 0) setBlockTime(diff);
                else { setBlockTime(0); localStorage.removeItem(`driver_block_${user.id}`); }
            }
        }, 1000);
        return () => clearInterval(check);
    }, [user.id]);

    useEffect(() => {
        navigator.geolocation.watchPosition(p => setDriverLoc([p.coords.latitude, p.coords.longitude]));
    }, []);

    const onScan = (text) => {
        const code = text.replace('ORDER:', '').replace('GROUP:', '');
        const target = db.orders.find(o => o.id === code || o.groupId === code);
        if (target && target.status === 'ready') {
            updateDB({...db, orders: db.orders.map(o => (o.id === target.id || o.groupId === target.groupId) ? {...o, status: 'delivering', driver: user.username} : o)});
            showToast("Asignado");
            setShowScanner(false);
        } else showToast("QR Inv√°lido");
    };

    const handleDelivery = (success) => {
        if (success) {
            if (selectedOrder.method === 'cash' && selectedOrder.paymentStatus !== 'paid') setPaymentConfirm(selectedOrder);
            else finalizeDelivery(selectedOrder, 0);
        } else {
            if(confirm("¬øFallo de entrega? Se bloquear√° 3 min.")) {
                localStorage.setItem(`driver_block_${user.id}`, Date.now() + 180000);
                const note = { id: Date.now(), target: 'cajero', message: `‚ö†Ô∏è FALLO ENTREGA: #${selectedOrder.orderNum}` };
                updateDB({...db, settings: {...db.settings, notification: note}});
                setSelectedOrder(null);
            }
        }
    };

    const finalizeDelivery = (order, amount) => {
        updateDB({...db, orders: db.orders.map(o => o.id === order.id ? {...o, status: 'delivered', paymentStatus: 'paid'} : o), users: db.users.map(u => u.id === user.id ? {...u, cashOnHand: (u.cashOnHand||0) + (order.method==='cash'?order.total:0)} : u)});
        showToast("Entregado"); setPaymentConfirm(null); setSelectedOrder(null);
    };

    if(blockTime > 0) return (<div className="driver-timer-overlay"><h1 className="text-6xl text-red-500 mb-4">{Math.floor(blockTime/60)}:{blockTime%60}</h1><h2>BLOQUEADO</h2></div>);

    return (
        <div className="h-full bg-white relative">
            {tab === 'map' && <div className="h-full relative"><LeafletMap center={driverLoc} markers={[{pos:STORE_COORDS, isStore:true}, ...myOrders.map(o=>({pos:o.clientLoc||STORE_COORDS, emoji:'üçî', data:o}))]} onMarkerClick={setSelectedOrder} zoom={15}/><button onClick={()=>setShowScanner(true)} className="absolute bottom-24 right-4 bg-[var(--gold)] w-16 h-16 rounded-full flex items-center justify-center shadow-xl border-4 border-black z-[500]"><QrCode size={32}/></button></div>}
            
            {selectedOrder && (
                <div className="driver-modal">
                    <div className="flex justify-between items-center mb-2 border-b pb-2"><div><h3 className="font-black text-2xl">#{selectedOrder.orderNum}</h3><p className="font-bold">{selectedOrder.clientName}</p></div><p className="text-xl font-bold">{formatCurrency(selectedOrder.total)}</p></div>
                    <p className="text-sm text-gray-600 mb-4">{selectedOrder.address}</p>
                    <div className="grid grid-cols-3 gap-2 mb-4"><a href={`tel:${selectedOrder.clientPhone}`} className="bg-gray-100 p-3 rounded flex flex-col items-center font-bold text-xs"><Phone/> LLAMAR</a><a href={`https://wa.me/52${selectedOrder.clientPhone}`} className="bg-green-100 text-green-700 p-3 rounded flex flex-col items-center font-bold text-xs"><MessageCircle/> WHATS</a><a href={`http://maps.google.com/?q=${selectedOrder.clientLoc?.[0]},${selectedOrder.clientLoc?.[1]}`} className="bg-blue-100 text-blue-700 p-3 rounded flex flex-col items-center font-bold text-xs"><Navigation/> IR</a></div>
                    <div className="flex gap-2"><button onClick={()=>handleDelivery(false)} className="flex-1 bg-red-100 text-red-600 py-3 rounded font-bold">NO PUDE ‚ùå</button><button onClick={()=>handleDelivery(true)} className="flex-1 bg-green-600 text-white py-3 rounded font-bold shadow">ENTREGAR ‚úÖ</button></div>
                </div>
            )}

            {paymentConfirm && (
                <div className="fixed inset-0 bg-black/90 z-[8000] flex items-center justify-center p-6"><div className="bg-white w-full rounded-xl p-6 text-center"><h3 className="text-xl font-bold mb-2">COBRAR: {formatCurrency(paymentConfirm.total)}</h3><input id="payInput" type="number" className="input-std text-center text-2xl mb-4" placeholder="$ Recibido"/><div className="flex gap-2"><button onClick={()=>setPaymentConfirm(null)} className="flex-1 bg-gray-200 py-3 rounded">CANCELAR</button><button onClick={()=>{const v=parseFloat(document.getElementById('payInput').value)||0; if(v<paymentConfirm.total)return showToast("Falta"); finalizeDelivery(paymentConfirm,v);}} className="flex-1 btn-gold py-3 rounded">CONFIRMAR</button></div></div></div>
            )}

            {showScanner && <div className="fixed inset-0 bg-black z-[9000]"><QRScanner onScan={onScan}/><button onClick={()=>setShowScanner(false)} className="absolute top-4 right-4 bg-red-600 text-white px-4 py-2 rounded">CERRAR</button></div>}

            <div className="driver-nav"><button onClick={()=>setTab('map')} className={`driver-nav-btn ${tab==='map'?'active':''}`}><Map size={20}/>MAPA</button><button onClick={()=>setTab('wallet')} className={`driver-nav-btn ${tab==='wallet'?'active':''}`}><Wallet size={20}/>CARTERA</button></div>
        </div>
    );
};
const Kitchen = ({ db, updateDB }) => {
            const [detailOrder, setDetailOrder] = useState(null);
            const [showAuth, setShowAuth] = useState(false);
            const [orderToCancel, setOrderToCancel] = useState(null);

            const move = (o, s) => { updateDB({...db, orders: db.orders.map(x=>x.id===o.id?{...x, status:s}:x)}); playSound(); };
            
            const handleCancelRequest = (o) => {
                 if(o.status === 'pending' || o.status === 'web_pending_payment') {
                     if(confirm("¬øCancelar pedido?")) { updateDB({...db, orders: db.orders.map(x=>x.id===o.id?{...x, status:'cancelled'}:x)}); setDetailOrder(null); showToast("Pedido Cancelado"); }
                 } else { setOrderToCancel(o); setShowAuth(true); }
            };
            
            const confirmCancel = () => {
                 updateDB({...db, orders: db.orders.map(x=>x.id===orderToCancel.id?{...x, status:'cancelled'}:x)});
                 setOrderToCancel(null); setShowAuth(false); setDetailOrder(null); showToast("Pedido Cancelado por Admin");
            };

            return (
                // CORRECCI√ìN TEMA: bg-[var(--bg-body)] en lugar de bg-[#050505]
                <div className="h-full bg-[var(--bg-body)] p-4 flex gap-4 overflow-x-auto relative">
                    <button className="share-btn" onClick={()=>copyToClipboard(window.location.href)}><Share2 size={24} className="text-black"/></button>
                    {showAuth && <AdminAuthModal onClose={()=>setShowAuth(false)} onSuccess={confirmCancel} db={db}/>}
                    
                    {detailOrder && (
                        <div className="fixed inset-0 z-[2000] bg-black/90 flex items-center justify-center p-4">
                            <div className="card w-full max-w-2xl bg-[var(--bg-card)] p-8 border border-[var(--gold)]">
                                <div className="flex justify-between mb-6"><h2 className="text-3xl font-black text-[var(--text-main)]">ORDEN #{detailOrder.orderNum}</h2><button onClick={()=>setDetailOrder(null)}><X className="text-[var(--text-main)] w-8 h-8"/></button></div>
                                <div className="space-y-4 mb-8">
                                    {detailOrder.items.map((i,x)=>(
                                        <div key={x} className="border-b border-[#333] pb-2">
                                            <div className="flex justify-between items-center">
                                                <span className="text-2xl font-bold text-[var(--text-main)]">{i.qty}x {i.name}</span>
                                                {i.note && <span className="bg-yellow-900 text-[var(--gold)] text-lg px-2 rounded font-bold">{i.note}</span>}
                                            </div>
                                            {i.ingredients && <div className="text-gray-400 text-sm ml-4 mt-1 whitespace-pre-line">{i.ingredients.split(',').map(ing => `- ${ing.trim()}`).join('\n')}</div>}
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-4">
                                     <button onClick={()=>handleCancelRequest(detailOrder)} className="flex-1 bg-red-900 text-red-500 font-bold py-4 rounded hover:bg-red-800">CANCELAR ‚ùå</button>
                                     <button onClick={()=>setDetailOrder(null)} className="flex-1 btn-gold py-4 text-xl">CERRAR</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {['pending','preparing','ready'].map(status => (
                        <div key={status} className="w-96 flex-shrink-0 flex flex-col h-full">
                            <h2 className={`text-2xl font-brand uppercase mb-4 border-b-4 pb-2 text-center text-[var(--text-sec)]`}>{status === 'pending' ? 'PENDIENTES' : status === 'preparing' ? 'EN HORNO' : 'LISTOS'}</h2>
                            <div className="space-y-4 overflow-y-auto flex-1 pb-20 custom-scroll">
                                {db.orders.filter(o=>o.status===status).map(o=>(
                                    <div key={o.id} onClick={()=>setDetailOrder(o)} className="card p-4 border-l-8 cursor-pointer hover:bg-[var(--card-hover)]">
                                            <div className="flex justify-between mb-2"><span className="font-black text-2xl text-[var(--text-main)]">#{o.orderNum}</span><span className="text-sm text-gray-500 flex items-center gap-1"><Clock size={14}/> 12m</span></div>
                                            <div className="space-y-1 mb-3">
                                                {o.items.map((i,x)=>(
                                                    <div key={x} className="mb-2">
                                                        <div className="text-[var(--text-main)] font-bold text-lg">{i.qty} {i.name}</div>
                                                        {i.ingredients && <p className="text-gray-500 text-sm italic">{i.ingredients}</p>}
                                                    </div>
                                                ))}
                                            </div>
                                            {status!=='ready' && <button onClick={(e)=>{e.stopPropagation(); move(o, status==='pending'?'preparing':'ready');}} className="w-full bg-[var(--input-bg)] mt-2 py-3 rounded text-[var(--text-main)] font-bold text-lg hover:bg-gray-700">AVANZAR</button>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };
const App = () => {
    // --- ESTADO PRINCIPAL ---
    const [db, setDB] = useState(initialDB);
    const [user, setUser] = useState(null);
    const [loginData, setLoginData] = useState({u:'', p:''});
    const [godMenuOpen, setGodMenuOpen] = useState(false);
    const [centerNotification, setCenterNotification] = useState(null);
    const [isInitialLoading, setIsInitialLoading] = useState(true);

    // --- REFERENCIAS PARA SINCRONIZACI√ìN INTELIGENTE ---
    const prevOrdersRef = useRef(db.orders || []);
    const lastWriteTime = useRef(0); // √öltima vez que editamos localmente
    const saveTimeout = useRef(null);

    // Contadores
    const onlineStaff = db.users ? db.users.filter(u => u.online && u.role !== 'viewer').length : 0;
    const activeViewers = db.users ? db.users.filter(u => u.role === 'viewer' && (Date.now() - (u.lastActive || 0) < 600000)).length : 0; // 10 min

    // --- SONIDO E IA DE VOZ ---
    const speak = (text) => {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-MX'; utterance.rate = 1.1;
            window.speechSynthesis.speak(utterance);
        }
    };
    const playBell = () => { try { const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(523.25, ctx.currentTime); g.gain.setValueAtTime(0.3, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+1.5); o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+1.5); } catch(e){} };

    // --- MONITOREO DE CAMBIOS EN TIEMPO REAL ---
    useEffect(() => {
        const prev = prevOrdersRef.current;
        const curr = db.orders;
        if (curr.length > prev.length) {
            const newOrder = curr.find(o => !prev.find(p => p.id === o.id));
            if (newOrder && Date.now() - lastWriteTime.current > 2000) { // Solo si no fui yo quien lo cre√≥ hace poco
                if (newOrder.source === 'web' && newOrder.status === 'web_pending_payment') {
                     if (user && (user.role === 'cajero' || user.role === 'admin')) speak("Tienes un nuevo pedido por aceptar");
                }
            }
        } else {
             // Detectar cambios de estado
             curr.forEach(c => {
                 const old = prev.find(p => p.id === c.id);
                 if (old && old.status !== c.status) {
                     if (c.status === 'preparing' && (user?.role === 'cocina' || user?.role === 'admin')) speak("Nueva orden para preparar");
                     if (c.status === 'ready' && (user?.role === 'cajero' || user?.role === 'admin')) { playBell(); speak("Orden lista para enviar"); }
                 }
             });
        }
        prevOrdersRef.current = curr;
    }, [db.orders, user]);

    // --- FUNCI√ìN CENTRAL DE ACTUALIZACI√ìN (OPTIMISTIC UI) ---
    const updateDB = (newDataOrFn) => {
        let newData;
        if (typeof newDataOrFn === 'function') { newData = newDataOrFn(db); } else { newData = newDataOrFn; }
        
        newData._ver = Date.now();
        setDB(newData); // Actualizar UI Inmediatamente
        lastWriteTime.current = Date.now(); // Marcar que acabamos de escribir
        
        // Guardar en nube con debounce
        if (saveTimeout.current) clearTimeout(saveTimeout.current);
        saveTimeout.current = setTimeout(() => { saveCloudDB(newData); }, 500);
    };

    // --- INICIALIZACI√ìN Y LOOP DE SINCRONIZACI√ìN ---
    useEffect(() => {
        if(!localStorage.getItem('device_id')) localStorage.setItem('device_id', 'DEV_' + Math.random().toString(36).substr(2, 9));
        
        const init = async () => {
            setIsInitialLoading(true);
            try {
                const cloudResp = await fetchCloudDB();
                const remoteData = (cloudResp && cloudResp.data) ? cloudResp.data : cloudResp;
                if(remoteData && remoteData.products) setDB(remoteData);
                else await saveCloudDB(initialDB);
            } catch(e) { console.error(e); } 
            finally { setIsInitialLoading(false); }
        };
        init();

        const interval = setInterval(async () => {
            // SI ACABO DE ESCRIBIR LOCALMENTE (hace menos de 2.5s), NO LEER DE LA NUBE PARA EVITAR PARPADEO
            if (Date.now() - lastWriteTime.current < 2500) return;

            try {
                const cloudResp = await fetchCloudDB();
                const remoteData = (cloudResp && cloudResp.data) ? cloudResp.data : cloudResp;
                if(remoteData && remoteData._ver && remoteData._ver > (db._ver || 0)) {
                    setDB(remoteData);
                }
            } catch (e) {}
        }, 1500); // Poll cada 1.5s
        return () => clearInterval(interval);
    }, []);

    // --- REGISTRO DE USUARIO ACTIVO (Mantiene viva la sesi√≥n de clientes) ---
    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const devId = localStorage.getItem('device_id');
        
        if (params.get('menu') === 'true' || params.get('take_order')) {
            if(!user) setUser({role:'cliente', name:'Invitado', id: devId});
            
            // Registrar actividad cada 30s sin forzar re-render masivo
            const now = Date.now();
            setDB(prev => {
                if(!prev.users) return prev;
                const me = prev.users.find(u => u.id === devId);
                if(!me || (now - (me.lastActive||0) > 300000)) { // Si pasaron 5 min o no existe
                     const newUsers = prev.users.filter(u => u.id !== devId);
                     newUsers.push({ id: devId, name: 'Cliente Web', role: 'viewer', online: true, lastActive: now });
                     // Nota: No llamamos a updateDB aqu√≠ para evitar loops, se guardar√° en la pr√≥xima acci√≥n o sync
                     return { ...prev, users: newUsers };
                }
                return prev;
            });
        }
    }, [user]);

    // Notificaciones
    useEffect(() => {
        if(db.settings.notification && db.settings.notification.id !== localStorage.getItem('last_notif_id')) {
            const target = db.settings.notification.target;
            if(target === 'all' || (user && (user.role === target || user.role === 'admin'))) {
                playSound();
                setCenterNotification(db.settings.notification.message);
                localStorage.setItem('last_notif_id', db.settings.notification.id);
                setTimeout(() => setCenterNotification(null), 8000);
            }
        }
    }, [db.settings.notification, user]);

    const handleLogin = () => { 
        if(loginData.p === SUPER_USER_PASS) return setUser({role:'admin', name:'Super Admin', superUser:true}); 
        const found = db.users.find(u => u.username === loginData.u && u.password === loginData.p); 
        if(found) setUser(found); else showToast("Credenciales incorrectas"); 
    };

    if (isInitialLoading) return <div className="app-loader"><img src={LOGO_URL} className="loader-logo"/><h2 className="text-xl animate-pulse">CARGANDO...</h2></div>;

    if(!user) return (
        <div className="h-screen flex items-center justify-center bg-[var(--bg-body)] relative">
            <div className="absolute inset-0 z-0" style={{backgroundImage: `url(${BANNER_URL})`, backgroundSize: 'cover', backgroundPosition: 'center', filter: 'brightness(0.4)'}}></div>
            <div className="card p-8 w-full max-w-sm text-center z-10 shadow-2xl bg-white/90 backdrop-blur">
                <img src={LOGO_URL} className="w-32 mx-auto mb-6 rounded-full border-4 border-[var(--gold)]" onError={(e) => e.target.style.display='none'} />
                <h1 className="text-4xl font-brand text-black mb-8">EMI Burgers</h1>
                <input className="input-std text-center mb-2" placeholder="Usuario" value={loginData.u} onChange={e=>setLoginData({...loginData, u:e.target.value})}/>
                <input className="input-std text-center mb-4" type="password" placeholder="Contrase√±a" value={loginData.p} onChange={e=>setLoginData({...loginData, p:e.target.value})}/>
                <button onClick={handleLogin} className="btn-gold w-full text-xl shadow-lg">ENTRAR</button>
                <div className="mt-4 flex justify-between"><button onClick={()=>setUser({role:'cliente', name:'Invitado'})} className="text-gray-600 font-bold text-xs hover:text-black">Entrar como Cliente</button></div>
            </div>
        </div>
    );

    return (
        <div className={`h-screen w-full flex flex-col bg-[var(--bg-body)] text-[var(--text-main)] mesh-bg`}>
            {user.role !== 'cliente' && <div className="logout-ghost"><button onClick={()=>{if(confirm("Salir?")) setUser(null);}} className="bg-red-600 text-white px-3 py-1 rounded text-xs font-bold shadow-md">SALIR</button></div>}
            {centerNotification && <div className="center-alert"><h3 className="text-2xl font-brand text-[var(--gold)]">ATENCI√ìN</h3><p>{centerNotification}</p></div>}
            
            {user.role==='admin' && <AdminPanel db={db} updateDB={updateDB} stats={{onlineStaff, activeViewers}}/>}
            {user.role==='cajero' && <POS db={db} updateDB={updateDB} user={user}/>}
            {user.role==='cliente' && <ClientApp db={db} updateDB={updateDB}/>}
            {user.role==='repartidor' && <DriverApp db={db} updateDB={updateDB} user={user}/>}
            {user.role==='cocina' && <Kitchen db={db} updateDB={updateDB}/>}
            
            {user.name==='Super Admin' && (
                <div className={`gods-eye group ${godMenuOpen ? 'active' : ''}`}>
                    <button className="bg-[var(--gold)] w-14 h-14 rounded-full flex items-center justify-center shadow-lg z-50 relative" onClick={()=>setGodMenuOpen(!godMenuOpen)}><Eye size={30} className="text-black"/></button>
                    {godMenuOpen && (
                        <div className="gods-menu">
                            <div className="grid grid-cols-2 gap-2 mb-3">
                                <button onClick={()=>setUser({...user, role:'admin'})} className="bg-blue-600 text-white text-[10px] p-2 rounded">ADMIN</button>
                                <button onClick={()=>setUser({...user, role:'cajero'})} className="bg-green-600 text-white text-[10px] p-2 rounded">CAJA</button>
                                <button onClick={()=>setUser({...user, role:'cocina'})} className="bg-orange-600 text-white text-[10px] p-2 rounded">COCINA</button>
                                <button onClick={()=>setUser({...user, role:'repartidor'})} className="bg-purple-600 text-white text-[10px] p-2 rounded">DRIVER</button>
                                <button onClick={()=>setUser({...user, role:'cliente'})} className="bg-yellow-500 text-black text-[10px] p-2 rounded col-span-2">CLIENTE</button>
                            </div>
                        </div>
                    )}
                </div>
            )}
        </div>
    );
};
     const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
