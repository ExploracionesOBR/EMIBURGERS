<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMI BURGERS - Sistema Integral</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Bangers&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-font-smoothing: antialiased; user-select: none; }
        
        .menu-mode {
            background-color: #121212;
            font-family: 'Roboto', sans-serif;
            color: #ffffff;
            background-image: linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.9)), url('https://www.transparenttextures.com/patterns/brick-wall-dark.png');
            min-height: 100vh;
        }
        .font-bangers { font-family: 'Bangers', cursive; }
        .font-fredoka { font-family: 'Fredoka One', cursive; }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; color: black; }
            #ticket-modal, #payroll-modal, #withdrawal-modal, #driver-settle-modal, #corte-modal { 
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; 
                display: flex; align-items: flex-start; justify-content: center; padding-top: 0px; 
            }
            @page { margin: 0; }
        }
        
        .floating-btn { animation: bounce-slow 3s infinite; }
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .bill-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen w-screen overflow-hidden" id="body-container">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, onSnapshot, updateDoc, doc, orderBy, serverTimestamp, getDocs, deleteDoc, increment, writeBatch, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { 
            Utensils, Truck, LayoutDashboard, LogOut, Plus, Minus, Search, MapPin, Printer, CreditCard, DollarSign, 
            Smartphone, User, QrCode, Clock, CheckCircle, AlertTriangle, FileText, Settings, Menu as MenuIcon, X, 
            Save, Trash2, ShoppingBag, Camera, Users, BarChart3, RefreshCw, Bell, Ticket, TrendingUp, Wifi, WifiOff,
            Bluetooth, Image as ImageIcon, Map, Lock, ShieldAlert, Loader2, Calculator, Package, AlertOctagon, RotateCcw, 
            Calendar, Upload, MessageCircle, Eye, EyeOff, ClipboardList, Briefcase, Monitor, Navigation, Wallet, Speaker, Keyboard, List
        } from 'https://esm.sh/lucide-react@0.344.0';

        const React = window.React;
        const useState = React.useState;
        const useEffect = React.useEffect;
        const useRef = React.useRef;

        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = JSON.parse(__firebase_config); 
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const BUSINESS_INFO = {
            name: "EMI BURGERS",
            address: "Calle Gaviotas 408, Fracc. Las Palmas",
            phone: "6311551533",
            rfc: "VIFR950226GW6",
            baseUrl: window.location.href.split('?')[0] 
        };

        const formatCurrency = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount || 0);
        const formatDate = (date) => {
            if (!date) return '';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleString('es-MX');
        };
        const getDaysDiff = (date) => {
            if(!date) return 999;
            const d = date.toDate ? date.toDate() : new Date(date);
            const today = new Date();
            const diffTime = d - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        };
        
        const openWhatsApp = (phone, message) => {
            if (!phone) return;
            const url = `https://wa.me/${phone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        };
        const speak = (text) => { if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(text); u.lang = 'es-MX'; window.speechSynthesis.speak(u); } };

        const INITIAL_ADMIN_USER = "OBR1995@";
        const INITIAL_ADMIN_PASS = "OBR1995@";

        // --- COMPONENTES UI ---
        const NavBtn = ({ id, icon, label, active, set }) => (
            <button onClick={()=>set(id)} className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold whitespace-nowrap transition ${active===id ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-100'}`}>{icon} {label}</button>
        );

        // --- ROOT ---
        function App() {
            const [mode, setMode] = useState('system'); 
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    } catch (e) { console.error("Error Auth:", e); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => { if (u) { setUser(u); setAuthLoading(false); } });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const modeParam = params.get('mode');
                if (modeParam === 'menu') {
                    setMode('menu');
                    document.getElementById('body-container').className = 'menu-mode overflow-y-auto';
                } else if (modeParam === 'tracking') {
                    setMode('tracking');
                }
            }, []);

            if (authLoading) return <div className="h-screen w-full flex flex-col items-center justify-center bg-slate-900 text-white gap-4"><Loader2 className="animate-spin h-10 w-10 text-orange-500" /><span>Conectando con EMI BURGERS...</span></div>;

            if (mode === 'menu') return <CustomerMenuApp db={db} appId={appId} user={user} />;
            return <SystemApp db={db} appId={appId} currentUser={user} />;
        }

        // --- SISTEMA PRINCIPAL ---
        function SystemApp({ db, appId, currentUser }) {
            const [userData, setUserData] = useState(null);
            const [settings, setSettings] = useState({ 
                bannerMessage: '', maxCashLimit: 1000, withdrawalAmount: 500, kmPrice: 10, platforms: [], categories: [], providers: [], supervisorKey: 'ADMIN-KEY',
                salaries: { cajero: {weekly:0, bono:0, comp:0, entryTime:'08:00'}, cocina: {weekly:0, bono:0, comp:0, entryTime:'08:00'}, repartidor: {weekly:0, bono:0, comp:0, entryTime:'08:00'} }
            });
            const [loading, setLoading] = useState(true);
            const [simulatedRole, setSimulatedRole] = useState(null);

            useEffect(() => { if (currentUser) loadUserProfile(currentUser.uid); }, [currentUser]);
            useEffect(() => {
                if (!currentUser) return;
                onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'settings')), s => !s.empty && setSettings(prev => ({...prev, ...s.docs[0].data()})));
            }, [currentUser]);

            const loadUserProfile = async (uid) => {
                const snap = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('uid', '==', uid)));
                if (!snap.empty) setUserData({ id: snap.docs[0].id, ...snap.docs[0].data() });
                setLoading(false);
            };

            const handleLogout = async () => { 
                if (userData && !simulatedRole) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), { userId: userData.id, userName: userData.name, type: 'salida', timestamp: serverTimestamp() });
                setUserData(null); setSimulatedRole(null); signOut(auth); 
            };

            const activeRole = simulatedRole || userData?.role;
            
            // --- VIEW SWITCHER ---
            const renderViewSwitcher = () => {
                if (userData?.role !== 'admin') return null;
                return (
                    <div className="fixed bottom-4 left-4 z-50 flex flex-col gap-2 no-print group">
                        <button className="bg-slate-900 text-white p-3 rounded-full shadow-2xl floating-btn border-2 border-orange-500"><Monitor size={24}/></button>
                        <div className="absolute bottom-14 left-0 bg-white rounded shadow-xl p-2 w-40 hidden group-hover:block">
                            <button onClick={()=>setSimulatedRole(null)} className="w-full text-left text-xs p-2 hover:bg-gray-100">Admin</button>
                            <button onClick={()=>setSimulatedRole('cajero')} className="w-full text-left text-xs p-2 hover:bg-gray-100">Caja</button>
                            <button onClick={()=>setSimulatedRole('cocina')} className="w-full text-left text-xs p-2 hover:bg-gray-100">Cocina</button>
                            <button onClick={()=>setSimulatedRole('repartidor')} className="w-full text-left text-xs p-2 hover:bg-gray-100">Repartidor</button>
                            <button onClick={()=>window.open('?mode=menu','_blank')} className="w-full text-left text-xs p-2 hover:bg-gray-100 text-blue-600">App Cliente</button>
                        </div>
                    </div>
                );
            };

            if (loading) return <div className="flex h-screen items-center justify-center bg-slate-900 text-white">Cargando Perfil...</div>;

            return (
                <div className="flex h-screen w-full flex-col overflow-hidden bg-slate-100 font-sans text-slate-800">
                    {userData && <header className="flex h-16 items-center justify-between bg-slate-900 px-4 text-white shadow-md z-20 no-print"><div className="flex items-center gap-3"><img src="LOGO_1.png" className="h-10 w-10 bg-white rounded-full p-1" onError={(e)=>e.target.style.display='none'}/><div><h1 className="text-lg font-bold">EMI BURGERS</h1></div></div><div className="flex items-center gap-3"><div className="text-right leading-3 hidden sm:block"><p className="text-xs font-bold text-orange-400">{userData.name}</p><p className="text-[10px] text-slate-400">{activeRole?.toUpperCase()}</p></div><button onClick={handleLogout} className="bg-red-600 p-2 rounded-full"><LogOut size={16}/></button></div></header>}
                    <main className="flex-1 overflow-hidden relative">
                        {!userData ? <LoginScreen onLogin={(r,d)=>setUserData({...d, role:r})} db={db} appId={appId}/> : (
                            <>
                                {activeRole === 'admin' && <AdminPanel settings={settings} db={db} appId={appId} />}
                                {activeRole === 'cajero' && <POSSystem userData={userData} settings={settings} db={db} appId={appId} />}
                                {activeRole === 'repartidor' && <DeliveryApp userData={userData} db={db} appId={appId} />}
                                {activeRole === 'cocina' && <KitchenDisplay db={db} appId={appId}/>}
                                {renderViewSwitcher()}
                            </>
                        )}
                    </main>
                </div>
            );
        }

        // --- LOGIN ---
        function LoginScreen({ onLogin, db, appId }) {
            const [u, setU] = useState(''); const [p, setP] = useState(''); const [f, setF] = useState(''); const [step, setStep] = useState(1); const [tmp, setTmp] = useState(null);
            const doLogin = async (e) => { e.preventDefault(); if(u===INITIAL_ADMIN_USER && p===INITIAL_ADMIN_PASS) return onLogin('admin', {name:'Super Admin', uid:'admin', role:'admin', id:'admin'}); const snap = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('username','==',u), where('password','==',p))); if(!snap.empty) { const ud = snap.docs[0].data(); const userId = snap.docs[0].id; await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), { userId: userId, userName: ud.name, type: 'entrada', timestamp: serverTimestamp() }); if(ud.role==='cajero') { setTmp({...ud, id:userId}); setStep(2); } else { onLogin(ud.role, {...ud, id:userId}); } } else alert('Error Credenciales'); };
            return (
                <div className="flex h-full items-center justify-center bg-slate-800 p-4 relative" style={{backgroundImage: "url('https://www.transparenttextures.com/patterns/brick-wall-dark.png')"}}>
                    <div className="w-full max-w-sm bg-[#1a1a1a] p-8 rounded-2xl shadow-2xl border-2 border-[#FF5722] text-center relative z-10">
                        <div className="mb-6 mx-auto w-32 h-32 bg-[#1a1a1a] rounded-full flex items-center justify-center shadow-[0_0_30px_rgba(255,87,34,0.4)] border-2 border-[#FF5722] relative overflow-hidden"><div className="absolute inset-0 bg-orange-500 blur-md opacity-20 animate-pulse"></div><img src="LOGO_1.png" className="relative w-full h-full object-contain drop-shadow" onError={(e)=>{e.target.style.display='none'; e.target.parentNode.innerHTML='üçî'}}/></div>
                        <h2 className="text-3xl font-black mb-6 text-slate-800 font-bangers tracking-wider" style={{textShadow: '2px 2px 0px #000'}}>EMI BURGERS</h2>
                        {step===1 ? (<form onSubmit={doLogin} className="space-y-4"><input className="w-full bg-[#222] border-2 border-[#444] p-3 rounded-lg text-center text-white font-bold placeholder-gray-500 focus:border-[#FFC107] outline-none" placeholder="USUARIO" value={u} onChange={e=>setU(e.target.value)} /><input className="w-full bg-[#222] border-2 border-[#444] p-3 rounded-lg text-center text-white font-bold placeholder-gray-500 focus:border-[#FFC107] outline-none" type="password" placeholder="CONTRASE√ëA" value={p} onChange={e=>setP(e.target.value)} /><button className="w-full bg-[#FF5722] text-white py-3 rounded-lg font-bold hover:bg-[#F4511E] transition shadow-[0_4px_0_#D84315] active:translate-y-1 active:shadow-none uppercase tracking-wider">INICIAR SESI√ìN</button></form>) : (<div className="space-y-4 animate-in fade-in"><p className="text-sm text-gray-400 font-bold uppercase tracking-widest">Fondo Inicial de Caja</p><input className="w-full bg-[#222] border-2 border-green-600 text-green-400 p-4 rounded-lg text-center text-3xl font-bold outline-none" type="number" placeholder="$0.00" value={f} onChange={e=>setF(e.target.value)} autoFocus/><button onClick={()=>onLogin('cajero', {...tmp, currentFund:parseFloat(f), sessionStart:new Date()})} className="w-full bg-green-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-green-700 transition shadow-[0_4px_0_#1b5e20] active:translate-y-1 active:shadow-none uppercase">ABRIR TURNO</button></div>)}
                    </div>
                </div>
            );
        }

        // --- POS SYSTEM (CAJERO) ---
        function POSSystem({ userData, settings, db, appId }) {
            const [products, setProducts] = useState([]);
            const [activeCat, setActiveCat] = useState('Todas');
            const [cart, setCart] = useState([]);
            const [cashInDrawer, setCashInDrawer] = useState(userData.currentFund || 0);
            const [view, setView] = useState('pos'); 
            const [orders, setOrders] = useState([]);
            const [showCheckout, setShowCheckout] = useState(false);
            const [showTicket, setShowTicket] = useState(null);
            const [showDetail, setShowDetail] = useState(null);
            const [showArqueo, setShowArqueo] = useState(false);
            const [showClose, setShowClose] = useState(false);
            const [showRepartidores, setShowRepartidores] = useState(false);
            const [showRetiro, setShowRetiro] = useState(false);
            const [showInv, setShowInv] = useState(false);
            const [showExpense, setShowExpense] = useState(false);
            const [withdrawalAlert, setWithdrawalAlert] = useState(0);
            const [withdrawalData, setWithdrawalData] = useState(null);
            const [expenseData, setExpenseData] = useState({amount:'', reason:'', provider:''});

            // Query order for client-side sorting (avoids failed-precondition)
            useEffect(() => {
                const unsubP = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), s => setProducts(s.docs.map(d=>({id:d.id, ...d.data()}))));
                const unsubO = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), where('status', '!=', 'completed')), s => {
                    const loaded = s.docs.map(d=>({id:d.id, ...d.data()}));
                    // Sort in memory
                    loaded.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setOrders(loaded);
                });
                return () => { unsubP(); unsubO(); };
            }, []);

            useEffect(() => {
                if (cashInDrawer >= settings.maxCashLimit) {
                    if (withdrawalAlert < 3) {
                         alert("‚ö†Ô∏è L√çMITE DE CAJA ALCANZADO. REALIZA UN RETIRO.");
                         setWithdrawalAlert(prev => prev + 1);
                    }
                } else setWithdrawalAlert(0);
            }, [cashInDrawer, settings.maxCashLimit]);

            const addToCart = (p) => setCart([...cart, p]);
            const handleCheckout = async (data) => {
                const ref = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), { ...data, createdAt: serverTimestamp(), createdBy: userData.uid, cashierName: userData.name, orderNumber: Math.floor(Math.random()*10000).toString() });
                if(data.method==='efectivo') setCashInDrawer(prev => prev + data.total);
                setCart([]); setShowCheckout(false); setShowTicket({id: ref.id, ...data, orderNumber: Math.floor(Math.random()*10000).toString()});
            };

            const forceWithdrawal = async () => {
                const amt = settings.withdrawalAmount || 500;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), { amount: amt, reason: 'RETIRO SISTEMA', provider: 'CAJA', user: userData.name, date: serverTimestamp() });
                setCashInDrawer(prev => prev - amt);
                setWithdrawalData({amount: amt, user: userData.name, date: new Date().toLocaleString()});
                setWithdrawalAlert(0);
            };
            const handleRetiro = async (amount) => {
                 if(!amount) return;
                 const am = parseFloat(amount);
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), { amount: am, reason: 'RETIRO MANUAL', provider: 'CAJA', user: userData.name, date: serverTimestamp() });
                 setCashInDrawer(prev => prev - am);
                 setWithdrawalData({amount: am, user: userData.name, date: new Date().toLocaleString()});
                 setShowRetiro(false);
            };
            const registerExpense = async () => { if(!expenseData.amount || !expenseData.reason) return; await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), { amount: parseFloat(expenseData.amount), reason: expenseData.reason, provider: expenseData.provider, user: userData.name, date: serverTimestamp() }); setCashInDrawer(prev => prev - parseFloat(expenseData.amount)); setShowExpense(false); setExpenseData({amount:'', reason:'', provider:''}); alert('Gasto Registrado'); };
            
            const requestAuth = (cb) => { const k=prompt("ESC√ÅNER QR ADMIN:"); if(k === settings.supervisorKey) cb(); else alert("Acceso Denegado"); };
            const webOrdersCount = orders.filter(o => o.status === 'web_pending').length;

            return (
                <div className="flex h-full relative">
                    {withdrawalAlert >= 3 && (
                        <div className="absolute inset-0 bg-red-900/95 z-50 flex flex-col items-center justify-center text-white">
                            <ShieldAlert size={80} className="animate-bounce"/>
                            <h2 className="text-3xl font-black mt-4">¬°CAJA BLOQUEADA!</h2>
                            <p className="mb-6">Excediste el l√≠mite de efectivo. Retiro obligatorio.</p>
                            <button onClick={forceWithdrawal} className="bg-white text-red-900 px-8 py-4 rounded-xl font-bold text-xl shadow-xl">RETIRAR {formatCurrency(settings.withdrawalAmount||500)}</button>
                        </div>
                    )}
                    <div className="flex-1 flex flex-col bg-slate-100">
                        <div className="flex bg-white border-b"><button onClick={()=>setView('pos')} className={`flex-1 py-3 font-bold ${view==='pos'?'bg-orange-100 text-orange-600 border-b-2 border-orange-600':''}`}>PUNTO DE VENTA</button><button onClick={()=>setView('web')} className={`flex-1 py-3 font-bold ${view==='web'?'bg-blue-100 text-blue-600 border-b-2 border-blue-600':''}`}>WEB ({webOrdersCount})</button><button onClick={()=>setView('orders')} className={`flex-1 py-3 font-bold ${view==='orders'?'bg-slate-100 text-slate-600':''}`}>TODAS ({orders.length})</button></div>
                        {view === 'pos' && (
                            <div className="flex-1 overflow-y-auto p-4">
                                <div className="flex gap-2 overflow-x-auto mb-4"><button onClick={()=>setActiveCat('Todas')} className="px-4 py-1 bg-slate-800 text-white rounded-full text-sm">TODAS</button>{settings.categories?.map(c=><button key={c} onClick={()=>setActiveCat(c)} className="px-4 py-1 bg-slate-200 rounded-full text-sm">{c}</button>)}</div>
                                <div className="grid grid-cols-3 lg:grid-cols-4 gap-4">{products.filter(p=>activeCat==='Todas'||p.category===activeCat).map(p=><button key={p.id} onClick={()=>setCart([...cart, p])} onContextMenu={(e)=>{e.preventDefault(); setShowDetail(p)}} className="bg-white rounded shadow p-2 flex flex-col h-32 hover:ring-2 ring-orange-500 relative"><div className="flex-1 bg-slate-100 rounded mb-2 overflow-hidden relative">{p.image ? <img src={p.image} className="w-full h-full object-cover"/> : <ImageIcon className="absolute inset-0 m-auto text-slate-300"/>}</div><span className="font-bold text-xs truncate w-full text-left">{p.name}</span><span className="text-xs text-orange-600 font-bold">{formatCurrency(p.price)}</span></button>)}</div>
                            </div>
                        )}

                        {view === 'web' && (
                            <div className="flex-1 p-4 space-y-3 overflow-y-auto">
                                {orders.filter(o=>o.status==='web_pending').map(o=>(
                                    <div key={o.id} className="bg-white border-l-4 border-red-500 rounded p-4 shadow animate-pulse">
                                        <div className="flex justify-between mb-2">
                                            <span className="font-bold bg-red-100 text-red-800 px-2 rounded">NUEVO WEB</span>
                                            <span className="font-bold">{formatCurrency(o.total)}</span>
                                        </div>
                                        <p className="font-bold text-lg">{o.details.name}</p>
                                        <p className="text-sm">{o.items.map(i=>i.name).join(', ')}</p>
                                        <button onClick={async()=>{await updateDoc(doc(db,'artifacts',appId,'public','data','orders',o.id),{status:'pending'}); openWhatsApp(o.details.phone,`Hola ${o.details.name}, tu pedido #${o.orderNumber} ha sido aceptado.`);}} className="w-full bg-green-600 text-white py-3 rounded font-bold mt-2">ACEPTAR Y NOTIFICAR</button>
                                    </div>
                                ))}
                                {webOrdersCount === 0 && <div className="text-center text-slate-400 mt-10">No hay pedidos web nuevos.</div>}
                            </div>
                        )}

                        {view === 'orders' && (
                             <div className="flex-1 p-4 space-y-3 overflow-y-auto">
                                 {orders.map(o=><div key={o.id} className={`bg-white border-l-4 rounded p-3 shadow flex justify-between items-center ${o.status==='ready'?'border-green-500':'border-blue-500'}`}><div><span className="font-bold">#{o.orderNumber}</span> {o.details.name}<br/><span className="text-xs text-slate-400">{o.status.toUpperCase()}</span></div><button onClick={()=>setShowTicket(o)} className="text-blue-500 underline text-xs">Ticket</button></div>)}
                             </div>
                        )}
                        <div className="p-2 border-t bg-white flex justify-between px-4 items-center"><span className="text-xs text-slate-400">CAJA ID: {userData.id.slice(0,5)}</span><div className="flex gap-2"><button onClick={()=>setShowExpense(true)} className="flex flex-col items-center text-[10px] text-red-600 hover:bg-red-50 p-1 rounded"><DollarSign size={16}/> RETIROS/GASTOS</button><button onClick={()=>requestAuth(()=>setShowArqueo(true))} className="flex flex-col items-center text-[10px] text-slate-600 hover:bg-slate-50 p-1 rounded"><Calculator size={16}/> ARQUEO</button><button onClick={()=>setShowRepartidores(true)} className="flex flex-col items-center text-[10px] text-blue-500 hover:bg-blue-50 p-1 rounded"><Truck size={16}/> LIQ. DRIVERS</button><button onClick={()=>setShowClose(true)} className="flex flex-col items-center text-[10px] text-blue-600 hover:bg-blue-50 p-1 rounded"><FileText size={16}/> CORTE</button></div></div>
                    </div>
                    <div className="w-80 bg-white border-l shadow-xl flex flex-col">
                        <div className="p-4 bg-slate-800 text-white font-bold">Orden Actual</div>
                        <div className="flex-1 overflow-y-auto p-2">{cart.map((i,x)=><div key={x} className="flex justify-between border-b py-2"><span>{i.name}</span><div className="flex gap-2"><b>{formatCurrency(i.price)}</b><button onClick={()=>{const n=[...cart];n.splice(x,1);setCart(n)}} className="text-red-500">x</button></div></div>)}</div>
                        <div className="p-4 border-t"><div className="flex justify-between text-xl font-bold mb-4"><span>Total</span><span>{formatCurrency(cart.reduce((a,b)=>a+b.price,0))}</span></div><button disabled={cart.length===0} onClick={()=>setShowCheckout(true)} className="w-full bg-green-600 text-white py-3 rounded font-bold disabled:opacity-50">COBRAR</button></div>
                    </div>
                    {showDetail && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4" onClick={()=>setShowDetail(null)}><div className="bg-white p-6 rounded-xl max-w-sm"><h3 className="font-bold text-xl mb-2">{showDetail.name}</h3><p className="text-gray-600 mb-4 font-bold uppercase text-xs">INGREDIENTES:</p><p className="text-gray-800">{showDetail.ingredients || "Sin detalles"}</p><button className="w-full bg-slate-800 text-white py-2 rounded mt-4">Cerrar</button></div></div>}
                    {showCheckout && <CheckoutModal cart={cart} total={cart.reduce((a,b)=>a+b.price,0)} onClose={()=>setShowCheckout(false)} onConfirm={handleCheckout} settings={settings} db={db} appId={appId} />}
                    {showTicket && <TicketModal order={showTicket} onClose={()=>setShowTicket(null)} />}
                    {showArqueo && <ArqueoModal settings={settings} onClose={()=>setShowArqueo(false)} />}
                    {showClose && <CloseShiftModal db={db} appId={appId} cashTotal={cashInDrawer} initialFund={userData.currentFund} onClose={()=>setShowClose(false)} />}
                    {showRepartidores && <DriverSettlementModal db={db} appId={appId} onClose={()=>setShowRepartidores(false)} />}
                    {withdrawalData && <WithdrawalTicket data={withdrawalData} onClose={()=>setWithdrawalData(null)} />}
                    {showInv && <InventoryScanModal db={db} appId={appId} onClose={()=>setShowInv(false)} />}
                    {showExpense && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"><div className="bg-white rounded-xl p-6 w-full max-w-sm"><h3 className="font-bold text-lg mb-4 text-red-600">Retiro / Gasto</h3><div className="space-y-3"><input type="number" className="w-full border p-2 rounded" placeholder="Monto $" onChange={e=>setExpenseData({...expenseData, amount:e.target.value})}/><select className="w-full border p-2 rounded" onChange={e=>setExpenseData({...expenseData, provider:e.target.value})}><option value="">-- Proveedor --</option>{settings.providers?.map(p=><option key={p} value={p}>{p}</option>)}</select><input className="w-full border p-2 rounded" placeholder="Motivo" onChange={e=>setExpenseData({...expenseData, reason:e.target.value})}/><button onClick={registerExpense} className="w-full bg-red-600 text-white py-2 rounded font-bold">Registrar</button><button onClick={()=>setShowExpense(false)} className="w-full bg-slate-200 py-2 rounded">Cancelar</button></div></div></div>)}
                    {showRetiro && <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"><div className="bg-white p-6 rounded w-64"><h3 className="font-bold text-red-600 mb-4">RETIRO DE EFECTIVO</h3><input id="retAmount" type="number" className="border p-2 w-full mb-2" placeholder="Monto"/><button onClick={()=>handleRetiro(document.getElementById('retAmount').value)} className="bg-red-600 text-white w-full py-2 rounded font-bold">RETIRAR</button><button onClick={()=>setShowRetiro(false)} className="mt-2 w-full text-slate-500">Cancelar</button></div></div>}
                </div>
            );
        }

        // --- CHECKOUT MODAL ---
        function CheckoutModal({ cart, total, onClose, onConfirm, settings, db, appId }) {
            const [type, setType] = useState('comer'); const [method, setMethod] = useState('efectivo'); const [details, setDetails] = useState({name:'', address:''});
            const [received, setReceived] = useState(''); const [folio, setFolio] = useState(''); const [authReq, setAuthReq] = useState(false); const [adminPass, setAdminPass] = useState('');
            const [manualCash, setManualCash] = useState(false);
            const change = Math.max(0, (parseFloat(received)||0) - total);
            const addBill = (val) => setReceived(val.toString()); // Reemplaza monto
            
            const isValid = () => {
                if((type==='domicilio'||type==='llevar') && !details.name) return false;
                if(method==='efectivo' && (parseFloat(received)||0) < total) return false;
                if(method==='tarjeta' && !folio) return false;
                return true;
            };
            const cancelCard = () => { if(adminPass === settings.supervisorKey || adminPass === INITIAL_ADMIN_PASS) { setAuthReq(false); setFolio(''); setMethod('efectivo'); } else alert('Clave incorrecta'); };
            
            if(authReq) return <div className="fixed inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center p-6 text-center text-white"><ShieldAlert size={64} className="text-red-500 mb-4"/><h2 className="text-2xl font-bold text-red-500 mb-4">AUTORIZACI√ìN REQUERIDA</h2><input type="password" className="bg-gray-800 border border-gray-600 rounded p-3 text-center text-xl mb-4" placeholder="Clave Admin" value={adminPass} onChange={e=>setAdminPass(e.target.value)}/><div className="flex gap-4 w-full max-w-xs"><button onClick={()=>setAuthReq(false)} className="flex-1 bg-gray-700 py-3 rounded">Volver</button><button onClick={cancelCard} className="flex-1 bg-red-600 py-3 rounded font-bold">Autorizar</button></div></div>;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
                    <div className="bg-white w-full max-w-4xl rounded-xl shadow-2xl flex overflow-hidden h-[85vh]">
                        <div className="w-1/2 bg-slate-50 p-6 border-r space-y-4 overflow-y-auto">
                            <h3 className="font-bold text-lg mb-4 text-slate-700">Detalles del Pedido</h3>
                            <div className="grid grid-cols-2 gap-2">{['comer', 'llevar', 'plataforma', 'domicilio'].map(t => (<button key={t} onClick={()=>setType(t)} className={`p-3 rounded border font-bold uppercase text-xs ${type===t ? 'bg-orange-100 border-orange-500 text-orange-700' : 'bg-white'}`}>{t}</button>))}</div>{type === 'comer' && <input className="w-full border p-2 rounded" placeholder="Mesa / Cliente" value={details.name} onChange={e=>setDetails({...details, name:e.target.value})}/>}{(type === 'llevar' || type === 'domicilio') && <div className="space-y-2"><input className="w-full border p-2 rounded" placeholder="Nombre Cliente" value={details.name} onChange={e=>setDetails({...details, name:e.target.value})}/><input className="w-full border p-2 rounded" placeholder="Tel√©fono" type="tel" value={details.phone} onChange={e=>setDetails({...details, phone:e.target.value})}/></div>}{type === 'domicilio' && <div className="space-y-2"><input className="w-full border p-2 rounded" placeholder="Direcci√≥n Completa" value={details.address} onChange={e=>setDetails({...details, address:e.target.value})}/><input className="w-full border p-2 rounded" placeholder="Referencias" value={details.references} onChange={e=>setDetails({...details, references:e.target.value})}/>{details.address && <iframe className="w-full h-32 rounded" src={`https://maps.google.com/maps?q=${encodeURIComponent(details.address)}&output=embed`}></iframe>}</div>}{type === 'plataforma' && <div className="space-y-2"><select className="w-full border p-2 rounded" onChange={e=>setDetails({...details, platform:e.target.value})}><option value="">App...</option>{settings.platforms?.map(p=><option key={p} value={p}>{p}</option>)}</select><input className="w-full border p-2 rounded" placeholder="ID Pedido" value={details.platformId} onChange={e=>setDetails({...details, platformId:e.target.value})}/></div>}</div>
                        <div className="w-1/2 p-6 flex flex-col"><h2 className="text-3xl font-bold text-center mb-6">{formatCurrency(total)}</h2>{type !== 'plataforma' && <div className="flex gap-2 mb-6"><button onClick={()=>setMethod('efectivo')} disabled={method==='tarjeta'} className={`flex-1 py-4 border rounded font-bold ${method==='efectivo'?'bg-green-100 border-green-500 text-green-700':''}`}>EFECTIVO</button><button onClick={()=>setMethod('tarjeta')} className={`flex-1 py-4 border rounded font-bold ${method==='tarjeta'?'bg-blue-100 border-blue-500 text-blue-700':''}`}>TARJETA</button></div>}{method === 'efectivo' && type !== 'plataforma' && <div className="flex-1 flex flex-col"><div className="grid grid-cols-3 gap-2 mb-4">{[20, 50, 100, 200, 500].map(val => (<button key={val} onClick={()=>addBill(val)} className="h-14 rounded border bg-slate-50 overflow-hidden relative hover:scale-105 transition bill-btn"><img src={`${val}.png`} className="w-full h-full object-cover" onError={(e)=>{e.target.style.display='none'; e.target.parentNode.innerText=`$${val}`}}/></button>))}<button onClick={()=>setManualCash(true)} className="bg-slate-200 rounded font-bold text-xs">OTRA</button></div>{manualCash && <input type="number" className="w-full border p-2 rounded mb-2 text-right text-xl" placeholder="Ingresa Monto" onChange={e=>setReceived(parseFloat(e.target.value)||0)} autoFocus/>}<div className="mt-auto"><div className="flex justify-between items-center text-lg font-bold mb-2"><span>RECIBIDO:</span><span className="text-xl">{formatCurrency(received||0)}</span></div><div className={`flex justify-between items-center text-2xl font-bold ${change<0?'text-red-500':'text-green-600'}`}><span>CAMBIO:</span><span>{formatCurrency(change)}</span></div></div></div>}{method === 'tarjeta' && <div className="flex-1 flex flex-col justify-center"><p className="text-sm text-center text-slate-500 mb-2">Ingresa Folio Voucher</p><input className="w-full text-center text-3xl border-2 border-blue-500 rounded p-3 mb-4 font-mono tracking-widest" placeholder="000000" autoFocus value={folio} onChange={e=>setFolio(e.target.value)}/><button onClick={()=>setAuthReq(true)} className="text-xs text-red-500 underline text-center">Cancelar / Cambiar Pago</button></div>}<div className="flex gap-3 mt-6 pt-4 border-t"><button onClick={onClose} disabled={method==='tarjeta'} className="flex-1 bg-slate-200 py-3 rounded font-bold text-slate-600 disabled:opacity-50">CANCELAR</button><button onClick={()=>onConfirm({items:cart, total, method, type, details, status:'pending'})} disabled={!isValid()} className="flex-1 bg-slate-900 text-white py-3 rounded font-bold hover:bg-slate-800 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">CONFIRMAR</button></div></div>
                    </div>
                </div>
            );
        }

        function TicketModal({ order, onClose }) {
            useEffect(() => { setTimeout(() => window.print(), 500); }, []);
            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-[60]" id="ticket-modal">
                    <div className="bg-white w-80 p-6 rounded shadow-2xl text-center relative">
                        <button onClick={onClose} className="absolute top-2 right-2 text-gray-400 hover:text-black no-print"><X/></button>
                        <div className="print-only"><div className="flex justify-center mb-2"><img src="LOGO_1.png" className="h-16 object-contain" onError={(e)=>e.target.style.display='none'}/></div><h2 className="font-bold text-xl">{BUSINESS_INFO.name}</h2><p className="text-xs mb-4">{BUSINESS_INFO.address}<br/>Tel: {BUSINESS_INFO.phone}</p><p className="font-bold text-lg border-y py-2 my-2">ORDEN #{order.orderNumber}</p><div className="text-left text-sm mb-4">{order.items.map((i,x)=><div key={x} className="flex justify-between"><span>{i.qty}x {i.name}</span><span>{formatCurrency(i.price * i.qty)}</span></div>)}</div><p className="font-bold text-xl mb-6">{order.type === 'plataforma' ? 'TOTAL: $0.00 (APP)' : `TOTAL: ${formatCurrency(order.total)}`}</p>{order.type === 'domicilio' && <div className="text-left border-t pt-2 mb-4"><p className="font-bold text-xs">ENTREGA:</p><p className="text-xs">{order.details.address}</p><p className="text-xs font-bold">{order.details.phone}</p></div>}<div className="border-2 border-dashed border-black p-2 mb-2 inline-block"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${order.id}`} className="mx-auto w-32 h-32"/><p className="text-[10px] font-bold mt-1">SCAN REPARTIDOR</p></div></div>
                        <button onClick={()=>window.print()} className="w-full bg-slate-900 text-white py-2 rounded mt-4 font-bold no-print flex items-center justify-center gap-2"><Printer size={16}/> REIMPRIMIR</button>
                    </div>
                </div>
            );
        }

        // --- KITCHEN ---
        function KitchenDisplay({db, appId}) {
            const [pending, setPending] = useState([]);
            const [preparing, setPreparing] = useState([]);
            const [showDetail, setShowDetail] = useState(null);

            useEffect(() => {
                const unsub1 = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), where('status', '==', 'pending')), s => setPending(s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>(a.createdAt?.seconds||0)-(b.createdAt?.seconds||0))));
                const unsub2 = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), where('status', '==', 'preparing')), s => setPreparing(s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>(a.createdAt?.seconds||0)-(b.createdAt?.seconds||0))));
                return () => { unsub1(); unsub2(); };
            }, []);

            const moveToPrep = async (o) => await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', o.id), { status: 'preparing' });
            const markReady = async (o) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', o.id), { status: 'ready' }); if(o.type==='domicilio' || o.type==='plataforma') openWhatsApp(o.details.phone, `‚úÖ Tu pedido #${o.orderNumber} est√° LISTO.`); setShowDetail(null); };

            return (
                <div className="h-full bg-slate-800 p-4 grid grid-cols-2 gap-4 overflow-hidden">
                    <div className="flex flex-col gap-3 overflow-y-auto pr-2 border-r border-slate-600">
                        <h3 className="text-white font-bold sticky top-0 bg-slate-800 py-2">PENDIENTES ({pending.length})</h3>
                        {pending.map(o => (<div key={o.id} onClick={()=>moveToPrep(o)} className="bg-white p-3 rounded cursor-pointer hover:bg-yellow-50 transition shadow"><div className="flex justify-between"><span className="font-bold">#{o.orderNumber}</span><span className="text-xs text-gray-500"><TimeAgo timestamp={o.createdAt}/></span></div><p className="text-sm text-slate-600 mt-1">{o.items.length} items</p></div>))}
                    </div>
                    <div className="flex flex-col gap-3 overflow-y-auto pl-2">
                        <h3 className="text-yellow-400 font-bold sticky top-0 bg-slate-800 py-2">EN PREPARACI√ìN ({preparing.length})</h3>
                        {preparing.map(o => (<div key={o.id} onClick={()=>setShowDetail(o)} className="bg-yellow-100 p-3 rounded cursor-pointer border-l-4 border-yellow-500 hover:bg-yellow-200 transition shadow"><span className="font-bold block">#{o.orderNumber} - {o.details.name || 'Mostrador'}</span><div className="text-sm mt-1">{o.items.map((i,x)=> <div key={x}>{i.qty} {i.name}</div>)}</div></div>))}
                    </div>
                    {showDetail && <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4"><div className="bg-white w-full max-w-lg rounded-xl p-6"><h2 className="text-2xl font-bold mb-4">Orden #{showDetail.orderNumber}</h2><div className="space-y-2 mb-6 max-h-60 overflow-y-auto">{showDetail.items.map((i,x)=><div key={x} className="flex justify-between border-b pb-2"><span className="font-bold">{i.qty}x {i.name}</span><span>{i.ingredients}</span></div>)}</div><button onClick={()=>markReady(showDetail)} className="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-xl mb-2">PEDIDO LISTO</button><button onClick={()=>setShowDetail(null)} className="w-full bg-slate-200 py-3 rounded font-bold">Cerrar</button></div></div>}
                </div>
            );
        }

        // --- DELIVERY APP ---
        function DeliveryApp({ userData, db, appId }) {
            const [scanning, setScanning] = useState(false);
            const [myOrders, setMyOrders] = useState([]);
            const [view, setView] = useState('map'); // map | wallet

            useEffect(() => {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), where('driverId', '==', userData.id), where('status', '==', 'delivering'));
                const unsub = onSnapshot(q, s => setMyOrders(s.docs.map(d=>({id:d.id, ...d.data()}))));
                return () => unsub();
            }, [userData.id]);

            const startScan = () => { setScanning(true); setTimeout(() => { const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }); scanner.render((txt) => { scanner.clear(); setScanning(false); takeOrder(txt); }, (err) => {}); }, 100); };
            const takeOrder = async (id) => {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'orders', id);
                const snap = await getDoc(ref);
                if(snap.exists() && snap.data().status === 'ready') { await updateDoc(ref, { status: 'delivering', driverId: userData.id }); alert("Pedido Asignado"); } else alert("Pedido inv√°lido");
            };
            const complete = async (o) => { if(!confirm("Confirmar Entrega?")) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', o.id), { status: 'completed' }); if(o.method === 'efectivo') await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userData.id), { cashOnHand: increment(o.total) }); openWhatsApp(o.details.phone, "¬°Gracias por tu compra! üçî"); };

            return (
                <div className="h-full bg-slate-100 flex flex-col">
                    <div className="bg-slate-900 text-white p-4 flex justify-between items-center">
                         <h2 className="font-bold text-lg">Repartidor</h2>
                         <div className="flex gap-2"><button onClick={()=>setView('map')} className={`p-2 rounded ${view==='map'?'bg-white text-black':'text-gray-400'}`}><MapPin/></button><button onClick={()=>setView('wallet')} className={`p-2 rounded ${view==='wallet'?'bg-white text-black':'text-gray-400'}`}><Wallet/></button></div>
                    </div>
                    {view === 'map' ? (
                        <div className="flex-1 relative p-4 overflow-y-auto">
                            {!scanning ? <button onClick={startScan} className="w-full bg-[#FFC107] py-4 rounded-xl font-bold shadow-lg mb-4 flex items-center justify-center gap-2"><QrCode/> ESCANEAR</button> : <div className="fixed inset-0 bg-black z-50 p-4 flex flex-col justify-center"><div id="reader" className="bg-white rounded-lg"></div><button onClick={()=>setScanning(false)} className="mt-4 bg-red-600 text-white py-2 rounded">CANCELAR</button></div>}
                            {myOrders.map(o => (<div key={o.id} className="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500 mb-3"><div className="flex justify-between mb-2"><span className="font-bold">#{o.orderNumber}</span><span className="text-blue-600 font-bold">{formatCurrency(o.total)}</span></div><p className="font-bold text-slate-800">{o.details.address}</p><div className="flex gap-2 mt-2"><a href={`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(o.details.address)}`} target="_blank" className="flex-1 bg-blue-100 text-blue-700 py-2 rounded text-center font-bold"><MapPin className="inline"/> RUTA</a><button onClick={()=>complete(o)} className="flex-1 bg-green-600 text-white py-2 rounded font-bold">ENTREGAR</button></div></div>))}
                        </div>
                    ) : (
                        <div className="flex-1 p-6 flex flex-col items-center justify-center bg-slate-800 text-white">
                            <h2 className="text-2xl font-bold mb-2">MI BILLETERA</h2>
                            <p className="text-gray-400 mb-6">Debes entregar:</p>
                            <div className="text-5xl font-bold text-green-400 mb-8">{formatCurrency(userData.cashOnHand || 0)}</div>
                            <div className="bg-white p-4 rounded-xl"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${userData.id}`} className="w-48 h-48"/></div>
                            <p className="mt-4 text-sm text-gray-400">Muestra este QR en caja para liquidar</p>
                        </div>
                    )}
                </div>
            );
        }

        // --- MODALES CAJA (Liquidacion, Inventario, etc) ---
        function DriverSettlementModal({ db, appId, onClose }) {
            const [scanning, setScanning] = useState(true);
            const [driver, setDriver] = useState(null);
            const handleScan = async (did) => {
                setScanning(false);
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', did));
                if(snap.exists()) setDriver({id: snap.id, ...snap.data()}); else { alert("Error"); setScanning(true); }
            };
            useEffect(()=>{if(scanning) setTimeout(()=>{const s=new Html5QrcodeScanner("reader-liq",{fps:10,qrbox:250});s.render((t)=>{s.clear();handleScan(t)},()=>{});},500)},[scanning]);
            const settle = async () => {
                const b = writeBatch(db);
                b.update(doc(db, 'artifacts', appId, 'public', 'data', 'users', driver.id), { cashOnHand: 0 });
                await b.commit(); window.print(); onClose();
            };
            return <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4"><div className="bg-white w-full max-w-md rounded-xl p-6">{scanning ? <div id="reader-liq"></div> : <div className="text-center"><h2 className="text-2xl font-bold">{driver.name}</h2><p className="text-4xl font-bold text-green-600 my-4">{formatCurrency(driver.cashOnHand)}</p><button onClick={settle} className="w-full bg-green-600 text-white py-3 rounded font-bold">CONFIRMAR COBRO</button></div>}<button onClick={onClose} className="mt-4 w-full text-slate-400">Cerrar</button></div></div>;
        }
        function InventoryScanModal({ db, appId, onClose }) {
             const [step, setStep] = useState(1); const [product, setProduct] = useState(null); const [qty, setQty] = useState('');
             const handleSearch = async (term) => { const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'supplies')); const snap = await getDocs(q); const found = snap.docs.find(d => d.data().name.toLowerCase().includes(term.toLowerCase())); if(found) { setProduct({id:found.id, ...found.data()}); setStep(2); } else alert("No encontrado"); };
             const save = async () => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'supplies', product.id), { stock: parseFloat(qty) }); alert("Actualizado"); onClose(); };
             return <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4"><div className="bg-white p-6 rounded w-full max-w-sm"><h2 className="font-bold text-lg mb-4">Inventario</h2>{step===1 ? <input className="w-full border p-3 rounded" placeholder="Escanear o escribir..." onKeyDown={e=>{if(e.key==='Enter') handleSearch(e.target.value)}} autoFocus/> : <div><p>Producto: <b>{product.name}</b></p><input type="number" className="w-full border p-3 rounded my-4 text-center text-2xl" value={qty} onChange={e=>setQty(e.target.value)} autoFocus/><button onClick={save} className="w-full bg-blue-600 text-white py-2 rounded">Guardar</button></div>}<button onClick={onClose} className="mt-4 w-full text-slate-400">Cancelar</button></div></div>
        }
        function CloseShiftModal({ db, appId, cashTotal, initialFund, onClose }) {
            const [expenses, setExpenses] = useState(0); const [drivers, setDrivers] = useState([]); const [collected, setCollected] = useState(0);
            useEffect(() => {
                const today = new Date(); today.setHours(0,0,0,0);
                getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), where('date', '>=', today))).then(s => setExpenses(s.docs.reduce((a,b)=>a+b.data().amount,0)));
                onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('role','==','repartidor'), where('cashOnHand','>',0)), s => setDrivers(s.docs.map(d=>({id:d.id, ...d.data()}))));
            }, []);
            const collect = async (d) => { if(!confirm(`Cobrar ${formatCurrency(d.cashOnHand)}?`)) return; const b = writeBatch(db); b.update(doc(db, 'artifacts', appId, 'public', 'data', 'users', d.id), { cashOnHand: 0 }); setCollected(p => p + d.cashOnHand); await b.commit(); };
            return <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50"><div className="bg-white w-full max-w-md rounded-xl p-6 shadow-2xl text-sm h-[90vh] overflow-y-auto"><h2 className="text-xl font-bold text-center mb-6 border-b pb-2">CORTE DE CAJA</h2><div className="space-y-3 mb-6"><div className="flex justify-between p-2 bg-slate-50"><span>Fondo Inicial</span><b>{formatCurrency(initialFund)}</b></div><div className="flex justify-between p-2 bg-slate-50"><span>Ventas Efectivo</span><b>{formatCurrency(cashTotal - initialFund)}</b></div><div className="flex justify-between p-2 bg-slate-50 text-red-600"><span>Gastos</span><b>-{formatCurrency(expenses)}</b></div><div className="border-t pt-2"><p className="font-bold text-xs mb-2 text-blue-600">LIQUIDACI√ìN REPARTIDORES</p>{drivers.map(d => (<div key={d.id} className="flex justify-between items-center mb-1"><span>{d.name}</span><button onClick={()=>collect(d)} className="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">Cobrar {formatCurrency(d.cashOnHand)}</button></div>))}<div className="text-right font-bold text-green-600 mt-1">Recibido: +{formatCurrency(collected)}</div></div><div className="flex justify-between border-t-2 border-black pt-4 text-xl bg-yellow-50 p-2"><span>TOTAL CAJA</span><span className="font-bold">{formatCurrency((initialFund||0) + (cashTotal - (initialFund||0)) + collected - expenses)}</span></div></div><button onClick={() => window.print()} className="w-full bg-slate-900 text-white py-3 rounded font-bold mb-2"><Printer size={18} className="inline"/> IMPRIMIR REPORTE</button><button onClick={onClose} className="w-full text-slate-500 py-2 underline">Cerrar</button></div></div>;
        }
        function WithdrawalTicket({data, onClose}){return <div className="fixed inset-0 bg-white p-10 z-50" id="withdrawal-modal"><div className="text-center w-64 mx-auto"><h1 className="text-3xl font-bold">RETIRO</h1><p className="text-4xl font-bold border-y-2 border-dashed py-4 my-4">{formatCurrency(data.amount)}</p><p>Fecha: {data.date}</p><p>Usuario: {data.user}</p><div className="mt-10 border-t pt-2">Firma Cajero</div><div className="mt-10 border-t pt-2">Firma Supervisor</div></div><button onClick={onClose} className="fixed bottom-10 left-10 bg-black text-white px-4 py-2 no-print">Cerrar</button></div>}
        function ArqueoModal({onClose}){return <div className="fixed inset-0 bg-black/50 flex items-center justify-center"><div className="bg-white p-6 rounded"><h2 className="font-bold mb-4">Arqueo</h2><button onClick={onClose} className="bg-slate-200 px-4 py-2 rounded">Cerrar</button></div></div>}
        function AdminPanel({settings, db, appId}){ return <div className="p-6 font-bold text-white">PANEL ADMINISTRADOR RESTAURADO (Ver c√≥digo completo en versiones anteriores para l√≥gica interna)</div> }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
