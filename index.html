<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMI BURGERS - ¬°EL SABOR QUE MANDA!</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Roboto:wght@300;400;500;700;900&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- QR Scanner Lib -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --gold: #FFD700; --accent: #FF4500; --success: #00e676; --danger: #ff3333;
            --z-map: 0; --z-ui: 10; --z-fab: 2000; --z-modal: 5000; --z-toast: 6000; --z-loader: 10000;
        }
        
        /* VARIABLES DE TEMA */
        body.dark { 
            --bg-body: #050505; 
            --bg-card: #141414; 
            --text-main: #f0f0f0; 
            --input-bg: #222; 
            --border: #333; 
        }
        body.light { 
            --bg-body: #f3f4f6; 
            --bg-card: #ffffff; 
            --text-main: #111827; 
            --input-bg: #e5e7eb; 
            --border: #d1d5db; 
        }
        /* CLIENTE SIEMPRE DARK */
        body.client-mode { --bg-body: #050505 !important; --bg-card: #141414 !important; --text-main: #f0f0f0 !important; }

        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: 'Roboto', sans-serif; 
            margin: 0; overflow: hidden; height: 100vh; width: 100vw; 
            transition: background-color 0.3s, color 0.3s; /* Transici√≥n suave de tema */
        }
        
        #root { height: 100%; width: 100%; overflow: hidden; display: flex; flex-direction: column; }
        .font-brand { font-family: 'Bangers', cursive; letter-spacing: 1.5px; }
        
        /* CARD (Fondo din√°mico seg√∫n tema) */
        .card { 
            background-color: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        
        .input-std { background-color: var(--input-bg) !important; border: 1px solid var(--border) !important; color: var(--text-main) !important; padding: 0.75rem; width: 100%; outline: none; border-radius: 0.5rem; }
        .btn-gold { background: linear-gradient(180deg, var(--gold) 0%, #e6c200 100%); color: black; font-weight: 900; border-radius: 0.75rem; padding: 0.8rem; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 0.5rem; }

        /* --- BANNER RESPONSIVO (PC vs M√ìVIL) --- */
        .banner-container {
            width: 100%;
            height: 30vh; /* PC: 30% de la altura de la pantalla */
            min-height: 250px;
            overflow: hidden;
            position: relative;
        }
        .mobile-banner { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: block; 
        }
        
        /* Ajuste espec√≠fico para Celulares */
        @media (max-width: 768px) {
            .banner-container {
                height: 160px; /* Altura fija en m√≥vil */
                min-height: auto;
            }
        }

        /* --- CONTROLES DE ADMIN (Visibles por defecto) --- */
        .theme-toggle { 
            position: fixed; bottom: 10px; right: 10px; z-index: var(--z-fab); 
            background: var(--bg-card); padding: 0; border-radius: 50%; 
            width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; 
            border: 1px solid var(--border); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .gods-eye { 
            position: fixed; bottom: 20px; left: 20px; z-index: var(--z-fab); 
            opacity: 0.8; transform: scale(0.9); cursor: pointer; 
        }
        .dash-map-btn { 
            position: fixed; top: 75px; right: 0; background: #2563eb; color: white; 
            padding: 10px 15px 10px 20px; border-radius: 30px 0 0 30px; 
            font-weight: bold; font-size: 12px; z-index: 9998; 
            display: flex; align-items: center; gap: 5px; cursor: pointer;
        }
        .logout-ghost { 
            position: fixed; top: 10px; left: 10px; z-index: var(--z-fab); opacity: 0.8; 
        }
        .share-btn { 
            position: fixed; top: 15px; right: 15px; background: var(--gold); 
            border-radius: 50%; width: 45px; height: 45px; 
            display: flex; align-items: center; justify-content: center; z-index: 9999; cursor: pointer;
        }

        /* OCULTAR SOLO EN MODO CLIENTE */
        body.client-mode .theme-toggle, 
        body.client-mode .share-btn, 
        body.client-mode .gods-eye, 
        body.client-mode .dash-map-btn, 
        body.client-mode .logout-ghost { 
            display: none !important; 
        }

        /* --- LOADER --- */
        .app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: var(--z-loader); display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--gold); font-family: 'Bangers', cursive; }
        .loader-logo { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--gold); object-fit: cover; animation: pulse-load 1s infinite; margin-bottom: 20px; }
        .loader-bar { width: 200px; height: 4px; background: #333; border-radius: 4px; overflow: hidden; }
        .loader-progress { height: 100%; background: var(--accent); width: 50%; animation: load-slide 1s infinite; }
        
        /* --- Video Promocional --- */
        .mobile-video-container { position: fixed; bottom: 70px; left: 0; width: 100%; height: 100px; z-index: 50; pointer-events: none; background: black; overflow: hidden; border-top: 2px solid var(--gold); }
        .mobile-video-container video { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .mobile-video-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); }

        /* --- DiDi & Mapas --- */
        .didi-search-container { background: white; border-radius: 8px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .didi-input { flex: 1; border: none; outline: none; font-size: 16px; color: black; }
        .didi-btn-orange { background: #FF6600; color: white; font-weight: bold; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .didi-suggestions { background: white; border-radius: 0 0 8px 8px; margin-top: -5px; max-height: 200px; overflow-y: auto; color: black; }
        .didi-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .leaflet-container { background: #1a1a1a; width: 100%; height: 100%; z-index: 0; }

        /* Overlay Cerrado */
        .closed-store-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: black; background-image: url('./CERRADO_OFF.png'); background-size: contain; background-repeat: no-repeat; background-position: center; z-index: 10000; }

        /* --- Animaciones & Utilidades --- */
        @keyframes pulse-load { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }
        @keyframes load-slide { 0% {transform: translateX(-100%);} 100% {transform: translateX(100%);} }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        .install-btn { position: fixed; bottom: 20px !important; left: 20px !important; top: auto !important; z-index: 9999 !important; background: black; border: 2px solid var(--gold); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; animation: bounce 2s infinite; }
        .install-btn img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        
        .gods-menu { position: absolute; bottom: 60px; left: 0; width: 220px; background: rgba(0,0,0,0.95); border: 1px solid var(--gold); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; gap: 5px; backdrop-filter: blur(10px); z-index: 5001; }
        .track-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; height: 100%; padding: 1rem; overflow-y: auto; }
        @media (min-width: 768px) { .track-grid { grid-template-columns: 1fr 1fr; overflow: hidden; } }
        .track-col-left { display: flex; flex-direction: column; gap: 1rem; }
        .track-col-right { background: #111; border-radius: 1rem; padding: 1rem; overflow-y: auto; height: fit-content; }
        .driver-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #111; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #333; z-index: 1000; }
        .driver-nav-btn { display: flex; flex-direction: column; align-items: center; color: #777; background: none; border: none; font-size: 10px; font-weight: bold; flex: 1; }
        .driver-nav-btn.active { color: var(--gold); }
        .center-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); border: 2px solid var(--gold); color: white; padding: 30px; border-radius: 15px; z-index: var(--z-modal); text-align: center; max-width: 90%; width: 400px; }
    </style>
</head>
<body class="dark">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { 
            Utensils, Truck, LayoutDashboard, LogOut, Plus, Minus, Search, MapPin, Printer, CreditCard, DollarSign, 
            Smartphone, User, QrCode, Clock, CheckCircle, AlertTriangle, FileText, Settings, Menu as MenuIcon, X, 
            Save, Trash2, ShoppingBag, Camera, Users, BarChart3, Bell, Ticket, TrendingUp, Lock, Eye, Send, Map, Navigation, 
            Wallet, Receipt, ArrowRight, Banknote, Power, Wifi, WifiOff, RefreshCw, Crosshair, Home, UserCheck, Calendar, Globe, QrCode as QRIcon,
            Package, Percent, Edit, Phone, Table, ArrowLeft, MessageCircle, Sun, Moon, Video, Copy, ClipboardList, PieChart, Link as LinkIcon, PenTool, Share2, MoreVertical, Download, Cloud, Info, Image, Ban, EyeOff,
            ChefHat, Bike, History, Unlock, Layers, MessageSquare, Box
        } from 'https://esm.sh/lucide-react@0.344.0';

        const React = window.React;
        const ReactDOM = window.ReactDOM;
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        const STORE_COORDS = [27.446895, -109.943874]; 
        const CITY_SUFFIX = ", Ciudad Obreg√≥n, Sonora, Mexico";
        const SUPER_USER_PASS = "OBR1995@";
        const STORE_PHONE = "526443366197"; 
        
        const LOGO_URL = "./LOGO_1.png";
        const BANNER_URL = "./BANNER_MENU.jpg"; 
        const VIDEO_URL = "./WEB_PROMOCIONES.mp4";
        const CLOSED_IMG = "./CERRADO_OFF.png"; 

        // URL DE TU SCRIPT (Aseg√∫rate que sea la √∫ltima que te dio Google)
        const API_URL = "https://script.google.com/macros/s/AKfycbxehvXqpEG_2oQCByz8nOqThDPPD_p24GQerg7JTLglBT6gKWgClnpWkaZplaOw3w6GWw/exec";
        
        // --- NUEVO ID DE BASE DE DATOS (LIMPIEZA TOTAL) ---
        const DB_ID = "emi_db_v87_supreme_3";

        const generateId = () => Math.random().toString(36).substr(2, 9).toUpperCase();
        const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(val || 0);

        // --- FUNCIONES API BLINDADAS ---
        const fetchCloudDB = async () => {
            try {
                // Forzamos un par√°metro random para evitar cach√© del navegador
                const res = await fetch(`${API_URL}?action=read&id=${DB_ID}&t=${Date.now()}`);
                return await res.json();
            } catch (e) { console.error("Error fetch", e); return null; }
        };

        const saveCloudDB = async (data) => {
            try {
                // Siempre enviamos el ID nuevo
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Importante para evitar bloqueos
                    body: JSON.stringify({ action: 'update', id: DB_ID, data: data })
                });
            } catch (e) { console.error("Error save", e); }
        };

        const playSound = () => {
             try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, ctx.currentTime); 
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.2);
             } catch(e) { console.log("Audio not supported"); }
        };

        const copyToClipboard = (text) => {
            const urlObj = new URL(text);
            urlObj.searchParams.set('menu', 'true');
            const menuLink = urlObj.toString();
            const textArea = document.createElement("textarea");
            textArea.value = menuLink;
            textArea.style.position = "fixed";  
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Enlace de men√∫ copiado');
            } catch (err) {
                showToast("Error al copiar.");
            }
            document.body.removeChild(textArea);
        };
        
        const fetchCloudDB = async () => {
            try {
                const res = await fetch(`${API_URL}?action=read&id=${DB_ID}`);
                if (!res.ok) throw new Error("Network response was not ok");
                const json = await res.json();
                return json && json.id ? json : null;
            } catch (e) { 
                console.error("Read Error", e); 
                return null; 
            }
        };

        const saveCloudDB = async (db) => {
            try {
                let res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' }, 
                    body: JSON.stringify({ action: 'update', id: DB_ID, data: db })
                });
                let json = await res.json();
                if (!json.success) {
                     await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' }, 
                        body: JSON.stringify({ action: 'create', id: DB_ID, collection: 'db', data: db })
                    });
                }
                return true;
            } catch (e) { 
                console.error("Save Error", e); 
                return false; 
            }
        };

        const initialDB = {
            products: [], 
            users: [], 
            orders: [],
            coupons: [],
            supplies: [],
            settings: {
                storeOpen: true,
                pickupEnabled: true,
                deliveryEnabled: true,
                paymentMethods: { cash: true, card: true },
                deliveryRadius: 15,
                driverAssign: 'manual',
                supervisorKey: 'ADMIN123',
                cashLimit: 2000,
                providers: [], 
                platforms: ['Uber Eats', 'DiDi Food', 'Rappi'],
                ticketConfig: { header: 'EMI BURGERS\nCD. OBREGON', footer: '¬°GRACIAS POR SU COMPRA!' },
                deliveryTable: [
                    { min: 0, max: 3, price: 30 },
                    { min: 3.1, max: 7, price: 50 },
                    { min: 7.1, max: 15, price: 80 }
                ],
                notification: null
            },
            cashDrawer: { current: 0, initial: 0 },
            expenses: []
        };

        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            if(!lat1 || !lon1 || !lat2 || !lon2) return 0;
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180; 
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        };
        const getDeliveryPrice = (dist, table) => { const rule = table.find(r => dist >= r.min && dist <= r.max); return rule ? rule.price : (table[table.length-1]?.price || 0); };
        
        const printTicket = (html) => {
            const win = window.open('', '', 'width=300,height=600');
            if(win){
                const currentUrl = window.location.href;
                const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
                win.document.write(`<html><head><base href="${baseUrl}"><style>body{font-family:monospace;font-size:12px;width:280px;margin:0;padding:10px;} .center{text-align:center;} .bold{font-weight:bold;} hr{border-top:1px dashed #000;} img{display:block;margin:0 auto;}</style></head><body>${html}</body></html>`);
                win.document.close(); setTimeout(() => { win.print(); win.close(); }, 500);
            } else { showToast("Permite popups para imprimir"); }
        };
        
        const getCirclePoints = (center, radiusKm) => {
            const points = [];
            const earthRadius = 6371;
            for (let i = 0; i < 360; i += 5) {
                const lat1 = center[0] * Math.PI / 180;
                const lon1 = center[1] * Math.PI / 180;
                const brng = i * Math.PI / 180;
                const dist = radiusKm / earthRadius;
                
                const lat2 = Math.asin(Math.sin(lat1) * Math.cos(dist) + Math.cos(lat1) * Math.sin(dist) * Math.cos(brng));
                const lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(dist) * Math.cos(lat1), Math.cos(dist) - Math.sin(lat1) * Math.sin(lat2));
                
                points.push([lat2 * 180 / Math.PI, lon2 * 180 / Math.PI]);
            }
            return points;
        };

        const ModalAlert = ({ message, type, onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-black/90 z-[12000] flex items-center justify-center p-4 animate-in fade-in">
                <div className={`bg-[#1a1a1a] border-2 ${type==='confirm'?'border-[var(--gold)]':'border-red-500'} p-6 rounded-xl w-full max-w-sm text-center shadow-2xl`}>
                    <div className="mb-4 flex justify-center text-4xl">{type==='confirm'?'‚ùì':'‚ö†Ô∏è'}</div>
                    <p className="text-white text-lg font-bold mb-6 whitespace-pre-wrap">{message}</p>
                    <div className="flex gap-3">
                        {type === 'confirm' && <button onClick={onCancel} className="flex-1 bg-gray-700 text-white py-3 rounded-lg font-bold">CANCELAR</button>}
                        <button onClick={onConfirm} className={`flex-1 ${type==='confirm'?'btn-gold':'bg-red-600 text-white'} py-3 rounded-lg font-bold`}>{type==='confirm'?'ACEPTAR':'ENTENDIDO'}</button>
                    </div>
                </div>
            </div>
        );

const LeafletMap = ({ center, markers, zoom = 14, onClickMap, showHeatmap, route, radius, onMarkerClick }) => {
            const containerRef = useRef(null);
            const mapInstance = useRef(null);
            const userInteracted = useRef(0);

            // Efecto de Inicializaci√≥n y Actualizaci√≥n de Elementos
            useEffect(() => {
                if (!containerRef.current || typeof L === 'undefined') return;

                const safeCenter = (center && center[0] && center[1]) ? center : STORE_COORDS;
                // URLs limpias y correctas
                const darkUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
                const lightUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                const isDark = document.body.classList.contains('dark');

                if (!mapInstance.current) {
                    mapInstance.current = L.map(containerRef.current, { zoomControl: false, attributionControl: false }).setView(safeCenter, zoom);
                    L.tileLayer(isDark ? darkUrl : lightUrl).addTo(mapInstance.current);
                    
                    mapInstance.current.on('mousedown touchstart zoomstart', () => { userInteracted.current = Date.now(); });
                    if(onClickMap) mapInstance.current.on('click', (e) => onClickMap([e.latlng.lat, e.latlng.lng]));
                } else {
                    // Recentrado inteligente solo si el usuario no movi√≥ el mapa recientemente
                    if(Date.now() - userInteracted.current > 10000) {
                          const currentCenter = mapInstance.current.getCenter();
                          const dist = Math.sqrt(Math.pow(currentCenter.lat - safeCenter[0], 2) + Math.pow(currentCenter.lng - safeCenter[1], 2));
                          if (dist > 0.001) mapInstance.current.setView(safeCenter, zoom); 
                    }
                    setTimeout(() => mapInstance.current.invalidateSize(), 100);
                }

                // Limpieza de capas viejas
                mapInstance.current.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.Circle || layer instanceof L.Polyline || layer instanceof L.Polygon) mapInstance.current.removeLayer(layer);
                });

                // Dibujar Radio
                if (radius) {
                    const outerBounds = [[90, -180], [90, 180], [-90, 180], [-90, -180]];
                    const hole = getCirclePoints(STORE_COORDS, radius);
                    L.polygon([outerBounds, hole], { color: 'transparent', fillColor: '#111', fillOpacity: 0.6 }).addTo(mapInstance.current);
                    L.circle(STORE_COORDS, { color: '#00e676', fillColor: 'transparent', weight: 2, radius: radius * 1000 }).addTo(mapInstance.current);
                }

                // Dibujar Marcadores
                if(showHeatmap) {
                     markers.forEach((m) => {
                         if(m.pos && m.pos[0] && m.pos[1]) {
                           if (!m.isStore) L.circle(m.pos, { color: 'red', fillColor: '#f03', fillOpacity: 0.2, radius: 300, stroke: false }).addTo(mapInstance.current);
                           else {
                               const el = document.createElement('div');
                               el.className = 'custom-pin';
                               el.innerHTML = `<img src="${LOGO_URL}" style="width:40px;height:40px;border-radius:50%;border:2px solid gold;">`;
                               const icon = L.divIcon({ className: 'bg-transparent', html: el, iconSize: [40,40], iconAnchor: [20,20] });
                               L.marker(m.pos, { icon }).addTo(mapInstance.current);
                           }
                         }
                     });
                } else {
                    markers.forEach((m) => {
                        if(m.pos && m.pos[0] && m.pos[1]) {
                            const el = document.createElement('div');
                            if (m.isMyLoc) {
                                el.className = 'user-gps-dot';
                            } else if(m.isClient) { 
                                el.className = 'custom-pin';
                                el.innerHTML = '<div style="font-size:30px;">üîµ</div>'; 
                            } else if (m.type === 'driver-order') {
                                el.className = 'driver-order-icon';
                                el.innerHTML = `<div>üçî</div><span class="driver-order-num">${m.label}</span>`;
                            } else {
                                el.className = m.type === 'driver' ? 'driver-pin' : 'custom-pin';
                                if(m.isStore) { 
                                    el.innerHTML = `<img src="${LOGO_URL}" style="width:40px;height:40px;border-radius:50%;border:2px solid gold;">`;
                                } else if (m.type === 'driver') {
                                    el.innerHTML = 'üèçÔ∏è';
                                } else {
                                    el.innerHTML = m.emoji || 'üìç';
                                }
                            }
                            
                            if(m.label && !m.isMyLoc && m.type !== 'driver-order') {
                                 const lbl = document.createElement('div');
                                 lbl.className = 'absolute -bottom-5 left-1/2 transform -translate-x-1/2 bg-black/80 text-white text-[10px] px-1 rounded whitespace-nowrap border border-white/20';
                                 lbl.innerText = m.label;
                                 el.appendChild(lbl);
                            }
                            const iconSize = m.isMyLoc ? [20,20] : (m.type==='driver'?[36,36]:[40,40]);
                            const icon = L.divIcon({ className: 'bg-transparent', html: el, iconSize: iconSize, iconAnchor: [iconSize[0]/2, iconSize[1]/2] });
                            const marker = L.marker(m.pos, { icon }).addTo(mapInstance.current);
                            if(m.popup) marker.bindPopup(m.popup);
                            if(m.data && onMarkerClick) marker.on('click', () => onMarkerClick(m.data));
                        }
                    });
                }

                // Dibujar Ruta
                if(route && route.length >= 2) {
                     const validRoute = route.filter(p => p && p[0] && p[1]);
                     if(validRoute.length >= 2) {
                         L.polyline(validRoute, {color: '#4285F4', weight: 6, opacity: 0.9, dashArray: '10, 10'}).addTo(mapInstance.current);
                         if(Date.now() - userInteracted.current > 10000) {
                            const bounds = L.latLngBounds(validRoute);
                            if(bounds.isValid()) mapInstance.current.fitBounds(bounds, { padding: [50, 50] });
                         }
                     }
                }
            }, [center, markers, showHeatmap, radius, route]); 

            // DETECTOR DE CAMBIO DE TEMA (Para cambiar el mapa autom√°ticamente)
            useEffect(() => {
                if(!mapInstance.current) return;
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === "class") {
                            const isDark = document.body.classList.contains('dark');
                            const url = isDark 
                                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' 
                                : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                            
                            mapInstance.current.eachLayer(layer => {
                                if (layer instanceof L.TileLayer) layer.setUrl(url);
                            });
                        }
                    });
                });
                observer.observe(document.body, { attributes: true });
                return () => observer.disconnect();
            }, []);
            
            if (typeof L === 'undefined') return <div className="w-full h-full flex items-center justify-center bg-gray-800 text-white">Cargando Mapa...</div>;

            return <div ref={containerRef} className="h-full w-full rounded-lg bg-[var(--bg-card)] border border-[var(--border)] z-0 relative overflow-hidden"></div>;
        };

        const QRScanner = ({ onScan, onClose }) => {
             useEffect(() => {
                const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }, false);
                scanner.render((decodedText) => {
                    onScan(decodedText);
                    scanner.clear();
                }, (error) => {});
                return () => { try { scanner.clear(); } catch(e){} };
            }, []);

            return (
                <div id="reader" style={{width:'100%', height:'100%'}}></div>
            ); 
        };

        const AdminAuthModal = ({ onClose, onSuccess, db }) => {
            const [pass, setPass] = useState('');
            const check = () => {
                if(pass === SUPER_USER_PASS || pass === db.settings.supervisorKey) {
                    onSuccess();
                } else {
                    showToast("Contrase√±a incorrecta");
                }
            };
            return (
                <div className="fixed inset-0 bg-black/90 z-[10000] flex items-center justify-center p-4">
                    <div className="bg-[var(--bg-card)] p-6 rounded border border-[var(--gold)] w-full max-w-xs text-center">
                        <h3 className="text-xl font-bold text-white mb-4"><Lock className="inline mb-1"/> AUTORIZACI√ìN</h3>
                        <input type="password" className="input-std text-center text-xl mb-4" placeholder="Clave Admin/Supervisor" value={pass} onChange={e=>setPass(e.target.value)} autoFocus/>
                        <div className="flex gap-2">
                            <button onClick={onClose} className="flex-1 bg-gray-600 text-white py-2 rounded">CANCELAR</button>
                            <button onClick={check} className="flex-1 btn-gold py-2 rounded">ACEPTAR</button>
                        </div>
                    </div>
                </div>
            );
        };

const Dashboard = ({ db }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);
            const [selectedZone, setSelectedZone] = useState(null);
            const [showMermas, setShowMermas] = useState(false);
            const [viewMap, setViewMap] = useState(false);

            const validOrders = db.orders.filter(o => o.status !== 'cancelled');
            const cancelledOrders = db.orders.filter(o => o.status === 'cancelled');

            const sales = validOrders.reduce((a,b)=>a+b.total,0);
            const expenses = db.expenses.reduce((a,b)=>a+b.amount,0);
            
            const activeOrders = db.orders.filter(o => o.status === 'delivering' || o.status === 'pending');
            const drivers = db.users.filter(u => u.role === 'repartidor' && u.online);
            
            const liveMarkers = [
                { pos: STORE_COORDS, emoji: 'üè™', isStore: true },
                ...activeOrders.map(o => ({ pos: o.clientLoc || STORE_COORDS, emoji: 'üçî', popup: `Pedido #${o.orderNum}` })),
                ...drivers.map(d => ({ pos: d.location || STORE_COORDS, emoji: 'üèçÔ∏è', label: d.name, type: 'driver' }))
            ];

            useEffect(() => {
                if(!canvasRef.current) return;
                if(chartRef.current) chartRef.current.destroy();

                const ctx = canvasRef.current.getContext('2d');
                const salesByDate = {};
                validOrders.forEach(o => {
                    const date = new Date(o.createdAt).toLocaleDateString();
                    salesByDate[date] = (salesByDate[date] || 0) + o.total;
                });
                const labels = Object.keys(salesByDate).slice(-7);
                const data = Object.values(salesByDate).slice(-7);

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.length ? labels : ['Hoy'],
                        datasets: [{ label: 'Ventas ($)', data: data.length ? data : [0], borderColor: '#FFD700', backgroundColor: 'rgba(255, 215, 0, 0.2)', tension: 0.4, fill: true }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: 'white' } } }, scales: { y: { ticks: { color: 'white' }, grid: { color: '#333' } }, x: { ticks: { color: 'white' }, grid: { color: '#333' } } } }
                });
                return () => { if(chartRef.current) chartRef.current.destroy(); }
            }, [db.orders]);

            const platformStats = validOrders.reduce((acc, o) => { const key = o.source === 'web' ? 'WEB' : (o.source === 'platform' ? (o.platformName || 'APP') : 'TIENDA'); acc[key] = (acc[key] || 0) + 1; return acc; }, {});
            const expired = db.supplies.filter(s => new Date(s.expiry) < new Date());
            const actualTopProducts = Object.entries(validOrders.reduce((acc, o) => {
                o.items.forEach(i => acc[i.name] = (acc[i.name] || 0) + i.qty);
                return acc;
            }, {})).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const topProducts = actualTopProducts.length > 0 ? actualTopProducts : [['Producto 1', 0], ['Producto 2', 0], ['Producto 3', 0]];
            const maxProdVal = actualTopProducts.length > 0 ? actualTopProducts[0][1] : 1;

            const handleMapClick = (markerData) => {
                 if (markerData && markerData.isStore) {
                 } else if (actualTopProducts.length > 0) {
                    const topItem = actualTopProducts[0][0];
                    const topQty = actualTopProducts[0][1];
                    showToast(`Zona Caliente: ${topItem} (${topQty} ventas)`);
                    setSelectedZone({ name: "Zona Centro", topItem: topItem, summary: `${topItem} lidera con ${topQty} unidades` });
                    setTimeout(() => setSelectedZone(null), 5000);
                } else {
                    showToast("Sin datos de ventas para mostrar zonas.");
                }
            };
            
            const hotZoneMarkers = [
                { pos: STORE_COORDS, emoji: 'üè™', popup: 'Tienda', isStore: true, data: {isStore: true} }, 
                ...validOrders.filter(o=>o.clientLoc).map(o=>({pos:o.clientLoc}))
            ];

            if (viewMap) {
                return (
                    <div className="h-full flex flex-col p-4">
                         <div className="flex justify-between items-center mb-4">
                             <h2 className="text-2xl font-bold text-[var(--gold)]">RASTREO EN VIVO</h2>
                             <button onClick={()=>setViewMap(false)} className="bg-red-600 text-white px-4 py-2 rounded">CERRAR MAPA</button>
                         </div>
                         <div className="flex-1 rounded border border-[var(--gold)] overflow-hidden">
                             <LeafletMap center={STORE_COORDS} markers={liveMarkers} zoom={13}/>
                         </div>
                         <div className="mt-2 flex gap-4 text-sm text-gray-400">
                             <span className="flex items-center gap-1">üçî Pedidos Activos</span>
                             <span className="flex items-center gap-1">üèçÔ∏è Repartidores</span>
                         </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6 animate-in fade-in pb-20 overflow-y-auto h-full">
                    {/* BOT√ìN RASTREO FLOTANTE (RESTAURADO) */}
                    <button className="dash-map-btn" onClick={()=>setViewMap(true)}>
                        <Map size={24}/> RASTREO
                    </button>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="card p-4 border-l-4 border-[var(--gold)]"><p className="text-gray-400 text-xs font-bold uppercase">Ventas</p><p className="text-3xl font-black text-[var(--text-main)]">{formatCurrency(sales)}</p></div>
                        <div className="card p-4 border-l-4 border-red-500"><p className="text-gray-400 text-xs font-bold uppercase">Gastos</p><p className="text-3xl font-black text-[var(--text-main)]">{formatCurrency(expenses)}</p></div>
                        <div className="card p-4 border-l-4 border-green-500"><p className="text-gray-400 text-xs font-bold uppercase">Utilidad</p><p className="text-3xl font-black text-[var(--text-main)]">{formatCurrency(sales - expenses)}</p></div>
                        <div className="card p-4 border-l-4 border-blue-500"><p className="text-gray-400 text-xs font-bold uppercase">Pedidos</p><p className="text-3xl font-black text-[var(--text-main)]">{validOrders.length}</p></div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="flex flex-col gap-4">
                            <div className="card p-6 h-64 flex-shrink-0">
                                <h3 className="font-bold text-[var(--text-main)] mb-2 flex items-center gap-2"><BarChart3 size={20}/> Historial de Ventas</h3>
                                <div className="w-full h-full pb-6"><canvas ref={canvasRef}></canvas></div>
                            </div>
                            <div className="card p-4 bg-[#222] border-l-4 border-red-800 h-64 overflow-y-auto custom-scroll">
                                <h3 className="font-bold text-red-500 mb-2 flex items-center gap-2"><Ban size={16}/> √ìrdenes Canceladas ({cancelledOrders.length})</h3>
                                {cancelledOrders.map(o => (
                                    <div key={o.id} className="border-b border-[#444] py-2 text-xs">
                                        <div className="flex justify-between text-white font-bold"><span>#{o.orderNum}</span><span>{formatCurrency(o.total)}</span></div>
                                        <p className="text-gray-400">{new Date(o.createdAt).toLocaleString()}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="card p-6 relative h-96 md:h-auto min-h-[300px] overflow-hidden"> 
                            <h3 className="font-bold text-[var(--text-main)] mb-4 flex items-center gap-2"><Map size={20}/> Zonas Calientes</h3>
                            <div className="h-full w-full absolute inset-0 pt-16 px-6 pb-6 rounded border border-[var(--border)]">
                                <LeafletMap center={STORE_COORDS} markers={hotZoneMarkers} showHeatmap={true} zoom={12} onMarkerClick={handleMapClick}/>
                                {selectedZone && <div className="absolute bottom-4 left-4 right-4 bg-black/90 text-white p-4 rounded z-[500] animate-in slide-in-from-bottom border border-[var(--gold)] text-center shadow-2xl">
                                    <h4 className="font-bold text-[var(--gold)] text-lg mb-1">üî• RESUMEN DE ZONA</h4>
                                    <p className="text-sm">{selectedZone.summary}</p>
                                </div>}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6">
                        <div className="card p-6">
                            <h3 className="font-bold text-[var(--gold)] mb-4 flex items-center gap-2"><TrendingUp size={20}/> Productos M√°s Vendidos</h3>
                            {topProducts.map(([name, qty], i) => (
                                <div key={i} className="mb-2">
                                    <div className="flex justify-between text-sm mb-1"><span className="text-[var(--text-main)]">{name}</span><span className="text-[var(--gold)]">{qty}</span></div>
                                    <div className="progress-bar"><div className="progress-fill bg-[var(--gold)]" style={{width: `${(qty/maxProdVal)*100}%`}}></div></div>
                                </div>
                             ))}
                        </div>

                        <div className="space-y-4">
                            <div className="card p-6">
                                <h3 className="font-bold text-[var(--text-main)] mb-4">Ventas por Canal</h3>
                                {Object.keys(platformStats).length === 0 ? <p className="text-gray-500 text-sm">Sin datos</p> : Object.entries(platformStats).map(([key, val]) => (
                                     <div key={key} className="flex justify-between items-center py-2 border-b border-[var(--border)]">
                                          <span className="text-[var(--text-main)]">{key}</span><span className="bg-[var(--input-bg)] px-2 rounded text-[var(--text-main)] text-xs">{val}</span>
                                     </div>
                                ))}
                            </div>
                            <div className="card p-6 border-l-4 border-red-500 cursor-pointer hover:bg-[var(--input-bg)]" onClick={()=>setShowMermas(true)}>
                                <h3 className="font-bold text-red-500 mb-2 flex items-center gap-2"><AlertTriangle size={16}/> P√©rdidas / Caducados</h3>
                                <div className="text-4xl font-black text-[var(--text-main)] mb-2">{expired.length}</div>
                            </div>
                        </div>
                    </div>

                    {showMermas && (
                        <div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4">
                            <div className="card w-full max-w-2xl bg-[var(--bg-card)] p-6">
                                <h3 className="text-2xl font-bold text-red-500 mb-4">DETALLE DE MERMAS</h3>
                                <table className="w-full text-left text-sm text-[var(--text-main)]">
                                    <thead><tr className="border-b border-[var(--border)]"><th>Producto</th><th>Entrada</th><th>Caducidad</th><th>Stock Perdido</th></tr></thead>
                                    <tbody>
                                        {expired.map(s => (
                                            <tr key={s.id} className="border-b border-[#333]">
                                                <td className="p-2">{s.name}</td>
                                                <td className="p-2">{s.entryDate || '-'}</td>
                                                <td className="p-2 text-red-500 font-bold">{s.expiry}</td>
                                                <td className="p-2">{s.stock} {s.unit}</td>
                                            </tr>
                                        ))}
                                        {expired.length === 0 && <tr><td colSpan="4" className="p-4 text-center text-gray-500">No hay registros de caducidad.</td></tr>}
                                    </tbody>
                                </table>
                                <button onClick={()=>setShowMermas(false)} className="mt-6 btn-gold w-full">CERRAR</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        const ProductManager = ({ db, updateDB }) => {
            const [modal, setModal] = useState(null);
            const [form, setForm] = useState({ name:'', price:0, cat:'', img:'', desc:'', ingredients:'', isComplement: false, active: true });
            
            const handleCSV = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = ev => {
                        const lines = ev.target.result.split('\n').slice(1);
                        const newProds = lines.map(l => {
                            const [name, price, cat, desc, img] = l.split(',');
                            return name ? {id:generateId(), name, price:parseFloat(price), cat, desc, img, active:true} : null;
                        }).filter(Boolean);
                        updateDB({...db, products: [...db.products, ...newProds]});
                    };
                    r.readAsText(f);
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setForm({...form, img: reader.result});
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            const save = () => {
                let products = [...db.products];
                if(form.id) products = products.map(p => p.id === form.id ? form : p);
                else products.push({ ...form, id: generateId() });
                updateDB({...db, products}); setModal(null);
            };
            
            const remove = (id) => { if(confirm("¬øEliminar?")) updateDB({...db, products: db.products.filter(p=>p.id!==id)}); };
            const toggleActive = (p) => { updateDB({...db, products: db.products.map(x=>x.id===p.id?{...x, active:!x.active}:x)}); };

            const groupedProducts = useMemo(() => {
                const groups = {};
                db.products.forEach(p => {
                    const cat = p.cat || 'Otros';
                    if (!groups[cat]) groups[cat] = [];
                    groups[cat].push(p);
                });
                return groups;
            }, [db.products]);

            return (
                <div className="space-y-6 overflow-y-auto h-full pb-20">
                    <div className="flex gap-2 sticky top-0 bg-[var(--bg-body)] z-20 pb-2">
                        <button onClick={()=>{setForm({name:'', price:0, cat:'', img:'', desc:'', ingredients:'', isComplement:false, active:true}); setModal(true);}} className="btn-gold z-10">NUEVO PRODUCTO</button>
                        <label className="btn-gold cursor-pointer bg-blue-600 text-white z-10">CARGAR CSV <input type="file" hidden onChange={handleCSV}/></label>
                        <button onClick={()=>{
                            const csv = "Nombre,Precio,Categoria,Descripcion,Imagen\nHamburguesa,100,Burgers,Rica,url";
                            const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv); a.download='plantilla.csv'; a.click();
                        }} className="btn-gold bg-green-600 text-white z-10">PLANTILLA</button>
                    </div>
                    
                    {Object.entries(groupedProducts).map(([cat, prods]) => (
                        <div key={cat} className="mb-6">
                            <h3 className="text-2xl font-bold text-[var(--gold)] mb-3 border-b border-[var(--border)]">{cat}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {prods.map(p => (
                                    <div key={p.id} className={`card p-3 flex gap-3 items-center group ${!p.active ? 'opacity-50' : ''}`}>
                                                <img src={p.img} className="w-16 h-16 rounded object-cover"/>
                                                <div className="flex-1">
                                                    <p className="font-bold text-[var(--text-main)]">{p.name}</p>
                                                    <p className="text-[var(--gold)] font-bold">{formatCurrency(p.price)}</p>
                                                    {p.isComplement && <span className="text-[10px] bg-blue-900 text-blue-200 px-1 rounded">Complemento</span>}
                                                </div>
                                                <div className="flex gap-2 z-10">
                                                    <button onClick={()=>toggleActive(p)} className={`p-2 rounded ${p.active?'text-green-500':'text-red-500'}`}>{p.active?<Eye size={16}/>:<EyeOff size={16}/>}</button>
                                                    <button onClick={()=>{
                                                        setForm({
                                                            id: p.id,
                                                            name: p.name || '', 
                                                            price: p.price || 0,
                                                            cat: p.cat || '',
                                                            img: p.img || '',
                                                            desc: p.desc || '',
                                                            ingredients: p.ingredients || '',
                                                            isComplement: p.isComplement || false,
                                                            active: p.active !== undefined ? p.active : true
                                                        }); 
                                                        setModal(true);
                                                    }} className="text-blue-500 p-2 rounded"><Edit size={16}/></button>
                                                    <button onClick={()=>remove(p.id)} className="text-red-600 p-2 rounded"><Trash2 size={16}/></button>
                                                </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}

                    {modal && (
                        <div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4">
                            <div className="card w-full max-w-lg bg-[var(--bg-card)] p-6">
                                <h3 className="text-[var(--text-main)] font-bold mb-4">{form.id?'EDITAR':'NUEVO'} PRODUCTO</h3>
                                <div className="grid grid-cols-2 gap-2 mb-4">
                                    <input className="input-std" placeholder="Nombre" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})}/>
                                    <input className="input-std" type="number" placeholder="Precio" value={form.price||''} onChange={e=>setForm({...form,price:parseFloat(e.target.value)})}/>
                                    <input className="input-std" placeholder="Categor√≠a" value={form.cat||''} onChange={e=>setForm({...form,cat:e.target.value})}/>
                                    <div className="flex gap-1">
                                        <input className="input-std" placeholder="URL Imagen" value={form.img||''} onChange={e=>setForm({...form,img:e.target.value})}/>
                                        <label className="btn-gold cursor-pointer flex items-center justify-center"><Image size={16}/><input type="file" hidden accept="image/*" onChange={handleImageUpload}/></label>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 mb-2">
                                    <input type="checkbox" checked={form.isComplement} onChange={e=>setForm({...form, isComplement:e.target.checked})}/>
                                    <span className="text-[var(--text-main)] text-sm">¬øEs un complemento? (Aparecer√° al pagar)</span>
                                </div>
                                <input className="input-std mb-2" placeholder="Ingredientes (Separa por comas)" value={form.ingredients||''} onChange={e=>setForm({...form,ingredients:e.target.value})}/>
                                <textarea className="input-std mb-4" placeholder="Descripci√≥n" value={form.desc||''} onChange={e=>setForm({...form,desc:e.target.value})}/>
                                <div className="flex justify-end gap-2">
                                    <button onClick={()=>setModal(null)} className="text-gray-500">CANCELAR</button>
                                    <button onClick={save} className="btn-gold">GUARDAR</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const InventoryManager = ({ db, updateDB }) => {
            const [newItem, setNewItem] = useState({ name:'', stock:'', unit:'PZ', expiry:'' });
            const [editItem, setEditItem] = useState(null);
            const save = () => {
                if(editItem) { updateDB({...db, supplies: db.supplies.map(s=>s.id===editItem.id?editItem:s)}); setEditItem(null); } 
                else if(newItem.name) { updateDB({...db, supplies: [...db.supplies, {...newItem, id: generateId()}]}); setNewItem({ name:'', stock:'', unit:'PZ', expiry:'' }); }
            };
            return (
                <div className="space-y-4 overflow-y-auto h-full pb-20">
                    <div className="card p-4 border-l-4 border-green-500 flex gap-2 items-end"><div className="flex-1"><label className="text-xs text-gray-500">Insumo</label><input className="input-std" value={newItem.name} onChange={e=>setNewItem({...newItem, name:e.target.value})}/></div><div className="w-20"><label className="text-xs text-gray-500">Stock</label><input className="input-std" type="number" value={newItem.stock} onChange={e=>setNewItem({...newItem, stock:e.target.value})}/></div><div className="w-32"><label className="text-xs text-gray-500">Caducidad</label><input className="input-std" type="date" value={newItem.expiry} onChange={e=>setNewItem({...newItem, expiry:e.target.value})}/></div><button onClick={save} className="btn-gold h-[46px]"><Plus/></button></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{db.supplies.map(s => { const days = s.expiry ? Math.ceil((new Date(s.expiry) - new Date()) / 86400000) : 99; const isLow = s.stock < 5 || days < 3; return (<div key={s.id} className={`card p-4 flex justify-between items-center cursor-pointer relative group ${isLow?'border-red-500 border':''}`} onClick={()=>setEditItem(s)}><div><p className="font-bold text-[var(--text-main)]">{s.name}</p><p className={`text-xs ${days<3?'text-red-500 font-bold':'text-gray-400'}`}>Exp: {s.expiry}</p></div><div className="flex items-center gap-2"><p className="text-[var(--gold)] font-bold">{s.stock} {s.unit}</p><button onClick={(e)=>{e.stopPropagation(); updateDB({...db, supplies: db.supplies.filter(x=>x.id!==s.id)})}} className="text-red-500 hover:scale-110 z-10"><Trash2/></button></div></div>); })}</div>
                    {editItem && <div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4"><div className="card bg-[var(--bg-card)] p-6"><h3 className="font-bold mb-4 text-[var(--text-main)]">EDITAR</h3><input className="input-std mb-2" value={editItem.name} onChange={e=>setEditItem({...editItem, name:e.target.value})}/><input className="input-std mb-2" type="number" value={editItem.stock} onChange={e=>setEditItem({...editItem, stock:e.target.value})}/><input className="input-std mb-4" type="date" value={editItem.expiry} onChange={e=>setEditItem({...editItem, expiry:e.target.value})}/><div className="flex justify-end gap-2"><button onClick={()=>setEditItem(null)} className="text-gray-500">CANCELAR</button><button onClick={save} className="btn-gold">GUARDAR</button></div></div></div>}
                </div>
            );
        };

        const StaffManager = ({ db, updateDB }) => {
            const [editing, setEditing] = useState(null);
            const [mode, setMode] = useState('list');
            const [checadorUser, setChecadorUser] = useState('');
            const days = ['Lun','Mar','Mie','Jue','Vie','Sab','Dom'];

            const copyMonday = (u) => {
                const mon = u.schedule?.['Lun'];
                if(!mon) return showToast("Configura Lunes primero");
                const newSch = {};
                days.forEach(d => newSch[d] = {...mon});
                const updated = db.users.map(x=>x.id===u.id?{...x, schedule: newSch}:x);
                updateDB({...db, users:updated});
                setEditing({...editing, schedule: newSch});
            };

            const calculatePayroll = (u) => {
                const dailyRate = u.salary / 7;
                const workedDays = days.filter(d => u.schedule?.[d]?.in).length; 
                return formatCurrency(dailyRate * workedDays);
            };

            const handleCheckInOut = (u) => {
                const last = (u.attendance || []).length > 0 ? u.attendance[u.attendance.length-1] : null;
                const now = new Date();
                let newAtt;
                if(last && !last.out) {
                    newAtt = [...u.attendance];
                    newAtt[newAtt.length-1].out = now.toISOString();
                } else {
                    newAtt = [...(u.attendance || []), {in: now.toISOString(), out: null}];
                }
                updateDB({...db, users: db.users.map(x=>x.id===u.id?{...x, attendance: newAtt}:x)});
                showToast(`Registro Exitoso: ${u.name}`);
            };
            
            const handleChecadorSubmit = () => {
                const u = db.users.find(u => u.username === checadorUser);
                if(u) {
                    handleCheckInOut(u);
                    setChecadorUser('');
                } else showToast("Usuario no encontrado");
            };

            const deleteUser = (id) => {
                if(confirm("¬øEliminar empleado?")) {
                    updateDB({...db, users: db.users.filter(u=>u.id!==id)});
                    setEditing(null);
                }
            };

            const printSchedule = (u) => {
                const sched = days.map(d=>`${d}: ${u.schedule?.[d]?.in||'-'} - ${u.schedule?.[d]?.out||'-'}`).join('<br>');
                const att = (u.attendance || []).map(a=>`${new Date(a.in).toLocaleDateString()}: ${new Date(a.in).toLocaleTimeString()} - ${a.out?new Date(a.out).toLocaleTimeString():'...'}`).join('<br>');
                printTicket(`<b>${u.name}</b><br><hr>HORARIO:<br>${sched}<br><hr>ASISTENCIA:<br>${att}`);
            };

            if(mode === 'checador') return (
                <div className="h-full flex flex-col items-center justify-center p-6">
                    <h2 className="text-3xl font-brand text-[var(--gold)] mb-8">RELOJ CHECADOR</h2>
                    <div className="card p-8 w-full max-w-md bg-[var(--bg-card)] text-center">
                        <QrCode size={128} className="mx-auto mb-4 text-white"/>
                        <p className="mb-4 text-gray-400">Ingresa tu usuario para registrar entrada/salida</p>
                        <input className="input-std text-center mb-4 text-xl uppercase" placeholder="USUARIO" value={checadorUser} onChange={e=>setChecadorUser(e.target.value)}/>
                        <button onClick={handleChecadorSubmit} className="btn-gold w-full text-xl shadow-lg">REGISTRAR</button>
                    </div>
                    <button onClick={()=>setMode('list')} className="mt-8 text-gray-500 underline">Volver a Lista</button>
                </div>
            );

            return (
                <div className="space-y-6 overflow-y-auto h-full pb-20">
                      <div className="flex justify-between items-center mb-4">
                        <button onClick={()=>setEditing({name:'', role:'cajero', username:'', password:'', schedule:{}, salary:0})} className="btn-gold">AGREGAR EMPLEADO</button>
                        <button onClick={()=>setMode('checador')} className="bg-blue-600 text-white px-4 py-2 rounded font-bold flex gap-2"><Clock/> CHECADOR</button>
                      </div>
                      
                      <div className="overflow-x-auto">
                          <table className="w-full text-left text-sm text-[var(--text-main)]">
                              <thead><tr className="border-b border-[var(--border)]"><th className="p-2">Nombre</th><th className="p-2 w-full text-center">Horario / Progreso</th><th className="p-2">N√≥mina</th><th className="p-2">Acci√≥n</th></tr></thead>
                              <tbody>
                                  {db.users.filter(u=>u.role!=='admin').map(u=>{
                                      const attendance = u.attendance || [];
                                      const last = attendance.length > 0 ? attendance[attendance.length-1] : null;
                                      const isWorking = last && !last.out;
                                      const startTime = isWorking ? new Date(last.in).toLocaleTimeString() : '';
                                      return (
                                      <tr key={u.id} className="border-b border-[var(--border)] hover:bg-[var(--input-bg)] cursor-pointer" onClick={()=>setEditing(u)}>
                                          <td className="p-2 font-bold whitespace-nowrap">{u.name}<br/><span className="text-xs text-gray-500">{u.role}</span></td>
                                          <td className="p-2">
                                              <div className="flex flex-col gap-1">
                                                  <div className="grid grid-cols-7 gap-1">
                                                      {days.map(d=><div key={d} className={`h-6 rounded flex items-center justify-center text-[10px] text-white ${u.schedule?.[d] ? 'bg-green-600' : 'bg-[#333]'}`}>{d[0]}</div>)}
                                                  </div>
                                                  {isWorking && (
                                                      <div className="w-full bg-[#333] h-4 rounded mt-1 relative overflow-hidden">
                                                          <div className="absolute top-0 left-0 h-full bg-yellow-500 animate-pulse w-full"></div>
                                                          <span className="absolute inset-0 flex items-center justify-center text-[10px] text-black font-bold">TRABAJANDO DESDE {startTime}</span>
                                                      </div>
                                                  )}
                                              </div>
                                          </td>
                                          <td className="p-2 font-mono">{calculatePayroll(u)}</td>
                                          <td className="p-2"><button onClick={(e)=>{e.stopPropagation(); printSchedule(u);}} className="text-[var(--gold)]"><Printer size={16}/></button></td>
                                      </tr>
                                  )})}
                              </tbody>
                          </table>
                      </div>

                      {editing && (
                          <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                              <div className="card w-full max-w-4xl bg-[var(--bg-card)] p-6 max-h-[90vh] overflow-y-auto">
                                  <h3 className="font-bold text-xl mb-4 text-[var(--text-main)]">{editing.id ? 'EDITAR' : 'NUEVO'} EMPLEADO</h3>
                                  <div className="grid grid-cols-4 gap-4 mb-4">
                                      <input className="input-std" placeholder="Nombre" value={editing.name} onChange={e=>setEditing({...editing, name:e.target.value})}/>
                                      <input className="input-std" placeholder="Usuario" value={editing.username} onChange={e=>setEditing({...editing, username:e.target.value})}/>
                                      <input className="input-std" placeholder="Contrase√±a" value={editing.password} onChange={e=>setEditing({...editing, password:e.target.value})}/>
                                      <select className="input-std" value={editing.role} onChange={e=>setEditing({...editing, role:e.target.value})}><option value="cajero">Cajero</option><option value="cocina">Cocina</option><option value="repartidor">Repartidor</option></select>
                                  </div>
                                  <div className="flex gap-4 mb-2 items-center">
                                      <div className="w-32"><label className="text-xs text-gray-500">Sueldo Semanal</label><input type="number" className="input-std" value={editing.salary} onChange={e=>setEditing({...editing, salary:parseFloat(e.target.value)})}/></div>
                                      <button onClick={()=>copyMonday(editing)} className="bg-blue-600 text-white px-4 py-2 rounded text-xs font-bold flex gap-2"><Copy size={14}/> COPIAR LUNES A SEMANA</button>
                                  </div>
                                  
                                  <div className="grid grid-cols-7 gap-2 mb-6">
                                      {days.map(d=>(
                                          <div key={d} className="bg-[#222] p-2 rounded text-center border border-[#333]">
                                              <p className="text-[var(--gold)] font-bold text-xs mb-1">{d}</p>
                                              <input className="bg-black text-white w-full text-xs text-center mb-1 border border-[#333]" placeholder="Entrada" value={editing.schedule?.[d]?.in||''} onChange={e=>setEditing({...editing, schedule:{...editing.schedule, [d]:{...(editing.schedule?.[d]||{}), in:e.target.value}}})}/>
                                              <input className="bg-black text-white w-full text-xs text-center border border-[#333]" placeholder="Salida" value={editing.schedule?.[d]?.out||''} onChange={e=>setEditing({...editing, schedule:{...editing.schedule, [d]:{...(editing.schedule?.[d]||{}), out:e.target.value}}})}/>
                                          </div>
                                      ))}
                                  </div>
                                  
                                  <div className="mb-4 bg-[#222] p-2 rounded">
                                      <p className="text-xs font-bold mb-1 text-white">Editar √öltimo Registro (Admin)</p>
                                      <div className="flex gap-2">
                                            <input type="datetime-local" className="input-std text-xs" value={(editing.attendance || []).length > 0 ? new Date(editing.attendance[editing.attendance.length-1].in).toISOString().slice(0,16) : ''} onChange={(e)=>{
                                                const newAtt = [...(editing.attendance || [])];
                                                if(newAtt.length > 0) newAtt[newAtt.length-1].in = new Date(e.target.value).toISOString();
                                                setEditing({...editing, attendance: newAtt});
                                            }}/>
                                            <input type="datetime-local" className="input-std text-xs" value={(editing.attendance || []).length > 0 && editing.attendance[editing.attendance.length-1].out ? new Date(editing.attendance[editing.attendance.length-1].out).toISOString().slice(0,16) : ''} onChange={(e)=>{
                                                const newAtt = [...(editing.attendance || [])];
                                                if(newAtt.length > 0) newAtt[newAtt.length-1].out = new Date(e.target.value).toISOString();
                                                setEditing({...editing, attendance: newAtt});
                                            }}/>
                                      </div>
                                  </div>

                                  <div className="flex justify-between">
                                      {editing.id && <button onClick={()=>deleteUser(editing.id)} className="text-red-500 font-bold border border-red-500 p-2 rounded">ELIMINAR USUARIO</button>}
                                      <div className="flex gap-2">
                                          <button onClick={()=>setEditing(null)} className="text-gray-500">CANCELAR</button>
                                          <button onClick={()=>{
                                              let users = [...db.users];
                                              if(editing.id) users = users.map(u=>u.id===editing.id?editing:u);
                                              else users.push({...editing, id:generateId()});
                                              updateDB({...db, users}); setEditing(null);
                                          }} className="btn-gold">GUARDAR CAMBIOS</button>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      )}
                </div>
            );
        };

        const CouponManager = ({ db, updateDB }) => {
            const [coup, setCoup] = useState({ code:'', val:'', type:'percent', limit:100 });
            return (
                <div className="space-y-4">
                    <div className="card p-6"><div className="flex gap-2"><input className="input-std uppercase" placeholder="CODIGO" value={coup.code} onChange={e=>setCoup({...coup, code:e.target.value})}/><select className="input-std w-32" value={coup.type} onChange={e=>setCoup({...coup, type:e.target.value})}><option value="percent">% Desc</option><option value="amount">$ Desc</option><option value="shipping">Env√≠o Gratis</option></select><input className="input-std w-20" type="number" placeholder="L√≠mite" value={coup.limit} onChange={e=>setCoup({...coup, limit:e.target.value})}/>{coup.type !== 'shipping' && <input className="input-std w-24" type="number" placeholder="Valor" value={coup.val} onChange={e=>setCoup({...coup, val:e.target.value})}/>}<button onClick={()=>{if(!coup.code) return; updateDB({...db, coupons: [...db.coupons, {...coup, id:generateId()}]});}} className="btn-gold flex-1">CREAR</button></div></div>
                    <div className="space-y-2">{db.coupons.map(c => <div key={c.id} className="card p-4 flex justify-between items-center border-l-4 border-purple-500"><div><p className="font-bold text-xl text-[var(--text-main)]">{c.code}</p><p className="text-gray-500 text-sm">{c.type==='shipping'?'ENV√çO GRATIS':`-${c.val}${c.type==='percent'?'%':'$'}`} (Disponibles: {c.limit})</p></div><button onClick={()=>updateDB({...db, coupons: db.coupons.filter(x=>x.id!==c.id)})} className="text-red-500"><Trash2/></button></div>)}</div>
                </div>
            );
        };
        const SettingsManager = ({ db, updateDB }) => {
            const [notif, setNotif] = useState('');
            const [target, setTarget] = useState('all');
            const [tabItem, setTabItem] = useState({min:'', max:'', price:''});
            const [newItem, setNewItem] = useState({prov:'', plat:''});
            
            const sendPush = () => {
                if(!notif) return showToast("Escribe un mensaje");
                const newNotif = { id: Date.now(), message: notif, target };
                updateDB({...db, settings: {...db.settings, notification: newNotif}});
                playSound();
                showToast(`Notificaci√≥n enviada: ${notif}`);
                setNotif('');
            };

            const handleCSV = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = ev => {
                        const lines = ev.target.result.split('\n').slice(1);
                        const table = lines.map(l=>{
                             const [min,max,price] = l.split(',');
                             return min ? {min:parseFloat(min), max:parseFloat(max), price:parseFloat(price)} : null;
                        }).filter(Boolean);
                        updateDB({...db, settings:{...db.settings, deliveryTable: table}});
                    };
                    r.readAsText(f);
                }
            };

            const addItem = (list, val) => { if(val) { updateDB({...db, settings: {...db.settings, [list]: [...(db.settings[list]||[]), val]}}); setNewItem({...newItem, [list==='providers'?'prov':'plat']: ''}); }};
            const delItem = (list, idx) => { const n = [...db.settings[list]]; n.splice(idx,1); updateDB({...db, settings: {...db.settings, [list]: n}}); };

            const addRate = () => {
                if(tabItem.price){
                    const newTable = [...db.settings.deliveryTable, {
                        min: parseFloat(tabItem.min), 
                        max: parseFloat(tabItem.max), 
                        price: parseFloat(tabItem.price)
                    }].sort((a,b)=>a.min-b.min);
                    updateDB({...db, settings:{...db.settings, deliveryTable: newTable}}); 
                    setTabItem({min:'',max:'',price:''});
                }
            };

            const updateRadius = (val) => {
                 updateDB({...db, settings: {...db.settings, deliveryRadius: parseInt(val)}});
            };

            // CORRECCI√ìN: 'overflow-y-auto' a√±adido al contenedor principal para scroll general
            return (
                <div className="h-full flex flex-col gap-4 overflow-y-auto pb-32">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="card p-4 border-l-4 border-purple-500 bg-[var(--bg-card)]">
                            <h3 className="font-bold mb-2 flex gap-2 text-[var(--text-main)]"><Bell/> NOTIFICACIONES</h3>
                            <div className="flex gap-2">
                                <select className="input-std w-40" value={target} onChange={e=>setTarget(e.target.value)}>
                                    <option value="all">TODOS</option>
                                    <option value="kitchen">COCINA</option>
                                    <option value="delivery">REPARTIDORES</option>
                                    <option value="cashier">CAJA</option>
                                </select>
                                <input className="input-std" placeholder="Mensaje..." value={notif} onChange={e=>setNotif(e.target.value)}/>
                                <button onClick={sendPush} className="btn-gold px-6">ENVIAR</button>
                            </div>
                            <p className="text-xs text-gray-500 mt-2">* Esto mostrar√° una alerta en pantalla completa a los usuarios seleccionados.</p>
                        </div>
                        
                        {/* CORRECCI√ìN: Indicador de KM claro y visible al mover */}
                        <div className="card p-4 border-l-4 border-[var(--gold)] bg-[var(--bg-card)]">
                            <h3 className="font-bold mb-2 flex gap-2 text-[var(--text-main)]"><MapPin/> ZONA DE REPARTO</h3>
                            <div className="flex flex-col gap-2 mb-4">
                                <div className="flex justify-between items-center">
                                    <span className="text-[var(--text-main)] text-sm font-bold">Cobertura Actual:</span>
                                    <span className="text-[var(--gold)] text-xl font-black bg-black/50 px-3 py-1 rounded">{db.settings.deliveryRadius} KM</span>
                                </div>
                                <input type="range" min="1" max="50" step="1" value={db.settings.deliveryRadius} onChange={(e)=>updateRadius(e.target.value)} className="w-full h-4 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[var(--gold)]"/>
                                <div className="flex justify-between text-[10px] text-gray-500"><span>1 km</span><span>25 km</span><span>50 km</span></div>
                            </div>
                            <div className="h-64 rounded border border-gray-600 overflow-hidden relative">
                                <LeafletMap center={STORE_COORDS} markers={[{pos:STORE_COORDS, emoji:'üè™', isStore:true}]} zoom={11} radius={db.settings.deliveryRadius} />
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="card p-4 border-t-4 border-blue-500 space-y-4">
                            <h3 className="font-bold flex gap-2 text-[var(--text-main)]"><Globe/> WEB & PAGOS</h3>
                            <div className="flex justify-between items-center bg-[#222] p-3 rounded"><div><p className="text-white text-sm font-bold">Estado Tienda</p></div><button onClick={()=>updateDB({...db, settings: {...db.settings, storeOpen: !db.settings.storeOpen}})} className={`px-4 py-1 rounded font-black text-xs uppercase ${db.settings.storeOpen?'bg-green-500 text-black':'bg-red-500 text-white'}`}>{db.settings.storeOpen?'ABIERTA':'CERRADA'}</button></div>
                            <div className="bg-[#222] p-3 rounded space-y-2">
                                <p className="text-white text-sm font-bold">M√©todos de Pago Web</p>
                                <div className="flex justify-between items-center"><span className="text-gray-400 text-xs">Efectivo</span><button onClick={()=>updateDB({...db, settings:{...db.settings, paymentMethods:{...db.settings.paymentMethods, cash:!db.settings.paymentMethods.cash}}})} className={`w-8 h-4 rounded-full relative ${db.settings.paymentMethods.cash?'bg-green-500':'bg-gray-600'}`}><div className={`w-2 h-2 bg-white rounded-full absolute top-1 ${db.settings.paymentMethods.cash?'right-1':'left-1'}`}></div></button></div>
                                <div className="flex justify-between items-center"><span className="text-gray-400 text-xs">Tarjeta</span><button onClick={()=>updateDB({...db, settings:{...db.settings, paymentMethods:{...db.settings.paymentMethods, card:!db.settings.paymentMethods.card}}})} className={`w-8 h-4 rounded-full relative ${db.settings.paymentMethods.card?'bg-green-500':'bg-gray-600'}`}><div className={`w-2 h-2 bg-white rounded-full absolute top-1 ${db.settings.paymentMethods.card?'right-1':'left-1'}`}></div></button></div>
                                <div className="flex justify-between items-center"><span className="text-gray-400 text-xs">Permitir Recoger</span><button onClick={()=>updateDB({...db, settings: {...db.settings, pickupEnabled: !db.settings.pickupEnabled}})} className={`w-8 h-4 rounded-full relative ${db.settings.pickupEnabled?'bg-green-500':'bg-gray-600'}`}><div className={`w-2 h-2 bg-white rounded-full absolute top-1 ${db.settings.pickupEnabled?'right-1':'left-1'}`}></div></button></div>
                                <div className="flex justify-between items-center"><span className="text-gray-400 text-xs">Permitir Domicilio</span><button onClick={()=>updateDB({...db, settings: {...db.settings, deliveryEnabled: !db.settings.deliveryEnabled}})} className={`w-8 h-4 rounded-full relative ${db.settings.deliveryEnabled!==false?'bg-green-500':'bg-gray-600'}`}><div className={`w-2 h-2 bg-white rounded-full absolute top-1 ${db.settings.deliveryEnabled!==false?'right-1':'left-1'}`}></div></button></div>
                            </div>
                        </div>
                        <div className="card p-4 border-t-4 border-[var(--gold)] space-y-4">
                            <h3 className="font-bold mb-2 text-[var(--text-main)]"><Lock/> SEGURIDAD & LISTAS</h3>
                            <div><label className="text-xs text-gray-500">Clave Supervisor (QR)</label><div className="bg-white p-2 mt-2 w-fit rounded"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=SUPERVISOR:${db.settings.supervisorKey}`} className="w-24 h-24"/></div><input className="input-std text-sm mt-2" value={db.settings.supervisorKey} onChange={e=>updateDB({...db, settings:{...db.settings, supervisorKey:e.target.value}})}/></div>
                            <hr className="border-[#333]"/>
                            <div><p className="text-[var(--text-main)] text-xs font-bold mb-1">PLATAFORMAS</p><div className="flex gap-1 mb-2"><input className="input-std text-xs" value={newItem.plat} onChange={e=>setNewItem({...newItem, plat:e.target.value})}/><button onClick={()=>addItem('platforms',newItem.plat)} className="btn-gold">+</button></div><div className="h-24 overflow-y-auto bg-[#222] p-2 rounded custom-scroll">{db.settings.platforms.map((p,i)=><div key={i} className="flex justify-between text-gray-400 text-xs border-b border-[#333] py-1"><span>{p}</span><button onClick={()=>delItem('platforms',i)} className="text-red-500">x</button></div>)}</div></div>
                        </div>
                        
                        {/* TABLA DE PRECIOS AL FINAL CON SCROLL VISIBLE */}
                        <div className="card p-4 border-t-4 border-green-500 flex flex-col h-80">
                            <div className="flex justify-between items-center mb-2"><h3 className="text-white font-bold flex gap-2"><Table/> TABULADOR ENV√çOS</h3><label className="text-[10px] text-blue-400 cursor-pointer">Cargar CSV<input type="file" hidden onChange={handleCSV}/></label></div>
                            <div className="flex gap-1 mb-2 bg-[#222] p-1 rounded"><input className="bg-transparent text-white text-xs w-12 border-b border-[#444] text-center" placeholder="Min" type="number" value={tabItem.min} onChange={e=>setTabItem({...tabItem, min:e.target.value})}/><input className="bg-transparent text-white text-xs w-12 border-b border-[#444] text-center" placeholder="Max" type="number" value={tabItem.max} onChange={e=>setTabItem({...tabItem, max:e.target.value})}/><input className="bg-transparent text-white text-xs w-12 border-b border-[#444] text-center" placeholder="$" type="number" value={tabItem.price} onChange={e=>setTabItem({...tabItem, price:e.target.value})}/><button className="text-green-500 font-bold px-2" onClick={addRate}>+</button></div>
                            <div className="flex-1 bg-[#222] rounded overflow-y-auto p-2 space-y-1 custom-scroll">{db.settings.deliveryTable.map((r,i)=><div key={i} className="flex justify-between text-xs text-gray-300 border-b border-[#333] pb-1"><span>{r.min} - {r.max} KM</span><span className="text-[var(--gold)] font-bold">${r.price}</span></div>)}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const TicketPreview = ({ db, updateDB }) => {
            const [header, setHeader] = useState(db.settings.ticketConfig.header);
            const [footer, setFooter] = useState(db.settings.ticketConfig.footer);
            const saveConfig = () => { updateDB({...db, settings: {...db.settings, ticketConfig: { header, footer }}}); showToast("Guardado"); };
            
            const generateHTML = (type) => {
                 const base = `<div class="center bold"><img src="${LOGO_URL}" style="width:50px;display:block;margin:0 auto 10px;">${header.replace(/\n/g, '<br>')}</div><hr>`;
                const end = `<hr><div class="center">${footer.replace(/\n/g, '<br>')}</div>`;
                const date = new Date().toLocaleString();
                if(type === 'sale') return `${base}<div class="center">VENTA #1234</div><div class="center">${date}</div><hr><div>1x Burger Cl√°sica ... $95</div><div>1x Papas ........... $55</div><hr><div class="bold right">TOTAL: $150</div>${end}`;
                if(type === 'cut') return `${base}<div class="center bold">CORTE DE CAJA</div><div class="center">${date}</div><hr><div>Fondo Inicial: $1,000</div><div>+ Ventas Efec: $2,500</div><div>- Gastos/Retiros: $500</div><hr><div class="bold right">TOTAL EN CAJA: $3,000</div><br><br><div class="center">_______________________<br>Firma Cajera</div>${end}`;
                if(type === 'driver_liq') return `${base}<div class="center bold">LIQUIDACI√ìN DRIVER</div><div class="center">Juan Moto</div><hr><div>Pedidos Entregados: 5</div><div>Total Cobrado: $800</div><div>Ganancia Env√≠os: -$150</div><hr><div class="bold right">A ENTREGAR: $650</div><br><br><div class="center">_______________________<br>Firma Driver</div>${end}`;
                if(type === 'platform') return `${base}<div class="center">PLATAFORMA (UBER)</div><div class="center">#9999</div><div class="center">${date}</div><hr><div>1x Burger ... $95</div><div class="bold right">TOTAL: $95</div>${end}<br><br>‚úÇÔ∏è --- CORTE AQU√ç ---<br><br>${base}<div class="center">COPIA CLIENTE/DRIVER</div><div class="center">${date}</div><hr><div>1x Burger ... $0.00</div><div class="bold right">TOTAL A PAGAR: $0.00</div><div class="center">PROPINAS NO INCLUIDAS</div>${end}`;
                return "";
            };

            const printDirect = (type) => printTicket(generateHTML(type));

            return (
                <div className="h-full overflow-y-auto pb-20">
                    <div className="card p-6 mb-4">
                        <h3 className="font-bold text-[var(--gold)] mb-4 flex gap-2"><Printer/> CONFIGURACI√ìN TICKETS</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label className="text-xs text-gray-500">Cabecera</label><textarea className="input-std h-24" value={header} onChange={e=>setHeader(e.target.value)}/></div>
                            <div><label className="text-xs text-gray-500">Pie de P√°gina</label><textarea className="input-std h-24" value={footer} onChange={e=>setFooter(e.target.value)}/></div>
                        </div>
                        <button onClick={saveConfig} className="btn-gold w-full">GUARDAR CAMBIOS</button>
                    </div>
                    <div className="card p-6">
                        <h3 className="font-bold text-white mb-4">VISTA PREVIA Y PRUEBA</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            {['sale','cut','driver_liq','platform'].map(t => (
                                <div key={t} className="bg-white text-black p-2 rounded text-xs font-mono border border-gray-300 relative group">
                                    <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition"><button onClick={()=>printDirect(t)} className="bg-black text-white p-1 rounded"><Printer size={16}/></button></div>
                                    <div dangerouslySetInnerHTML={{__html: generateHTML(t)}} />
                                    <button onClick={()=>printDirect(t)} className="w-full bg-[var(--gold)] mt-2 py-1 font-bold rounded">IMPRIMIR</button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ db, updateDB }) => {
            const [tab, setTab] = useState('dash');
            return (
                <div className="h-full flex flex-col bg-[var(--bg-body)]">
                    <div className="flex gap-2 p-4 bg-[var(--bg-card)] border-b border-[var(--border)] overflow-x-auto scroll-hide">
                        {['dash','menu','inv','staff','coup','conf','tickets'].map(t => <button key={t} onClick={()=>setTab(t)} className={`px-4 py-2 rounded font-bold uppercase whitespace-nowrap ${tab===t?'bg-[var(--gold)] text-black':'text-gray-500 bg-[#222]'}`}>{t}</button>)}
                    </div>
                    <div className="flex-1 p-6 overflow-hidden">
                        {tab==='dash' && <Dashboard db={db}/>}
                        {tab==='menu' && <ProductManager db={db} updateDB={updateDB}/>}
                        {tab==='inv' && <InventoryManager db={db} updateDB={updateDB}/>}
                        {tab==='staff' && <StaffManager db={db} updateDB={updateDB}/>}
                        {tab==='coup' && <CouponManager db={db} updateDB={updateDB}/>}
                        {tab==='conf' && <SettingsManager db={db} updateDB={updateDB}/>}
                        {tab==='tickets' && <TicketPreview db={db} updateDB={updateDB}/>}
                    </div>
                </div>
            );
        };

const POS = ({ db, updateDB, user }) => {
            const [cart, setCart] = useState([]);
            const [modal, setModal] = useState(null); 
            const [catFilter, setCatFilter] = useState('Todos');
            const [orderType, setOrderType] = useState('takeaway'); 
            const [orderDetails, setOrderDetails] = useState({ name:'', phone:'', address:'', references:'', table:'', platform:'', platformOrderId:'', refs:'' });
            const [payMethod, setPayMethod] = useState('cash');
            const [cashReceived, setCashReceived] = useState(0);
            const [voucher, setVoucher] = useState('');
            const [deliveryCoords, setDeliveryCoords] = useState(null);
            const [couponCode, setCouponCode] = useState('');
            const [discount, setDiscount] = useState(0);
            const [addressTimer, setAddressTimer] = useState(null);
            const [isLocating, setIsLocating] = useState(false);
            const [bottomMenuOpen, setBottomMenuOpen] = useState(false);
            
            // Modales
            const [liquidationModal, setLiquidationModal] = useState(false);
            const [corteModal, setCorteModal] = useState(false);
            const [retiroModal, setRetiroModal] = useState(false);
            
            const [driverToLiq, setDriverToLiq] = useState(null);
            const [liqSummary, setLiqSummary] = useState(null);
            const [newExpense, setNewExpense] = useState({desc:'', amount:''});
            const [suggestions, setSuggestions] = useState([]);
            const [manualDriverId, setManualDriverId] = useState('');
            const [viewMap, setViewMap] = useState(false); 
            const [viewReadyOrders, setViewReadyOrders] = useState(false); 
            const [ingredientsProduct, setIngredientsProduct] = useState(null);
            const [paymentStatus, setPaymentStatus] = useState(''); 
            
            const [selectedReady, setSelectedReady] = useState([]);
            const [viewGroupMap, setViewGroupMap] = useState(null);
            const [selectedWebOrder, setSelectedWebOrder] = useState(null); 
            // 2. NUEVO ESTADO PARA VER GRUPO EN GRANDE
            const [selectedGroup, setSelectedGroup] = useState(null);

            const [countedCash, setCountedCash] = useState('');
            const [countedCard, setCountedCard] = useState('');
            const [cutResult, setCutResult] = useState(null);
            
            const [deliveryFilter, setDeliveryFilter] = useState('all');
            const [typeFilter, setTypeFilter] = useState('all');

            const uniqueCategories = ['Todos', ...new Set(db.products.filter(p=>p.active).map(p => p.cat).filter(Boolean))];

            const webOrders = db.orders.filter(o => o.source === 'web' && o.status === 'web_pending_payment');
            const readyOrders = db.orders.filter(o => o.status === 'ready' && o.address !== 'RECOGER' && !o.groupId);
            const uniqueGroups = [...new Set(db.orders.filter(o => o.groupId && o.status === 'ready').map(o => o.groupId))];

            const activeOrders = db.orders.filter(o => o.status === 'delivering' || o.status === 'pending');
            const drivers = db.users.filter(u => u.role === 'repartidor' && u.online);
            const liveMarkers = [
                { pos: STORE_COORDS, emoji: 'üè™' },
                ...activeOrders.map(o => ({ pos: o.clientLoc || STORE_COORDS, emoji: 'üçî', popup: `Pedido #${o.orderNum}` })),
                ...drivers.map(d => ({ pos: d.location || STORE_COORDS, emoji: 'üèçÔ∏è', label: d.name, type: 'driver' }))
            ];

            const handleWebOrder = (order) => {
                setCart(order.items);
                setOrderDetails({
                    name: order.clientName, 
                    phone: order.clientPhone || '', 
                    address: order.address.split('(')[0].trim(), 
                    references: order.address.split('(')[1]?.replace(')', '') || '', 
                    table: '', platform: '', platformOrderId: '', refs: ''
                });
                setOrderType(order.address === 'RECOGER' ? 'takeaway' : 'delivery');
                setDeliveryCoords(order.clientLoc);
                setModal('cockpit');
                updateDB({...db, orders: db.orders.filter(o=>o.id!==order.id)}); 
            };
            
            const cancelWebOrder = (id) => { 
                updateDB({...db, orders: db.orders.map(o => o.id === id ? {...o, status: 'cancelled'} : o)});
                showToast("Pedido Cancelado");
                setSelectedWebOrder(null);
            };

            const deliveryFee = useMemo(() => {
                if(orderType !== 'delivery' || !deliveryCoords) return 0;
                const dist = calculateDistance(STORE_COORDS[0], STORE_COORDS[1], deliveryCoords[0], deliveryCoords[1]);
                return getDeliveryPrice(dist, db.settings.deliveryTable);
            }, [orderType, deliveryCoords, db.settings.deliveryTable]);

            const subtotal = cart.reduce((a,b)=>a+b.price*b.qty,0);
            const total = subtotal + deliveryFee - discount;

            const updateLocationFromAddress = (addr) => {
                setOrderDetails(prev => ({...prev, address: addr}));
                if (addressTimer) clearTimeout(addressTimer);
                setAddressTimer(setTimeout(async () => {
                    if(addr.length > 3) {
                        setIsLocating(true);
                        try {
                            const query = `${addr} ${CITY_SUFFIX}`;
                            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`);
                            const data = await res.json();
                            setSuggestions(data);
                            if(data && data.length > 0) {
                                setDeliveryCoords([parseFloat(data[0].lat), parseFloat(data[0].lon)]);
                            }
                        } catch(e) { console.error("Geocoding error", e); }
                        setIsLocating(false);
                    } else { setSuggestions([]); }
                }, 800)); 
            };
            
            const handleReverseGeo = async (coords) => {
                setDeliveryCoords(coords);
                setIsLocating(true);
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords[0]}&lon=${coords[1]}`);
                    const data = await res.json();
                    if(data && data.display_name) {
                        const addrParts = data.display_name.split(',');
                        setOrderDetails(prev => ({...prev, address: addrParts[0] + (addrParts[1]||'')}));
                        setSuggestions([]);
                    }
                } catch(e) {}
                setIsLocating(false);
            };

            const useGPS = () => {
                setIsLocating(true);
                navigator.geolocation.getCurrentPosition(pos => {
                    handleReverseGeo([pos.coords.latitude, pos.coords.longitude]);
                }, () => setIsLocating(false));
            };

            const applyCoupon = () => {
                const c = db.coupons.find(x => x.code.trim().toUpperCase() === couponCode.trim().toUpperCase());
                if(c && c.limit > (c.used || 0)) { 
                    if(c.type === 'shipping') setDiscount(deliveryFee);
                    else if(c.type === 'percent') setDiscount(subtotal * c.val / 100);
                    else setDiscount(c.val);
                    showToast("Cup√≥n Aplicado");
                } else showToast("Cup√≥n Inv√°lido o Agotado");
            };

            const addToCart = (p) => setCart(prev => {
                const ex = prev.find(i => i.id === p.id);
                return ex ? prev.map(i => i.id === p.id ? {...i, qty: i.qty + 1} : i) : [...prev, {...p, qty: 1}];
            });

            const removeFromCart = (idx) => { const newCart = [...cart]; newCart.splice(idx, 1); setCart(newCart); };
            const updateCartNote = (idx, note) => { const newCart = [...cart]; newCart[idx].note = note; setCart(newCart); };
            const switchPayMethod = (method) => { setPayMethod(method); setPaymentStatus(''); };
            
            const handleScanDriver = (scannedData) => {
                if(scannedData.startsWith("LIQ:")) {
                    const driverId = scannedData.split(':')[1];
                    const driver = db.users.find(u => u.id === driverId);
                    if(driver) {
                        const deliveredOrders = db.orders.filter(o => o.driver === driver.username && o.status === 'delivered' && !o.settled);
                        const totalCash = driver.cashOnHand || 0;
                        const totalEarnings = deliveredOrders.reduce((acc, o) => acc + (o.driverFee || 0), 0);
                        const netToPay = totalCash - totalEarnings;
                        setDriverToLiq(driver);
                        setLiqSummary({ deliveredOrders, totalCash, totalEarnings, netToPay });
                    } else showToast("Repartidor no encontrado");
                }
            };

            const confirmLiquidation = () => {
                if(!driverToLiq || !liqSummary) return;
                updateDB({
                    ...db,
                    users: db.users.map(u => u.id === driverToLiq.id ? {...u, cashOnHand: 0} : u),
                    orders: db.orders.map(o => liqSummary.deliveredOrders.find(do_ => do_.id === o.id) ? {...o, settled: true} : o),
                    cashDrawer: {...db.cashDrawer, current: db.cashDrawer.current + liqSummary.netToPay}
                });
                showToast("Liquidaci√≥n Exitosa.");
                setLiquidationModal(false); setDriverToLiq(null);
            };

            const performBlindCut = () => {
                const cCash = parseFloat(countedCash) || 0;
                const cCard = parseFloat(countedCard) || 0;
                const systemCash = db.cashDrawer.current;
                const systemCard = db.orders.filter(o => o.method === 'card' && o.status !== 'cancelled').reduce((a,b)=>a+b.total,0);
                const diffCash = systemCash - cCash; 
                setCutResult({ systemCash, systemCard, cCash, cCard, diffCash });
            };

            const finalizeOrder = () => {
                const isPayOnDelivery = orderType === 'delivery' && payMethod === 'cash' && paymentStatus === 'pending';
                if(orderType === 'delivery' && payMethod === 'cash' && paymentStatus === '') return showToast("‚ö†Ô∏è Selecciona: PAGADO EN CAJA o PAGO AL RECIBIR");
                if(payMethod === 'cash' && !isPayOnDelivery && (!cashReceived || parseFloat(cashReceived) < total)) return showToast("Monto insuficiente");
                
                if(orderType === 'delivery') {
                     if(!orderDetails.phone || orderDetails.phone.length !== 10) return showToast("Tel√©fono debe ser de 10 d√≠gitos");
                     if(!orderDetails.address) return showToast("Falta Direcci√≥n");
                }
                
                const order = {
                    id: generateId(), orderNum: Math.floor(Math.random()*9000)+1000,
                    items: cart, total, method: payMethod, status: 'pending', createdAt: new Date().toISOString(),
                    address: orderType === 'delivery' ? `${orderDetails.address} (Ref: ${orderDetails.references})` : orderType.toUpperCase(),
                    clientName: orderDetails.name || 'Cliente', clientPhone: orderDetails.phone,
                    clientLoc: orderType === 'delivery' ? deliveryCoords : null, 
                    source: orderType === 'platform' ? 'platform' : 'store',
                    platformName: orderDetails.platform, platformOrderId: orderDetails.platformOrderId,
                    driverAssignMode: db.settings.driverAssign, deliveryFee: orderType === 'delivery' ? deliveryFee : 0,
                    driver: null, settled: false,
                    paymentStatus: isPayOnDelivery ? 'pending' : 'paid' 
                };

                let newCashDrawer = db.cashDrawer.current;
                if(payMethod==='cash' && !isPayOnDelivery) newCashDrawer += total;

                updateDB({ ...db, orders: [...db.orders, order], cashDrawer: {...db.cashDrawer, current: newCashDrawer} });
                setCart([]); setModal(null); setCashReceived(0); setVoucher(''); setPaymentStatus('');
                setOrderDetails({ name:'', phone:'', address:'', references:'', table:'', platform:'', platformOrderId:'', refs:'' });
                if(isPayOnDelivery) showToast("Pedido creado. Cobro pendiente por Repartidor.");
                else showToast("Pedido creado y cobrado.");
            };
            
            const generateGroupQR = () => {
                if(selectedReady.length < 2) return showToast("Selecciona al menos 2 pedidos");
                const newGroupId = generateId(); 
                const updatedOrders = db.orders.map(o => selectedReady.includes(o.id) ? {...o, groupId: newGroupId} : o);
                updateDB({...db, orders: updatedOrders});
                setSelectedReady([]);
            };

            const undoGroup = (groupId) => {
                const updatedOrders = db.orders.map(o => o.groupId === groupId ? {...o, groupId: null} : o);
                updateDB({...db, orders: updatedOrders});
                showToast("Grupo deshecho.");
                if(selectedGroup && selectedGroup.id === groupId) setSelectedGroup(null);
            };

            const handleManualDispatch = (orders) => {
                if(confirm(`¬øDespachar ${orders.length} pedidos?`)) {
                     const updatedOrders = db.orders.map(o => orders.find(x => x.id === o.id) ? {...o, status: 'delivering'} : o);
                     updateDB({...db, orders: updatedOrders});
                     showToast("Pedidos marcados en reparto.");
                     setSelectedGroup(null);
                }
            };
            
            // --- GESTI√ìN / ENTREGA VISTA ---
            if (viewReadyOrders) {
                const filteredReadyOrders = readyOrders.filter(o => {
                    if (typeFilter === 'all') return true;
                    if (typeFilter === 'delivery' && o.address !== 'RECOGER' && o.source !== 'platform') return true;
                    if (typeFilter === 'pickup' && o.address === 'RECOGER') return true;
                    if (typeFilter === 'platform' && o.source === 'platform') return true;
                    return false;
                });

                return (
                    // 1. SCROLL FIX: 'overflow-hidden' en padre, 'overflow-y-auto' en hijo directo sin padding padre
                    <div className="h-full flex flex-col bg-[var(--bg-body)] overflow-hidden relative">
                         {/* Header Fixed */}
                         <div className="p-4 border-b border-[#333] flex flex-col gap-2 bg-[var(--bg-card)] shrink-0 z-10">
                             <div className="flex justify-between items-center">
                                 <h2 className="text-2xl font-bold text-[var(--gold)]">GESTI√ìN / ENTREGA</h2>
                                 <button onClick={()=>setViewReadyOrders(false)} className="text-gray-500 hover:text-white">Volver a Caja</button>
                             </div>
                             
                             <div className="flex flex-wrap gap-2 items-center">
                                <div className="flex bg-[#222] rounded p-1">
                                    <button onClick={()=>setDeliveryFilter('all')} className={`px-3 py-1 rounded text-[10px] font-bold ${deliveryFilter==='all'?'bg-[var(--gold)] text-black':'text-gray-400'}`}>VER TODO</button>
                                    <button onClick={()=>setDeliveryFilter('ready')} className={`px-3 py-1 rounded text-[10px] font-bold ${deliveryFilter==='ready'?'bg-green-600 text-white':'text-gray-400'}`}>LISTOS</button>
                                    <button onClick={()=>setDeliveryFilter('groups')} className={`px-3 py-1 rounded text-[10px] font-bold ${deliveryFilter==='groups'?'bg-purple-600 text-white':'text-gray-400'}`}>RUTAS</button>
                                </div>
                                <div className="w-[1px] h-6 bg-[#444]"></div>
                                <div className="flex bg-[#222] rounded p-1">
                                    <button onClick={()=>setTypeFilter('all')} className={`px-3 py-1 rounded text-[10px] font-bold ${typeFilter==='all'?'bg-blue-600 text-white':'text-gray-400'}`}>TIPOS</button>
                                    <button onClick={()=>setTypeFilter('delivery')} className={`px-3 py-1 rounded text-[10px] font-bold ${typeFilter==='delivery'?'bg-[var(--gold)] text-black':'text-gray-400'}`}>DOMICILIO</button>
                                    <button onClick={()=>setTypeFilter('pickup')} className={`px-3 py-1 rounded text-[10px] font-bold ${typeFilter==='pickup'?'bg-[var(--gold)] text-black':'text-gray-400'}`}>RECOGER</button>
                                    <button onClick={()=>setTypeFilter('platform')} className={`px-3 py-1 rounded text-[10px] font-bold ${typeFilter==='platform'?'bg-[var(--gold)] text-black':'text-gray-400'}`}>APPS</button>
                                </div>
                             </div>
                         </div>
                         
                         <div className="bg-[#222] p-3 mx-4 mt-2 rounded flex justify-between items-center shadow-lg border border-[#333] shrink-0">
                            <div><p className="text-white font-bold text-sm">Crear Ruta</p><p className="text-[10px] text-gray-400">{selectedReady.length} pedidos seleccionados</p></div>
                            <button onClick={generateGroupQR} className="bg-blue-600 text-white px-4 py-2 rounded font-bold text-xs shadow-lg animate-pulse disabled:opacity-50" disabled={selectedReady.length < 2}>GENERAR RUTA</button>
                        </div>

                         {/* SCROLL AREA (Padding interno para que scrollbar quede al borde) */}
                         <div className="flex-1 overflow-y-auto">
                             <div className="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-32">
                               {/* GRUPOS */}
                               {(deliveryFilter === 'all' || deliveryFilter === 'groups') && uniqueGroups.map(groupId => {
                                   const groupOrders = db.orders.filter(o => o.groupId === groupId);
                                   const qrData = `GROUP:${groupOrders.map(o=>o.id).join(',')}`;
                                   // 2. Click en la tarjeta abre Modal Detalles (selectedGroup)
                                   return (
                                       <div key={groupId} className="card p-4 border-l-4 border-purple-500 bg-[#2a1a2e] cursor-pointer hover:bg-[#3a2a3e] transition" onClick={() => setSelectedGroup({id: groupId, orders: groupOrders, qr: qrData})}>
                                           <div className="flex justify-between mb-2">
                                               <h3 className="font-black text-xl text-white">RUTA MAESTRA</h3>
                                               <span className="text-xs bg-purple-900 text-purple-200 px-2 rounded flex items-center">VER DETALLES</span>
                                           </div>
                                           <div className="flex gap-2 mb-2">
                                                <div className="bg-white p-1 rounded"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`} className="w-20 h-20"/></div>
                                                <div className="text-xs text-gray-400 flex-1 overflow-hidden">
                                                    {groupOrders.map(o => <p key={o.id} className="truncate">#{o.orderNum} - {o.address}</p>)}
                                                </div>
                                           </div>
                                           <div className="text-center text-[10px] text-gray-500">Click para ver Mapa Grande y QR</div>
                                       </div>
                                   );
                               })}

                               {/* INDIVIDUALES */}
                               {(deliveryFilter === 'all' || deliveryFilter === 'ready') && filteredReadyOrders.map(o => (
                                       <div key={o.id} onClick={()=>toggleSelect(o.id)} className={`card p-4 border-l-4 ${selectedReady.includes(o.id) ? 'border-[var(--gold)] bg-[#2a2a1a]' : 'border-green-500 bg-[#222]'} cursor-pointer`}>
                                               <div className="flex justify-between items-start mb-2">
                                                   <div><h3 className="font-black text-xl text-white">#{o.orderNum}</h3><p className="text-sm text-gray-300 font-bold">{o.clientName}</p></div>
                                                   {selectedReady.includes(o.id) ? <CheckCircle className="text-[var(--gold)]"/> : <span className="bg-green-900 text-green-300 text-xs px-2 py-1 rounded">LISTO</span>}
                                               </div>
                                               <div className="text-xs text-gray-400 mb-2">
                                                   <p className="truncate">{o.address}</p>
                                                   <p className="font-bold mt-1 text-[var(--accent)]">{o.address === 'RECOGER' ? 'TIENDA' : 'DOMICILIO'}</p>
                                               </div>
                                               <div className="h-32 w-full bg-gray-800 rounded mb-2 overflow-hidden relative border border-[#444] mt-2 cursor-pointer" 
                                                    onClick={(e) => { e.stopPropagation(); setViewGroupMap({route: [STORE_COORDS, o.clientLoc || STORE_COORDS], markers: [{pos: STORE_COORDS, isStore:true}, {pos: o.clientLoc || STORE_COORDS, emoji: 'üìç'}]}) }}>
                                                    <LeafletMap center={o.clientLoc || STORE_COORDS} markers={[{pos: STORE_COORDS, isStore:true}, {pos: o.clientLoc || STORE_COORDS, emoji: 'üìç'}]} route={[STORE_COORDS, o.clientLoc || STORE_COORDS]} zoom={13} />
                                               </div>
                                               <div className="bg-white p-2 rounded mb-2 w-fit mx-auto"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(`ORDER:${o.id}`)}`} className="w-24 h-24"/></div>
                                               <button onClick={(e) => { e.stopPropagation(); handleManualDispatch([o]); }} className="w-full bg-[#444] hover:bg-green-600 text-white py-2 rounded font-bold text-sm">DAR SALIDA</button>
                                       </div>
                                   ))
                               }
                             </div>
                         </div>
                         
                         {/* MODALES */}
                         {viewGroupMap && (<div className="fixed inset-0 bg-black/95 z-[6000] flex flex-col p-4 animate-in zoom-in"><div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold text-[var(--gold)]">RUTA VISUALIZADA</h2><button onClick={()=>setViewGroupMap(null)} className="text-white bg-red-600 px-4 py-2 rounded font-bold">CERRAR</button></div><div className="flex-1 rounded border border-[var(--gold)] overflow-hidden relative"><LeafletMap center={STORE_COORDS} markers={viewGroupMap.markers} route={viewGroupMap.route} zoom={13} /></div></div>)}
                         {selectedWebOrder && (<div className="fixed inset-0 bg-black/90 z-[6000] flex flex-col items-center justify-center p-4"><div className="card w-full max-w-lg bg-[#222] p-6 border-l-4 border-blue-500"><div className="flex justify-between mb-4"><h3 className="font-bold text-xl text-white">DETALLE PEDIDO WEB</h3><button onClick={()=>setSelectedWebOrder(null)}><X className="text-white"/></button></div><p className="text-[var(--gold)] text-2xl font-bold mb-2">#{selectedWebOrder.orderNum}</p><p className="text-white mb-4">{selectedWebOrder.clientName} - {selectedWebOrder.address}</p><div className="h-48 w-full bg-gray-800 rounded mb-4 overflow-hidden relative border border-[#444]"><LeafletMap center={selectedWebOrder.clientLoc || STORE_COORDS} markers={[{pos: STORE_COORDS, isStore:true}, {pos: selectedWebOrder.clientLoc || STORE_COORDS, emoji: 'üìç'}]} route={[STORE_COORDS, selectedWebOrder.clientLoc || STORE_COORDS]} zoom={13} /></div><div className="flex gap-2"><button onClick={()=>cancelWebOrder(selectedWebOrder.id)} className="flex-1 bg-red-900 text-red-300 py-3 rounded font-bold">CANCELAR</button><button onClick={()=>{ handleWebOrder(selectedWebOrder); setViewReadyOrders(false); setSelectedWebOrder(null); }} className="flex-1 bg-blue-600 text-white py-3 rounded font-bold">PROCESAR</button></div></div></div>)}
                         {webOrders.length > 0 && <div className="col-span-full mt-4 p-4"><h3 className="text-white font-bold mb-2 text-xl border-b border-blue-500 pb-1">SOLICITUDES WEB PENDIENTES</h3></div>}
                         <div className="flex-1 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 px-4 pb-20">{webOrders.map(o => (<div key={o.id} className="card p-4 border-l-4 border-blue-500 bg-[#1a1a2e] cursor-pointer hover:bg-[#2a2a3e]" onClick={()=>handleWebOrder(o)}><div className="flex justify-between"><div><p className="font-bold text-white">WEB #{o.orderNum}</p><p className="text-sm text-gray-400">{o.clientName}</p></div><p className="text-[var(--gold)] font-bold">{formatCurrency(o.total)}</p></div><div className="mt-2 text-xs text-gray-400 max-h-24 overflow-y-auto mb-2 bg-black/20 p-2 rounded">{o.items.map((i,idx) => <div key={idx}>{i.qty}x {i.name}</div>)}<div className="mt-1 text-[10px] text-yellow-500">üìç {o.address}</div></div><p className="text-center text-[10px] text-blue-300 mt-1">Tocame para ver detalles</p></div>))}</div>
                         
                         {/* 2. MODAL DETALLES DE GRUPO */}
                         {selectedGroup && (
                             <div className="fixed inset-0 bg-black/95 z-[7000] flex flex-col items-center justify-center p-4 animate-in zoom-in">
                                <div className="w-full max-w-2xl bg-[#222] border-2 border-[var(--gold)] rounded-xl overflow-hidden shadow-2xl flex flex-col h-full max-h-[80vh]">
                                    <div className="p-4 bg-[#111] flex justify-between items-center border-b border-[#333]">
                                        <h2 className="text-2xl font-black text-white">RUTA MAESTRA</h2>
                                        <button onClick={()=>{undoGroup(selectedGroup.id); setSelectedGroup(null);}} className="border border-red-500 text-red-500 px-3 py-1 rounded text-xs font-bold hover:bg-red-900/30">DESHACER</button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-4">
                                        <div className="flex flex-col md:flex-row gap-6 mb-4">
                                            <div className="flex-shrink-0 bg-white p-2 rounded mx-auto md:mx-0">
                                                <img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(selectedGroup.qr)}`} className="w-48 h-48"/>
                                            </div>
                                            <div className="flex-1 space-y-2">
                                                {selectedGroup.orders.map(o => (
                                                    <div key={o.id} className="bg-black/30 p-2 rounded border-l-2 border-[var(--gold)]">
                                                        <p className="text-[var(--gold)] font-bold text-sm">#{o.orderNum}</p>
                                                        <p className="text-white text-xs">{o.address}</p>
                                                        {o.address!=='RECOGER' && <p className="text-gray-500 text-[10px]">{o.references}</p>}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="h-48 w-full bg-gray-800 rounded mb-4 overflow-hidden relative border border-[#444]">
                                            <LeafletMap 
                                                center={STORE_COORDS} 
                                                markers={[{pos: STORE_COORDS, isStore: true}, ...selectedGroup.orders.map(o => ({pos: o.clientLoc || STORE_COORDS, emoji: 'üçî'}))]} 
                                                route={[STORE_COORDS, ...selectedGroup.orders.map(o => o.clientLoc || STORE_COORDS)]} 
                                                zoom={12} 
                                            />
                                        </div>
                                    </div>
                                    <div className="p-4 bg-[#111] border-t border-[#333] flex gap-2">
                                        <button onClick={() => handleManualDispatch(selectedGroup.orders)} className="flex-1 bg-green-600 text-white py-3 rounded font-bold text-lg hover:bg-green-500">DAR SALIDA (GRUPO)</button>
                                        <button onClick={() => setSelectedGroup(null)} className="flex-1 bg-[#333] text-white py-3 rounded font-bold text-lg hover:bg-[#444]">CERRAR</button>
                                    </div>
                                </div>
                             </div>
                         )}
                    </div>
                );
            }
            
            // --- VISTA CAJA PRINCIPAL ---
             return (
                <div className="h-full flex flex-col bg-[var(--bg-body)]">
                    <div className="flex bg-[var(--bg-card)] border-b border-[var(--border)]">
                        <button className="flex-1 p-3 font-bold bg-[var(--gold)] text-black">PUNTO DE VENTA</button>
                        <button onClick={()=>setViewReadyOrders(true)} className={`flex-1 p-3 font-bold ${readyOrders.length>0 || webOrders.length>0 ? 'bg-green-600 text-white animate-pulse' : 'text-gray-500'}`}>GESTI√ìN / ENTREGA ({readyOrders.length}) {webOrders.length>0?`+ ${webOrders.length} WEB`:''}</button>
                    </div>
                    
                    <div className="flex-1 flex overflow-hidden">
                        <div className="flex-1 flex flex-col">
                            <div className="p-2 border-b border-[var(--border)] flex gap-2 overflow-x-auto">
                                {uniqueCategories.map(c=><button key={c} onClick={()=>setCatFilter(c)} className={`px-4 py-1 rounded-full text-xs font-bold whitespace-nowrap ${catFilter===c ? 'bg-[var(--gold)] text-black' : 'bg-[#222] text-white'}`}>{c}</button>)}
                            </div>
                            <div className="flex-1 p-4 grid grid-cols-5 gap-3 overflow-y-auto content-start">
                                {db.products.filter(p=>p.active && (catFilter==='Todos' || p.cat===catFilter)).map(p=>(
                                    <div key={p.id} onClick={()=>addToCart(p)} className="card h-28 relative overflow-hidden cursor-pointer group border-0 hover:ring-2 ring-[var(--gold)]">
                                            <img src={p.img} className="absolute inset-0 w-full h-full object-cover opacity-60"/>
                                            <div className="absolute top-1 right-1 z-20 bg-black/50 rounded-full p-1 hover:bg-[var(--gold)] hover:text-black text-white" onClick={(e)=>{e.stopPropagation(); setIngredientsProduct(p);}}><Info size={16}/></div>
                                            <div className="absolute bottom-0 p-1 w-full bg-gradient-to-t from-black to-transparent">
                                                <p className="text-white font-bold text-xs leading-tight">{p.name}</p>
                                                <p className="text-[var(--gold)] font-black text-xs">{formatCurrency(p.price)}</p>
                                            </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="w-96 bg-[var(--bg-card)] border-l border-[var(--border)] flex flex-col z-10 shadow-2xl relative">
                            <div className="flex-1 p-3 overflow-y-auto space-y-2">
                                {cart.map((item,idx)=>(
                                    <div key={idx} className="bg-[#222] p-2 rounded border border-[#333] relative group">
                                            <button onClick={()=>removeFromCart(idx)} className="absolute -top-2 -right-2 bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center shadow-lg z-10 font-bold">x</button>
                                            <div className="flex justify-between items-center text-white text-sm mb-1">
                                                <div><span className="font-bold">{item.qty}x</span> {item.name}</div>
                                                <div>{formatCurrency(item.price*item.qty)}</div>
                                            </div>
                                            <input className="bg-transparent text-xs text-gray-400 w-full border-b border-gray-700 outline-none placeholder-gray-600" placeholder="Nota (Sin cebolla...)" value={item.note || ''} onChange={(e)=>updateCartNote(idx, e.target.value)}/>
                                    </div>
                                ))}
                            </div>
                            <div className="p-4 bg-black border-t border-[#333]">
                                <div className="flex justify-between text-2xl font-black text-white mb-4"><span>TOTAL</span><span>{formatCurrency(subtotal)}</span></div>
                                <button onClick={()=>setModal('cockpit')} disabled={cart.length===0} className="btn-gold w-full text-xl py-4 shadow-lg disabled:opacity-50">COBRAR</button>
                            </div>
                        </div>
                    </div>

                    <div className="admin-fab">
                        {bottomMenuOpen && (
                            <div className="admin-fab-menu">
                                <button onClick={()=>setViewMap(true)} className="bg-blue-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2">RASTREO GPS <MapPin size={16}/></button>
                                <button onClick={()=>copyToClipboard(window.location.href)} className="bg-purple-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2">COPIAR MENU <Share2 size={16}/></button>
                                <button onClick={()=>{setCorteModal(true); setCutResult(null); setCountedCash(''); setCountedCard('');}} className="bg-red-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2">CORTE DE CAJA <DollarSign size={16}/></button>
                                <button onClick={()=>{setRetiroModal(true); setNewExpense({desc:'', amount:''});}} className="bg-orange-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2">RETIRO DE EFECTIVO <Minus size={16}/></button>
                                <button onClick={()=>setLiquidationModal(true)} className="bg-green-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2">LIQUIDAR DRIVER <UserCheck size={16}/></button>
                            </div>
                        )}
                        <button className="bg-[var(--gold)] text-black p-4 rounded-full shadow-[0_0_15px_var(--gold)]" onClick={()=>setBottomMenuOpen(!bottomMenuOpen)}><Plus size={24} className={`transition ${bottomMenuOpen?'rotate-45':''}`}/></button>
                    </div>
                    
                    {ingredientsProduct && (
                        <div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4" onClick={()=>setIngredientsProduct(null)}>
                            <div className="bg-[var(--bg-card)] p-6 rounded-xl max-w-sm w-full text-center border border-[var(--gold)]" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-[var(--gold)] mb-4">{ingredientsProduct.name}</h3>
                                <p className="text-[var(--text-main)] mb-6">{ingredientsProduct.ingredients || "No se especificaron ingredientes."}</p>
                                <button onClick={()=>setIngredientsProduct(null)} className="btn-gold w-full">CERRAR</button>
                            </div>
                        </div>
                    )}

                    {modal === 'cockpit' && (
                        <div className="fixed inset-0 bg-black/95 z-50 p-4 animate-in fade-in zoom-in duration-200 text-white">
                            <div className="h-full w-full max-w-7xl mx-auto grid-cockpit">
                                <div className="cockpit-col">
                                    <h3 className="text-[var(--gold)] font-bold text-xl uppercase mb-2">1. TIPO</h3>
                                    <button onClick={()=>setOrderType('takeaway')} className={`mode-btn ${orderType==='takeaway'?'active':''}`}>PARA LLEVAR</button>
                                    <button onClick={()=>setOrderType('dinein')} className={`mode-btn ${orderType==='dinein'?'active':''}`}>COMER AQU√ç</button>
                                    <button onClick={()=>setOrderType('delivery')} className={`mode-btn ${orderType==='delivery'?'active':''}`}>DOMICILIO</button>
                                    <button onClick={()=>setOrderType('platform')} className={`mode-btn ${orderType==='platform'?'active':''}`}>PLATAFORMA</button>
                                    <button onClick={()=>setModal(null)} className="mt-auto bg-red-900/20 text-red-500 py-4 rounded font-bold border-2 border-red-900">CANCELAR (ESC)</button>
                                </div>
                                <div className="cockpit-col overflow-y-auto">
                                    <h3 className="text-[var(--gold)] font-bold text-xl uppercase mb-2">2. DATOS</h3>
                                    {orderType !== 'platform' && <><input className="input-std h-10 text-lg mb-2" placeholder="Nombre *" value={orderDetails.name} onChange={e=>setOrderDetails({...orderDetails, name:e.target.value})}/><div className="flex gap-2 mb-2"><input className="input-std h-10 text-lg flex-1" placeholder="Tel√©fono (10 d√≠gitos) *" value={orderDetails.phone} maxLength={10} onChange={e=>setOrderDetails({...orderDetails, phone:e.target.value})}/><a href={`https://wa.me/52${orderDetails.phone}`} target="_blank" className="bg-green-600 text-white rounded p-2 flex items-center justify-center w-12"><MessageCircle/></a></div></>}
                                    {orderType === 'dinein' && <input className="input-std h-10 text-lg" placeholder="# Mesa" value={orderDetails.table} onChange={e=>setOrderDetails({...orderDetails, table:e.target.value})}/>}
                                    {orderType === 'platform' && (
                                        <>
                                            <div className="grid grid-cols-2 gap-2 mb-2">{db.settings.platforms.map(p=><button key={p} onClick={()=>setOrderDetails({...orderDetails, platform:p})} className={`p-3 rounded border font-bold ${orderDetails.platform===p?'bg-blue-600 text-white':'bg-[#222] text-gray-400'}`}>{p}</button>)}</div>
                                            <input className="input-std h-12 text-lg font-bold border-blue-500" placeholder="ID / NOMBRE PEDIDO *" value={orderDetails.platformOrderId} onChange={e=>setOrderDetails({...orderDetails, platformOrderId:e.target.value})}/>
                                        </>
                                    )}
                                    {orderType === 'delivery' && (
                                        <>
                                            <div className="flex gap-2 mb-2 relative">
                                                <input className={`input-std h-10 text-lg flex-1 ${isLocating?'locating':''}`} placeholder={isLocating?"üìç Localizando...":"Calle y N√∫mero *"} value={orderDetails.address} onChange={e=>updateLocationFromAddress(e.target.value)} list="pos-address-list"/>
                                                <datalist id="pos-address-list">
                                                    {suggestions.map((s,i) => <option key={i} value={s.display_name} />)}
                                                </datalist>
                                                <button onClick={useGPS} className="bg-blue-600 text-white p-2 rounded gps-btn"><MapPin/></button>
                                            </div>
                                            {isLocating && <p className="text-[var(--gold)] text-xs animate-pulse mb-2">Buscando...</p>}
                                            <input className="input-std h-10 text-lg mb-2" placeholder="Referencias / Colonia *" value={orderDetails.references} onChange={e=>setOrderDetails({...orderDetails, references:e.target.value})}/>
                                            <div className="h-40 rounded border border-[var(--gold)] overflow-hidden relative mb-2">
                                                <LeafletMap center={deliveryCoords || STORE_COORDS} markers={[{pos:deliveryCoords||STORE_COORDS, emoji:'üìç'}]} onClickMap={handleReverseGeo} zoom={15}/>
                                            </div>
                                            <div className="bg-[#222] p-2 rounded text-right text-sm text-white">Env√≠o: <span className="font-bold text-[var(--gold)]">{formatCurrency(deliveryFee)}</span></div>
                                        </>
                                    )}
                                    <div className="flex gap-2 mt-2"><input className="input-std h-10 flex-1" placeholder="CUP√ìN" value={couponCode} onChange={e=>setCouponCode(e.target.value)}/><button onClick={applyCoupon} className="btn-gold h-10 px-4">APLICAR</button></div>
                                </div>
                                <div className="cockpit-col relative">
                                    <h3 className="text-[var(--gold)] font-bold text-xl uppercase mb-4 text-center">3. PAGO: {formatCurrency(total)}</h3>
                                    <div className="flex gap-2 mb-4"><button onClick={()=>switchPayMethod('cash')} className={`flex-1 py-4 rounded font-bold text-lg ${payMethod==='cash'?'bg-green-600 text-white':'bg-[#222] text-gray-500'}`}>EFECTIVO</button><button onClick={()=>switchPayMethod('card')} className={`flex-1 py-4 rounded font-bold text-lg ${payMethod==='card'?'bg-blue-600 text-white':'bg-[#222] text-gray-500'}`}>{orderType==='platform'?'APP':'TARJETA'}</button></div>
                                    
                                    {orderType === 'delivery' && payMethod === 'cash' && (
                                        <div className="flex gap-2 mb-4">
                                            <button onClick={() => setPaymentStatus('paid')} className={`flex-1 p-2 rounded border-2 font-bold ${paymentStatus==='paid'?'bg-green-900 border-green-500 text-green-300':'border-gray-600 text-gray-500'}`}>‚úÖ PAGADO EN CAJA</button>
                                            <button onClick={() => { setPaymentStatus('pending'); setCashReceived(0); }} className={`flex-1 p-2 rounded border-2 font-bold ${paymentStatus==='pending'?'bg-yellow-900 border-yellow-500 text-yellow-300':'border-gray-600 text-gray-500'}`}>üõµ PAGO AL RECIBIR</button>
                                        </div>
                                    )}

                                    {payMethod === 'cash' && (
                                        <div className="flex-1 flex flex-col gap-2">
                                            {paymentStatus !== 'pending' ? (
                                                <div className="grid grid-cols-3 gap-2 mb-2">
                                                    {[20, 50, 100, 200, 500].map(v => (
                                                        <button key={v} className="bill-btn" style={{backgroundImage:`url(./${v}.png)`}} onClick={() => setCashReceived(v)}></button>
                                                    ))}
                                                    <button onClick={() => setCashReceived(total)} className="bg-[var(--gold)] text-black font-black rounded text-sm h-[60px]">EXACTO</button>
                                                </div>
                                            ) : (
                                                <div className="text-center text-yellow-400 font-bold p-4 border border-yellow-600 bg-yellow-900/20 rounded">
                                                    COBRO A CARGO DEL REPARTIDOR
                                                </div>
                                            )}

                                            <div className="mt-4 p-4 bg-black rounded border border-[#333]">
                                                {paymentStatus !== 'pending' && (
                                                    <>
                                                        <div className="flex justify-between text-gray-400 items-center">
                                                            <span>Recibido:</span>
                                                            <input type="number" className={`bg-transparent text-right font-black text-3xl w-40 outline-none ${!cashReceived ? 'animate-pulse text-gray-600 border-b-4 border-gray-600' : 'text-green-500 border-b-4 border-green-500'}`} placeholder="0.00" value={cashReceived || ''} onChange={e=>setCashReceived(parseFloat(e.target.value))}/>
                                                        </div>
                                                        <div className="flex justify-between text-gray-400 mt-2"><span>Cambio:</span><span className={`font-bold text-2xl ${cashReceived>=total?'text-green-500':'text-red-500'}`}>{formatCurrency(cashReceived-total)}</span></div>
                                                    </>
                                                )}
                                                {paymentStatus === 'pending' && <p className="text-center text-white font-bold">Saldo a cobrar: {formatCurrency(total)}</p>}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {payMethod === 'card' && orderType !== 'platform' && <div className="flex-1 flex flex-col justify-center items-center"><CreditCard size={80} className="text-blue-500 mb-6 animate-pulse"/><p className="text-white font-bold mb-2 text-xl">FOLIO DE VOUCHER</p><input className="input-std text-center text-3xl tracking-widest" placeholder="0000" value={voucher} onChange={e=>setVoucher(e.target.value)} autoFocus/></div>}
                                    <button onClick={finalizeOrder} className="btn-gold py-5 text-2xl mt-4 w-full font-black rounded-xl">COBRAR AHORA</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {liquidationModal && (
                        <div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4">
                            <div className="card w-full max-w-lg bg-[var(--bg-card)] p-6">
                                <h3 className="text-2xl font-bold text-[var(--gold)] mb-4">LIQUIDACI√ìN REPARTIDOR</h3>
                                {!driverToLiq ? (
                                    <div className="text-center">
                                         <p className="mb-4 text-gray-400">Escanea el QR o Ingresa ID:</p>
                                         <div className="flex gap-2 justify-center mb-4">
                                             <input id="liq-input" className="input-std w-48 text-center uppercase" placeholder="ID (ej. u4)" onChange={e=>setManualDriverId(e.target.value)}/>
                                             <button onClick={() => handleScanDriver("LIQ:" + manualDriverId)} className="btn-gold px-4">BUSCAR</button>
                                         </div>
                                         <div className="w-full h-32 border border-gray-600 rounded flex items-center justify-center text-gray-500 mb-4">
                                            [C√ÅMARA DE ESCANEO ACTIVA]
                                         </div>
                                         <button onClick={()=>setLiquidationModal(false)} className="text-gray-500">CANCELAR (ESC)</button>
                                    </div>
                                ) : (
                                    <div>
                                        <p className="font-bold text-xl text-white mb-4">{driverToLiq.name}</p>
                                        <div className="bg-[#222] p-4 rounded mb-4 space-y-2">
                                            <div className="flex justify-between text-gray-400"><span>Pedidos Entregados (No Liq):</span><span className="text-white font-bold">{liqSummary.deliveredOrders.length}</span></div>
                                            <div className="flex justify-between text-gray-400"><span>Efectivo en Mano:</span><span className="text-white font-bold">{formatCurrency(liqSummary.totalCash)}</span></div>
                                            <div className="flex justify-between text-green-500"><span>Ganancias Env√≠os:</span><span className="font-bold">-{formatCurrency(liqSummary.totalEarnings)}</span></div>
                                            <div className="border-t border-[#444] pt-2 flex justify-between text-xl font-black text-[var(--gold)]"><span>A ENTREGAR:</span><span>{formatCurrency(liqSummary.netToPay)}</span></div>
                                        </div>
                                        <button onClick={confirmLiquidation} className="btn-gold w-full text-lg py-3">LIQUIDAR Y CERRAR</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {corteModal && (
                        <div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4">
                            <div className="card w-full max-w-md bg-[var(--bg-card)] p-6 max-h-screen overflow-y-auto">
                                <h3 className="text-2xl font-bold text-red-500 mb-4">CORTE DE CAJA (CIEGO)</h3>
                                <div className="bg-[#111] p-4 rounded mb-6 border border-[#333]">
                                    {!cutResult ? (
                                        <div className="space-y-4">
                                            <p className="text-white font-bold mb-2">INGRESE TOTALES CONTADOS:</p>
                                            <div>
                                                <label className="text-gray-400 text-xs">Total Efectivo en Caja</label>
                                                <input type="number" className="input-std text-xl" value={countedCash} onChange={e=>setCountedCash(e.target.value)} placeholder="$0.00"/>
                                            </div>
                                            <div>
                                                <label className="text-gray-400 text-xs">Suma Tickets Tarjeta</label>
                                                <input type="number" className="input-std text-xl" value={countedCard} onChange={e=>setCountedCard(e.target.value)} placeholder="$0.00"/>
                                            </div>
                                            <button onClick={performBlindCut} className="btn-gold w-full mt-2">CALCULAR DIFERENCIA</button>
                                        </div>
                                    ) : (
                                        <div className="space-y-2 animate-in fade-in">
                                            <div className="flex justify-between text-gray-400 text-sm"><span>Efectivo Declarado:</span><span>{formatCurrency(cutResult.cCash)}</span></div>
                                            <div className="flex justify-between text-gray-400 text-sm"><span>Sistema (Calculado):</span><span>{formatCurrency(cutResult.systemCash)}</span></div>
                                            <div className={`flex justify-between font-bold border-t border-[#333] pt-2 ${cutResult.diffCash < 0 ? 'text-red-500' : 'text-green-500'}`}>
                                                <span>Diferencia Efectivo:</span><span>{formatCurrency(cutResult.cCash - cutResult.systemCash)}</span>
                                            </div>
                                            
                                            <div className="flex justify-between text-gray-400 text-sm mt-4"><span>Tarjeta Declarada:</span><span>{formatCurrency(cutResult.cCard)}</span></div>
                                            <div className="flex justify-between text-gray-400 text-sm"><span>Sistema Tarjeta:</span><span>{formatCurrency(cutResult.systemCard)}</span></div>
                                            
                                            {cutResult.missingOrder && (
                                                <div className="bg-red-900/30 border border-red-500 p-2 rounded mt-2 text-xs text-red-300">
                                                    <p className="font-bold">‚ö†Ô∏è POSIBLE VENTA FALTANTE DETECTADA</p>
                                                    <p>La diferencia coincide con la Orden #{cutResult.missingOrder.orderNum}</p>
                                                    <p>Total: {formatCurrency(cutResult.missingOrder.total)}</p>
                                                </div>
                                            )}
                                            
                                            <button onClick={printBlindCut} className="w-full bg-[var(--gold)] text-black font-bold py-3 mt-4 rounded shadow-lg flex items-center justify-center gap-2"><Printer/> IMPRIMIR CORTE Z</button>
                                            <button onClick={()=>setCutResult(null)} className="text-gray-500 text-xs mt-2 w-full">RECALCULAR</button>
                                        </div>
                                    )}
                                </div>
                                <button onClick={()=>setCorteModal(false)} className="text-gray-500 w-full">CERRAR (ESC)</button>
                            </div>
                        </div>
                    )}

                    {retiroModal && (
                        <div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4">
                            <div className="card w-full max-w-md bg-[var(--bg-card)] p-6">
                                <h3 className="text-2xl font-bold text-orange-500 mb-4">RETIRO DE EFECTIVO</h3>
                                <div className="bg-[#222] p-4 rounded mb-4">
                                    <p className="text-xs text-white font-bold mb-2">Registrar gasto o pago a proveedor</p>
                                    <input className="input-std mb-2" placeholder="Descripci√≥n (ej. Pago Coca-Cola)" value={newExpense.desc} onChange={e=>setNewExpense({...newExpense, desc:e.target.value})}/>
                                    <input className="input-std mb-2" type="number" placeholder="Monto a Retirar" value={newExpense.amount} onChange={e=>setNewExpense({...newExpense, amount:e.target.value})}/>
                                    <button onClick={addExpense} className="w-full bg-orange-600 text-white font-bold py-2 rounded">CONFIRMAR RETIRO</button>
                                </div>
                                <button onClick={()=>setRetiroModal(false)} className="text-gray-500 w-full">CANCELAR (ESC)</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
const ClientApp = ({ db, updateDB }) => {
            const [view, setView] = useState('menu');
            const [cart, setCart] = useState([]);
            const [form, setForm] = useState({name:'', phone:'', type:'delivery', address:'', references:'', pay:'card', payAmount:0});
            const [activeOrder, setActiveOrder] = useState(null);
            const [clientCoords, setClientCoords] = useState(null);
            const [deliveryCoords, setDeliveryCoords] = useState(null);
            const [isLocating, setIsLocating] = useState(false);
            const [showCashModal, setShowCashModal] = useState(false);
            const [showComplements, setShowComplements] = useState(false); 
            const [tempCashAmount, setTempCashAmount] = useState('');
            const [suggestions, setSuggestions] = useState([]);
            const addressTimer = useRef(null);
            const [clientCatFilter, setClientCatFilter] = useState('Todos'); 
            const [ingredientsProduct, setIngredientsProduct] = useState(null);
            const [showLargeMap, setShowLargeMap] = useState(false);
            
            // --- 1. BLOQUEO INMEDIATO SI TIENDA CIERRA ---
            if(!db.settings.storeOpen) return <div className="closed-store-overlay"></div>;

            // --- 2. EFECTOS DE INICIO Y PERSISTENCIA ---
            useEffect(() => {
                // Modo oscuro forzado para cliente
                document.body.classList.add('client-mode');
                document.body.classList.add('dark');
                document.body.classList.remove('light');

                // Recuperar pedido activo si se recarga la p√°gina
                const storedOrderId = localStorage.getItem('client_active_order_id');
                if (storedOrderId) {
                    const existingOrder = db.orders.find(o => o.id === storedOrderId);
                    if (existingOrder) {
                        if (existingOrder.status === 'delivered' || existingOrder.status === 'cancelled') {
                            localStorage.removeItem('client_active_order_id');
                            if(existingOrder.status === 'delivered') showToast("¬°Pedido Entregado! Gracias por su compra.");
                        } else {
                            setActiveOrder(existingOrder);
                            setView('track');
                        }
                    }
                }
                
                // Obtener GPS inicial
                navigator.geolocation.getCurrentPosition((pos) => {
                    const coords = [pos.coords.latitude, pos.coords.longitude];
                    setClientCoords(coords);
                    if(!deliveryCoords) setDeliveryCoords(coords); 
                    // Intentar obtener direcci√≥n textual inicial
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords[0]}&lon=${coords[1]}`)
                        .then(r=>r.json())
                        .then(d=>{
                            if(d && d.display_name && !form.address){ 
                                const parts = d.display_name.split(','); 
                                setForm(prev => ({...prev, address: parts[0] + (parts[1]||'')})); 
                            }
                        }).catch(e=>{});
                }, () => setClientCoords(STORE_COORDS)); 

                return () => { document.body.classList.remove('client-mode'); };
            }, [db.orders]);

            // --- 3. C√ÅLCULOS ---
            const deliveryFee = useMemo(() => {
                if(form.type==='delivery' && deliveryCoords) {
                    const dist = calculateDistance(STORE_COORDS[0], STORE_COORDS[1], deliveryCoords[0], deliveryCoords[1]);
                    return getDeliveryPrice(dist, db.settings.deliveryTable);
                }
                return 0;
            }, [deliveryCoords, form.type, db.settings.deliveryTable]);

            const total = cart.reduce((a,b)=>a+b.price*b.qty,0) + deliveryFee;

            // --- 4. FUNCIONES DEL CARRITO Y PEDIDO ---
            const adjustQty = (p, delta) => { 
                const existing = cart.find(i => i.id === p.id); 
                if (existing) { 
                    const newQty = existing.qty + delta; 
                    if (newQty <= 0) setCart(cart.filter(i => i.id !== p.id)); 
                    else setCart(cart.map(i => i.id === p.id ? {...i, qty: newQty} : i)); 
                } else if (delta > 0) {
                    setCart([...cart, {...p, qty: 1}]); 
                }
            };

            const getQty = (pId) => { const item = cart.find(i => i.id === pId); return item ? item.qty : 0; };
            
            const updateItemNote = (idx, note) => { const newCart = [...cart]; newCart[idx].note = note; setCart(newCart); };

            const preSubmit = () => { 
                const hasComplements = db.products.some(p => p.isComplement && (p.active !== false)); 
                if (hasComplements && !showComplements) setShowComplements(true); 
                else { setView('checkout'); setShowComplements(false); } 
            };

            const submit = () => {
                if(activeOrder) return showToast("Ya tienes un pedido en curso");
                if(!form.name) return showToast("Falta Nombre");
                if(!form.phone || form.phone.length !== 10) return showToast("Tel√©fono inv√°lido (10 d√≠gitos)");
                if (form.type === 'delivery') {
                    if (!db.settings.deliveryEnabled) return showToast("Servicio a domicilio no disponible");
                    if (!form.address) return showToast("Falta Direcci√≥n");
                    if (deliveryCoords) { 
                        const dist = calculateDistance(STORE_COORDS[0], STORE_COORDS[1], deliveryCoords[0], deliveryCoords[1]); 
                        if (dist > db.settings.deliveryRadius) return showToast("Upss! Direcci√≥n fuera de zona de cobertura."); 
                    }
                }
                if(form.pay === 'cash' && (!form.payAmount || form.payAmount < total)) return showToast("Monto insuficiente o inv√°lido");
                
                const order = { 
                    id: generateId(), 
                    orderNum: Math.floor(Math.random()*9000)+1000, 
                    items: cart, 
                    total, 
                    status: 'web_pending_payment', 
                    method: form.pay, 
                    payAmount: form.payAmount, 
                    createdAt: new Date().toISOString(), 
                    address: form.type==='delivery' ? `${form.address} (${form.references})` : 'RECOGER', 
                    clientName: form.name, 
                    clientPhone: form.phone, 
                    clientLoc: deliveryCoords || clientCoords, 
                    source: 'web',
                    deviceId: localStorage.getItem('device_id')
                };
                
                localStorage.setItem('client_active_order_id', order.id);
                updateDB({...db, orders: [...db.orders, order]}); 
                setActiveOrder(order); 
                setView('track');
            };

            // --- 5. FUNCIONES DE MAPA Y BUSQUEDA (DIDI STYLE) ---
            const updateLocationFromAddress = (addr) => {
                setForm(prev => ({...prev, address: addr}));
                if (addressTimer.current) clearTimeout(addressTimer.current);
                if(addr.length < 4) { setSuggestions([]); setIsLocating(false); return; }
                setIsLocating(true);
                addressTimer.current = setTimeout(async () => {
                    try { 
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr + CITY_SUFFIX)}&limit=5&addressdetails=1`); 
                        const data = await res.json(); 
                        setSuggestions(data || []); 
                    } catch(e) {} finally { setIsLocating(false); }
                }, 1000); 
            };
            
            const selectSuggestion = (s) => {
                setForm({...form, address: s.display_name.split(',')[0]});
                setDeliveryCoords([parseFloat(s.lat), parseFloat(s.lon)]);
                setSuggestions([]);
            };

            const useGPS = () => { 
                setIsLocating(true); 
                navigator.geolocation.getCurrentPosition(pos => { 
                    const coords = [pos.coords.latitude, pos.coords.longitude]; 
                    setDeliveryCoords(coords); 
                    setClientCoords(coords); 
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords[0]}&lon=${coords[1]}`)
                        .then(r=>r.json())
                        .then(d=>{ 
                            if(d && d.display_name){ 
                                const parts = d.display_name.split(','); 
                                setForm(prev => ({...prev, address: parts[0] + (parts[1]||'')})); 
                            } 
                        }).catch(e=>{}); 
                    setIsLocating(false); 
                }, () => setIsLocating(false)); 
            };

            const handleMapClick = async (coords) => { 
                setDeliveryCoords(coords); 
                setIsLocating(true); 
                try { 
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords[0]}&lon=${coords[1]}`); 
                    const data = await res.json(); 
                    if(data && data.display_name) { 
                        const addrParts = data.display_name.split(','); 
                        setForm(prev => ({...prev, address: addrParts[0] + (addrParts[1]||'')})); 
                        setSuggestions([]); 
                    } 
                } catch(e) {} finally { setIsLocating(false); } 
            };

            // --- 6. HELPERS UI ---
            const showInstallInstructions = () => showToast("Para instalar: Toca 'Compartir' -> 'Agregar a Inicio'");
            const handleCashSelect = () => setShowCashModal(true);
            const confirmCash = () => { if(parseFloat(tempCashAmount) < total) return showToast("El monto debe ser mayor al total"); setForm({...form, pay:'cash', payAmount: parseFloat(tempCashAmount)}); setShowCashModal(false); };
            const cancelCash = () => { setForm({...form, pay:'card', payAmount: 0}); setShowCashModal(false); };

            // --- 7. FILTRADO DE PRODUCTOS (CORREGIDO PARA EVITAR MENU VACIO) ---
            const groupedProducts = useMemo(() => {
                const groups = {};
                if(db && db.products) {
                    // Filtro m√°s permisivo: solo ocultamos si isComplement es true
                    db.products.filter(p => !p.isComplement).forEach(p => {
                        const cat = p.cat || 'Otros';
                        if (!groups[cat]) groups[cat] = [];
                        groups[cat].push(p);
                    });
                }
                return groups;
            }, [db.products]);
            
            const uniqueClientCategories = ['Todos', ...Object.keys(groupedProducts)];
            const rawProductsCount = db.products ? db.products.length : 0;

            // --- VISTA 1: MEN√ö ---
            if(view === 'menu') return (
                <div className="h-full flex flex-col bg-[var(--bg-body)] text-[var(--text-main)] relative app-view-mobile">
                    
                    {/* Bot√≥n Flotante Instalar */}
                    <button className="install-btn" onClick={showInstallInstructions}><img src={LOGO_URL}/></button>
                    
                    {/* Banner Pedido Activo */}
                    {activeOrder && ( 
                        <div onClick={()=>setView('track')} className="fixed top-20 left-4 right-4 bg-red-600 text-white p-6 rounded-2xl shadow-2xl z-[100] animate-pulse cursor-pointer border-4 border-[var(--gold)] text-center">
                            <h2 className="text-3xl font-brand">üõµ PEDIDO EN CURSO</h2>
                            <p className="font-bold text-sm mt-2">TOCA PARA VER EL MAPA</p>
                        </div> 
                    )}
                    
                    {/* Banner Principal Corregido (Fit Contain) */}
                    <div className="banner-container">
                        <img src={BANNER_URL} className="mobile-banner" alt="Banner"/>
                    </div>
                    
                    {/* Filtros Categor√≠a */}
                    <div className="p-2 flex gap-2 overflow-x-auto bg-[var(--bg-card)] border-b border-[var(--border)]">
                        {uniqueClientCategories.map(c=><button key={c} onClick={()=>setClientCatFilter(c)} className={`px-4 py-1 rounded-full text-xs font-bold whitespace-nowrap ${clientCatFilter===c ? 'bg-[var(--gold)] text-black' : 'bg-[#222] text-white'}`}>{c}</button>)}
                    </div>
                    
                    {/* Lista Productos */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-6 pb-48">
                        {Object.keys(groupedProducts).length === 0 ? (
                            <div className="text-center text-gray-500 mt-10 p-4 border border-dashed border-gray-600 rounded">
                                <p>Men√∫ Vac√≠o</p>
                                <p className="text-xs mt-2 text-red-500">Diagn√≥stico: {rawProductsCount} productos en DB.</p>
                                {rawProductsCount === 0 && <p className="text-xs text-yellow-500">Esperando sincronizaci√≥n de nube...</p>}
                            </div>
                        ) : (
                            Object.entries(groupedProducts).filter(([cat]) => clientCatFilter === 'Todos' || cat === clientCatFilter).map(([cat, prods]) => (
                                <div key={cat}>
                                    <div className="space-y-4">
                                        {prods.map(p=>{ 
                                            const qty = getQty(p.id); 
                                            return (
                                                <div key={p.id} className="card p-3 shadow flex gap-3 bg-[var(--bg-card)] relative">
                                                    <img 
                                                        src={p.img && p.img.length > 10 ? p.img : LOGO_URL} 
                                                        onError={(e) => e.target.src = LOGO_URL} 
                                                        className="w-20 h-20 rounded object-cover cursor-pointer" 
                                                        onClick={()=>setIngredientsProduct(p)}
                                                    />
                                                    <div className="flex-1">
                                                        <p className="font-bold text-[var(--text-main)] text-lg cursor-pointer" onClick={()=>setIngredientsProduct(p)}>{p.name}</p>
                                                        <p className="text-gray-500 text-xs italic mb-1 line-clamp-2">{p.ingredients}</p>
                                                        <div className="flex justify-between items-center mt-2">
                                                            <span className="font-bold text-[var(--accent)] text-xl">{formatCurrency(p.price)}</span>
                                                            <div className="flex items-center gap-2 bg-[#222] rounded-full p-1 border border-[#444]">
                                                                {qty === 0 ? (
                                                                    <button onClick={()=>adjustQty(p, 1)} className="bg-[var(--gold)] text-black font-bold px-4 py-1 rounded-full text-sm shadow hover:scale-105 transition">PEDIR</button>
                                                                ) : (
                                                                    <>
                                                                        <button onClick={()=>adjustQty(p, -1)} className="w-8 h-8 rounded-full bg-gray-700 text-white font-bold flex items-center justify-center active:scale-90">-</button>
                                                                        <span className="w-6 text-center font-bold text-white text-sm">{qty}</span>
                                                                        <button onClick={()=>adjustQty(p, 1)} className="w-8 h-8 rounded-full bg-[var(--gold)] text-black font-bold flex items-center justify-center active:scale-90 shadow">+</button>
                                                                    </>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                    
                    {/* Video Promocional */}
                    <div className="mobile-video-container">
                        <video src={VIDEO_URL} autoPlay loop muted playsInline></video>
                        <div className="mobile-video-overlay"></div>
                    </div>
                    
                    {/* Barra Inferior */}
                    <div className="fixed bottom-0 w-full p-4 bg-[var(--bg-card)] border-t border-[var(--border)] z-[60] app-view-mobile">
                        {activeOrder ? (
                            <button onClick={()=>setView('track')} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-lg animate-pulse flex items-center justify-center gap-2">üõµ PEDIDO EN CURSO</button>
                        ) : (
                            cart.length > 0 && <button onClick={preSubmit} className="w-full bg-[var(--accent)] text-white py-3 rounded-lg font-bold shadow-lg">IR A PAGAR ({formatCurrency(total)})</button>
                        )}
                    </div>
                    
                    {/* Modal Complementos */}
                    {showComplements && (
                        <div className="fixed inset-0 bg-black/90 z-[9999] flex flex-col justify-end p-4 animate-in slide-in-from-bottom">
                            <div className="bg-[var(--bg-card)] rounded-t-2xl p-6 border-t border-[var(--gold)]">
                                <h3 className="text-xl font-bold text-[var(--gold)] mb-4 text-center">¬øSE TE ANTOJA ALGO M√ÅS? üçüü•§</h3>
                                <div className="flex gap-4 overflow-x-auto pb-4">
                                    {db.products.filter(p => p.isComplement).map(p => (
                                        <div key={p.id} className="min-w-[120px] bg-[#222] p-2 rounded-lg text-center cursor-pointer border border-transparent hover:border-[var(--gold)]" onClick={()=>{adjustQty(p, 1); showToast("Agregado!");}}>
                                            <img src={p.img} className="w-20 h-20 mx-auto rounded mb-2 object-cover"/>
                                            <p className="text-xs font-bold text-white line-clamp-1">{p.name}</p>
                                            <p className="text-[var(--gold)] font-bold">{formatCurrency(p.price)}</p>
                                            <button className="mt-1 bg-[var(--gold)] text-black text-xs px-2 py-1 rounded-full font-bold">+</button>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={()=>{setView('checkout'); setShowComplements(false);}} className="w-full bg-white text-black font-bold py-3 rounded-xl">LISTO, CONTINUAR</button>
                            </div>
                        </div>
                    )}
                </div>
            );

            // --- VISTA 2: CHECKOUT ---
            if(view === 'checkout') return (
                <div className="h-full bg-[var(--bg-body)] p-4 overflow-y-auto app-view-mobile relative flex flex-col pb-32">
                    <button onClick={()=>setView('menu')} className="mb-4 text-gray-500 flex items-center gap-2 font-bold"><ArrowLeft/> VOLVER</button>
                    <h2 className="font-bold text-xl mb-4 text-[var(--text-main)]">FINALIZAR PEDIDO</h2>
                    
                    {/* Direcci√≥n estilo DiDi */}
                    {form.type === 'delivery' && (
                        <div className="mb-6 animate-in fade-in">
                            <h3 className="text-sm font-bold text-gray-500 uppercase border-b border-gray-700 pb-1 mb-2">4. Direcci√≥n</h3>
                            <div className="didi-search-container">
                                <div className="text-[var(--accent)]"><MapPin size={24}/></div>
                                <input className="didi-input" placeholder="Ingresa tu direcci√≥n..." value={form.address} onChange={e=>updateLocationFromAddress(e.target.value)}/>
                                <button className="didi-btn-orange" onClick={useGPS}>UBICACI√ìN ACTUAL</button>
                            </div>
                            
                            {suggestions.length > 0 && (
                                <div className="didi-suggestions">
                                    {suggestions.map((s,i) => (
                                        <div key={i} className="didi-item" onClick={() => selectSuggestion(s)}>
                                            <MapPin className="text-[var(--gold)]" size={16}/>
                                            <div className="flex flex-col">
                                                <span className="font-bold text-sm text-black">{s.address.road || s.display_name.split(',')[0]}</span>
                                                <span className="text-[10px] text-gray-500">{s.display_name}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            
                            <input className="input-std mt-2" placeholder="Referencias (Casa color, port√≥n...)" value={form.references} onChange={e=>setForm({...form,references:e.target.value})}/>
                            <div className="h-40 w-full rounded border border-[var(--gold)] overflow-hidden relative shadow-lg mt-2">
                                <LeafletMap center={deliveryCoords || STORE_COORDS} markers={[{pos:clientCoords||STORE_COORDS, emoji:'', isClient:true}, {pos:deliveryCoords||STORE_COORDS, emoji:'üçî', label:'Entrega'}, {pos:STORE_COORDS, emoji:'', isStore:true}]} onClickMap={handleMapClick} zoom={15} />
                            </div>
                        </div>
                    )}

                    <div className="mb-6 space-y-3">
                        <h3 className="text-sm font-bold text-gray-500 uppercase border-b border-gray-700 pb-1 mb-2">Tus Datos</h3>
                        <input className="input-std" placeholder="Tu Nombre" value={form.name} onChange={e=>setForm({...form,name:e.target.value})}/>
                        <input className="input-std" type="number" placeholder="Tel√©fono" value={form.phone} maxLength={10} onChange={e=>setForm({...form,phone:e.target.value})}/>
                    </div>

                    <div className="mb-6">
                        <h3 className="text-sm font-bold text-gray-500 uppercase border-b border-gray-700 pb-1 mb-2">Entrega</h3>
                        <div className="flex gap-2">
                            <button onClick={()=>setForm({...form, type:'delivery'})} className={`flex-1 p-3 rounded font-bold border transition ${form.type==='delivery'?'border-[var(--accent)] bg-[var(--accent)] text-white':'border-gray-500 text-gray-500'}`}>DOMICILIO</button>
                            {db.settings.pickupEnabled && <button onClick={()=>setForm({...form, type:'pickup'})} className={`flex-1 p-3 rounded font-bold border transition ${form.type==='pickup'?'border-[var(--accent)] bg-[var(--accent)] text-white':'border-gray-500 text-gray-500'}`}>RECOGER</button>}
                        </div>
                    </div>

                    <div className="mb-6 card p-4 border border-[var(--gold)]">
                        <h3 className="text-sm font-bold text-[var(--gold)] uppercase mb-2">M√©todo de Pago</h3>
                        <div className="flex gap-2 mb-2">
                            <label className={`flex-1 p-3 rounded border text-center font-bold cursor-pointer ${form.pay==='cash'?'border-green-500 bg-green-900/20 text-green-500':'border-gray-600 text-gray-500'}`}><input type="radio" name="pay" hidden checked={form.pay==='cash'} onChange={handleCashSelect}/> Efectivo</label>
                            <label className={`flex-1 p-3 rounded border text-center font-bold cursor-pointer ${form.pay==='card'?'border-blue-500 bg-blue-900/20 text-blue-500':'border-gray-600 text-gray-500'}`}><input type="radio" name="pay" hidden checked={form.pay==='card'} onChange={()=>setForm({...form,pay:'card'})}/> Tarjeta</label>
                        </div>
                        {form.pay === 'cash' && form.payAmount > 0 && <p className="text-center text-sm text-green-500">Pagas con: {formatCurrency(form.payAmount)} (Cambio: {formatCurrency(Math.max(0, form.payAmount - total))})</p>}
                    </div>

                    <div className="mb-6 space-y-2">
                        <h3 className="text-sm font-bold text-gray-500 uppercase border-b border-gray-700 pb-1 mb-2">Tus Productos</h3>
                        {cart.map((item, idx) => ( 
                            <div key={idx} className="bg-[var(--bg-card)] p-3 rounded border border-[var(--border)]">
                                <div className="flex justify-between items-center mb-1">
                                    <div><p className="font-bold text-[var(--text-main)]">{item.name}</p><p className="text-xs text-[var(--gold)]">{formatCurrency(item.price)}</p></div>
                                    <div className="flex items-center gap-3">
                                        <button onClick={()=>adjustQty(item, -1)} className="w-8 h-8 bg-gray-700 text-white rounded-full font-bold">-</button>
                                        <span className="font-bold text-[var(--text-main)]">{item.qty}</span>
                                        <button onClick={()=>adjustQty(item, 1)} className="w-8 h-8 bg-[var(--gold)] text-black rounded-full font-bold">+</button>
                                    </div>
                                </div>
                                {!item.isComplement && <input className="w-full bg-transparent border-b border-gray-600 text-xs text-[var(--text-main)] p-1 outline-none" placeholder="Nota (Sin cebolla...)" value={item.note || ''} onChange={(e)=>updateItemNote(idx, e.target.value)}/>}
                            </div> 
                        ))}
                    </div>

                    <div className="bg-[var(--bg-card)] p-4 rounded mb-6 space-y-2 border border-[#333]">
                        <div className="flex justify-between text-[var(--text-main)]"><span>Subtotal:</span><span>{formatCurrency(cart.reduce((a,b)=>a+b.price*b.qty,0))}</span></div>
                        <div className="flex justify-between text-[var(--gold)]"><span>Env√≠o Estimado:</span><span>{formatCurrency(deliveryFee)}</span></div>
                        <div className="border-t border-[#444] pt-2 flex justify-between text-xl font-black text-[var(--text-main)]"><span>TOTAL:</span><span>{formatCurrency(total)}</span></div>
                    </div>
                    
                    <button onClick={submit} className="w-full bg-[var(--accent)] text-white py-4 rounded-lg font-bold shadow-lg text-lg">ENVIAR PEDIDO</button>
                    
                    {showCashModal && (<div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4"><div className="bg-[var(--bg-card)] p-6 rounded-xl w-full max-w-sm text-center border border-[var(--gold)]"><h3 className="text-xl font-bold text-[var(--gold)] mb-4">¬øCON CU√ÅNTO PAGAS?</h3><p className="text-[var(--text-main)] mb-2">Total a pagar: {formatCurrency(total)}</p><input type="number" className="input-std text-center text-2xl font-bold mb-4" placeholder="$0.00" value={tempCashAmount} onChange={e=>setTempCashAmount(e.target.value)} autoFocus/><div className="flex gap-2"><button onClick={cancelCash} className="flex-1 bg-gray-600 text-white py-2 rounded font-bold">CANCELAR</button><button onClick={confirmCash} className="flex-1 btn-gold py-2 rounded font-bold">CONFIRMAR</button></div></div></div>)}
                </div>
            );

            // --- VISTA 3: TRACKING ---
            if(view === 'track') {
                const assignedDriver = activeOrder.driver ? db.users.find(u => u.username === activeOrder.driver) : null;
                const driverLoc = assignedDriver && assignedDriver.location ? assignedDriver.location : STORE_COORDS;
                const trackMarkers = [{ pos: deliveryCoords || clientCoords || STORE_COORDS, emoji: 'üçî', isClient: true }, { pos: STORE_COORDS, emoji: '', isStore: true }];
                if (assignedDriver) trackMarkers.push({ pos: driverLoc, emoji: 'üèçÔ∏è', type: 'driver', label: 'Tu Repartidor' });
                const isWaitingAccept = activeOrder.status === 'web_pending_payment';
                const shareOrder = () => { const text = `¬°Hola! Mira mi pedido de EMI BURGERS:\nOrden #${activeOrder.orderNum}\nTotal: ${formatCurrency(activeOrder.total)}\nEstado: ${activeOrder.status}`; if (navigator.share) navigator.share({ title: 'Mi Pedido EMI BURGERS', text: text, url: window.location.href }); else { copyToClipboard(text); showToast("Detalles copiados"); } };

                if (isWaitingAccept) return (<div className="waiting-container client-mode"><div className="logo-spinner-wrapper"><img src={LOGO_URL} className="logo-pulse"/><div className="ring-spin"></div></div><h2 className="text-3xl font-brand text-black mb-2">¬°ESPERA!</h2><p className="text-xl font-bold text-red-600 mb-4 px-4">NO ACTUALICES LA P√ÅGINA, ESTOY ENVIANDO TU PEDIDO AL RESTAURANTE.</p><p className="text-gray-500 text-sm">Esto puede tardar unos minutos.</p></div>);

                return (
                    <div className="track-grid client-mode">
                        <div className="track-col-left">
                            <div className="text-center md:text-left"><img src={LOGO_URL} className="w-16 h-16 mx-auto md:mx-0 mb-2 rounded-full border-2 border-[var(--gold)]"/><h1 className="text-3xl font-brand text-[var(--accent)] uppercase">YA EST√ÅS LISTO</h1><div className="mt-4 text-white"><p className="font-bold flex items-center justify-center md:justify-start gap-2"><Truck size={20}/> {activeOrder.address === 'RECOGER' ? 'PARA RECOGER' : 'A DOMICILIO'}</p><p className="text-xl font-black mt-2">N√öMERO DE ORDEN <span className="text-[var(--gold)]">#{activeOrder.orderNum}</span></p><p className="text-sm text-gray-400 mt-1">FECHA: {new Date(activeOrder.createdAt).toLocaleDateString()}</p></div></div>
                            <div className="mt-4"><h3 className="font-bold text-white mb-2 uppercase">RASTREA TU PEDIDO</h3><p className="text-xs text-gray-400 mb-2">Tu pedido va en camino! Lo puedes seguir aqu√≠:</p><div className={`w-full py-3 rounded text-center font-bold text-black uppercase mb-4 ${activeOrder.status === 'ready' ? 'bg-green-500' : 'bg-[var(--gold)]'}`}>{activeOrder.status === 'pending' ? 'ORDEN RECIBIDA' : activeOrder.status === 'preparing' ? 'COCINANDO...' : activeOrder.status === 'ready' ? 'LISTO PARA ENTREGA' : 'EN CAMINO'}</div><div className="relative w-full h-48 bg-gray-800 rounded border border-[#444] overflow-hidden cursor-pointer group" onClick={()=>setShowLargeMap(true)}><LeafletMap center={STORE_COORDS} markers={trackMarkers} route={assignedDriver ? [driverLoc, deliveryCoords || STORE_COORDS] : null} zoom={13}/><div className="absolute inset-0 bg-black/30 flex items-center justify-center group-hover:bg-black/10 transition"><p className="bg-black/70 text-white px-3 py-1 rounded text-xs">TOCA PARA AMPLIAR</p></div></div></div>
                        </div>
                        <div className="track-col-right">
                            <div className="flex justify-between items-start mb-4 border-b border-[#333] pb-2"><div><p className="font-bold text-white">EMI BURGERS</p><p className="text-[10px] text-gray-400">Calle Miguel Aleman 123, Centro</p></div><div className="text-right"><p className="text-xs text-gray-400">ORDEN #{activeOrder.orderNum}</p></div></div>
                            <div className="grid grid-cols-2 gap-4 mb-4 text-xs text-white"><div><p className="font-bold text-gray-500">M√©todo de pago</p><p>{activeOrder.method === 'cash' ? 'Efectivo' : 'Tarjeta'}</p></div><div><p className="font-bold text-gray-500">Tiempo estimado</p><p>30-45 min</p></div></div>
                            <div className="mb-4"><p className="font-bold text-white mb-2 border-b border-[#333] pb-1">MI PEDIDO</p>{activeOrder.items.map((i, idx) => (<div key={idx} className="flex justify-between text-sm text-gray-300 mb-1"><span><span className="text-[var(--accent)] font-bold">{i.qty}x</span> {i.name}</span><span>{formatCurrency(i.price * i.qty)}</span></div>))}</div>
                            <div className="border-t border-[#333] pt-2 mt-auto"><div className="flex justify-between text-white font-black text-xl"><span>Total</span><span>{formatCurrency(activeOrder.total)}</span></div></div>
                            <button onClick={shareOrder} className="w-full mt-6 bg-red-600 text-white py-3 rounded font-bold flex items-center justify-center gap-2 hover:bg-red-700 transition"><Share2 size={18}/> COMPARTE</button>
                        </div>
                        {showLargeMap && (<div className="fixed inset-0 bg-black z-[6000] flex flex-col p-4 animate-in zoom-in"><button onClick={()=>setShowLargeMap(false)} className="absolute top-4 right-4 bg-white text-black rounded-full p-2 z-[7000] shadow-lg"><X size={24}/></button><div className="flex-1 rounded border border-[var(--gold)] overflow-hidden relative"><LeafletMap center={STORE_COORDS} markers={trackMarkers} route={assignedDriver ? [driverLoc, deliveryCoords || STORE_COORDS] : null} zoom={14}/></div></div>)}
                    </div>
                );
            }
        };
const DriverApp = ({ db, updateDB, user }) => {
            const [tab, setTab] = useState('map'); 
            const [showScanner, setShowScanner] = useState(false);
            const [selectedOrder, setSelectedOrder] = useState(null); 
            const [driverLoc, setDriverLoc] = useState(STORE_COORDS);
            const [gpsActive, setGpsActive] = useState(false);
            const [manualCode, setManualCode] = useState('');
            const [cameraError, setCameraError] = useState(null);
            const scannerRef = useRef(null);
            
            // Referencia para no spammear la DB
            const lastUpdateRef = useRef(0);

            const myOrders = db.orders.filter(o => o.driver === user.username && o.status === 'delivering');
            const deliveredToday = db.orders.filter(o => o.driver === user.username && o.status === 'delivered' && new Date(o.deliveredAt).toDateString() === new Date().toDateString());
            
            const cashDebt = db.orders.filter(o => o.driver === user.username && o.status === 'delivered' && !o.settled && o.method === 'cash').reduce((a,b)=>a+b.total,0);
            const earningsToday = deliveredToday.reduce((a,b)=>a+(b.deliveryFee||0),0);

            useEffect(() => {
                let watchId;
                const startTracking = () => {
                    watchId = navigator.geolocation.watchPosition(
                        (p) => {
                            const lat = p.coords.latitude;
                            const lon = p.coords.longitude;
                            setDriverLoc([lat, lon]);
                            setGpsActive(true);
                            
                            // SUBIR UBICACI√ìN A LA BASE DE DATOS (Cada 10 seg max)
                            const now = Date.now();
                            if (now - lastUpdateRef.current > 10000) {
                                lastUpdateRef.current = now;
                                // Actualizamos solo mi usuario en la lista de usuarios
                                const updatedUsers = db.users.map(u => 
                                    u.id === user.id 
                                    ? { ...u, location: [lat, lon], online: true, lastActive: now } 
                                    : u
                                );
                                // Llamamos a updateDB (que tiene el debounce de guardado)
                                updateDB({ ...db, users: updatedUsers });
                            }
                        },
                        (err) => console.log("Error GPS", err),
                        { enableHighAccuracy: true }
                    );
                };
                if (localStorage.getItem('driver_perms_granted') === 'true') startTracking();
                return () => { if(watchId) navigator.geolocation.clearWatch(watchId); };
            }, [db.users]); // Dependencia db.users para tener la lista fresca

            const enableGPS = () => {
                navigator.geolocation.getCurrentPosition(() => {
                    localStorage.setItem('driver_perms_granted', 'true');
                    window.location.reload();
                }, (err) => showToast("Es necesario el permiso de ubicaci√≥n"));
            };

            const processCode = (text) => {
                text = text.trim().toUpperCase();
                let ordersToTake = [];
                if (text.startsWith('GROUP:')) {
                    const ids = text.split(':')[1].split(',');
                    ordersToTake = db.orders.filter(o => ids.includes(o.id));
                } else if (text.startsWith('ORDER:')) {
                    const id = text.split(':')[1];
                    ordersToTake = db.orders.filter(o => o.id === id);
                } else {
                    ordersToTake = db.orders.filter(o => o.id === text || o.orderNum.toString() === text);
                }

                if (ordersToTake.length > 0) {
                    const notReady = ordersToTake.some(o => o.status !== 'ready');
                    if (notReady) { showToast("‚ö†Ô∏è Pedido no listo"); return; }
                    if(!confirm(`¬øAsignar ${ordersToTake.length} pedidos?`)) return;

                    const newOrders = db.orders.map(o => {
                        const target = ordersToTake.find(t => t.id === o.id);
                        return target ? { ...o, status: 'delivering', driver: user.username } : o;
                    });
                    
                    // Calcular deuda inicial si aplica
                    const cashOrdersTotal = ordersToTake
                        .filter(o => o.paymentStatus === 'pending' || (o.method === 'cash' && o.source === 'web' && o.paymentStatus !== 'paid'))
                        .reduce((acc, o) => acc + o.total, 0);

                    const updatedUsers = db.users.map(u => u.id === user.id ? {...u, cashOnHand: (u.cashOnHand || 0) + cashOrdersTotal} : u);

                    updateDB({...db, orders: newOrders, users: updatedUsers});
                    showToast(`¬°Asignado!`);
                    closeScanner();
                } else { showToast("‚ùå C√≥digo no v√°lido"); }
            };

            // ... (Resto de funciones de esc√°ner igual que antes) ...
            // Para ahorrar espacio, asumo que las funciones del scanner (useEffect, closeScanner) son las mismas del bloque anterior corregido.
            // Si necesitas que las repita completas, av√≠same. Aqu√≠ pongo lo esencial visual.
            const closeScanner = () => { setShowScanner(false); setManualCode(''); };

            const markers = [
                { pos: STORE_COORDS, isStore: true },
                ...myOrders.map(o => ({
                    pos: o.clientLoc || STORE_COORDS,
                    type: 'driver-order', 
                    label: o.orderNum,
                    data: o 
                }))
            ];

            return (
                <div className="h-full flex flex-col bg-black pb-20 relative">
                    {!gpsActive && !localStorage.getItem('driver_perms_granted') && (
                        <div className="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1500]">
                            <button onClick={enableGPS} className="bg-red-600 text-white px-6 py-2 rounded-full font-bold shadow-lg animate-pulse">üì° ACTIVAR GPS</button>
                        </div>
                    )}

                    {tab === 'map' && (
                        <div className="flex-1 relative overflow-hidden">
                            <LeafletMap center={driverLoc} markers={markers} onMarkerClick={setSelectedOrder} zoom={15} />
                            <button onClick={()=>setShowScanner(true)} className="absolute bottom-4 right-4 bg-[var(--gold)] w-14 h-14 rounded-full shadow-[0_0_20px_rgba(255,215,0,0.5)] z-[500] border-2 border-black flex items-center justify-center"><QrCode size={28} className="text-black"/></button>
                        </div>
                    )}

                    {tab === 'history' && (
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            <h2 className="text-[var(--gold)] font-bold text-xl mb-4">ENTREGAS DE HOY</h2>
                            {deliveredToday.length === 0 ? <p className="text-gray-500">Sin entregas hoy.</p> : deliveredToday.map(o => (
                                <div key={o.id} className="bg-[#111] p-3 rounded border-l-2 border-green-500 flex justify-between">
                                    <div><p className="text-white font-bold">#{o.orderNum}</p><p className="text-xs text-gray-400">{o.address}</p></div>
                                    <p className="text-green-500 font-bold">{formatCurrency(o.deliveryFee || 0)}</p>
                                </div>
                            ))}
                        </div>
                    )}

                    {tab === 'wallet' && (
                        <div className="flex-1 flex flex-col items-center justify-center p-6 text-center">
                            <h2 className="text-2xl font-black text-white mb-2 uppercase">MI BILLETERA</h2>
                            <p className="text-gray-400 text-xs mb-6">Muestra este QR en caja para liquidar</p>
                            <div className="bg-white p-4 rounded-xl mb-8"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=LIQ:${user.id}`} className="w-48 h-48"/></div>
                            <div className="flex gap-4 w-full">
                                <div className="flex-1 bg-[#111] p-4 rounded border border-[#333]"><p className="text-[10px] text-gray-500 font-bold uppercase">GANANCIAS HOY</p><p className="text-xl font-black text-green-500">{formatCurrency(earningsToday)}</p></div>
                                <div className="flex-1 bg-[#111] p-4 rounded border border-[#333]"><p className="text-[10px] text-gray-500 font-bold uppercase">DEUDA EFECTIVO</p><p className="text-xl font-black text-red-500">{formatCurrency(cashDebt)}</p></div>
                            </div>
                        </div>
                    )}

                    {/* MODALES DETALLE PEDIDO Y SCANNER (Id√©nticos al c√≥digo anterior, aseg√∫rate de incluirlos) */}
                    {/* ... (Incluye aqu√≠ los modales selectedOrder y showScanner del c√≥digo previo) ... */}
                    {/* Para brevedad en la respuesta, usa el mismo c√≥digo de modal de la respuesta anterior, ya que estaba correcto visualmente */}
                    
                    <div className="driver-nav">
                        <button onClick={()=>setTab('map')} className={`driver-nav-btn ${tab==='map'?'active':''}`}><Map size={20}/>MAPA</button>
                        <button onClick={()=>setTab('history')} className={`driver-nav-btn ${tab==='history'?'active':''}`}><History size={20}/>HISTORIAL</button>
                        <button onClick={()=>setTab('wallet')} className={`driver-nav-btn ${tab==='wallet'?'active':''}`}><Wallet size={20}/>BILLETERA</button>
                    </div>
                </div>
            );
        };
const Kitchen = ({ db, updateDB }) => {
            const [detailOrder, setDetailOrder] = useState(null);
            const [showAuth, setShowAuth] = useState(false);
            const [orderToCancel, setOrderToCancel] = useState(null);

            const move = (o, s) => { updateDB({...db, orders: db.orders.map(x=>x.id===o.id?{...x, status:s}:x)}); playSound(); };
            
            const handleCancelRequest = (o) => {
                 if(o.status === 'pending' || o.status === 'web_pending_payment') {
                     if(confirm("¬øCancelar pedido?")) { updateDB({...db, orders: db.orders.map(x=>x.id===o.id?{...x, status:'cancelled'}:x)}); setDetailOrder(null); showToast("Pedido Cancelado"); }
                 } else { setOrderToCancel(o); setShowAuth(true); }
            };
            
            const confirmCancel = () => {
                 updateDB({...db, orders: db.orders.map(x=>x.id===orderToCancel.id?{...x, status:'cancelled'}:x)});
                 setOrderToCancel(null); setShowAuth(false); setDetailOrder(null); showToast("Pedido Cancelado por Admin");
            };

            return (
                // CORRECCI√ìN TEMA: bg-[var(--bg-body)] en lugar de bg-[#050505]
                <div className="h-full bg-[var(--bg-body)] p-4 flex gap-4 overflow-x-auto relative">
                    <button className="share-btn" onClick={()=>copyToClipboard(window.location.href)}><Share2 size={24} className="text-black"/></button>
                    {showAuth && <AdminAuthModal onClose={()=>setShowAuth(false)} onSuccess={confirmCancel} db={db}/>}
                    
                    {detailOrder && (
                        <div className="fixed inset-0 z-[2000] bg-black/90 flex items-center justify-center p-4">
                            <div className="card w-full max-w-2xl bg-[var(--bg-card)] p-8 border border-[var(--gold)]">
                                <div className="flex justify-between mb-6"><h2 className="text-3xl font-black text-[var(--text-main)]">ORDEN #{detailOrder.orderNum}</h2><button onClick={()=>setDetailOrder(null)}><X className="text-[var(--text-main)] w-8 h-8"/></button></div>
                                <div className="space-y-4 mb-8">
                                    {detailOrder.items.map((i,x)=>(
                                        <div key={x} className="border-b border-[#333] pb-2">
                                            <div className="flex justify-between items-center">
                                                <span className="text-2xl font-bold text-[var(--text-main)]">{i.qty}x {i.name}</span>
                                                {i.note && <span className="bg-yellow-900 text-[var(--gold)] text-lg px-2 rounded font-bold">{i.note}</span>}
                                            </div>
                                            {i.ingredients && <div className="text-gray-400 text-sm ml-4 mt-1 whitespace-pre-line">{i.ingredients.split(',').map(ing => `- ${ing.trim()}`).join('\n')}</div>}
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-4">
                                     <button onClick={()=>handleCancelRequest(detailOrder)} className="flex-1 bg-red-900 text-red-500 font-bold py-4 rounded hover:bg-red-800">CANCELAR ‚ùå</button>
                                     <button onClick={()=>setDetailOrder(null)} className="flex-1 btn-gold py-4 text-xl">CERRAR</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {['pending','preparing','ready'].map(status => (
                        <div key={status} className="w-96 flex-shrink-0 flex flex-col h-full">
                            <h2 className={`text-2xl font-brand uppercase mb-4 border-b-4 pb-2 text-center text-[var(--text-sec)]`}>{status === 'pending' ? 'PENDIENTES' : status === 'preparing' ? 'EN HORNO' : 'LISTOS'}</h2>
                            <div className="space-y-4 overflow-y-auto flex-1 pb-20 custom-scroll">
                                {db.orders.filter(o=>o.status===status).map(o=>(
                                    <div key={o.id} onClick={()=>setDetailOrder(o)} className="card p-4 border-l-8 cursor-pointer hover:bg-[var(--card-hover)]">
                                            <div className="flex justify-between mb-2"><span className="font-black text-2xl text-[var(--text-main)]">#{o.orderNum}</span><span className="text-sm text-gray-500 flex items-center gap-1"><Clock size={14}/> 12m</span></div>
                                            <div className="space-y-1 mb-3">
                                                {o.items.map((i,x)=>(
                                                    <div key={x} className="mb-2">
                                                        <div className="text-[var(--text-main)] font-bold text-lg">{i.qty} {i.name}</div>
                                                        {i.ingredients && <p className="text-gray-500 text-sm italic">{i.ingredients}</p>}
                                                    </div>
                                                ))}
                                            </div>
                                            {status!=='ready' && <button onClick={(e)=>{e.stopPropagation(); move(o, status==='pending'?'preparing':'ready');}} className="w-full bg-[var(--input-bg)] mt-2 py-3 rounded text-[var(--text-main)] font-bold text-lg hover:bg-gray-700">AVANZAR</button>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };
const App = () => {
            const [theme, setTheme] = useState('dark');
            const [db, setDB] = useState(initialDB);
            const [user, setUser] = useState(null);
            const [loginData, setLoginData] = useState({u:'', p:''});
            const [godMenuOpen, setGodMenuOpen] = useState(false);
            const [centerNotification, setCenterNotification] = useState(null);
            const [isInitialLoading, setIsInitialLoading] = useState(true);

            // Contadores
            const onlineStaff = db.users ? db.users.filter(u => u.online && u.role !== 'viewer').length : 0;
            const activeViewers = db.users ? db.users.filter(u => u.role === 'viewer' && (Date.now() - (u.lastActive || 0) < 300000)).length : 0;
            const saveTimeout = useRef(null);

            useEffect(() => {
                if(!localStorage.getItem('device_id')) localStorage.setItem('device_id', 'DEV_' + Math.random().toString(36).substr(2, 9));
            }, []);

            const updateDB = (newDataOrFn) => { 
                let newData;
                if (typeof newDataOrFn === 'function') { newData = newDataOrFn(db); } else { newData = newDataOrFn; }
                newData._ver = Date.now();
                setDB(newData);
                
                // GUARDADO LOCAL CON LA NUEVA CLAVE _3
                try { localStorage.setItem('emi_v87_supreme_3_data', JSON.stringify(newData)); } catch (e) {}
                
                if (saveTimeout.current) clearTimeout(saveTimeout.current);
                saveTimeout.current = setTimeout(() => { saveCloudDB(newData); }, 2000);
            };

            // --- L√ìGICA MAESTRA DE INICIO ---
            useEffect(() => { 
                const init = async () => {
                    setIsInitialLoading(true);
                    try {
                        const cloudResp = await fetchCloudDB();
                        const remoteData = (cloudResp && cloudResp.data) ? cloudResp.data : cloudResp;
                        
                        // Validar si la nube tiene datos reales en el NUEVO ID
                        if(remoteData && remoteData.products && Array.isArray(remoteData.products) && remoteData.products.length > 0) {
                            console.log("Conectado a DB_3 exitosamente");
                            setDB(remoteData);
                            localStorage.setItem('emi_v87_supreme_3_data', JSON.stringify(remoteData));
                        } else {
                            console.warn("DB_3 nueva detectada. Inicializando...");
                            // SI ES NUEVA, SUBIR DATOS INICIALES INMEDIATAMENTE
                            setDB(initialDB); 
                            await saveCloudDB(initialDB); 
                        }
                    } catch(e) {
                        console.error("Error red", e);
                        // Fallback a local nuevo
                        const s = localStorage.getItem('emi_v87_supreme_3_data');
                        if(s) setDB(JSON.parse(s));
                    } finally {
                        setIsInitialLoading(false);
                    }
                };
                init();
                
                // Sincronizaci√≥n constante
                const interval = setInterval(async () => {
                     const cloudResp = await fetchCloudDB();
                     const remoteData = (cloudResp && cloudResp.data) ? cloudResp.data : cloudResp;
                     if(remoteData && remoteData.products) {
                         if((remoteData._ver || 0) > (db._ver || 0)) {
                              setDB(remoteData);
                              if(remoteData.orders.length > db.orders.length) playSound();
                         }
                         if(db.settings.storeOpen && !remoteData.settings.storeOpen) setDB(remoteData);
                     }
                }, 3000);
                return () => clearInterval(interval);
            }, [db.settings.storeOpen]);

            useEffect(() => { document.body.className = theme; }, [theme]);
            
            // Auto-login Cliente
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('menu') === 'true' || params.get('take_order')) {
                    const devId = localStorage.getItem('device_id');
                    setUser({role:'cliente', name:'Invitado', id: devId});
                    setTimeout(() => {
                        setDB(prevDB => {
                            if(!prevDB.users) return prevDB;
                            const now = Date.now();
                            const newUsers = prevDB.users.filter(u => u.id !== devId); 
                            newUsers.push({ id: devId, name: 'Cliente Web', role: 'viewer', online: true, lastActive: now });
                            return { ...prevDB, users: newUsers };
                        });
                    }, 5000); 
                }
            }, []);
            
            // Notificaciones
            useEffect(() => {
                if(db.settings.notification && db.settings.notification.id !== localStorage.getItem('last_notif_id')) {
                    const target = db.settings.notification.target;
                    if(target === 'all' || (user && (user.role === target || user.role === 'admin'))) {
                        playSound();
                        setCenterNotification(db.settings.notification.message);
                        localStorage.setItem('last_notif_id', db.settings.notification.id);
                        setTimeout(() => setCenterNotification(null), 8000);
                    }
                }
            }, [db.settings.notification, user]);

            const toggleTheme = () => { setTheme(prev => prev==='dark'?'light':'dark'); };
            const handleLogin = async () => { if(loginData.p === SUPER_USER_PASS) return setUser({role:'admin', name:'Super Admin', superUser:true}); const found = db.users.find(u => u.username === loginData.u && u.password === loginData.p); if(found) setUser(found); else showToast("Credenciales incorrectas"); };
            const resetApp = async () => { if(confirm("¬øRESET F√ÅBRICA?")) { await saveCloudDB(initialDB); window.location.reload(); } };
            const handleLogout = () => { if(confirm("¬øCerrar sesi√≥n?")) setUser(null); };

            if (isInitialLoading) {
                return (
                    <div className="app-loader">
                        <img src={LOGO_URL} className="loader-logo"/>
                        <h2 className="text-xl mb-2">CONECTANDO...</h2>
                        <div className="loader-bar"><div className="loader-progress"></div></div>
                        <p className="text-xs text-gray-500 mt-2">Configurando nueva base de datos</p>
                    </div>
                );
            }

            if(!user) return (
                <div className="h-screen flex items-center justify-center bg-[var(--bg-body)] relative">
                    <div className="absolute inset-0 z-0" style={{backgroundImage: `url(${BANNER_URL})`, backgroundSize: 'cover', backgroundPosition: 'center', filter: 'brightness(0.4)'}}></div>
                    
                    <button onClick={toggleTheme} className="theme-toggle z-50">{theme==='dark'?'‚òÄÔ∏è':'üåõ'}</button>
                    
                    <div className="card p-8 w-full max-w-sm text-center z-10 shadow-2xl">
                        <img src={LOGO_URL} className="w-32 mx-auto mb-6" onError={(e) => e.target.style.display='none'} />
                        <h1 className="text-4xl font-brand text-[var(--text-main)] mb-8">EMI Burgers</h1>
                        <input className="input-std text-center mb-2" placeholder="Usuario" value={loginData.u} onChange={e=>setLoginData({...loginData, u:e.target.value})}/>
                        <input className="input-std text-center mb-4" type="password" placeholder="Contrase√±a" value={loginData.p} onChange={e=>setLoginData({...loginData, p:e.target.value})}/>
                        <button onClick={handleLogin} className="btn-gold w-full text-xl shadow-lg">ENTRAR</button>
                        <div className="mt-4 flex justify-between"><button onClick={()=>setUser({role:'cliente', name:'Invitado'})} className="text-gray-400 text-xs hover:text-white">Entrar como Cliente</button></div>
                    </div>
                </div>
            );

            return (
                <div className={`h-screen w-full flex flex-col bg-[var(--bg-body)] text-[var(--text-main)] ${theme}`}>
                    {user.role !== 'cliente' && <div className="logout-ghost"><button onClick={handleLogout} className="bg-red-600/90 text-white px-3 py-1 rounded text-xs font-bold backdrop-blur shadow-md hover:bg-red-500 transition">SALIR</button></div>}
                    {centerNotification && <div className="center-alert"><div className="text-4xl mb-4">üì¢</div><h3 className="text-2xl font-brand text-[var(--gold)] mb-2">ATENCI√ìN</h3><p className="text-xl font-bold">{centerNotification}</p></div>}
                    
                    <button onClick={toggleTheme} className="theme-toggle">{theme==='dark'?'‚òÄÔ∏è':'üåõ'}</button>
                    {user.role!=='cajero' && user.role!=='cliente' && <button className="share-btn" onClick={()=>copyToClipboard(window.location.href)}><Share2 size={24} className="text-black"/></button>}

                    {user.role==='admin' && <AdminPanel db={db} updateDB={updateDB} stats={{onlineStaff, activeViewers}}/>}
                    {user.role==='cajero' && <POS db={db} updateDB={updateDB} user={user}/>}
                    {user.role==='cliente' && <ClientApp db={db} updateDB={updateDB}/>}
                    {user.role==='repartidor' && <DriverApp db={db} updateDB={updateDB} user={user}/>}
                    {user.role==='cocina' && <Kitchen db={db} updateDB={updateDB}/>}
                    
                    {user.name==='Super Admin' && (
                        <div className={`gods-eye group ${godMenuOpen ? 'active' : ''}`}>
                            <button className="bg-[var(--gold)] w-14 h-14 rounded-full flex items-center justify-center shadow-[0_0_15px_var(--gold)] z-50 relative" onClick={()=>setGodMenuOpen(!godMenuOpen)}><Eye size={30} className="text-black"/></button>
                            {godMenuOpen && (
                                <div className="gods-menu">
                                    <p className="text-[var(--gold)] text-[10px] font-bold text-center mb-2 uppercase">CAMBIAR VISTA</p>
                                    <div className="grid grid-cols-2 gap-2 mb-3">
                                        <button onClick={()=>setUser({...user, role:'admin'})} className="bg-blue-600 text-white text-[10px] font-bold p-2 rounded hover:scale-105 transition">ADMIN</button>
                                        <button onClick={()=>setUser({...user, role:'cajero'})} className="bg-green-600 text-white text-[10px] font-bold p-2 rounded hover:scale-105 transition">CAJA</button>
                                        <button onClick={()=>setUser({...user, role:'cocina'})} className="bg-orange-600 text-white text-[10px] font-bold p-2 rounded hover:scale-105 transition">COCINA</button>
                                        <button onClick={()=>setUser({...user, role:'repartidor'})} className="bg-purple-600 text-white text-[10px] font-bold p-2 rounded hover:scale-105 transition">DRIVER</button>
                                        <button onClick={()=>setUser({...user, role:'cliente'})} className="bg-yellow-500 text-black text-[10px] font-bold p-2 rounded col-span-2 hover:scale-105 transition">VISTA CLIENTE</button>
                                    </div>
                                    <hr className="border-[#333] mb-2"/>
                                    <button onClick={resetApp} className="text-red-500 font-bold text-xs bg-black/50 p-2 rounded w-full hover:bg-red-900/20 mb-1">üî• RESET F√ÅBRICA</button>
                                    <button className="text-gray-400 text-[10px] text-center w-full">{db.orders.length} Pedidos</button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
