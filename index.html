<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMI BURGERS - ¬°EL SABOR QUE MANDA!</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Roboto:wght@300;400;500;700;900&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="preload" as="image" href="./CERRADO_OFF.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --gold: #FFD700; 
            --accent: #FF4500; 
            --success: #00e676; 
            --danger: #ff3333;
            --bg-special: #F0EBEB; /* COLOR SOLICITADO */
            
            --z-map: 0; --z-ui: 10; --z-fab: 2000; --z-modal: 5000; --z-toast: 6000; --z-loader: 10000;
        }
        
        /* TEMA CLARO FORZADO */
        body { 
            --bg-body: #ffffff; 
            --bg-card: #ffffff; 
            --text-main: #000000; 
            --border: #d1d5db;
            
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: 'Roboto', sans-serif; 
            margin: 0; overflow: hidden; height: 100vh; width: 100vw; 
        }

        #root { height: 100%; width: 100%; overflow: hidden; display: flex; flex-direction: column; }
        .font-brand { font-family: 'Bangers', cursive; letter-spacing: 1.5px; }
        
        .card { 
            background-color: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
        }
        
        /* INPUTS CON EL COLOR ESPECIAL #F0EBEB */
        .input-std, .input-special { 
            background-color: var(--bg-special) !important; 
            border: 1px solid #ccc !important; 
            color: #000000 !important; 
            padding: 0.75rem; 
            width: 100%; 
            outline: none; 
            border-radius: 0.5rem; 
            font-weight: 500;
        }
        .input-std::placeholder { color: #666; }

        .btn-gold { background: linear-gradient(180deg, var(--gold) 0%, #e6c200 100%); color: black; font-weight: 900; border-radius: 0.75rem; padding: 0.8rem; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 0.5rem; }

        /* --- UTILS --- */
        .theme-toggle, .gods-eye, .share-btn, .dash-map-btn, .logout-ghost { position: fixed; z-index: var(--z-fab); cursor: pointer; }
        .theme-toggle { bottom: 10px; right: 10px; background: var(--bg-card); border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .gods-eye { bottom: 20px; left: 20px; opacity: 0.8; transform: scale(0.9); }
        .dash-map-btn { top: 75px; right: 0; background: #2563eb; color: white; padding: 10px 15px 10px 20px; border-radius: 30px 0 0 30px; font-weight: bold; font-size: 12px; z-index: 9998; display: flex; align-items: center; gap: 5px; }
        .logout-ghost { top: 10px; left: 10px; opacity: 0.8; }
        .share-btn { top: 15px; right: 15px; background: var(--gold); border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        
        body.client-mode .theme-toggle, body.client-mode .share-btn, body.client-mode .gods-eye, body.client-mode .dash-map-btn, body.client-mode .logout-ghost { display: none !important; }

        /* --- LOADER --- */
        .app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; z-index: var(--z-loader); display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--gold); font-family: 'Bangers', cursive; }
        .loader-logo { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--gold); object-fit: cover; animation: pulse-load 1s infinite; margin-bottom: 20px; }
        
        /* --- POS UI --- */
        .gestion-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .grid-cockpit { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 1rem; height: 90vh; }
        @media (max-width: 1024px) { .grid-cockpit { grid-template-columns: 1fr; overflow-y: auto; display: flex; flex-direction: column; height: auto; } }
        
        .mode-btn { padding: 1rem; border-radius: 0.5rem; font-weight: bold; margin-bottom: 0.5rem; border: 1px solid #ccc; background: white; color: black; transition: all 0.2s; width: 100%; text-align: left; }
        .mode-btn.active { background-color: var(--gold); color: black; border-color: black; transform: scale(1.02); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .bill-btn { background-size: cover; background-position: center; border-radius: 4px; height: 60px; width: 100%; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; background-color: white; }
        .admin-fab { position: fixed; bottom: 20px; right: 20px; z-index: var(--z-fab); display: flex; flex-direction: column; align-items: end; gap: 10px; }
        .admin-fab-menu { display: flex; flex-direction: column; align-items: end; gap: 10px; margin-bottom: 10px; animation: slide-up 0.3s ease-out; }
        @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Animation */
        @keyframes pulse-load { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }
        .leaflet-container { background: #f0f0f0; width: 100%; height: 100%; z-index: 0; }
        
        /* Preload Imagen Cerrado */
        .closed-store-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: black; background-image: url('./CERRADO_OFF.png'); background-size: contain; background-repeat: no-repeat; background-position: center; z-index: 10000; }
        .input-dark-force { background-color: #000 !important; color: #fff !important; }
        
        /* Estilos Driver */
        .driver-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #eee; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .driver-nav-btn { display: flex; flex-direction: column; align-items: center; color: #999; background: none; border: none; font-size: 10px; font-weight: bold; flex: 1; }
        .driver-nav-btn.active { color: var(--gold); text-shadow: 0px 0px 1px black; }
    </style>
</head>
<body class="dark">
    <div id="root"></div>
 <script type="text/babel" data-type="module">
        import { 
            Utensils, Truck, LayoutDashboard, LogOut, Plus, Minus, Search, MapPin, Printer, CreditCard, DollarSign, 
            Smartphone, User, QrCode, Clock, CheckCircle, AlertTriangle, FileText, Settings, Menu as MenuIcon, X, 
            Save, Trash2, ShoppingBag, Camera, Users, BarChart3, Bell, Ticket, TrendingUp, Lock, Eye, Send, Map, Navigation, 
            Wallet, Receipt, ArrowRight, Banknote, Power, Wifi, WifiOff, RefreshCw, Crosshair, Home, UserCheck, Calendar, Globe, QrCode as QRIcon,
            Package, Percent, Edit, Phone, Table, ArrowLeft, MessageCircle, Sun, Moon, Video, Copy, ClipboardList, PieChart, Link as LinkIcon, PenTool, Share2, MoreVertical, Download, Cloud, Info, Image, Ban, EyeOff,
            ChefHat, Bike, History, Unlock, Layers, MessageSquare, Box
        } from 'https://esm.sh/lucide-react@0.344.0';

        const React = window.React;
        const ReactDOM = window.ReactDOM;
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- 1. CONFIGURACI√ìN GLOBAL ---
        const STORE_COORDS = [27.446895, -109.943874]; 
        const CITY_SUFFIX = ", Ciudad Obreg√≥n, Sonora, Mexico";
        const SUPER_USER_PASS = "OBR1995@";
        const STORE_PHONE = "526443366197"; 
        
        const LOGO_URL = "./LOGO_1.png";
        const BANNER_URL = "./BANNER_MENU.jpg"; 
        const VIDEO_URL = "./WEB_PROMOCIONES.mp4";
        const CLOSED_IMG = "./CERRADO_OFF.png"; 

        // URL DE TU SCRIPT DE GOOGLE
        const API_URL = "https://script.google.com/macros/s/AKfycby7u7Y41wSQKuCTVn0WlI_uw3MbPf5bKXGAOddp7MpO_DBTJ8lwV1VEfMN7y7zAXH9cog/exec";
        
        // --- NUEVO ID DE BASE DE DATOS ---
        const DB_ID = "emi_db_v87_supreme_3";

        // --- UTILIDADES GLOBALES (DEFINIDAS UNA SOLA VEZ) ---
        const generateId = () => Math.random().toString(36).substr(2, 9).toUpperCase();
        const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(val || 0);

        const showToast = (msg) => {
            const div = document.createElement('div');
            div.className = 'custom-toast';
            div.innerHTML = `<span>üîî ${msg}</span>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        };

        const playSound = () => {
             try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, ctx.currentTime); 
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.2);
             } catch(e) { console.log("Audio not supported"); }
        };

        const copyToClipboard = (text) => {
            // Intento inteligente de crear link de men√∫ si es la URL base
            try {
                const urlObj = new URL(text);
                if(urlObj.href.includes(window.location.host)) {
                    urlObj.searchParams.set('menu', 'true');
                    text = urlObj.toString();
                }
            } catch(e) {}

            // M√©todo compatible
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => showToast("Copiado")).catch(() => fallbackCopy(text));
            } else {
                fallbackCopy(text);
            }
        };

        const fallbackCopy = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";  
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try { document.execCommand('copy'); showToast('Copiado'); } catch (err) {}
            document.body.removeChild(textArea);
        };

        const printTicket = (html) => {
            const win = window.open('', '', 'width=300,height=600');
            if(win){
                const currentUrl = window.location.href;
                const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
                win.document.write(`<html><head><base href="${baseUrl}"><style>body{font-family:monospace;font-size:12px;width:280px;margin:0;padding:10px;} .center{text-align:center;} .bold{font-weight:bold;} hr{border-top:1px dashed #000;} img{display:block;margin:0 auto;}</style></head><body>${html}</body></html>`);
                win.document.close(); setTimeout(() => { win.print(); win.close(); }, 500);
            } else { showToast("Permite popups para imprimir"); }
        };

        // --- 2. FUNCIONES DE CONEXI√ìN A NUBE (API) ---
        const fetchCloudDB = async () => {
            try {
                const res = await fetch(`${API_URL}?action=read&id=${DB_ID}&t=${Date.now()}`);
                if (!res.ok) throw new Error("Network response was not ok");
                return await res.json();
            } catch (e) { console.error("Error fetch", e); return null; }
        };

        const saveCloudDB = async (data) => {
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'update', id: DB_ID, data: data })
                });
            } catch (e) { console.error("Error save", e); }
        };

        // --- 3. BASE DE DATOS INICIAL ---
        const initialDB = {
            settings: {
                storeOpen: true,
                deliveryEnabled: true,
                pickupEnabled: true,
                deliveryRadius: 10,
                deliveryTable: [{min:0, max:3, price:30}, {min:3.1, max:5, price:40}, {min:5.1, max:8, price:50}, {min:8.1, max:10, price:60}],
                notification: { id: null, message: '', target: 'all' },
                paymentMethods: { cash: true, card: true },
                driverAssign: 'manual',
                supervisorKey: 'ADMIN123',
                cashLimit: 2000,
                providers: [], 
                platforms: ['Uber Eats', 'DiDi Food', 'Rappi'],
                ticketConfig: { header: 'EMI BURGERS\nCD. OBREGON', footer: '¬°GRACIAS POR SU COMPRA!' }
            },
            products: [], 
            orders: [],
            coupons: [],
            supplies: [],
            cashDrawer: { current: 0, initial: 0 },
            expenses: [],
            users: [
                {id: '1', name: 'Cajero Principal', role: 'cajero', username: 'caja', password: '123'},
                {id: '2', name: 'Cocina Master', role: 'cocina', username: 'cocina', password: '123'},
                {id: '3', name: 'Repartidor 1', role: 'repartidor', username: 'moto1', password: '123'}
            ]
        };

        // --- 4. HERRAMIENTAS GEOGR√ÅFICAS ---
        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            if(!lat1 || !lon1 || !lat2 || !lon2) return 0;
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180; 
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        const getDeliveryPrice = (dist, table) => {
            if (!table) return 0;
            const sorted = [...table].sort((a,b) => a.min - b.min);
            const rule = sorted.find(r => dist >= r.min && dist <= r.max);
            return rule ? rule.price : (sorted[sorted.length-1]?.price || 0);
        };

        const getCirclePoints = (center, radiusKm) => {
            const points = [];
            const earthRadius = 6371;
            for (let i = 0; i < 360; i += 5) {
                const lat1 = center[0] * Math.PI / 180;
                const lon1 = center[1] * Math.PI / 180;
                const brng = i * Math.PI / 180;
                const dist = radiusKm / earthRadius;
                const lat2 = Math.asin(Math.sin(lat1) * Math.cos(dist) + Math.cos(lat1) * Math.sin(dist) * Math.cos(brng));
                const lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(dist) * Math.cos(lat1), Math.cos(dist) - Math.sin(lat1) * Math.sin(lat2));
                points.push([lat2 * 180 / Math.PI, lon2 * 180 / Math.PI]);
            }
            return points;
        };
     
        const ModalAlert = ({ message, type, onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-black/90 z-[12000] flex items-center justify-center p-4 animate-in fade-in">
                <div className={`bg-[#1a1a1a] border-2 ${type==='confirm'?'border-[var(--gold)]':'border-red-500'} p-6 rounded-xl w-full max-w-sm text-center shadow-2xl`}>
                    <div className="mb-4 flex justify-center text-4xl">{type==='confirm'?'‚ùì':'‚ö†Ô∏è'}</div>
                    <p className="text-white text-lg font-bold mb-6 whitespace-pre-wrap">{message}</p>
                    <div className="flex gap-3">
                        {type === 'confirm' && <button onClick={onCancel} className="flex-1 bg-gray-700 text-white py-3 rounded-lg font-bold">CANCELAR</button>}
                        <button onClick={onConfirm} className={`flex-1 ${type==='confirm'?'btn-gold':'bg-red-600 text-white'} py-3 rounded-lg font-bold`}>{type==='confirm'?'ACEPTAR':'ENTENDIDO'}</button>
                    </div>
                </div>
            </div>
        );

const LeafletMap = ({ center, markers, zoom = 14, onClickMap, showHeatmap, route, radius, onMarkerClick }) => {
            const containerRef = useRef(null);
            const mapInstance = useRef(null);
            const userInteracted = useRef(0);

            // Efecto de Inicializaci√≥n y Actualizaci√≥n de Elementos
            useEffect(() => {
                if (!containerRef.current || typeof L === 'undefined') return;

                const safeCenter = (center && center[0] && center[1]) ? center : STORE_COORDS;
                // URLs limpias y correctas
                const darkUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
                const lightUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                const isDark = document.body.classList.contains('dark');

                if (!mapInstance.current) {
                    mapInstance.current = L.map(containerRef.current, { zoomControl: false, attributionControl: false }).setView(safeCenter, zoom);
                    L.tileLayer(isDark ? darkUrl : lightUrl).addTo(mapInstance.current);
                    
                    mapInstance.current.on('mousedown touchstart zoomstart', () => { userInteracted.current = Date.now(); });
                    if(onClickMap) mapInstance.current.on('click', (e) => onClickMap([e.latlng.lat, e.latlng.lng]));
                } else {
                    // Recentrado inteligente solo si el usuario no movi√≥ el mapa recientemente
                    if(Date.now() - userInteracted.current > 10000) {
                          const currentCenter = mapInstance.current.getCenter();
                          const dist = Math.sqrt(Math.pow(currentCenter.lat - safeCenter[0], 2) + Math.pow(currentCenter.lng - safeCenter[1], 2));
                          if (dist > 0.001) mapInstance.current.setView(safeCenter, zoom); 
                    }
                    setTimeout(() => mapInstance.current.invalidateSize(), 100);
                }

                // Limpieza de capas viejas
                mapInstance.current.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.Circle || layer instanceof L.Polyline || layer instanceof L.Polygon) mapInstance.current.removeLayer(layer);
                });

                // Dibujar Radio
                if (radius) {
                    const outerBounds = [[90, -180], [90, 180], [-90, 180], [-90, -180]];
                    const hole = getCirclePoints(STORE_COORDS, radius);
                    L.polygon([outerBounds, hole], { color: 'transparent', fillColor: '#111', fillOpacity: 0.6 }).addTo(mapInstance.current);
                    L.circle(STORE_COORDS, { color: '#00e676', fillColor: 'transparent', weight: 2, radius: radius * 1000 }).addTo(mapInstance.current);
                }

                // Dibujar Marcadores
                if(showHeatmap) {
                     markers.forEach((m) => {
                         if(m.pos && m.pos[0] && m.pos[1]) {
                           if (!m.isStore) L.circle(m.pos, { color: 'red', fillColor: '#f03', fillOpacity: 0.2, radius: 300, stroke: false }).addTo(mapInstance.current);
                           else {
                               const el = document.createElement('div');
                               el.className = 'custom-pin';
                               el.innerHTML = `<img src="${LOGO_URL}" style="width:40px;height:40px;border-radius:50%;border:2px solid gold;">`;
                               const icon = L.divIcon({ className: 'bg-transparent', html: el, iconSize: [40,40], iconAnchor: [20,20] });
                               L.marker(m.pos, { icon }).addTo(mapInstance.current);
                           }
                         }
                     });
                } else {
                    markers.forEach((m) => {
                        if(m.pos && m.pos[0] && m.pos[1]) {
                            const el = document.createElement('div');
                            if (m.isMyLoc) {
                                el.className = 'user-gps-dot';
                            } else if(m.isClient) { 
                                el.className = 'custom-pin';
                                el.innerHTML = '<div style="font-size:30px;">üîµ</div>'; 
                            } else if (m.type === 'driver-order') {
                                el.className = 'driver-order-icon';
                                el.innerHTML = `<div>üçî</div><span class="driver-order-num">${m.label}</span>`;
                            } else {
                                el.className = m.type === 'driver' ? 'driver-pin' : 'custom-pin';
                                if(m.isStore) { 
                                    el.innerHTML = `<img src="${LOGO_URL}" style="width:40px;height:40px;border-radius:50%;border:2px solid gold;">`;
                                } else if (m.type === 'driver') {
                                    el.innerHTML = 'üèçÔ∏è';
                                } else {
                                    el.innerHTML = m.emoji || 'üìç';
                                }
                            }
                            
                            if(m.label && !m.isMyLoc && m.type !== 'driver-order') {
                                 const lbl = document.createElement('div');
                                 lbl.className = 'absolute -bottom-5 left-1/2 transform -translate-x-1/2 bg-black/80 text-white text-[10px] px-1 rounded whitespace-nowrap border border-white/20';
                                 lbl.innerText = m.label;
                                 el.appendChild(lbl);
                            }
                            const iconSize = m.isMyLoc ? [20,20] : (m.type==='driver'?[36,36]:[40,40]);
                            const icon = L.divIcon({ className: 'bg-transparent', html: el, iconSize: iconSize, iconAnchor: [iconSize[0]/2, iconSize[1]/2] });
                            const marker = L.marker(m.pos, { icon }).addTo(mapInstance.current);
                            if(m.popup) marker.bindPopup(m.popup);
                            if(m.data && onMarkerClick) marker.on('click', () => onMarkerClick(m.data));
                        }
                    });
                }

                // Dibujar Ruta
                if(route && route.length >= 2) {
                     const validRoute = route.filter(p => p && p[0] && p[1]);
                     if(validRoute.length >= 2) {
                         L.polyline(validRoute, {color: '#4285F4', weight: 6, opacity: 0.9, dashArray: '10, 10'}).addTo(mapInstance.current);
                         if(Date.now() - userInteracted.current > 10000) {
                            const bounds = L.latLngBounds(validRoute);
                            if(bounds.isValid()) mapInstance.current.fitBounds(bounds, { padding: [50, 50] });
                         }
                     }
                }
            }, [center, markers, showHeatmap, radius, route]); 

            // DETECTOR DE CAMBIO DE TEMA (Para cambiar el mapa autom√°ticamente)
            useEffect(() => {
                if(!mapInstance.current) return;
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === "class") {
                            const isDark = document.body.classList.contains('dark');
                            const url = isDark 
                                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' 
                                : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                            
                            mapInstance.current.eachLayer(layer => {
                                if (layer instanceof L.TileLayer) layer.setUrl(url);
                            });
                        }
                    });
                });
                observer.observe(document.body, { attributes: true });
                return () => observer.disconnect();
            }, []);
            
            if (typeof L === 'undefined') return <div className="w-full h-full flex items-center justify-center bg-gray-800 text-white">Cargando Mapa...</div>;

            return <div ref={containerRef} className="h-full w-full rounded-lg bg-[var(--bg-card)] border border-[var(--border)] z-0 relative overflow-hidden"></div>;
        };

        const QRScanner = ({ onScan, onClose }) => {
             useEffect(() => {
                const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }, false);
                scanner.render((decodedText) => {
                    onScan(decodedText);
                    scanner.clear();
                }, (error) => {});
                return () => { try { scanner.clear(); } catch(e){} };
            }, []);

            return (
                <div id="reader" style={{width:'100%', height:'100%'}}></div>
            ); 
        };

        const AdminAuthModal = ({ onClose, onSuccess, db }) => {
            const [pass, setPass] = useState('');
            const check = () => {
                if(pass === SUPER_USER_PASS || pass === db.settings.supervisorKey) {
                    onSuccess();
                } else {
                    showToast("Contrase√±a incorrecta");
                }
            };
            return (
                <div className="fixed inset-0 bg-black/90 z-[10000] flex items-center justify-center p-4">
                    <div className="bg-[var(--bg-card)] p-6 rounded border border-[var(--gold)] w-full max-w-xs text-center">
                        <h3 className="text-xl font-bold text-white mb-4"><Lock className="inline mb-1"/> AUTORIZACI√ìN</h3>
                        <input type="password" className="input-std text-center text-xl mb-4" placeholder="Clave Admin/Supervisor" value={pass} onChange={e=>setPass(e.target.value)} autoFocus/>
                        <div className="flex gap-2">
                            <button onClick={onClose} className="flex-1 bg-gray-600 text-white py-2 rounded">CANCELAR</button>
                            <button onClick={check} className="flex-1 btn-gold py-2 rounded">ACEPTAR</button>
                        </div>
                    </div>
                </div>
            );
        };

const Dashboard = ({ db }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);
            const [selectedZone, setSelectedZone] = useState(null);
            const [showMermas, setShowMermas] = useState(false);
            const [viewMap, setViewMap] = useState(false);

            const validOrders = db.orders.filter(o => o.status !== 'cancelled');
            const cancelledOrders = db.orders.filter(o => o.status === 'cancelled');

            const sales = validOrders.reduce((a,b)=>a+b.total,0);
            const expenses = db.expenses.reduce((a,b)=>a+b.amount,0);
            
            const activeOrders = db.orders.filter(o => o.status === 'delivering' || o.status === 'pending');
            const drivers = db.users.filter(u => u.role === 'repartidor' && u.online);
            
            const liveMarkers = [
                { pos: STORE_COORDS, emoji: 'üè™', isStore: true },
                ...activeOrders.map(o => ({ pos: o.clientLoc || STORE_COORDS, emoji: 'üçî', popup: `Pedido #${o.orderNum}` })),
                ...drivers.map(d => ({ pos: d.location || STORE_COORDS, emoji: 'üèçÔ∏è', label: d.name, type: 'driver' }))
            ];

            useEffect(() => {
                if(!canvasRef.current) return;
                if(chartRef.current) chartRef.current.destroy();

                const ctx = canvasRef.current.getContext('2d');
                const salesByDate = {};
                validOrders.forEach(o => {
                    const date = new Date(o.createdAt).toLocaleDateString();
                    salesByDate[date] = (salesByDate[date] || 0) + o.total;
                });
                const labels = Object.keys(salesByDate).slice(-7);
                const data = Object.values(salesByDate).slice(-7);

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.length ? labels : ['Hoy'],
                        datasets: [{ label: 'Ventas ($)', data: data.length ? data : [0], borderColor: '#FFD700', backgroundColor: 'rgba(255, 215, 0, 0.2)', tension: 0.4, fill: true }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: 'white' } } }, scales: { y: { ticks: { color: 'white' }, grid: { color: '#333' } }, x: { ticks: { color: 'white' }, grid: { color: '#333' } } } }
                });
                return () => { if(chartRef.current) chartRef.current.destroy(); }
            }, [db.orders]);

            const platformStats = validOrders.reduce((acc, o) => { const key = o.source === 'web' ? 'WEB' : (o.source === 'platform' ? (o.platformName || 'APP') : 'TIENDA'); acc[key] = (acc[key] || 0) + 1; return acc; }, {});
            const expired = db.supplies.filter(s => new Date(s.expiry) < new Date());
            const actualTopProducts = Object.entries(validOrders.reduce((acc, o) => {
                o.items.forEach(i => acc[i.name] = (acc[i.name] || 0) + i.qty);
                return acc;
            }, {})).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const topProducts = actualTopProducts.length > 0 ? actualTopProducts : [['Producto 1', 0], ['Producto 2', 0], ['Producto 3', 0]];
            const maxProdVal = actualTopProducts.length > 0 ? actualTopProducts[0][1] : 1;

            const handleMapClick = (markerData) => {
                 if (markerData && markerData.isStore) {
                 } else if (actualTopProducts.length > 0) {
                    const topItem = actualTopProducts[0][0];
                    const topQty = actualTopProducts[0][1];
                    showToast(`Zona Caliente: ${topItem} (${topQty} ventas)`);
                    setSelectedZone({ name: "Zona Centro", topItem: topItem, summary: `${topItem} lidera con ${topQty} unidades` });
                    setTimeout(() => setSelectedZone(null), 5000);
                } else {
                    showToast("Sin datos de ventas para mostrar zonas.");
                }
            };
            
            const hotZoneMarkers = [
                { pos: STORE_COORDS, emoji: 'üè™', popup: 'Tienda', isStore: true, data: {isStore: true} }, 
                ...validOrders.filter(o=>o.clientLoc).map(o=>({pos:o.clientLoc}))
            ];

            if (viewMap) {
                return (
                    <div className="h-full flex flex-col p-4">
                         <div className="flex justify-between items-center mb-4">
                             <h2 className="text-2xl font-bold text-[var(--gold)]">RASTREO EN VIVO</h2>
                             <button onClick={()=>setViewMap(false)} className="bg-red-600 text-white px-4 py-2 rounded">CERRAR MAPA</button>
                         </div>
                         <div className="flex-1 rounded border border-[var(--gold)] overflow-hidden">
                             <LeafletMap center={STORE_COORDS} markers={liveMarkers} zoom={13}/>
                         </div>
                         <div className="mt-2 flex gap-4 text-sm text-gray-400">
                             <span className="flex items-center gap-1">üçî Pedidos Activos</span>
                             <span className="flex items-center gap-1">üèçÔ∏è Repartidores</span>
                         </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6 animate-in fade-in pb-20 overflow-y-auto h-full">
                    {/* BOT√ìN RASTREO FLOTANTE (RESTAURADO) */}
                    <button className="dash-map-btn" onClick={()=>setViewMap(true)}>
                        <Map size={24}/> RASTREO
                    </button>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="card p-4 border-l-4 border-[var(--gold)]"><p className="text-gray-400 text-xs font-bold uppercase">Ventas</p><p className="text-3xl font-black text-[var(--text-main)]">{formatCurrency(sales)}</p></div>
                        <div className="card p-4 border-l-4 border-red-500"><p className="text-gray-400 text-xs font-bold uppercase">Gastos</p><p className="text-3xl font-black text-[var(--text-main)]">{formatCurrency(expenses)}</p></div>
                        <div className="card p-4 border-l-4 border-green-500"><p className="text-gray-400 text-xs font-bold uppercase">Utilidad</p><p className="text-3xl font-black text-[var(--text-main)]">{formatCurrency(sales - expenses)}</p></div>
                        <div className="card p-4 border-l-4 border-blue-500"><p className="text-gray-400 text-xs font-bold uppercase">Pedidos</p><p className="text-3xl font-black text-[var(--text-main)]">{validOrders.length}</p></div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="flex flex-col gap-4">
                            <div className="card p-6 h-64 flex-shrink-0">
                                <h3 className="font-bold text-[var(--text-main)] mb-2 flex items-center gap-2"><BarChart3 size={20}/> Historial de Ventas</h3>
                                <div className="w-full h-full pb-6"><canvas ref={canvasRef}></canvas></div>
                            </div>
                            <div className="card p-4 bg-[#222] border-l-4 border-red-800 h-64 overflow-y-auto custom-scroll">
                                <h3 className="font-bold text-red-500 mb-2 flex items-center gap-2"><Ban size={16}/> √ìrdenes Canceladas ({cancelledOrders.length})</h3>
                                {cancelledOrders.map(o => (
                                    <div key={o.id} className="border-b border-[#444] py-2 text-xs">
                                        <div className="flex justify-between text-white font-bold"><span>#{o.orderNum}</span><span>{formatCurrency(o.total)}</span></div>
                                        <p className="text-gray-400">{new Date(o.createdAt).toLocaleString()}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="card p-6 relative h-96 md:h-auto min-h-[300px] overflow-hidden"> 
                            <h3 className="font-bold text-[var(--text-main)] mb-4 flex items-center gap-2"><Map size={20}/> Zonas Calientes</h3>
                            <div className="h-full w-full absolute inset-0 pt-16 px-6 pb-6 rounded border border-[var(--border)]">
                                <LeafletMap center={STORE_COORDS} markers={hotZoneMarkers} showHeatmap={true} zoom={12} onMarkerClick={handleMapClick}/>
                                {selectedZone && <div className="absolute bottom-4 left-4 right-4 bg-black/90 text-white p-4 rounded z-[500] animate-in slide-in-from-bottom border border-[var(--gold)] text-center shadow-2xl">
                                    <h4 className="font-bold text-[var(--gold)] text-lg mb-1">üî• RESUMEN DE ZONA</h4>
                                    <p className="text-sm">{selectedZone.summary}</p>
                                </div>}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6">
                        <div className="card p-6">
                            <h3 className="font-bold text-[var(--gold)] mb-4 flex items-center gap-2"><TrendingUp size={20}/> Productos M√°s Vendidos</h3>
                            {topProducts.map(([name, qty], i) => (
                                <div key={i} className="mb-2">
                                    <div className="flex justify-between text-sm mb-1"><span className="text-[var(--text-main)]">{name}</span><span className="text-[var(--gold)]">{qty}</span></div>
                                    <div className="progress-bar"><div className="progress-fill bg-[var(--gold)]" style={{width: `${(qty/maxProdVal)*100}%`}}></div></div>
                                </div>
                             ))}
                        </div>

                        <div className="space-y-4">
                            <div className="card p-6">
                                <h3 className="font-bold text-[var(--text-main)] mb-4">Ventas por Canal</h3>
                                {Object.keys(platformStats).length === 0 ? <p className="text-gray-500 text-sm">Sin datos</p> : Object.entries(platformStats).map(([key, val]) => (
                                     <div key={key} className="flex justify-between items-center py-2 border-b border-[var(--border)]">
                                          <span className="text-[var(--text-main)]">{key}</span><span className="bg-[var(--input-bg)] px-2 rounded text-[var(--text-main)] text-xs">{val}</span>
                                     </div>
                                ))}
                            </div>
                            <div className="card p-6 border-l-4 border-red-500 cursor-pointer hover:bg-[var(--input-bg)]" onClick={()=>setShowMermas(true)}>
                                <h3 className="font-bold text-red-500 mb-2 flex items-center gap-2"><AlertTriangle size={16}/> P√©rdidas / Caducados</h3>
                                <div className="text-4xl font-black text-[var(--text-main)] mb-2">{expired.length}</div>
                            </div>
                        </div>
                    </div>

                    {showMermas && (
                        <div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4">
                            <div className="card w-full max-w-2xl bg-[var(--bg-card)] p-6">
                                <h3 className="text-2xl font-bold text-red-500 mb-4">DETALLE DE MERMAS</h3>
                                <table className="w-full text-left text-sm text-[var(--text-main)]">
                                    <thead><tr className="border-b border-[var(--border)]"><th>Producto</th><th>Entrada</th><th>Caducidad</th><th>Stock Perdido</th></tr></thead>
                                    <tbody>
                                        {expired.map(s => (
                                            <tr key={s.id} className="border-b border-[#333]">
                                                <td className="p-2">{s.name}</td>
                                                <td className="p-2">{s.entryDate || '-'}</td>
                                                <td className="p-2 text-red-500 font-bold">{s.expiry}</td>
                                                <td className="p-2">{s.stock} {s.unit}</td>
                                            </tr>
                                        ))}
                                        {expired.length === 0 && <tr><td colSpan="4" className="p-4 text-center text-gray-500">No hay registros de caducidad.</td></tr>}
                                    </tbody>
                                </table>
                                <button onClick={()=>setShowMermas(false)} className="mt-6 btn-gold w-full">CERRAR</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        const ProductManager = ({ db, updateDB }) => {
            const [modal, setModal] = useState(null);
            const [form, setForm] = useState({ name:'', price:0, cat:'', img:'', desc:'', ingredients:'', isComplement: false, active: true });
            
            const handleCSV = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = ev => {
                        const lines = ev.target.result.split('\n').slice(1);
                        const newProds = lines.map(l => {
                            const [name, price, cat, desc, img] = l.split(',');
                            return name ? {id:generateId(), name, price:parseFloat(price), cat, desc, img, active:true} : null;
                        }).filter(Boolean);
                        updateDB({...db, products: [...db.products, ...newProds]});
                    };
                    r.readAsText(f);
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setForm({...form, img: reader.result});
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            const save = () => {
                let products = [...db.products];
                if(form.id) products = products.map(p => p.id === form.id ? form : p);
                else products.push({ ...form, id: generateId() });
                updateDB({...db, products}); setModal(null);
            };
            
            const remove = (id) => { if(confirm("¬øEliminar?")) updateDB({...db, products: db.products.filter(p=>p.id!==id)}); };
            const toggleActive = (p) => { updateDB({...db, products: db.products.map(x=>x.id===p.id?{...x, active:!x.active}:x)}); };

            const groupedProducts = useMemo(() => {
                const groups = {};
                db.products.forEach(p => {
                    const cat = p.cat || 'Otros';
                    if (!groups[cat]) groups[cat] = [];
                    groups[cat].push(p);
                });
                return groups;
            }, [db.products]);

            return (
                <div className="space-y-6 overflow-y-auto h-full pb-20">
                    <div className="flex gap-2 sticky top-0 bg-[var(--bg-body)] z-20 pb-2">
                        <button onClick={()=>{setForm({name:'', price:0, cat:'', img:'', desc:'', ingredients:'', isComplement:false, active:true}); setModal(true);}} className="btn-gold z-10">NUEVO PRODUCTO</button>
                        <label className="btn-gold cursor-pointer bg-blue-600 text-white z-10">CARGAR CSV <input type="file" hidden onChange={handleCSV}/></label>
                        <button onClick={()=>{
                            const csv = "Nombre,Precio,Categoria,Descripcion,Imagen\nHamburguesa,100,Burgers,Rica,url";
                            const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv); a.download='plantilla.csv'; a.click();
                        }} className="btn-gold bg-green-600 text-white z-10">PLANTILLA</button>
                    </div>
                    
                    {Object.entries(groupedProducts).map(([cat, prods]) => (
                        <div key={cat} className="mb-6">
                            <h3 className="text-2xl font-bold text-[var(--gold)] mb-3 border-b border-[var(--border)]">{cat}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {prods.map(p => (
                                    <div key={p.id} className={`card p-3 flex gap-3 items-center group ${!p.active ? 'opacity-50' : ''}`}>
                                                <img src={p.img} className="w-16 h-16 rounded object-cover"/>
                                                <div className="flex-1">
                                                    <p className="font-bold text-[var(--text-main)]">{p.name}</p>
                                                    <p className="text-[var(--gold)] font-bold">{formatCurrency(p.price)}</p>
                                                    {p.isComplement && <span className="text-[10px] bg-blue-900 text-blue-200 px-1 rounded">Complemento</span>}
                                                </div>
                                                <div className="flex gap-2 z-10">
                                                    <button onClick={()=>toggleActive(p)} className={`p-2 rounded ${p.active?'text-green-500':'text-red-500'}`}>{p.active?<Eye size={16}/>:<EyeOff size={16}/>}</button>
                                                    <button onClick={()=>{
                                                        setForm({
                                                            id: p.id,
                                                            name: p.name || '', 
                                                            price: p.price || 0,
                                                            cat: p.cat || '',
                                                            img: p.img || '',
                                                            desc: p.desc || '',
                                                            ingredients: p.ingredients || '',
                                                            isComplement: p.isComplement || false,
                                                            active: p.active !== undefined ? p.active : true
                                                        }); 
                                                        setModal(true);
                                                    }} className="text-blue-500 p-2 rounded"><Edit size={16}/></button>
                                                    <button onClick={()=>remove(p.id)} className="text-red-600 p-2 rounded"><Trash2 size={16}/></button>
                                                </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}

                    {modal && (
                        <div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4">
                            <div className="card w-full max-w-lg bg-[var(--bg-card)] p-6">
                                <h3 className="text-[var(--text-main)] font-bold mb-4">{form.id?'EDITAR':'NUEVO'} PRODUCTO</h3>
                                <div className="grid grid-cols-2 gap-2 mb-4">
                                    <input className="input-std" placeholder="Nombre" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})}/>
                                    <input className="input-std" type="number" placeholder="Precio" value={form.price||''} onChange={e=>setForm({...form,price:parseFloat(e.target.value)})}/>
                                    <input className="input-std" placeholder="Categor√≠a" value={form.cat||''} onChange={e=>setForm({...form,cat:e.target.value})}/>
                                    <div className="flex gap-1">
                                        <input className="input-std" placeholder="URL Imagen" value={form.img||''} onChange={e=>setForm({...form,img:e.target.value})}/>
                                        <label className="btn-gold cursor-pointer flex items-center justify-center"><Image size={16}/><input type="file" hidden accept="image/*" onChange={handleImageUpload}/></label>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 mb-2">
                                    <input type="checkbox" checked={form.isComplement} onChange={e=>setForm({...form, isComplement:e.target.checked})}/>
                                    <span className="text-[var(--text-main)] text-sm">¬øEs un complemento? (Aparecer√° al pagar)</span>
                                </div>
                                <input className="input-std mb-2" placeholder="Ingredientes (Separa por comas)" value={form.ingredients||''} onChange={e=>setForm({...form,ingredients:e.target.value})}/>
                                <textarea className="input-std mb-4" placeholder="Descripci√≥n" value={form.desc||''} onChange={e=>setForm({...form,desc:e.target.value})}/>
                                <div className="flex justify-end gap-2">
                                    <button onClick={()=>setModal(null)} className="text-gray-500">CANCELAR</button>
                                    <button onClick={save} className="btn-gold">GUARDAR</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const InventoryManager = ({ db, updateDB }) => {
            const [newItem, setNewItem] = useState({ name:'', stock:'', unit:'PZ', expiry:'' });
            const [editItem, setEditItem] = useState(null);
            const save = () => {
                if(editItem) { updateDB({...db, supplies: db.supplies.map(s=>s.id===editItem.id?editItem:s)}); setEditItem(null); } 
                else if(newItem.name) { updateDB({...db, supplies: [...db.supplies, {...newItem, id: generateId()}]}); setNewItem({ name:'', stock:'', unit:'PZ', expiry:'' }); }
            };
            return (
                <div className="space-y-4 overflow-y-auto h-full pb-20">
                    <div className="card p-4 border-l-4 border-green-500 flex gap-2 items-end"><div className="flex-1"><label className="text-xs text-gray-500">Insumo</label><input className="input-std" value={newItem.name} onChange={e=>setNewItem({...newItem, name:e.target.value})}/></div><div className="w-20"><label className="text-xs text-gray-500">Stock</label><input className="input-std" type="number" value={newItem.stock} onChange={e=>setNewItem({...newItem, stock:e.target.value})}/></div><div className="w-32"><label className="text-xs text-gray-500">Caducidad</label><input className="input-std" type="date" value={newItem.expiry} onChange={e=>setNewItem({...newItem, expiry:e.target.value})}/></div><button onClick={save} className="btn-gold h-[46px]"><Plus/></button></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{db.supplies.map(s => { const days = s.expiry ? Math.ceil((new Date(s.expiry) - new Date()) / 86400000) : 99; const isLow = s.stock < 5 || days < 3; return (<div key={s.id} className={`card p-4 flex justify-between items-center cursor-pointer relative group ${isLow?'border-red-500 border':''}`} onClick={()=>setEditItem(s)}><div><p className="font-bold text-[var(--text-main)]">{s.name}</p><p className={`text-xs ${days<3?'text-red-500 font-bold':'text-gray-400'}`}>Exp: {s.expiry}</p></div><div className="flex items-center gap-2"><p className="text-[var(--gold)] font-bold">{s.stock} {s.unit}</p><button onClick={(e)=>{e.stopPropagation(); updateDB({...db, supplies: db.supplies.filter(x=>x.id!==s.id)})}} className="text-red-500 hover:scale-110 z-10"><Trash2/></button></div></div>); })}</div>
                    {editItem && <div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4"><div className="card bg-[var(--bg-card)] p-6"><h3 className="font-bold mb-4 text-[var(--text-main)]">EDITAR</h3><input className="input-std mb-2" value={editItem.name} onChange={e=>setEditItem({...editItem, name:e.target.value})}/><input className="input-std mb-2" type="number" value={editItem.stock} onChange={e=>setEditItem({...editItem, stock:e.target.value})}/><input className="input-std mb-4" type="date" value={editItem.expiry} onChange={e=>setEditItem({...editItem, expiry:e.target.value})}/><div className="flex justify-end gap-2"><button onClick={()=>setEditItem(null)} className="text-gray-500">CANCELAR</button><button onClick={save} className="btn-gold">GUARDAR</button></div></div></div>}
                </div>
            );
        };

        const StaffManager = ({ db, updateDB }) => {
            const [editing, setEditing] = useState(null);
            const [mode, setMode] = useState('list');
            const [checadorUser, setChecadorUser] = useState('');
            const days = ['Lun','Mar','Mie','Jue','Vie','Sab','Dom'];

            const copyMonday = (u) => {
                const mon = u.schedule?.['Lun'];
                if(!mon) return showToast("Configura Lunes primero");
                const newSch = {};
                days.forEach(d => newSch[d] = {...mon});
                const updated = db.users.map(x=>x.id===u.id?{...x, schedule: newSch}:x);
                updateDB({...db, users:updated});
                setEditing({...editing, schedule: newSch});
            };

            const calculatePayroll = (u) => {
                const dailyRate = u.salary / 7;
                const workedDays = days.filter(d => u.schedule?.[d]?.in).length; 
                return formatCurrency(dailyRate * workedDays);
            };

            const handleCheckInOut = (u) => {
                const last = (u.attendance || []).length > 0 ? u.attendance[u.attendance.length-1] : null;
                const now = new Date();
                let newAtt;
                if(last && !last.out) {
                    newAtt = [...u.attendance];
                    newAtt[newAtt.length-1].out = now.toISOString();
                } else {
                    newAtt = [...(u.attendance || []), {in: now.toISOString(), out: null}];
                }
                updateDB({...db, users: db.users.map(x=>x.id===u.id?{...x, attendance: newAtt}:x)});
                showToast(`Registro Exitoso: ${u.name}`);
            };
            
            const handleChecadorSubmit = () => {
                const u = db.users.find(u => u.username === checadorUser);
                if(u) {
                    handleCheckInOut(u);
                    setChecadorUser('');
                } else showToast("Usuario no encontrado");
            };

            const deleteUser = (id) => {
                if(confirm("¬øEliminar empleado?")) {
                    updateDB({...db, users: db.users.filter(u=>u.id!==id)});
                    setEditing(null);
                }
            };

            const printSchedule = (u) => {
                const sched = days.map(d=>`${d}: ${u.schedule?.[d]?.in||'-'} - ${u.schedule?.[d]?.out||'-'}`).join('<br>');
                const att = (u.attendance || []).map(a=>`${new Date(a.in).toLocaleDateString()}: ${new Date(a.in).toLocaleTimeString()} - ${a.out?new Date(a.out).toLocaleTimeString():'...'}`).join('<br>');
                printTicket(`<b>${u.name}</b><br><hr>HORARIO:<br>${sched}<br><hr>ASISTENCIA:<br>${att}`);
            };

            if(mode === 'checador') return (
                <div className="h-full flex flex-col items-center justify-center p-6">
                    <h2 className="text-3xl font-brand text-[var(--gold)] mb-8">RELOJ CHECADOR</h2>
                    <div className="card p-8 w-full max-w-md bg-[var(--bg-card)] text-center">
                        <QrCode size={128} className="mx-auto mb-4 text-white"/>
                        <p className="mb-4 text-gray-400">Ingresa tu usuario para registrar entrada/salida</p>
                        <input className="input-std text-center mb-4 text-xl uppercase" placeholder="USUARIO" value={checadorUser} onChange={e=>setChecadorUser(e.target.value)}/>
                        <button onClick={handleChecadorSubmit} className="btn-gold w-full text-xl shadow-lg">REGISTRAR</button>
                    </div>
                    <button onClick={()=>setMode('list')} className="mt-8 text-gray-500 underline">Volver a Lista</button>
                </div>
            );

            return (
                <div className="space-y-6 overflow-y-auto h-full pb-20">
                      <div className="flex justify-between items-center mb-4">
                        <button onClick={()=>setEditing({name:'', role:'cajero', username:'', password:'', schedule:{}, salary:0})} className="btn-gold">AGREGAR EMPLEADO</button>
                        <button onClick={()=>setMode('checador')} className="bg-blue-600 text-white px-4 py-2 rounded font-bold flex gap-2"><Clock/> CHECADOR</button>
                      </div>
                      
                      <div className="overflow-x-auto">
                          <table className="w-full text-left text-sm text-[var(--text-main)]">
                              <thead><tr className="border-b border-[var(--border)]"><th className="p-2">Nombre</th><th className="p-2 w-full text-center">Horario / Progreso</th><th className="p-2">N√≥mina</th><th className="p-2">Acci√≥n</th></tr></thead>
                              <tbody>
                                  {db.users.filter(u=>u.role!=='admin').map(u=>{
                                      const attendance = u.attendance || [];
                                      const last = attendance.length > 0 ? attendance[attendance.length-1] : null;
                                      const isWorking = last && !last.out;
                                      const startTime = isWorking ? new Date(last.in).toLocaleTimeString() : '';
                                      return (
                                      <tr key={u.id} className="border-b border-[var(--border)] hover:bg-[var(--input-bg)] cursor-pointer" onClick={()=>setEditing(u)}>
                                          <td className="p-2 font-bold whitespace-nowrap">{u.name}<br/><span className="text-xs text-gray-500">{u.role}</span></td>
                                          <td className="p-2">
                                              <div className="flex flex-col gap-1">
                                                  <div className="grid grid-cols-7 gap-1">
                                                      {days.map(d=><div key={d} className={`h-6 rounded flex items-center justify-center text-[10px] text-white ${u.schedule?.[d] ? 'bg-green-600' : 'bg-[#333]'}`}>{d[0]}</div>)}
                                                  </div>
                                                  {isWorking && (
                                                      <div className="w-full bg-[#333] h-4 rounded mt-1 relative overflow-hidden">
                                                          <div className="absolute top-0 left-0 h-full bg-yellow-500 animate-pulse w-full"></div>
                                                          <span className="absolute inset-0 flex items-center justify-center text-[10px] text-black font-bold">TRABAJANDO DESDE {startTime}</span>
                                                      </div>
                                                  )}
                                              </div>
                                          </td>
                                          <td className="p-2 font-mono">{calculatePayroll(u)}</td>
                                          <td className="p-2"><button onClick={(e)=>{e.stopPropagation(); printSchedule(u);}} className="text-[var(--gold)]"><Printer size={16}/></button></td>
                                      </tr>
                                  )})}
                              </tbody>
                          </table>
                      </div>

                      {editing && (
                          <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                              <div className="card w-full max-w-4xl bg-[var(--bg-card)] p-6 max-h-[90vh] overflow-y-auto">
                                  <h3 className="font-bold text-xl mb-4 text-[var(--text-main)]">{editing.id ? 'EDITAR' : 'NUEVO'} EMPLEADO</h3>
                                  <div className="grid grid-cols-4 gap-4 mb-4">
                                      <input className="input-std" placeholder="Nombre" value={editing.name} onChange={e=>setEditing({...editing, name:e.target.value})}/>
                                      <input className="input-std" placeholder="Usuario" value={editing.username} onChange={e=>setEditing({...editing, username:e.target.value})}/>
                                      <input className="input-std" placeholder="Contrase√±a" value={editing.password} onChange={e=>setEditing({...editing, password:e.target.value})}/>
                                      <select className="input-std" value={editing.role} onChange={e=>setEditing({...editing, role:e.target.value})}><option value="cajero">Cajero</option><option value="cocina">Cocina</option><option value="repartidor">Repartidor</option></select>
                                  </div>
                                  <div className="flex gap-4 mb-2 items-center">
                                      <div className="w-32"><label className="text-xs text-gray-500">Sueldo Semanal</label><input type="number" className="input-std" value={editing.salary} onChange={e=>setEditing({...editing, salary:parseFloat(e.target.value)})}/></div>
                                      <button onClick={()=>copyMonday(editing)} className="bg-blue-600 text-white px-4 py-2 rounded text-xs font-bold flex gap-2"><Copy size={14}/> COPIAR LUNES A SEMANA</button>
                                  </div>
                                  
                                  <div className="grid grid-cols-7 gap-2 mb-6">
                                      {days.map(d=>(
                                          <div key={d} className="bg-[#222] p-2 rounded text-center border border-[#333]">
                                              <p className="text-[var(--gold)] font-bold text-xs mb-1">{d}</p>
                                              <input className="bg-black text-white w-full text-xs text-center mb-1 border border-[#333]" placeholder="Entrada" value={editing.schedule?.[d]?.in||''} onChange={e=>setEditing({...editing, schedule:{...editing.schedule, [d]:{...(editing.schedule?.[d]||{}), in:e.target.value}}})}/>
                                              <input className="bg-black text-white w-full text-xs text-center border border-[#333]" placeholder="Salida" value={editing.schedule?.[d]?.out||''} onChange={e=>setEditing({...editing, schedule:{...editing.schedule, [d]:{...(editing.schedule?.[d]||{}), out:e.target.value}}})}/>
                                          </div>
                                      ))}
                                  </div>
                                  
                                  <div className="mb-4 bg-[#222] p-2 rounded">
                                      <p className="text-xs font-bold mb-1 text-white">Editar √öltimo Registro (Admin)</p>
                                      <div className="flex gap-2">
                                            <input type="datetime-local" className="input-std text-xs" value={(editing.attendance || []).length > 0 ? new Date(editing.attendance[editing.attendance.length-1].in).toISOString().slice(0,16) : ''} onChange={(e)=>{
                                                const newAtt = [...(editing.attendance || [])];
                                                if(newAtt.length > 0) newAtt[newAtt.length-1].in = new Date(e.target.value).toISOString();
                                                setEditing({...editing, attendance: newAtt});
                                            }}/>
                                            <input type="datetime-local" className="input-std text-xs" value={(editing.attendance || []).length > 0 && editing.attendance[editing.attendance.length-1].out ? new Date(editing.attendance[editing.attendance.length-1].out).toISOString().slice(0,16) : ''} onChange={(e)=>{
                                                const newAtt = [...(editing.attendance || [])];
                                                if(newAtt.length > 0) newAtt[newAtt.length-1].out = new Date(e.target.value).toISOString();
                                                setEditing({...editing, attendance: newAtt});
                                            }}/>
                                      </div>
                                  </div>

                                  <div className="flex justify-between">
                                      {editing.id && <button onClick={()=>deleteUser(editing.id)} className="text-red-500 font-bold border border-red-500 p-2 rounded">ELIMINAR USUARIO</button>}
                                      <div className="flex gap-2">
                                          <button onClick={()=>setEditing(null)} className="text-gray-500">CANCELAR</button>
                                          <button onClick={()=>{
                                              let users = [...db.users];
                                              if(editing.id) users = users.map(u=>u.id===editing.id?editing:u);
                                              else users.push({...editing, id:generateId()});
                                              updateDB({...db, users}); setEditing(null);
                                          }} className="btn-gold">GUARDAR CAMBIOS</button>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      )}
                </div>
            );
        };

        const CouponManager = ({ db, updateDB }) => {
            const [coup, setCoup] = useState({ code:'', val:'', type:'percent', limit:100 });
            return (
                <div className="space-y-4">
                    <div className="card p-6"><div className="flex gap-2"><input className="input-std uppercase" placeholder="CODIGO" value={coup.code} onChange={e=>setCoup({...coup, code:e.target.value})}/><select className="input-std w-32" value={coup.type} onChange={e=>setCoup({...coup, type:e.target.value})}><option value="percent">% Desc</option><option value="amount">$ Desc</option><option value="shipping">Env√≠o Gratis</option></select><input className="input-std w-20" type="number" placeholder="L√≠mite" value={coup.limit} onChange={e=>setCoup({...coup, limit:e.target.value})}/>{coup.type !== 'shipping' && <input className="input-std w-24" type="number" placeholder="Valor" value={coup.val} onChange={e=>setCoup({...coup, val:e.target.value})}/>}<button onClick={()=>{if(!coup.code) return; updateDB({...db, coupons: [...db.coupons, {...coup, id:generateId()}]});}} className="btn-gold flex-1">CREAR</button></div></div>
                    <div className="space-y-2">{db.coupons.map(c => <div key={c.id} className="card p-4 flex justify-between items-center border-l-4 border-purple-500"><div><p className="font-bold text-xl text-[var(--text-main)]">{c.code}</p><p className="text-gray-500 text-sm">{c.type==='shipping'?'ENV√çO GRATIS':`-${c.val}${c.type==='percent'?'%':'$'}`} (Disponibles: {c.limit})</p></div><button onClick={()=>updateDB({...db, coupons: db.coupons.filter(x=>x.id!==c.id)})} className="text-red-500"><Trash2/></button></div>)}</div>
                </div>
            );
        };
        const SettingsManager = ({ db, updateDB }) => {
            const [notif, setNotif] = useState('');
            const [target, setTarget] = useState('all');
            const [tabItem, setTabItem] = useState({min:'', max:'', price:''});
            const [newItem, setNewItem] = useState({prov:'', plat:''});
            
            const sendPush = () => {
                if(!notif) return showToast("Escribe un mensaje");
                const newNotif = { id: Date.now(), message: notif, target };
                updateDB({...db, settings: {...db.settings, notification: newNotif}});
                playSound();
                showToast(`Notificaci√≥n enviada: ${notif}`);
                setNotif('');
            };

            const handleCSV = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = ev => {
                        const lines = ev.target.result.split('\n').slice(1);
                        const table = lines.map(l=>{
                             const [min,max,price] = l.split(',');
                             return min ? {min:parseFloat(min), max:parseFloat(max), price:parseFloat(price)} : null;
                        }).filter(Boolean);
                        updateDB({...db, settings:{...db.settings, deliveryTable: table}});
                    };
                    r.readAsText(f);
                }
            };

            const addItem = (list, val) => { if(val) { updateDB({...db, settings: {...db.settings, [list]: [...(db.settings[list]||[]), val]}}); setNewItem({...newItem, [list==='providers'?'prov':'plat']: ''}); }};
            const delItem = (list, idx) => { const n = [...db.settings[list]]; n.splice(idx,1); updateDB({...db, settings: {...db.settings, [list]: n}}); };

            const addRate = () => {
                if(tabItem.price){
                    const newTable = [...db.settings.deliveryTable, {
                        min: parseFloat(tabItem.min), 
                        max: parseFloat(tabItem.max), 
                        price: parseFloat(tabItem.price)
                    }].sort((a,b)=>a.min-b.min);
                    updateDB({...db, settings:{...db.settings, deliveryTable: newTable}}); 
                    setTabItem({min:'',max:'',price:''});
                }
            };

            const updateRadius = (val) => {
                 updateDB({...db, settings: {...db.settings, deliveryRadius: parseInt(val)}});
            };

            // CORRECCI√ìN: 'overflow-y-auto' a√±adido al contenedor principal para scroll general
            return (
                <div className="h-full flex flex-col gap-4 overflow-y-auto pb-32">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="card p-4 border-l-4 border-purple-500 bg-[var(--bg-card)]">
                            <h3 className="font-bold mb-2 flex gap-2 text-[var(--text-main)]"><Bell/> NOTIFICACIONES</h3>
                            <div className="flex gap-2">
                                <select className="input-std w-40" value={target} onChange={e=>setTarget(e.target.value)}>
                                    <option value="all">TODOS</option>
                                    <option value="kitchen">COCINA</option>
                                    <option value="delivery">REPARTIDORES</option>
                                    <option value="cashier">CAJA</option>
                                </select>
                                <input className="input-std" placeholder="Mensaje..." value={notif} onChange={e=>setNotif(e.target.value)}/>
                                <button onClick={sendPush} className="btn-gold px-6">ENVIAR</button>
                            </div>
                            <p className="text-xs text-gray-500 mt-2">* Esto mostrar√° una alerta en pantalla completa a los usuarios seleccionados.</p>
                        </div>
                        
                        {/* CORRECCI√ìN: Indicador de KM claro y visible al mover */}
                        <div className="card p-4 border-l-4 border-[var(--gold)] bg-[var(--bg-card)]">
                            <h3 className="font-bold mb-2 flex gap-2 text-[var(--text-main)]"><MapPin/> ZONA DE REPARTO</h3>
                            <div className="flex flex-col gap-2 mb-4">
                                <div className="flex justify-between items-center">
                                    <span className="text-[var(--text-main)] text-sm font-bold">Cobertura Actual:</span>
                                    <span className="text-[var(--gold)] text-xl font-black bg-black/50 px-3 py-1 rounded">{db.settings.deliveryRadius} KM</span>
                                </div>
                                <input type="range" min="1" max="50" step="1" value={db.settings.deliveryRadius} onChange={(e)=>updateRadius(e.target.value)} className="w-full h-4 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[var(--gold)]"/>
                                <div className="flex justify-between text-[10px] text-gray-500"><span>1 km</span><span>25 km</span><span>50 km</span></div>
                            </div>
                            <div className="h-64 rounded border border-gray-600 overflow-hidden relative">
                                <LeafletMap center={STORE_COORDS} markers={[{pos:STORE_COORDS, emoji:'üè™', isStore:true}]} zoom={11} radius={db.settings.deliveryRadius} />
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="card p-4 border-t-4 border-blue-500 space-y-4">
                            <h3 className="font-bold flex gap-2 text-[var(--text-main)]"><Globe/> WEB & PAGOS</h3>
                            <div className="flex justify-between items-center bg-[#222] p-3 rounded"><div><p className="text-white text-sm font-bold">Estado Tienda</p></div><button onClick={()=>updateDB({...db, settings: {...db.settings, storeOpen: !db.settings.storeOpen}})} className={`px-4 py-1 rounded font-black text-xs uppercase ${db.settings.storeOpen?'bg-green-500 text-black':'bg-red-500 text-white'}`}>{db.settings.storeOpen?'ABIERTA':'CERRADA'}</button></div>
                            <div className="bg-[#222] p-3 rounded space-y-2">
                                <p className="text-white text-sm font-bold">M√©todos de Pago Web</p>
                                <div className="flex justify-between items-center"><span className="text-gray-400 text-xs">Efectivo</span><button onClick={()=>updateDB({...db, settings:{...db.settings, paymentMethods:{...db.settings.paymentMethods, cash:!db.settings.paymentMethods.cash}}})} className={`w-8 h-4 rounded-full relative ${db.settings.paymentMethods.cash?'bg-green-500':'bg-gray-600'}`}><div className={`w-2 h-2 bg-white rounded-full absolute top-1 ${db.settings.paymentMethods.cash?'right-1':'left-1'}`}></div></button></div>
                                <div className="flex justify-between items-center"><span className="text-gray-400 text-xs">Tarjeta</span><button onClick={()=>updateDB({...db, settings:{...db.settings, paymentMethods:{...db.settings.paymentMethods, card:!db.settings.paymentMethods.card}}})} className={`w-8 h-4 rounded-full relative ${db.settings.paymentMethods.card?'bg-green-500':'bg-gray-600'}`}><div className={`w-2 h-2 bg-white rounded-full absolute top-1 ${db.settings.paymentMethods.card?'right-1':'left-1'}`}></div></button></div>
                                <div className="flex justify-between items-center"><span className="text-gray-400 text-xs">Permitir Recoger</span><button onClick={()=>updateDB({...db, settings: {...db.settings, pickupEnabled: !db.settings.pickupEnabled}})} className={`w-8 h-4 rounded-full relative ${db.settings.pickupEnabled?'bg-green-500':'bg-gray-600'}`}><div className={`w-2 h-2 bg-white rounded-full absolute top-1 ${db.settings.pickupEnabled?'right-1':'left-1'}`}></div></button></div>
                                <div className="flex justify-between items-center"><span className="text-gray-400 text-xs">Permitir Domicilio</span><button onClick={()=>updateDB({...db, settings: {...db.settings, deliveryEnabled: !db.settings.deliveryEnabled}})} className={`w-8 h-4 rounded-full relative ${db.settings.deliveryEnabled!==false?'bg-green-500':'bg-gray-600'}`}><div className={`w-2 h-2 bg-white rounded-full absolute top-1 ${db.settings.deliveryEnabled!==false?'right-1':'left-1'}`}></div></button></div>
                            </div>
                        </div>
                        <div className="card p-4 border-t-4 border-[var(--gold)] space-y-4">
                            <h3 className="font-bold mb-2 text-[var(--text-main)]"><Lock/> SEGURIDAD & LISTAS</h3>
                            <div><label className="text-xs text-gray-500">Clave Supervisor (QR)</label><div className="bg-white p-2 mt-2 w-fit rounded"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=SUPERVISOR:${db.settings.supervisorKey}`} className="w-24 h-24"/></div><input className="input-std text-sm mt-2" value={db.settings.supervisorKey} onChange={e=>updateDB({...db, settings:{...db.settings, supervisorKey:e.target.value}})}/></div>
                            <hr className="border-[#333]"/>
                            <div><p className="text-[var(--text-main)] text-xs font-bold mb-1">PLATAFORMAS</p><div className="flex gap-1 mb-2"><input className="input-std text-xs" value={newItem.plat} onChange={e=>setNewItem({...newItem, plat:e.target.value})}/><button onClick={()=>addItem('platforms',newItem.plat)} className="btn-gold">+</button></div><div className="h-24 overflow-y-auto bg-[#222] p-2 rounded custom-scroll">{db.settings.platforms.map((p,i)=><div key={i} className="flex justify-between text-gray-400 text-xs border-b border-[#333] py-1"><span>{p}</span><button onClick={()=>delItem('platforms',i)} className="text-red-500">x</button></div>)}</div></div>
                        </div>
                        
                        {/* TABLA DE PRECIOS AL FINAL CON SCROLL VISIBLE */}
                        <div className="card p-4 border-t-4 border-green-500 flex flex-col h-80">
                            <div className="flex justify-between items-center mb-2"><h3 className="text-white font-bold flex gap-2"><Table/> TABULADOR ENV√çOS</h3><label className="text-[10px] text-blue-400 cursor-pointer">Cargar CSV<input type="file" hidden onChange={handleCSV}/></label></div>
                            <div className="flex gap-1 mb-2 bg-[#222] p-1 rounded"><input className="bg-transparent text-white text-xs w-12 border-b border-[#444] text-center" placeholder="Min" type="number" value={tabItem.min} onChange={e=>setTabItem({...tabItem, min:e.target.value})}/><input className="bg-transparent text-white text-xs w-12 border-b border-[#444] text-center" placeholder="Max" type="number" value={tabItem.max} onChange={e=>setTabItem({...tabItem, max:e.target.value})}/><input className="bg-transparent text-white text-xs w-12 border-b border-[#444] text-center" placeholder="$" type="number" value={tabItem.price} onChange={e=>setTabItem({...tabItem, price:e.target.value})}/><button className="text-green-500 font-bold px-2" onClick={addRate}>+</button></div>
                            <div className="flex-1 bg-[#222] rounded overflow-y-auto p-2 space-y-1 custom-scroll">{db.settings.deliveryTable.map((r,i)=><div key={i} className="flex justify-between text-xs text-gray-300 border-b border-[#333] pb-1"><span>{r.min} - {r.max} KM</span><span className="text-[var(--gold)] font-bold">${r.price}</span></div>)}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const TicketPreview = ({ db, updateDB }) => {
            const [header, setHeader] = useState(db.settings.ticketConfig.header);
            const [footer, setFooter] = useState(db.settings.ticketConfig.footer);
            const saveConfig = () => { updateDB({...db, settings: {...db.settings, ticketConfig: { header, footer }}}); showToast("Guardado"); };
            
            const generateHTML = (type) => {
                 const base = `<div class="center bold"><img src="${LOGO_URL}" style="width:50px;display:block;margin:0 auto 10px;">${header.replace(/\n/g, '<br>')}</div><hr>`;
                const end = `<hr><div class="center">${footer.replace(/\n/g, '<br>')}</div>`;
                const date = new Date().toLocaleString();
                if(type === 'sale') return `${base}<div class="center">VENTA #1234</div><div class="center">${date}</div><hr><div>1x Burger Cl√°sica ... $95</div><div>1x Papas ........... $55</div><hr><div class="bold right">TOTAL: $150</div>${end}`;
                if(type === 'cut') return `${base}<div class="center bold">CORTE DE CAJA</div><div class="center">${date}</div><hr><div>Fondo Inicial: $1,000</div><div>+ Ventas Efec: $2,500</div><div>- Gastos/Retiros: $500</div><hr><div class="bold right">TOTAL EN CAJA: $3,000</div><br><br><div class="center">_______________________<br>Firma Cajera</div>${end}`;
                if(type === 'driver_liq') return `${base}<div class="center bold">LIQUIDACI√ìN DRIVER</div><div class="center">Juan Moto</div><hr><div>Pedidos Entregados: 5</div><div>Total Cobrado: $800</div><div>Ganancia Env√≠os: -$150</div><hr><div class="bold right">A ENTREGAR: $650</div><br><br><div class="center">_______________________<br>Firma Driver</div>${end}`;
                if(type === 'platform') return `${base}<div class="center">PLATAFORMA (UBER)</div><div class="center">#9999</div><div class="center">${date}</div><hr><div>1x Burger ... $95</div><div class="bold right">TOTAL: $95</div>${end}<br><br>‚úÇÔ∏è --- CORTE AQU√ç ---<br><br>${base}<div class="center">COPIA CLIENTE/DRIVER</div><div class="center">${date}</div><hr><div>1x Burger ... $0.00</div><div class="bold right">TOTAL A PAGAR: $0.00</div><div class="center">PROPINAS NO INCLUIDAS</div>${end}`;
                return "";
            };

            const printDirect = (type) => printTicket(generateHTML(type));

            return (
                <div className="h-full overflow-y-auto pb-20">
                    <div className="card p-6 mb-4">
                        <h3 className="font-bold text-[var(--gold)] mb-4 flex gap-2"><Printer/> CONFIGURACI√ìN TICKETS</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label className="text-xs text-gray-500">Cabecera</label><textarea className="input-std h-24" value={header} onChange={e=>setHeader(e.target.value)}/></div>
                            <div><label className="text-xs text-gray-500">Pie de P√°gina</label><textarea className="input-std h-24" value={footer} onChange={e=>setFooter(e.target.value)}/></div>
                        </div>
                        <button onClick={saveConfig} className="btn-gold w-full">GUARDAR CAMBIOS</button>
                    </div>
                    <div className="card p-6">
                        <h3 className="font-bold text-white mb-4">VISTA PREVIA Y PRUEBA</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            {['sale','cut','driver_liq','platform'].map(t => (
                                <div key={t} className="bg-white text-black p-2 rounded text-xs font-mono border border-gray-300 relative group">
                                    <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition"><button onClick={()=>printDirect(t)} className="bg-black text-white p-1 rounded"><Printer size={16}/></button></div>
                                    <div dangerouslySetInnerHTML={{__html: generateHTML(t)}} />
                                    <button onClick={()=>printDirect(t)} className="w-full bg-[var(--gold)] mt-2 py-1 font-bold rounded">IMPRIMIR</button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ db, updateDB }) => {
            const [tab, setTab] = useState('dash');
            return (
                <div className="h-full flex flex-col bg-[var(--bg-body)]">
                    <div className="flex gap-2 p-4 bg-[var(--bg-card)] border-b border-[var(--border)] overflow-x-auto scroll-hide">
                        {['dash','menu','inv','staff','coup','conf','tickets'].map(t => <button key={t} onClick={()=>setTab(t)} className={`px-4 py-2 rounded font-bold uppercase whitespace-nowrap ${tab===t?'bg-[var(--gold)] text-black':'text-gray-500 bg-[#222]'}`}>{t}</button>)}
                    </div>
                    <div className="flex-1 p-6 overflow-hidden">
                        {tab==='dash' && <Dashboard db={db}/>}
                        {tab==='menu' && <ProductManager db={db} updateDB={updateDB}/>}
                        {tab==='inv' && <InventoryManager db={db} updateDB={updateDB}/>}
                        {tab==='staff' && <StaffManager db={db} updateDB={updateDB}/>}
                        {tab==='coup' && <CouponManager db={db} updateDB={updateDB}/>}
                        {tab==='conf' && <SettingsManager db={db} updateDB={updateDB}/>}
                        {tab==='tickets' && <TicketPreview db={db} updateDB={updateDB}/>}
                    </div>
                </div>
            );
        };

const POS = ({ db, updateDB, user }) => {
    // --- ESTADOS ---
    const [cart, setCart] = useState([]);
    const [modal, setModal] = useState(null); 
    const [catFilter, setCatFilter] = useState('Todos');
    const [searchQuery, setSearchQuery] = useState(''); // MEJORA: Buscador a√±adido
    const [orderType, setOrderType] = useState('takeaway'); 
    const [orderDetails, setOrderDetails] = useState({ name:'', phone:'', address:'', references:'', table:'', platform:'', platformOrderId:'', refs:'' });
    const [payMethod, setPayMethod] = useState('cash');
    const [cashReceived, setCashReceived] = useState(0);
    const [voucher, setVoucher] = useState('');
    const [deliveryCoords, setDeliveryCoords] = useState(null);
    const [couponCode, setCouponCode] = useState('');
    const [discount, setDiscount] = useState(0);
    const [addressTimer, setAddressTimer] = useState(null);
    const [isLocating, setIsLocating] = useState(false);
    const [bottomMenuOpen, setBottomMenuOpen] = useState(false);
    
    // Modales Extra
    const [liquidationModal, setLiquidationModal] = useState(false);
    const [corteModal, setCorteModal] = useState(false);
    const [retiroModal, setRetiroModal] = useState(false);
    
    const [driverToLiq, setDriverToLiq] = useState(null);
    const [liqSummary, setLiqSummary] = useState(null);
    const [newExpense, setNewExpense] = useState({desc:'', amount:''});
    const [suggestions, setSuggestions] = useState([]);
    const [manualDriverId, setManualDriverId] = useState('');
    
    const [viewMap, setViewMap] = useState(false); 
    const [viewReadyOrders, setViewReadyOrders] = useState(false); 
    const [ingredientsProduct, setIngredientsProduct] = useState(null);
    
    const [paymentStatus, setPaymentStatus] = useState(''); 
    
    const [selectedReady, setSelectedReady] = useState([]);
    const [viewGroupMap, setViewGroupMap] = useState(null);
    const [selectedWebOrder, setSelectedWebOrder] = useState(null); 

    const [countedCash, setCountedCash] = useState('');
    const [countedCard, setCountedCard] = useState('');
    const [cutResult, setCutResult] = useState(null);
    
    const [deliveryFilter, setDeliveryFilter] = useState('all');

    const uniqueCategories = ['Todos', ...new Set(db.products.filter(p=>p.active).map(p => p.cat).filter(Boolean))];

    // Filtros de pedidos
    const webOrders = db.orders.filter(o => o.source === 'web' && o.status === 'web_pending_payment');
    const readyOrders = db.orders.filter(o => o.status === 'ready' && o.address !== 'RECOGER' && !o.groupId);
    const uniqueGroups = [...new Set(db.orders.filter(o => o.groupId && o.status === 'ready').map(o => o.groupId))];

    const activeOrders = db.orders.filter(o => o.status === 'delivering' || o.status === 'pending');
    const drivers = db.users.filter(u => u.role === 'repartidor' && u.online);
    const liveMarkers = [
        { pos: STORE_COORDS, emoji: 'üè™' },
        ...activeOrders.map(o => ({ pos: o.clientLoc || STORE_COORDS, emoji: 'üçî', popup: `Pedido #${o.orderNum}` })),
        ...drivers.map(d => ({ pos: d.location || STORE_COORDS, emoji: 'üèçÔ∏è', label: d.name, type: 'driver' }))
    ];

    const handleWebOrder = (order) => {
        setCart(order.items);
        setOrderDetails({
            name: order.clientName, 
            phone: order.clientPhone || '', 
            address: order.address.split('(')[0].trim(), 
            references: order.address.split('(')[1]?.replace(')', '') || '', 
            table: '', platform: '', platformOrderId: '', refs: ''
        });
        setOrderType(order.address === 'RECOGER' ? 'takeaway' : 'delivery');
        setDeliveryCoords(order.clientLoc);
        setModal('cockpit');
        updateDB({...db, orders: db.orders.filter(o=>o.id!==order.id)}); 
    };
    
    const cancelWebOrder = (id) => { 
        updateDB({...db, orders: db.orders.map(o => o.id === id ? {...o, status: 'cancelled'} : o)});
        showToast("Pedido Cancelado");
        setSelectedWebOrder(null);
    };

    const deliveryFee = useMemo(() => {
        if(orderType !== 'delivery' || !deliveryCoords) return 0;
        const dist = calculateDistance(STORE_COORDS[0], STORE_COORDS[1], deliveryCoords[0], deliveryCoords[1]);
        return getDeliveryPrice(dist, db.settings.deliveryTable);
    }, [orderType, deliveryCoords, db.settings.deliveryTable]);

    const subtotal = cart.reduce((a,b)=>a+b.price*b.qty,0);
    const total = subtotal + deliveryFee - discount;

    const updateLocationFromAddress = (addr) => {
        setOrderDetails(prev => ({...prev, address: addr}));
        if (addressTimer) clearTimeout(addressTimer);
        setAddressTimer(setTimeout(async () => {
            if(addr.length > 3) {
                setIsLocating(true);
                try {
                    const query = `${addr} ${CITY_SUFFIX}`;
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`);
                    const data = await res.json();
                    setSuggestions(data);
                    if(data && data.length > 0) {
                        setDeliveryCoords([parseFloat(data[0].lat), parseFloat(data[0].lon)]);
                    }
                } catch(e) { console.error("Geocoding error", e); }
                setIsLocating(false);
            } else { setSuggestions([]); }
        }, 800)); 
    };
    
    const handleReverseGeo = async (coords) => {
        setDeliveryCoords(coords);
        setIsLocating(true);
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords[0]}&lon=${coords[1]}`);
            const data = await res.json();
            if(data && data.display_name) {
                const addrParts = data.display_name.split(',');
                setOrderDetails(prev => ({...prev, address: addrParts[0] + (addrParts[1]||'')}));
                setSuggestions([]);
            }
        } catch(e) {}
        setIsLocating(false);
    };

    const useGPS = () => {
        setIsLocating(true);
        navigator.geolocation.getCurrentPosition(pos => {
            handleReverseGeo([pos.coords.latitude, pos.coords.longitude]);
        }, () => setIsLocating(false));
    };

    const applyCoupon = () => {
        const c = db.coupons.find(x => x.code.trim().toUpperCase() === couponCode.trim().toUpperCase());
        if(c && c.limit > (c.used || 0)) { 
            if(c.type === 'shipping') setDiscount(deliveryFee);
            else if(c.type === 'percent') setDiscount(subtotal * c.val / 100);
            else setDiscount(c.val);
            showToast("Cup√≥n Aplicado");
        } else showToast("Cup√≥n Inv√°lido o Agotado");
    };

    const addToCart = (p) => setCart(prev => {
        const ex = prev.find(i => i.id === p.id);
        return ex ? prev.map(i => i.id === p.id ? {...i, qty: i.qty + 1} : i) : [...prev, {...p, qty: 1}];
    });

    const removeFromCart = (idx) => {
         const newCart = [...cart];
         newCart.splice(idx, 1);
         setCart(newCart);
    };

    const updateCartNote = (idx, note) => {
        const newCart = [...cart];
        newCart[idx].note = note;
        setCart(newCart);
    };

    const switchPayMethod = (method) => {
        setPayMethod(method);
        setPaymentStatus('');
    };
    
    const handleScanDriver = (scannedData) => {
        if(scannedData.startsWith("LIQ:")) {
            const driverId = scannedData.split(':')[1];
            const driver = db.users.find(u => u.id === driverId);
            if(driver) {
                const deliveredOrders = db.orders.filter(o => o.driver === driver.username && o.status === 'delivered' && !o.settled);
                const totalCash = driver.cashOnHand || 0;
                const totalEarnings = deliveredOrders.reduce((acc, o) => acc + (o.driverFee || 0), 0);
                const netToPay = totalCash - totalEarnings;
                setDriverToLiq(driver);
                setLiqSummary({ deliveredOrders, totalCash, totalEarnings, netToPay });
            } else showToast("Repartidor no encontrado");
        }
    };

    const confirmLiquidation = () => {
        if(!driverToLiq || !liqSummary) return;
        const paymentToDrawer = liqSummary.netToPay;
        updateDB({
            ...db,
            users: db.users.map(u => u.id === driverToLiq.id ? {...u, cashOnHand: 0} : u),
            orders: db.orders.map(o => liqSummary.deliveredOrders.find(do_ => do_.id === o.id) ? {...o, settled: true} : o),
            cashDrawer: {...db.cashDrawer, current: db.cashDrawer.current + paymentToDrawer}
        });
        const ticket = `<div class="center bold"><img src="${LOGO_URL}" style="width:50px;display:block;margin:0 auto;">LIQUIDACI√ìN REPARTIDOR</div><div class="center">${driverToLiq.name}</div><hr><div>Entregas: ${liqSummary.deliveredOrders.length}</div><div>Total Cobrado: ${formatCurrency(liqSummary.totalCash)}</div><div>Ganancia Env√≠os: -${formatCurrency(liqSummary.totalEarnings)}</div><hr><div class="bold right">ENTREG√ì: ${formatCurrency(liqSummary.netToPay)}</div><br><br><div class="center">_______________________<br>Firma</div>`;
        printTicket(ticket);
        showToast("Liquidaci√≥n Exitosa.");
        setLiquidationModal(false); setDriverToLiq(null);
    };
    
    const addExpense = () => {
        if(!newExpense.amount) return;
        const amt = parseFloat(newExpense.amount);
        const available = db.cashDrawer.current - (db.cashDrawer.initial || 0);
        
        updateDB({
            ...db,
            expenses: [...db.expenses, {id:generateId(), desc:newExpense.desc || 'Retiro Varios', amount:amt, date:new Date().toISOString()}],
            cashDrawer: {...db.cashDrawer, current: db.cashDrawer.current - amt}
        });
        setNewExpense({desc:'', amount:''});
        showToast("Retiro Registrado");
        setRetiroModal(false);
    };

    const performBlindCut = () => {
        const cCash = parseFloat(countedCash) || 0;
        const cCard = parseFloat(countedCard) || 0;
        const systemCash = db.cashDrawer.current;
        const systemCard = db.orders.filter(o => o.method === 'card' && o.status !== 'cancelled').reduce((a,b)=>a+b.total,0);
        const diffCash = systemCash - cCash; 
        const diffCard = systemCard - cCard;
        let missingOrder = null;
        const diffAbs = Math.abs(diffCash);
        if (diffAbs > 0) missingOrder = db.orders.find(o => Math.abs(o.total - diffAbs) < 1); 

        setCutResult({ systemCash, systemCard, cCash, cCard, diffCash, diffCard, missingOrder });
    };

    const printBlindCut = () => {
         const ticket = `<div class="center bold"><img src="${LOGO_URL}" style="width:50px;display:block;margin:0 auto;">CORTE DE CAJA (Z)</div><div class="center">${new Date().toLocaleString()}</div><hr><div>EFECTIVO REPORTADO: ${formatCurrency(parseFloat(countedCash)||0)}</div><div>TARJETA REPORTADO: ${formatCurrency(parseFloat(countedCard)||0)}</div><hr><div>SISTEMA EFECTIVO: ${formatCurrency(cutResult.systemCash)}</div><div>SISTEMA TARJETA: ${formatCurrency(cutResult.systemCard)}</div><hr><div class="bold right">DIFERENCIA: ${formatCurrency((parseFloat(countedCash)||0) - cutResult.systemCash)}</div>${cutResult.missingOrder ? `<br><div class="center bold">POSIBLE FALTANTE:</div><div class="center">Orden #${cutResult.missingOrder.orderNum} - ${formatCurrency(cutResult.missingOrder.total)}</div>` : ''}<br><br><div class="center">_______________________<br>Firma Cajera</div>`;
        printTicket(ticket);
    };

    const finalizeOrder = () => {
        const isPayOnDelivery = orderType === 'delivery' && payMethod === 'cash' && paymentStatus === 'pending';
        if(orderType === 'delivery' && payMethod === 'cash' && paymentStatus === '') return showToast("‚ö†Ô∏è Selecciona: PAGADO EN CAJA o PAGO AL RECIBIR");
        if(payMethod === 'cash' && !isPayOnDelivery && (!cashReceived || parseFloat(cashReceived) < total)) return showToast("Monto insuficiente");
        
        if(orderType === 'delivery') {
             if(!orderDetails.phone || orderDetails.phone.length !== 10) return showToast("Tel√©fono debe ser de 10 d√≠gitos");
             if(!orderDetails.address) return showToast("Falta Direcci√≥n");
        }
        
        const order = {
            id: generateId(), orderNum: Math.floor(Math.random()*9000)+1000,
            items: cart, total, method: payMethod, status: 'pending', createdAt: new Date().toISOString(),
            address: orderType === 'delivery' ? `${orderDetails.address} (Ref: ${orderDetails.references})` : orderType.toUpperCase(),
            clientName: orderDetails.name || 'Cliente', clientPhone: orderDetails.phone,
            clientLoc: orderType === 'delivery' ? deliveryCoords : null, 
            source: orderType === 'platform' ? 'platform' : 'store',
            platformName: orderDetails.platform, platformOrderId: orderDetails.platformOrderId,
            driverAssignMode: db.settings.driverAssign, deliveryFee: orderType === 'delivery' ? deliveryFee : 0,
            driver: null, settled: false,
            paymentStatus: isPayOnDelivery ? 'pending' : 'paid' 
        };

        let newCashDrawer = db.cashDrawer.current;
        if(payMethod==='cash' && !isPayOnDelivery) newCashDrawer += total;

        updateDB({ ...db, orders: [...db.orders, order], cashDrawer: {...db.cashDrawer, current: newCashDrawer} });
        setCart([]); setModal(null); setCashReceived(0); setVoucher(''); setPaymentStatus('');
        setOrderDetails({ name:'', phone:'', address:'', references:'', table:'', platform:'', platformOrderId:'', refs:'' });
        if(isPayOnDelivery) showToast("Pedido creado. Cobro pendiente por Repartidor.");
        else showToast("Pedido creado y cobrado.");
    };
    
    // --- GESTI√ìN / ENTREGA LOGIC ---
    const generateGroupQR = () => {
        if(selectedReady.length < 2) return showToast("Selecciona al menos 2 pedidos");
        const newGroupId = generateId(); 
        const updatedOrders = db.orders.map(o => selectedReady.includes(o.id) ? {...o, groupId: newGroupId} : o);
        updateDB({...db, orders: updatedOrders});
        const qrData = `GROUP:${selectedReady.join(',')}`;
        const url = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(qrData)}`;
        const groupOrders = db.orders.filter(o => selectedReady.includes(o.id));
        const markers = [{pos: STORE_COORDS, isStore: true}, ...groupOrders.map(o => ({pos: o.clientLoc || STORE_COORDS, emoji: 'üçî'}))];
        const route = [STORE_COORDS, ...groupOrders.map(o => o.clientLoc || STORE_COORDS)];

        const modalContent = (
            <div className="fixed inset-0 bg-black/80 z-[5000] flex flex-col items-center justify-center p-4 animate-in zoom-in">
                <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md text-center">
                    <h2 className="text-2xl font-brand text-[var(--gold)] mb-4">RUTA MAESTRA ({selectedReady.length})</h2>
                    <div className="bg-white p-2 rounded mb-4 inline-block border border-gray-200"><img src={url} className="w-64 h-64"/></div>
                    <p className="text-gray-600 mb-4 text-sm font-bold">Escanea este c√≥digo para asignar TODOS los pedidos.</p>
                    <div className="w-full h-48 rounded border border-gray-300 mb-4 overflow-hidden relative">
                        <LeafletMap center={STORE_COORDS} markers={markers} route={route} zoom={12} />
                    </div>
                    <button onClick={()=>{document.getElementById('qr-modal').remove(); setSelectedReady([]);}} className="bg-red-600 text-white px-6 py-3 rounded font-bold w-full">CERRAR</button>
                </div>
            </div>
        );
        const div = document.createElement('div'); div.id = 'qr-modal'; document.body.appendChild(div);
        const root = ReactDOM.createRoot(div); root.render(modalContent);
    };

    const undoGroup = (groupId) => {
        const updatedOrders = db.orders.map(o => o.groupId === groupId ? {...o, groupId: null} : o);
        updateDB({...db, orders: updatedOrders});
        showToast("Grupo deshecho.");
    };

    const handleManualDispatch = (orders) => {
        if(confirm(`¬øDespachar ${orders.length} pedidos?`)) {
             const updatedOrders = db.orders.map(o => orders.find(x => x.id === o.id) ? {...o, status: 'delivering'} : o);
             updateDB({...db, orders: updatedOrders});
             showToast("Pedidos marcados en reparto.");
        }
    };
    
    useEffect(() => {
        const handleEsc = (event) => {
           if (event.keyCode === 27) {
               setModal(null); setLiquidationModal(false); setCorteModal(false); setRetiroModal(false);
               setViewMap(false); setBottomMenuOpen(false); setViewReadyOrders(false);
               setViewGroupMap(null); setSelectedWebOrder(null); 
           }
        };
        window.addEventListener('keydown', handleEsc);
        return () => window.removeEventListener('keydown', handleEsc);
    }, []);
    
    // --- VISTA MAPA ---
    if (viewMap) {
        return (
            <div className="h-full flex flex-col p-4 bg-[var(--bg-body)]">
                 <div className="flex justify-between items-center mb-4">
                     <h2 className="text-2xl font-bold text-[var(--gold)]">RASTREO EN VIVO</h2>
                     <button onClick={()=>setViewMap(false)} className="bg-red-600 text-white px-4 py-2 rounded font-bold shadow">CERRAR MAPA (ESC)</button>
                 </div>
                 <div className="flex-1 rounded border border-[var(--gold)] overflow-hidden shadow-xl">
                     <LeafletMap center={STORE_COORDS} markers={liveMarkers} zoom={13}/>
                 </div>
            </div>
        );
    }

    // --- VISTA GESTI√ìN / ENTREGA ---
    if (viewReadyOrders) {
        return (
            <div className="h-full flex flex-col bg-[var(--bg-body)] p-4">
                 <div className="flex justify-between items-center mb-4 border-b border-gray-300 pb-2">
                     <h2 className="text-2xl font-bold text-[var(--gold)] text-shadow-sm">GESTI√ìN / ENTREGA</h2>
                     <div className="flex gap-2">
                        <button onClick={()=>setDeliveryFilter('all')} className={`px-3 py-1 rounded text-xs font-bold transition ${deliveryFilter==='all'?'bg-[var(--gold)] text-black':'bg-gray-200 text-gray-500'}`}>TODOS</button>
                        <button onClick={()=>setDeliveryFilter('ready')} className={`px-3 py-1 rounded text-xs font-bold transition ${deliveryFilter==='ready'?'bg-green-600 text-white':'bg-gray-200 text-gray-500'}`}>LISTOS</button>
                        <button onClick={()=>setDeliveryFilter('groups')} className={`px-3 py-1 rounded text-xs font-bold transition ${deliveryFilter==='groups'?'bg-purple-600 text-white':'bg-gray-200 text-gray-500'}`}>RUTAS</button>
                        <button onClick={()=>setViewReadyOrders(false)} className="text-gray-500 ml-4 font-bold hover:text-black">Volver</button>
                     </div>
                 </div>
                 
                 <div className="bg-white p-4 rounded mb-4 flex justify-between items-center sticky top-0 z-10 border border-gray-300 shadow-md">
                    <div><p className="text-black font-bold">Agrupaci√≥n de Ruta</p><p className="text-xs text-gray-500">{selectedReady.length} seleccionados</p></div>
                    <button onClick={generateGroupQR} disabled={selectedReady.length < 2} className="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm shadow-lg hover:bg-blue-700 disabled:opacity-50">CREAR GRUPO</button>
                </div>

                 <div className="flex-1 overflow-y-auto gestion-grid content-start pb-20">
                    
                   {/* RENDERIZADO DE GRUPOS */}
                   {(deliveryFilter === 'all' || deliveryFilter === 'groups') && uniqueGroups.map(groupId => {
                       const groupOrders = db.orders.filter(o => o.groupId === groupId);
                       const groupRoute = [STORE_COORDS, ...groupOrders.map(o => o.clientLoc || STORE_COORDS)];
                       const groupMarkers = [{pos: STORE_COORDS, isStore:true}, ...groupOrders.map(o => ({pos: o.clientLoc || STORE_COORDS, emoji: 'üçî'}))];
                       const qrData = `GROUP:${groupOrders.map(o=>o.id).join(',')}`;
                       
                       return (
                           <div key={groupId} className="card p-4 border-l-4 border-purple-500 bg-purple-50 shadow-sm hover:shadow-md transition">
                                   <div className="flex justify-between mb-2">
                                       <h3 className="font-black text-xl text-purple-900">RUTA MAESTRA</h3>
                                       <button onClick={() => undoGroup(groupId)} className="text-red-500 text-xs underline font-bold hover:text-red-700">DESHACER</button>
                                   </div>
                                   <div className="flex gap-2 mb-2">
                                        <div className="bg-white p-1 rounded border border-gray-200"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`} className="w-20 h-20"/></div>
                                        <div className="text-xs text-gray-600 flex-1 overflow-hidden">
                                            {groupOrders.map(o => <p key={o.id} className="truncate font-medium">#{o.orderNum} - {o.address}</p>)}
                                        </div>
                                   </div>
                                   <div className="h-32 w-full bg-gray-100 rounded mb-2 overflow-hidden relative border border-gray-300 cursor-pointer hover:opacity-90 transition" onClick={() => setViewGroupMap({route: groupRoute, markers: groupMarkers})}>
                                        <LeafletMap center={STORE_COORDS} markers={groupMarkers} route={groupRoute} zoom={11} />
                                   </div>
                                   <button onClick={() => handleManualDispatch(groupOrders)} className="w-full bg-green-600 text-white py-2 rounded font-bold text-sm mt-2 shadow hover:bg-green-700">DAR SALIDA (GRUPO)</button>
                              </div>
                       );
                   })}

                   {/* RENDERIZADO DE INDIVIDUALES */}
                   {(deliveryFilter === 'all' || deliveryFilter === 'ready') && readyOrders.map(o => (
                           <div key={o.id} onClick={()=>setSelectedReady(prev => prev.includes(o.id)?prev.filter(i=>i!==o.id):[...prev,o.id])} className={`card p-4 border-l-4 transition cursor-pointer shadow-sm ${selectedReady.includes(o.id) ? 'border-[var(--gold)] bg-yellow-50 ring-2 ring-[var(--gold)]' : 'border-green-500 bg-white hover:bg-gray-50'}`}>
                                   <div className="flex justify-between items-start mb-2">
                                       <div>
                                           <h3 className="font-black text-xl text-gray-800">#{o.orderNum}</h3>
                                           <p className="text-sm text-gray-500 font-bold">{o.clientName}</p>
                                       </div>
                                       {selectedReady.includes(o.id) ? <CheckCircle className="text-[var(--gold)] fill-black"/> : <span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded font-bold border border-green-200">LISTO</span>}
                                   </div>
                                   <div className="text-xs text-gray-600 mb-2 font-medium">
                                       <p className="truncate">{o.address}</p>
                                   </div>
                                   
                                   <div className="h-32 w-full bg-gray-100 rounded mb-2 overflow-hidden relative border border-gray-300 mt-2 cursor-pointer hover:opacity-90" onClick={(e) => { e.stopPropagation(); setViewGroupMap({route: [STORE_COORDS, o.clientLoc || STORE_COORDS], markers: [{pos: STORE_COORDS, isStore:true}, {pos: o.clientLoc || STORE_COORDS, emoji: 'üìç'}]}) }}>
                                        <LeafletMap center={o.clientLoc || STORE_COORDS} markers={[{pos: STORE_COORDS, isStore:true}, {pos: o.clientLoc || STORE_COORDS, emoji: 'üìç'}]} route={[STORE_COORDS, o.clientLoc || STORE_COORDS]} zoom={13} />
                                   </div>
                                   
                                   <div className="bg-white p-2 rounded mb-2 w-fit mx-auto border border-gray-200">
                                       <img src={`https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(`ORDER:${o.id}`)}`} className="w-20 h-20"/>
                                   </div>

                                   <button onClick={(e) => { e.stopPropagation(); handleManualDispatch([o]); }} className="w-full bg-gray-800 hover:bg-black text-white py-2 rounded font-bold text-sm transition">DAR SALIDA</button>
                           </div>
                       ))
                   }
                 </div>
                 
                 {viewGroupMap && (
                     <div className="fixed inset-0 bg-black/80 z-[6000] flex flex-col p-4 animate-in zoom-in">
                         <div className="flex justify-between items-center mb-4">
                             <h2 className="text-2xl font-bold text-[var(--gold)]">RUTA VISUALIZADA</h2>
                             <button onClick={()=>setViewGroupMap(null)} className="text-white bg-red-600 px-4 py-2 rounded font-bold shadow">CERRAR</button>
                         </div>
                         <div className="flex-1 rounded border-2 border-[var(--gold)] overflow-hidden relative bg-white shadow-2xl">
                             <LeafletMap center={STORE_COORDS} markers={viewGroupMap.markers} route={viewGroupMap.route} zoom={13} />
                         </div>
                     </div>
                 )}

                 {selectedWebOrder && (
                    <div className="fixed inset-0 bg-black/80 z-[6000] flex flex-col items-center justify-center p-4">
                        <div className="bg-white w-full max-w-lg p-6 border-l-8 border-blue-500 rounded-r-xl shadow-2xl">
                             <div className="flex justify-between mb-4">
                                 <h3 className="font-bold text-xl text-blue-900">DETALLE PEDIDO WEB</h3>
                                 <button onClick={()=>setSelectedWebOrder(null)}><X className="text-gray-500 hover:text-black"/></button>
                             </div>
                             <p className="text-[var(--gold)] text-3xl font-black mb-2">#{selectedWebOrder.orderNum}</p>
                             <p className="text-gray-800 font-bold mb-4">{selectedWebOrder.clientName} - <span className="text-gray-500 font-normal">{selectedWebOrder.address}</span></p>
                             <div className="h-48 w-full bg-gray-100 rounded mb-4 overflow-hidden relative border border-gray-300">
                                  <LeafletMap center={selectedWebOrder.clientLoc || STORE_COORDS} markers={[{pos: STORE_COORDS, isStore:true}, {pos: selectedWebOrder.clientLoc || STORE_COORDS, emoji: 'üìç'}]} route={[STORE_COORDS, selectedWebOrder.clientLoc || STORE_COORDS]} zoom={13} />
                             </div>
                             <div className="flex gap-2">
                                 <button onClick={()=>cancelWebOrder(selectedWebOrder.id)} className="flex-1 bg-red-100 text-red-600 py-3 rounded font-bold hover:bg-red-200">CANCELAR</button>
                                 <button onClick={()=>{ handleWebOrder(selectedWebOrder); setViewReadyOrders(false); setSelectedWebOrder(null); }} className="flex-1 bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 shadow">PROCESAR</button>
                             </div>
                        </div>
                    </div>
                 )}

                 {webOrders.length > 0 && <div className="col-span-full mt-4 p-4"><h3 className="text-blue-600 font-black mb-2 text-xl border-b border-blue-200 pb-1 flex items-center gap-2"><Globe/> SOLICITUDES WEB PENDIENTES</h3></div>}
                 <div className="flex-1 overflow-y-auto gestion-grid px-4 pb-20">
                    {webOrders.map(o => (
                       <div key={o.id} className="card p-4 border-l-4 border-blue-500 bg-blue-50 cursor-pointer hover:bg-blue-100 transition shadow-sm" onClick={()=>handleWebOrder(o)}>
                             <div className="flex justify-between items-center">
                                 <div><p className="font-bold text-blue-900">WEB #{o.orderNum}</p><p className="text-sm text-blue-700">{o.clientName}</p></div>
                                 <p className="text-[var(--gold)] font-black text-lg bg-black/5 px-2 rounded">{formatCurrency(o.total)}</p>
                             </div>
                             <div className="mt-2 text-xs text-gray-600 max-h-24 overflow-y-auto mb-2 bg-white p-2 rounded border border-blue-100">
                                 {o.items.map((i,idx) => <div key={idx} className="flex justify-between"><span>{i.qty}x {i.name}</span></div>)}
                                 <div className="mt-1 text-[10px] text-orange-600 font-bold border-t border-gray-100 pt-1">üìç {o.address}</div>
                             </div>
                             <p className="text-center text-[10px] text-blue-400 mt-1 font-bold uppercase">Click para revisar</p>
                       </div>
                    ))}
                 </div>
            </div>
        );
    }
    
    // --- VISTA CAJA PRINCIPAL (POS) ---
     return (
        <div className="h-full flex flex-col bg-[var(--bg-body)]">
            {/* Header POS */}
            <div className="flex bg-[var(--bg-card)] border-b border-[var(--border)] shadow-sm shrink-0">
                <button className="flex-1 p-3 font-bold bg-[var(--gold)] text-black border-r border-yellow-500">PUNTO DE VENTA</button>
                <button onClick={()=>setViewReadyOrders(true)} className={`flex-1 p-3 font-bold transition ${readyOrders.length>0 || webOrders.length>0 ? 'bg-green-600 text-white animate-pulse' : 'text-gray-500 hover:bg-gray-100 hover:text-black'}`}>GESTI√ìN / ENTREGA ({readyOrders.length}) {webOrders.length>0?`+ ${webOrders.length} WEB`:''}</button>
            </div>
            
            <div className="flex-1 flex overflow-hidden">
                {/* Panel Izquierdo: Productos */}
                <div className="flex-1 flex flex-col h-full overflow-hidden relative">
                    {/* Barra de B√∫squeda y Filtros */}
                    <div className="p-2 border-b border-[var(--border)] flex gap-2 items-center bg-white shrink-0">
                        <div className="relative w-48">
                            <Search className="absolute left-2 top-2 text-gray-400" size={16}/>
                            <input className="input-special pl-8 py-1 h-8 text-sm" placeholder="Buscar..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)}/>
                        </div>
                        <div className="h-6 w-[1px] bg-gray-300 mx-1"></div>
                        <div className="flex-1 flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                            {uniqueCategories.map(c=><button key={c} onClick={()=>setCatFilter(c)} className={`px-4 py-1 rounded-full text-xs font-bold whitespace-nowrap transition ${catFilter===c ? 'bg-black text-white shadow' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{c}</button>)}
                        </div>
                    </div>
                    
                    {/* Grid de Productos */}
                    <div className="flex-1 p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 overflow-y-auto content-start bg-[#f9f9f9]">
                        {db.products.filter(p=>p.active && (catFilter==='Todos' || p.cat===catFilter) && (searchQuery === '' || p.name.toLowerCase().includes(searchQuery.toLowerCase()))).map(p=>(
                            <div key={p.id} onClick={()=>addToCart(p)} className="card h-32 relative overflow-hidden cursor-pointer group border-0 shadow-md hover:shadow-xl hover:-translate-y-1 transition duration-200 bg-white">
                                    <img src={p.img} className="absolute inset-0 w-full h-full object-cover opacity-90 group-hover:opacity-100 transition"/>
                                    <div className="absolute top-1 right-1 z-20 bg-white/80 rounded-full p-1 hover:bg-[var(--gold)] hover:text-black text-gray-600 shadow-sm backdrop-blur-sm" onClick={(e)=>{e.stopPropagation(); setIngredientsProduct(p);}}><Info size={16}/></div>
                                    <div className="absolute bottom-0 p-2 w-full bg-gradient-to-t from-black via-black/60 to-transparent">
                                        <p className="text-white font-bold text-sm leading-tight text-shadow-sm">{p.name}</p>
                                        <p className="text-[var(--gold)] font-black text-xs">{formatCurrency(p.price)}</p>
                                    </div>
                            </div>
                        ))}
                    </div>
                </div>
                
                {/* Panel Derecho: Carrito */}
                <div className="w-96 bg-white border-l border-[var(--border)] flex flex-col z-10 shadow-2xl relative h-full">
                    <div className="p-3 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 className="font-bold text-gray-500 text-sm">CARRITO ACTUAL</h3>
                        <span className="bg-black text-white text-xs px-2 py-1 rounded-full">{cart.length} items</span>
                    </div>
                    <div className="flex-1 p-3 overflow-y-auto space-y-2 bg-white">
                        {cart.length === 0 && <div className="text-center text-gray-300 mt-20 flex flex-col items-center"><ShoppingBag size={48} className="mb-2 opacity-50"/><p>Carrito vac√≠o</p></div>}
                        {cart.map((item,idx)=>(
                            <div key={idx} className="bg-white p-2 rounded border border-gray-200 relative group shadow-sm hover:shadow-md transition">
                                    <button onClick={()=>removeFromCart(idx)} className="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center shadow z-10 font-bold hover:scale-110 transition">x</button>
                                    <div className="flex justify-between items-center text-black text-sm mb-1">
                                        <div><span className="font-bold text-[var(--accent)]">{item.qty}x</span> {item.name}</div>
                                        <div className="font-bold text-gray-800">{formatCurrency(item.price*item.qty)}</div>
                                    </div>
                                    <input className="bg-transparent text-xs text-gray-500 w-full border-b border-dashed border-gray-300 outline-none placeholder-gray-300 focus:border-[var(--gold)]" placeholder="Nota (Sin cebolla...)" value={item.note || ''} onChange={(e)=>updateCartNote(idx, e.target.value)}/>
                            </div>
                        ))}
                    </div>
                    <div className="p-4 bg-gray-50 border-t border-gray-200">
                        <div className="flex justify-between text-2xl font-black text-black mb-4"><span>TOTAL</span><span>{formatCurrency(subtotal)}</span></div>
                        <button onClick={()=>setModal('cockpit')} disabled={cart.length===0} className="btn-gold w-full text-xl py-4 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed hover:brightness-105 transition transform active:scale-95">COBRAR</button>
                    </div>
                </div>
            </div>

            {/* Men√∫ Flotante Admin */}
            <div className="admin-fab">
                {bottomMenuOpen && (
                    <div className="admin-fab-menu">
                        <button onClick={()=>setViewMap(true)} className="bg-blue-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2 hover:scale-105 transition">RASTREO GPS <MapPin size={16}/></button>
                        <button onClick={()=>copyToClipboard(window.location.href)} className="bg-purple-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2 hover:scale-105 transition">COPIAR MENU <Share2 size={16}/></button>
                        <button onClick={()=>{setCorteModal(true); setCutResult(null); setCountedCash(''); setCountedCard('');}} className="bg-red-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2 hover:scale-105 transition">CORTE DE CAJA <DollarSign size={16}/></button>
                        <button onClick={()=>{setRetiroModal(true); setNewExpense({desc:'', amount:''});}} className="bg-orange-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2 hover:scale-105 transition">RETIRO DE EFECTIVO <Minus size={16}/></button>
                        <button onClick={()=>setLiquidationModal(true)} className="bg-green-600 text-white p-3 rounded-full font-bold shadow-lg flex items-center gap-2 hover:scale-105 transition">LIQUIDAR DRIVER <UserCheck size={16}/></button>
                    </div>
                )}
                <button className="bg-[var(--gold)] text-black p-4 rounded-full shadow-xl hover:scale-110 transition border-2 border-white" onClick={()=>setBottomMenuOpen(!bottomMenuOpen)}><Plus size={24} className={`transition duration-300 ${bottomMenuOpen?'rotate-45':''}`}/></button>
            </div>
            
            {ingredientsProduct && (
                <div className="fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center p-4" onClick={()=>setIngredientsProduct(null)}>
                    <div className="bg-white p-6 rounded-xl max-w-sm w-full text-center border-2 border-[var(--gold)] shadow-2xl" onClick={e=>e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-black mb-4">{ingredientsProduct.name}</h3>
                        <p className="text-gray-600 mb-6 font-medium">{ingredientsProduct.ingredients || "No se especificaron ingredientes."}</p>
                        <button onClick={()=>setIngredientsProduct(null)} className="btn-gold w-full shadow-md">CERRAR</button>
                    </div>
                </div>
            )}

            {/* MODAL COBRO (COCKPIT) - TEMA CLARO */}
            {modal === 'cockpit' && (
                <div className="fixed inset-0 bg-black/80 z-50 p-4 animate-in fade-in zoom-in duration-200 overflow-y-auto">
                    <div className="h-full w-full max-w-7xl mx-auto grid-cockpit bg-white rounded-2xl shadow-2xl overflow-hidden text-black">
                        <div className="cockpit-col p-4 bg-gray-50 border-r border-gray-200">
                            <h3 className="text-black font-black text-xl uppercase mb-2 border-b-2 border-[var(--gold)] inline-block">1. TIPO</h3>
                            <button onClick={()=>setOrderType('takeaway')} className={`mode-btn ${orderType==='takeaway'?'active':''}`}>PARA LLEVAR</button>
                            <button onClick={()=>setOrderType('dinein')} className={`mode-btn ${orderType==='dinein'?'active':''}`}>COMER AQU√ç</button>
                            <button onClick={()=>setOrderType('delivery')} className={`mode-btn ${orderType==='delivery'?'active':''}`}>DOMICILIO</button>
                            <button onClick={()=>setOrderType('platform')} className={`mode-btn ${orderType==='platform'?'active':''}`}>PLATAFORMA</button>
                            <button onClick={()=>setModal(null)} className="mt-auto w-full border border-red-200 bg-red-50 text-red-600 py-4 rounded font-bold hover:bg-red-100 transition">CANCELAR (ESC)</button>
                        </div>
                        
                        <div className="cockpit-col p-4 bg-white overflow-y-auto">
                            <h3 className="text-black font-black text-xl uppercase mb-2 border-b-2 border-[var(--gold)] inline-block">2. DATOS</h3>
                            {orderType !== 'platform' && (
                                <>
                                    <input className="input-special h-12 text-lg mb-2" placeholder="Nombre *" value={orderDetails.name} onChange={e=>setOrderDetails({...orderDetails, name:e.target.value})}/>
                                    <div className="flex gap-2 mb-2">
                                        <input className="input-special h-12 text-lg flex-1" placeholder="Tel√©fono (10 d√≠gitos) *" value={orderDetails.phone} maxLength={10} onChange={e=>setOrderDetails({...orderDetails, phone:e.target.value})}/>
                                        <a href={`https://wa.me/52${orderDetails.phone}?text=HOLA! ${orderDetails.name}, le contacto de EMI BURGER.`} target="_blank" className="bg-[#25D366] text-white rounded p-2 flex items-center justify-center w-12 hover:scale-105 transition shadow"><MessageCircle/></a>
                                    </div>
                                </>
                            )}
                            {orderType === 'dinein' && <input className="input-special h-12 text-lg" placeholder="# Mesa" value={orderDetails.table} onChange={e=>setOrderDetails({...orderDetails, table:e.target.value})}/>}
                            {orderType === 'platform' && (
                                <>
                                    <div className="grid grid-cols-2 gap-2 mb-2">{db.settings.platforms.map(p=><button key={p} onClick={()=>setOrderDetails({...orderDetails, platform:p})} className={`p-3 rounded border font-bold transition ${orderDetails.platform===p?'bg-blue-600 text-white shadow-lg':'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>{p}</button>)}</div>
                                    <input className="input-special h-12 text-lg font-bold border-blue-500" placeholder="ID / NOMBRE PEDIDO *" value={orderDetails.platformOrderId} onChange={e=>setOrderDetails({...orderDetails, platformOrderId:e.target.value})}/>
                                </>
                            )}
                            {orderType === 'delivery' && (
                                <>
                                    <div className="flex gap-2 mb-2 relative">
                                        <input className={`input-special h-12 text-lg flex-1 ${isLocating?'animate-pulse border-[var(--gold)]':''}`} placeholder={isLocating?"üìç Localizando...":"Calle y N√∫mero *"} value={orderDetails.address} onChange={e=>updateLocationFromAddress(e.target.value)} list="pos-address-list"/>
                                        <datalist id="pos-address-list">
                                            {suggestions.map((s,i) => <option key={i} value={s.display_name} />)}
                                        </datalist>
                                        <button onClick={useGPS} className="bg-blue-600 text-white p-2 rounded hover:bg-blue-700 shadow"><MapPin/></button>
                                    </div>
                                    {isLocating && <p className="text-[var(--gold)] text-xs font-bold mb-2">Buscando direcci√≥n...</p>}
                                    <input className="input-special h-12 text-lg mb-2" placeholder="Referencias / Colonia *" value={orderDetails.references} onChange={e=>setOrderDetails({...orderDetails, references:e.target.value})}/>
                                    <div className="h-40 rounded border border-gray-300 overflow-hidden relative mb-2 shadow-inner">
                                        <LeafletMap center={deliveryCoords || STORE_COORDS} markers={[{pos:deliveryCoords||STORE_COORDS, emoji:'üìç'}]} onClickMap={handleReverseGeo} zoom={15}/>
                                    </div>
                                    <div className="bg-black p-2 rounded text-right text-sm text-white">Env√≠o: <span className="font-bold text-[var(--gold)]">{formatCurrency(deliveryFee)}</span></div>
                                </>
                            )}
                            <div className="flex gap-2 mt-2"><input className="input-special h-10 flex-1" placeholder="CUP√ìN" value={couponCode} onChange={e=>setCouponCode(e.target.value)}/><button onClick={applyCoupon} className="btn-gold h-10 px-4 text-xs">APLICAR</button></div>
                        </div>
                        
                        <div className="cockpit-col p-4 bg-gray-50 border-l border-gray-200 relative flex flex-col">
                            <h3 className="text-black font-black text-xl uppercase mb-4 text-center border-b-2 border-[var(--gold)] inline-block mx-auto">3. PAGO: {formatCurrency(total)}</h3>
                            <div className="flex gap-2 mb-4"><button onClick={()=>switchPayMethod('cash')} className={`flex-1 py-4 rounded font-bold text-lg shadow transition ${payMethod==='cash'?'bg-green-600 text-white':'bg-white text-gray-400 border border-gray-200'}`}>EFECTIVO</button><button onClick={()=>switchPayMethod('card')} className={`flex-1 py-4 rounded font-bold text-lg shadow transition ${payMethod==='card'?'bg-blue-600 text-white':'bg-white text-gray-400 border border-gray-200'}`}>{orderType==='platform'?'APP':'TARJETA'}</button></div>
                            
                            {orderType === 'delivery' && payMethod === 'cash' && (
                                <div className="flex gap-2 mb-4">
                                    <button onClick={() => setPaymentStatus('paid')} className={`flex-1 p-2 rounded border-2 font-bold transition ${paymentStatus==='paid'?'bg-green-100 border-green-600 text-green-800':'border-gray-300 text-gray-400 bg-white'}`}>‚úÖ PAGADO EN CAJA</button>
                                    <button onClick={() => { setPaymentStatus('pending'); setCashReceived(0); }} className={`flex-1 p-2 rounded border-2 font-bold transition ${paymentStatus==='pending'?'bg-yellow-100 border-yellow-600 text-yellow-800':'border-gray-300 text-gray-400 bg-white'}`}>üõµ PAGO AL RECIBIR</button>
                                </div>
                            )}

                            {payMethod === 'cash' && (
                                <div className="flex-1 flex flex-col gap-2">
                                    {paymentStatus !== 'pending' ? (
                                        <div className="grid grid-cols-3 gap-2 mb-2">
                                            {[20, 50, 100, 200, 500].map(v => (
                                                <button key={v} className="bill-btn hover:scale-105 transition" style={{backgroundImage:`url(./${v}.png)`}} onClick={() => setCashReceived(v)}></button>
                                            ))}
                                            <button onClick={() => setCashReceived(total)} className="bg-[var(--gold)] text-black font-black rounded text-sm h-[60px] shadow hover:bg-yellow-400 transition">EXACTO</button>
                                        </div>
                                    ) : (
                                        <div className="text-center text-yellow-800 font-bold p-6 border-2 border-dashed border-yellow-500 bg-yellow-50 rounded mb-4">
                                            <Bike size={48} className="mx-auto mb-2 opacity-50"/>
                                            COBRO A CARGO DEL REPARTIDOR
                                        </div>
                                    )}

                                    <div className="mt-auto p-4 bg-white rounded border border-gray-300 shadow-lg">
                                        {paymentStatus !== 'pending' && (
                                            <>
                                                <div className="flex justify-between text-gray-600 items-center">
                                                    <span>Recibido:</span>
                                                    <input type="number" className={`bg-transparent text-right font-black text-3xl w-40 outline-none ${!cashReceived ? 'animate-pulse text-gray-400 border-b-4 border-gray-300' : 'text-green-600 border-b-4 border-green-500'}`} placeholder="0.00" value={cashReceived || ''} onChange={e=>setCashReceived(parseFloat(e.target.value))}/>
                                                </div>
                                                <div className="flex justify-between text-gray-600 mt-2"><span>Cambio:</span><span className={`font-bold text-2xl ${cashReceived>=total?'text-green-600':'text-red-500'}`}>{formatCurrency(cashReceived-total)}</span></div>
                                            </>
                                        )}
                                        {paymentStatus === 'pending' && <p className="text-center text-black font-bold">Saldo a cobrar: {formatCurrency(total)}</p>}
                                    </div>
                                </div>
                            )}
                            
                            {payMethod === 'card' && orderType !== 'platform' && <div className="flex-1 flex flex-col justify-center items-center"><CreditCard size={80} className="text-blue-500 mb-6 animate-pulse"/><p className="text-gray-500 font-bold mb-2 text-xl">FOLIO DE VOUCHER</p><input className="input-special text-center text-3xl tracking-widest border-2 border-blue-200" placeholder="0000" value={voucher} onChange={e=>setVoucher(e.target.value)} autoFocus/></div>}
                            <button onClick={finalizeOrder} className="btn-gold py-5 text-2xl mt-4 w-full font-black rounded-xl hover:scale-105 transition shadow-lg">COBRAR AHORA</button>
                        </div>
                    </div>
                </div>
            )}
            
            {liquidationModal && (
                <div className="fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center p-4 animate-in zoom-in">
                    <div className="bg-white w-full max-w-lg p-6 rounded-xl shadow-2xl text-black">
                        <h3 className="text-2xl font-bold text-[var(--gold)] mb-4 bg-black p-2 rounded text-center">LIQUIDACI√ìN REPARTIDOR</h3>
                        {!driverToLiq ? (
                            <div className="text-center">
                                 <p className="mb-4 text-gray-600 font-medium">Escanea el QR o Ingresa ID:</p>
                                 <div className="flex gap-2 justify-center mb-4">
                                     <input id="liq-input" className="input-special w-48 text-center uppercase font-bold text-lg" placeholder="ID (ej. u4)" onChange={e=>setManualDriverId(e.target.value)}/>
                                     <button onClick={() => handleScanDriver("LIQ:" + manualDriverId)} className="btn-gold px-4">BUSCAR</button>
                                 </div>
                                 <div className="w-full h-32 border-2 border-dashed border-gray-300 rounded flex items-center justify-center text-gray-400 mb-4 bg-gray-50">
                                     [C√ÅMARA DE ESCANEO ACTIVA]
                                 </div>
                                 <button onClick={()=>setLiquidationModal(false)} className="text-gray-500 hover:text-black font-bold">CANCELAR (ESC)</button>
                            </div>
                        ) : (
                            <div>
                                <p className="font-bold text-xl text-black mb-4 text-center">{driverToLiq.name}</p>
                                <div className="bg-gray-50 p-4 rounded mb-4 space-y-2 border border-gray-200">
                                    <div className="flex justify-between text-gray-600"><span>Pedidos Entregados:</span><span className="text-black font-bold">{liqSummary.deliveredOrders.length}</span></div>
                                    <div className="flex justify-between text-gray-600"><span>Efectivo en Mano:</span><span className="text-black font-bold">{formatCurrency(liqSummary.totalCash)}</span></div>
                                    <div className="flex justify-between text-green-600"><span>Ganancias Env√≠os:</span><span className="font-bold">-{formatCurrency(liqSummary.totalEarnings)}</span></div>
                                    <div className="border-t border-gray-300 pt-2 flex justify-between text-xl font-black text-black"><span>A ENTREGAR:</span><span>{formatCurrency(liqSummary.netToPay)}</span></div>
                                </div>
                                <button onClick={confirmLiquidation} className="btn-gold w-full text-lg py-3 shadow-lg">LIQUIDAR Y CERRAR</button>
                            </div>
                        )}
                    </div>
                </div>
            )}

            {corteModal && (
                <div className="fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md p-6 rounded-xl shadow-2xl max-h-screen overflow-y-auto">
                        <h3 className="text-2xl font-bold text-white bg-red-600 p-2 rounded text-center mb-6 shadow">CORTE DE CAJA (CIEGO)</h3>
                        
                        <div className="bg-gray-50 p-4 rounded mb-6 border border-gray-200">
                            {!cutResult ? (
                                <div className="space-y-4">
                                    <p className="text-black font-bold mb-2 text-center text-lg">INGRESE TOTALES CONTADOS:</p>
                                    <div>
                                        <label className="text-gray-500 text-xs font-bold uppercase">Total Efectivo en Caja</label>
                                        <input type="number" className="input-special text-2xl font-bold text-center h-16" value={countedCash} onChange={e=>setCountedCash(e.target.value)} placeholder="$0.00"/>
                                    </div>
                                    <div>
                                        <label className="text-gray-500 text-xs font-bold uppercase">Suma Tickets Tarjeta</label>
                                        <input type="number" className="input-special text-2xl font-bold text-center h-16" value={countedCard} onChange={e=>setCountedCard(e.target.value)} placeholder="$0.00"/>
                                    </div>
                                    <button onClick={performBlindCut} className="btn-gold w-full mt-4 py-3 shadow">CALCULAR DIFERENCIA</button>
                                </div>
                            ) : (
                                <div className="space-y-2 animate-in fade-in">
                                    <div className="flex justify-between text-gray-600 text-sm"><span>Efectivo Declarado:</span><span className="font-bold">{formatCurrency(cutResult.cCash)}</span></div>
                                    <div className="flex justify-between text-gray-600 text-sm"><span>Sistema (Calculado):</span><span>{formatCurrency(cutResult.systemCash)}</span></div>
                                    <div className={`flex justify-between font-black border-t border-gray-300 pt-2 text-lg ${cutResult.diffCash < 0 ? 'text-red-600' : 'text-green-600'}`}>
                                        <span>Diferencia Efectivo:</span><span>{formatCurrency(cutResult.cCash - cutResult.systemCash)}</span>
                                    </div>
                                    <div className="flex justify-between text-gray-600 text-sm mt-4"><span>Tarjeta Declarada:</span><span className="font-bold">{formatCurrency(cutResult.cCard)}</span></div>
                                    <div className="flex justify-between text-gray-600 text-sm"><span>Sistema Tarjeta:</span><span>{formatCurrency(cutResult.systemCard)}</span></div>
                                    
                                    {cutResult.missingOrder && (
                                        <div className="bg-red-50 border border-red-200 p-2 rounded mt-2 text-xs text-red-700 animate-pulse">
                                            <p className="font-bold flex items-center gap-1"><AlertTriangle size={12}/> POSIBLE VENTA FALTANTE DETECTADA</p>
                                            <p>Coincide con Orden #{cutResult.missingOrder.orderNum}</p>
                                            <p>Total: {formatCurrency(cutResult.missingOrder.total)}</p>
                                        </div>
                                    )}
                                    
                                    <button onClick={printBlindCut} className="w-full bg-black text-white font-bold py-3 mt-4 rounded shadow-lg flex items-center justify-center gap-2 hover:bg-gray-800"><Printer/> IMPRIMIR CORTE Z</button>
                                    <button onClick={()=>setCutResult(null)} className="text-blue-500 text-xs mt-2 w-full font-bold hover:underline">RECALCULAR</button>
                                </div>
                            )}
                        </div>
                        <button onClick={()=>setCorteModal(false)} className="text-gray-400 w-full hover:text-black font-bold">CERRAR (ESC)</button>
                    </div>
                </div>
            )}

            {retiroModal && (
                <div className="fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md p-6 rounded-xl shadow-2xl">
                        <h3 className="text-2xl font-bold text-white bg-orange-500 p-2 rounded text-center mb-4 shadow">RETIRO DE EFECTIVO</h3>
                        <div className="bg-gray-50 p-4 rounded mb-4 border border-gray-200">
                            <p className="text-xs text-gray-500 font-bold mb-2 uppercase">Registrar gasto o pago a proveedor</p>
                            <input className="input-special mb-2" placeholder="Descripci√≥n (ej. Pago Coca-Cola)" value={newExpense.desc} onChange={e=>setNewExpense({...newExpense, desc:e.target.value})}/>
                            <input className="input-special mb-2 font-bold text-lg" type="number" placeholder="Monto a Retirar" value={newExpense.amount} onChange={e=>setNewExpense({...newExpense, amount:e.target.value})}/>
                            <button onClick={addExpense} className="w-full bg-orange-600 text-white font-bold py-3 rounded shadow hover:bg-orange-700">CONFIRMAR RETIRO</button>
                        </div>
                        <button onClick={()=>setRetiroModal(false)} className="text-gray-400 w-full hover:text-black font-bold">CANCELAR (ESC)</button>
                    </div>
                </div>
            )}
        </div>
    );
};
const ClientApp = ({ db, updateDB }) => {
    const [view, setView] = useState('menu');
    const [cart, setCart] = useState([]);
    const [form, setForm] = useState({name:'', phone:'', type:'delivery', address:'', references:'', pay:'card', payAmount:0});
    const [activeOrder, setActiveOrder] = useState(null);
    const [clientCoords, setClientCoords] = useState(null);
    const [deliveryCoords, setDeliveryCoords] = useState(null);
    const [isLocating, setIsLocating] = useState(false);
    const [showCashModal, setShowCashModal] = useState(false);
    const [showComplements, setShowComplements] = useState(false); 
    const [tempCashAmount, setTempCashAmount] = useState('');
    const [suggestions, setSuggestions] = useState([]);
    const addressTimer = useRef(null);
    const [clientCatFilter, setClientCatFilter] = useState('Todos'); 
    const [ingredientsProduct, setIngredientsProduct] = useState(null);
    const [showLargeMap, setShowLargeMap] = useState(false);
    
    // --- 1. BLOQUEO INMEDIATO SI TIENDA CIERRA ---
    if(!db.settings.storeOpen) return <div className="closed-store-overlay"></div>;

    // --- 2. EFECTOS DE INICIO Y PERSISTENCIA ---
    useEffect(() => {
        document.body.classList.add('client-mode'); // Forzar estilos cliente
        
        // Recuperar pedido activo
        const storedOrderId = localStorage.getItem('client_active_order_id');
        if (storedOrderId) {
            const existingOrder = db.orders.find(o => o.id === storedOrderId);
            if (existingOrder) {
                if (existingOrder.status === 'delivered' || existingOrder.status === 'cancelled') {
                    localStorage.removeItem('client_active_order_id');
                    if(existingOrder.status === 'delivered') showToast("¬°Pedido Entregado! Gracias por su compra.");
                } else {
                    setActiveOrder(existingOrder);
                    setView('track');
                }
            }
        }
        
        navigator.geolocation.getCurrentPosition((pos) => {
            const coords = [pos.coords.latitude, pos.coords.longitude];
            setClientCoords(coords);
            if(!deliveryCoords) setDeliveryCoords(coords); 
        }, () => setClientCoords(STORE_COORDS)); 

        return () => { document.body.classList.remove('client-mode'); };
    }, [db.orders]);

    // --- 3. C√ÅLCULOS ---
    const deliveryFee = useMemo(() => {
        if(form.type==='delivery' && deliveryCoords) {
            const dist = calculateDistance(STORE_COORDS[0], STORE_COORDS[1], deliveryCoords[0], deliveryCoords[1]);
            return getDeliveryPrice(dist, db.settings.deliveryTable);
        }
        return 0;
    }, [deliveryCoords, form.type, db.settings.deliveryTable]);

    const total = cart.reduce((a,b)=>a+b.price*b.qty,0) + deliveryFee;

    // --- 4. FUNCIONES ---
    const adjustQty = (p, delta) => { 
        const existing = cart.find(i => i.id === p.id); 
        if (existing) { 
            const newQty = existing.qty + delta; 
            if (newQty <= 0) setCart(cart.filter(i => i.id !== p.id)); 
            else setCart(cart.map(i => i.id === p.id ? {...i, qty: newQty} : i)); 
        } else if (delta > 0) {
            setCart([...cart, {...p, qty: 1}]); 
        }
    };
    const getQty = (pId) => { const item = cart.find(i => i.id === pId); return item ? item.qty : 0; };
    const updateItemNote = (idx, note) => { const newCart = [...cart]; newCart[idx].note = note; setCart(newCart); };

    const preSubmit = () => { 
        const hasComplements = db.products.some(p => p.isComplement && (p.active !== false)); 
        if (hasComplements && !showComplements) setShowComplements(true); 
        else { setView('checkout'); setShowComplements(false); } 
    };

    const submit = () => {
        if(activeOrder) return showToast("Ya tienes un pedido en curso");
        if(!form.name) return showToast("Falta Nombre");
        if(!form.phone || form.phone.length !== 10) return showToast("Tel√©fono inv√°lido (10 d√≠gitos)");
        if (form.type === 'delivery') {
            if (!db.settings.deliveryEnabled) return showToast("Servicio a domicilio no disponible");
            if (!form.address) return showToast("Falta Direcci√≥n");
            if (deliveryCoords) { 
                const dist = calculateDistance(STORE_COORDS[0], STORE_COORDS[1], deliveryCoords[0], deliveryCoords[1]); 
                if (dist > db.settings.deliveryRadius) return showToast("Upss! Direcci√≥n fuera de zona de cobertura."); 
            }
        }
        if(form.pay === 'cash' && (!form.payAmount || form.payAmount < total)) return showToast("Monto insuficiente o inv√°lido");
        
        const order = { 
            id: generateId(), 
            orderNum: Math.floor(Math.random()*9000)+1000, 
            items: cart, 
            total, 
            status: 'web_pending_payment', 
            method: form.pay, 
            payAmount: form.payAmount, 
            createdAt: new Date().toISOString(), 
            address: form.type==='delivery' ? `${form.address} (${form.references})` : 'RECOGER', 
            clientName: form.name, 
            clientPhone: form.phone, 
            clientLoc: deliveryCoords || clientCoords, 
            source: 'web',
            deviceId: localStorage.getItem('device_id')
        };
        
        localStorage.setItem('client_active_order_id', order.id);
        updateDB({...db, orders: [...db.orders, order]}); 
        setActiveOrder(order); 
        setView('track');
    };

    // --- MAPA Y B√öSQUEDA ---
    const updateLocationFromAddress = (addr) => {
        setForm(prev => ({...prev, address: addr}));
        if (addressTimer.current) clearTimeout(addressTimer.current);
        if(addr.length < 4) { setSuggestions([]); setIsLocating(false); return; }
        setIsLocating(true);
        addressTimer.current = setTimeout(async () => {
            try { 
                // A√±adimos 'extratags=1' y 'addressdetails=1' para intentar obtener calle y n√∫mero
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr + " " + CITY_SUFFIX)}&limit=5&addressdetails=1&extratags=1`); 
                const data = await res.json(); 
                setSuggestions(data || []); 
            } catch(e) {} finally { setIsLocating(false); }
        }, 1000); 
    };
    
    const selectSuggestion = (s) => {
        // Intento de construir "Calle + N√∫mero" si est√° disponible en address
        let street = s.address.road || s.address.pedestrian || s.display_name.split(',')[0];
        let number = s.address.house_number || '';
        let finalAddr = number ? `${street} #${number}` : street;
        
        setForm({...form, address: finalAddr});
        setDeliveryCoords([parseFloat(s.lat), parseFloat(s.lon)]);
        setSuggestions([]);
    };

    const useGPS = () => { 
        setIsLocating(true); 
        navigator.geolocation.getCurrentPosition(pos => { 
            const coords = [pos.coords.latitude, pos.coords.longitude]; 
            setDeliveryCoords(coords); 
            setClientCoords(coords); 
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords[0]}&lon=${coords[1]}`)
                .then(r=>r.json())
                .then(d=>{ 
                    if(d && d.display_name){ 
                         let parts = d.display_name.split(','); 
                         setForm(prev => ({...prev, address: parts[0] + (parts[1]||'')})); 
                    } 
                }).catch(e=>{}); 
            setIsLocating(false); 
        }, () => setIsLocating(false)); 
    };

    const handleMapClick = async (coords) => { 
        setDeliveryCoords(coords); 
        setIsLocating(true); 
        try { 
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords[0]}&lon=${coords[1]}`); 
            const data = await res.json(); 
            if(data && data.display_name) { 
                const addrParts = data.display_name.split(','); 
                setForm(prev => ({...prev, address: addrParts[0] + (addrParts[1]||'')})); 
                setSuggestions([]); 
            } 
        } catch(e) {} finally { setIsLocating(false); } 
    };

    // --- FILTRADO DE PRODUCTOS (CORRECCI√ìN "OJITO") ---
    const groupedProducts = useMemo(() => {
        const groups = {};
        if(db && db.products) {
            // AHORA SI RESPETA EL OJITO (p.active !== false)
            db.products.filter(p => !p.isComplement && p.active !== false).forEach(p => {
                const cat = p.cat || 'Otros';
                if (!groups[cat]) groups[cat] = [];
                groups[cat].push(p);
            });
        }
        return groups;
    }, [db.products]);
    
    const uniqueClientCategories = ['Todos', ...Object.keys(groupedProducts)];
    const handleCashSelect = () => setShowCashModal(true);
    const confirmCash = () => { if(parseFloat(tempCashAmount) < total) return showToast("El monto debe ser mayor al total"); setForm({...form, pay:'cash', payAmount: parseFloat(tempCashAmount)}); setShowCashModal(false); };

    // --- VISTA 1: MEN√ö ---
    if(view === 'menu') return (
        <div className="h-full flex flex-col bg-[var(--bg-body)] text-[var(--text-main)] relative app-view-mobile">
            <button className="install-btn" onClick={()=>showToast("Comparte -> Agregar a Inicio")}><img src={LOGO_URL}/></button>
            {activeOrder && ( 
                <div onClick={()=>setView('track')} className="fixed top-20 left-4 right-4 bg-red-600 text-white p-6 rounded-2xl shadow-2xl z-[100] animate-pulse cursor-pointer border-4 border-[var(--gold)] text-center">
                    <h2 className="text-3xl font-brand">üõµ PEDIDO EN CURSO</h2>
                    <p className="font-bold text-sm mt-2">TOCA PARA VER EL MAPA</p>
                </div> 
            )}
            <div className="banner-container"><img src={BANNER_URL} className="mobile-banner" alt="Banner"/></div>
            
            <div className="p-2 flex gap-2 overflow-x-auto bg-[var(--bg-card)] border-b border-[var(--border)]">
                {uniqueClientCategories.map(c=><button key={c} onClick={()=>setClientCatFilter(c)} className={`px-4 py-1 rounded-full text-xs font-bold whitespace-nowrap ${clientCatFilter===c ? 'bg-[var(--gold)] text-black' : 'bg-gray-200 text-gray-700'}`}>{c}</button>)}
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-6 pb-48">
                {Object.keys(groupedProducts).length === 0 ? (
                    <div className="text-center text-gray-500 mt-10"><p>Men√∫ Vac√≠o o Cargando...</p></div>
                ) : (
                    Object.entries(groupedProducts).filter(([cat]) => clientCatFilter === 'Todos' || cat === clientCatFilter).map(([cat, prods]) => (
                        <div key={cat}>
                            <h3 className="font-brand text-2xl mb-4 text-[var(--accent)] border-b border-gray-300 pb-2">{cat}</h3>
                            <div className="space-y-4">
                                {prods.map(p=>{ 
                                    const qty = getQty(p.id); 
                                    return (
                                        <div key={p.id} className="card p-3 shadow flex gap-3 bg-[var(--bg-card)] relative">
                                            <img src={p.img || LOGO_URL} onError={(e) => e.target.src = LOGO_URL} className="w-24 h-24 rounded object-cover cursor-pointer" onClick={()=>setIngredientsProduct(p)}/>
                                            <div className="flex-1 flex flex-col justify-between">
                                                <div>
                                                    <p className="font-bold text-[var(--text-main)] text-lg leading-tight" onClick={()=>setIngredientsProduct(p)}>{p.name}</p>
                                                    <p className="text-gray-500 text-xs italic line-clamp-2 mt-1">{p.ingredients}</p>
                                                </div>
                                                <div className="flex justify-between items-end mt-2">
                                                    <span className="font-black text-xl text-[var(--accent)]">{formatCurrency(p.price)}</span>
                                                    <div className="flex items-center gap-2 bg-gray-100 rounded-full p-1 border border-gray-300">
                                                        {qty === 0 ? (
                                                            <button onClick={()=>adjustQty(p, 1)} className="bg-[var(--gold)] text-black font-bold px-4 py-1 rounded-full text-sm shadow">PEDIR</button>
                                                        ) : (
                                                            <>
                                                                <button onClick={()=>adjustQty(p, -1)} className="w-8 h-8 rounded-full bg-gray-300 text-black font-bold flex items-center justify-center">-</button>
                                                                <span className="w-6 text-center font-bold text-black text-sm">{qty}</span>
                                                                <button onClick={()=>adjustQty(p, 1)} className="w-8 h-8 rounded-full bg-[var(--gold)] text-black font-bold flex items-center justify-center shadow">+</button>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    ))
                )}
            </div>
            
            <div className="mobile-video-container"><video src={VIDEO_URL} autoPlay loop muted playsInline></video><div className="mobile-video-overlay"></div></div>
            <div className="fixed bottom-0 w-full p-4 bg-[var(--bg-card)] border-t border-[var(--border)] z-[60]">
                {activeOrder ? (
                    <button onClick={()=>setView('track')} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-lg animate-pulse">üõµ VER PEDIDO EN CURSO</button>
                ) : (
                    cart.length > 0 && <button onClick={preSubmit} className="w-full bg-[var(--accent)] text-white py-3 rounded-lg font-bold shadow-lg">IR A PAGAR ({formatCurrency(total)})</button>
                )}
            </div>
            
            {showComplements && (
                <div className="fixed inset-0 bg-black/90 z-[9999] flex flex-col justify-end p-4 animate-in slide-in-from-bottom">
                    <div className="bg-[var(--bg-card)] rounded-t-2xl p-6 border-t border-[var(--gold)]">
                        <h3 className="text-xl font-bold text-[var(--gold)] mb-4 text-center">¬øALGO M√ÅS? üçü</h3>
                        <div className="flex gap-4 overflow-x-auto pb-4">
                            {db.products.filter(p => p.isComplement && p.active !== false).map(p => (
                                <div key={p.id} className="min-w-[120px] bg-gray-100 p-2 rounded-lg text-center cursor-pointer border hover:border-[var(--gold)]" onClick={()=>{adjustQty(p, 1); showToast("Agregado!");}}>
                                    <img src={p.img} className="w-20 h-20 mx-auto rounded mb-2 object-cover"/>
                                    <p className="text-xs font-bold text-black line-clamp-1">{p.name}</p>
                                    <p className="text-[var(--gold)] font-bold">{formatCurrency(p.price)}</p>
                                </div>
                            ))}
                        </div>
                        <button onClick={()=>{setView('checkout'); setShowComplements(false);}} className="w-full bg-black text-white font-bold py-3 rounded-xl mt-4">CONTINUAR</button>
                    </div>
                </div>
            )}
            {ingredientsProduct && (
                <div className="fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center p-4" onClick={()=>setIngredientsProduct(null)}>
                    <div className="bg-white p-6 rounded-xl max-w-sm w-full text-center" onClick={e=>e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-black mb-4">{ingredientsProduct.name}</h3>
                        <p className="text-gray-700 mb-6">{ingredientsProduct.ingredients || "Sin descripci√≥n."}</p>
                        <button onClick={()=>setIngredientsProduct(null)} className="btn-gold w-full">CERRAR</button>
                    </div>
                </div>
            )}
        </div>
    );

    // --- VISTA 2: CHECKOUT (REORDENADO) ---
    if(view === 'checkout') return (
        <div className="h-full bg-[var(--bg-body)] p-4 overflow-y-auto app-view-mobile relative flex flex-col pb-32 text-[var(--text-main)]">
            <button onClick={()=>setView('menu')} className="mb-4 text-gray-600 flex items-center gap-2 font-bold"><ArrowLeft/> VOLVER AL MEN√ö</button>
            <h2 className="font-bold text-2xl mb-6 text-center text-[var(--text-main)]">FINALIZAR PEDIDO</h2>
            
            {/* 1. TUS PRODUCTOS */}
            <div className="mb-6 space-y-2">
                <h3 className="text-sm font-bold text-gray-500 uppercase border-b border-gray-300 pb-1 mb-2">1. Tus Productos</h3>
                {cart.map((item, idx) => ( 
                    <div key={idx} className="bg-white p-3 rounded border border-gray-200 shadow-sm">
                        <div className="flex justify-between items-center mb-1">
                            <div><p className="font-bold text-black">{item.name}</p><p className="text-xs text-[var(--gold)] font-bold">{formatCurrency(item.price)}</p></div>
                            <div className="flex items-center gap-3">
                                <button onClick={()=>adjustQty(item, -1)} className="w-8 h-8 bg-gray-200 text-black rounded-full font-bold">-</button>
                                <span className="font-bold text-black">{item.qty}</span>
                                <button onClick={()=>adjustQty(item, 1)} className="w-8 h-8 bg-[var(--gold)] text-black rounded-full font-bold">+</button>
                            </div>
                        </div>
                        {!item.isComplement && <input className="w-full bg-transparent border-b border-gray-300 text-xs text-black p-1 outline-none" placeholder="Nota (Sin cebolla...)" value={item.note || ''} onChange={(e)=>updateItemNote(idx, e.target.value)}/>}
                    </div> 
                ))}
            </div>

            {/* 2. TUS DATOS */}
            <div className="mb-6 space-y-3">
                <h3 className="text-sm font-bold text-gray-500 uppercase border-b border-gray-300 pb-1 mb-2">2. Tus Datos</h3>
                <input className="input-std" placeholder="Tu Nombre" value={form.name} onChange={e=>setForm({...form,name:e.target.value})}/>
                <input className="input-std" type="number" placeholder="Tel√©fono" value={form.phone} maxLength={10} onChange={e=>setForm({...form,phone:e.target.value})}/>
            </div>

            {/* 3. ENTREGA */}
            <div className="mb-6">
                <h3 className="text-sm font-bold text-gray-500 uppercase border-b border-gray-300 pb-1 mb-2">3. Tipo de Entrega</h3>
                <div className="flex gap-2">
                    <button onClick={()=>setForm({...form, type:'delivery'})} className={`flex-1 p-3 rounded font-bold border transition ${form.type==='delivery'?'border-[var(--accent)] bg-[var(--accent)] text-white':'bg-white text-gray-500'}`}>DOMICILIO</button>
                    {db.settings.pickupEnabled && <button onClick={()=>setForm({...form, type:'pickup'})} className={`flex-1 p-3 rounded font-bold border transition ${form.type==='pickup'?'border-[var(--accent)] bg-[var(--accent)] text-white':'bg-white text-gray-500'}`}>RECOGER</button>}
                </div>
            </div>

            {/* 4. DIRECCI√ìN (INPUT NEGRO FORZADO) */}
            {form.type === 'delivery' && (
                <div className="mb-6 animate-in fade-in">
                    <h3 className="text-sm font-bold text-gray-500 uppercase border-b border-gray-300 pb-1 mb-2">4. Direcci√≥n</h3>
                    <div className="didi-search-container border-black/20">
                        <div className="text-[var(--accent)]"><MapPin size={24}/></div>
                        {/* INPUT FORZADO A NEGRO CON CLASE input-dark-force */}
                        <input className="didi-input input-dark-force p-2 rounded" placeholder="Calle y N√∫mero..." value={form.address} onChange={e=>updateLocationFromAddress(e.target.value)}/>
                        <button className="didi-btn-orange flex items-center gap-1" onClick={useGPS}>
                            {isLocating ? <span className="animate-spin">‚Üª</span> : <Crosshair size={16}/>}
                            {isLocating ? 'LOCALIZANDO...' : 'UBICACI√ìN'}
                        </button>
                    </div>
                    
                    {suggestions.length > 0 && (
                        <div className="didi-suggestions shadow-xl z-50 relative">
                            {suggestions.map((s,i) => (
                                <div key={i} className="didi-item hover:bg-gray-100" onClick={() => selectSuggestion(s)}>
                                    <MapPin className="text-[var(--gold)]" size={16}/>
                                    <div className="flex flex-col">
                                        <span className="font-bold text-sm text-black">{s.address.road || s.display_name.split(',')[0]}</span>
                                        <span className="text-[10px] text-gray-500">{s.display_name}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    <input className="input-std mt-2" placeholder="Referencias (Casa color, port√≥n...)" value={form.references} onChange={e=>setForm({...form,references:e.target.value})}/>
                    <div className="h-40 w-full rounded border border-gray-400 overflow-hidden relative shadow-lg mt-2">
                        <LeafletMap center={deliveryCoords || STORE_COORDS} markers={[{pos:clientCoords||STORE_COORDS, emoji:'', isClient:true}, {pos:deliveryCoords||STORE_COORDS, emoji:'üçî', label:'Entrega'}, {pos:STORE_COORDS, emoji:'', isStore:true}]} onClickMap={handleMapClick} zoom={15} />
                    </div>
                </div>
            )}

            {/* 5. M√âTODO DE PAGO */}
            <div className="mb-6 card p-4 border border-[var(--gold)] bg-white">
                <h3 className="text-sm font-bold text-[var(--gold)] uppercase mb-2">5. M√©todo de Pago</h3>
                <div className="flex gap-2 mb-2">
                    <label className={`flex-1 p-3 rounded border text-center font-bold cursor-pointer ${form.pay==='cash'?'border-green-500 bg-green-50 text-green-600':'border-gray-300 text-gray-500'}`}><input type="radio" name="pay" hidden checked={form.pay==='cash'} onChange={handleCashSelect}/> Efectivo</label>
                    <label className={`flex-1 p-3 rounded border text-center font-bold cursor-pointer ${form.pay==='card'?'border-blue-500 bg-blue-50 text-blue-600':'border-gray-300 text-gray-500'}`}><input type="radio" name="pay" hidden checked={form.pay==='card'} onChange={()=>setForm({...form,pay:'card'})}/> Tarjeta</label>
                </div>
            </div>

            {/* 6. RESUMEN DE COMPRA (TOTALES Y CAMBIO) */}
            <div className="bg-white p-4 rounded mb-6 space-y-2 border border-gray-300 shadow-md">
                <h3 className="text-sm font-bold text-gray-500 uppercase border-b border-gray-300 pb-1 mb-2">6. Resumen</h3>
                <div className="flex justify-between text-gray-700"><span>Subtotal:</span><span>{formatCurrency(cart.reduce((a,b)=>a+b.price*b.qty,0))}</span></div>
                <div className="flex justify-between text-[var(--gold)] font-bold"><span>Env√≠o Estimado:</span><span>{formatCurrency(deliveryFee)}</span></div>
                <div className="border-t border-gray-300 pt-2 flex justify-between text-2xl font-black text-black"><span>TOTAL:</span><span>{formatCurrency(total)}</span></div>
                
                {/* MOSTRAR CAMBIO AQU√ç */}
                {form.pay === 'cash' && form.payAmount > 0 && (
                    <div className="bg-green-50 p-2 rounded border border-green-200 mt-2 text-center">
                        <p className="text-sm text-green-800 font-bold">Pagas con: {formatCurrency(form.payAmount)}</p>
                        <p className="text-lg text-green-600 font-black">Tu Cambio: {formatCurrency(Math.max(0, form.payAmount - total))}</p>
                    </div>
                )}
            </div>
            
            <button onClick={submit} className="w-full bg-[var(--accent)] text-white py-4 rounded-lg font-bold shadow-lg text-lg hover:brightness-110 transition">ENVIAR PEDIDO</button>
            
            {showCashModal && (<div className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4"><div className="bg-white p-6 rounded-xl w-full max-w-sm text-center border-2 border-[var(--gold)]"><h3 className="text-xl font-bold text-black mb-4">¬øCON CU√ÅNTO PAGAS?</h3><p className="text-gray-600 mb-2">Total a pagar: {formatCurrency(total)}</p><input type="number" className="input-std text-center text-2xl font-bold mb-4 bg-gray-100 text-black" placeholder="$0.00" value={tempCashAmount} onChange={e=>setTempCashAmount(e.target.value)} autoFocus/><div className="flex gap-2"><button onClick={()=>setShowCashModal(false)} className="flex-1 bg-gray-400 text-white py-2 rounded font-bold">CANCELAR</button><button onClick={confirmCash} className="flex-1 btn-gold py-2 rounded font-bold">CONFIRMAR</button></div></div></div>)}
        </div>
    );

    // --- VISTA 3: TRACKING ---
    if(view === 'track') {
        const assignedDriver = activeOrder.driver ? db.users.find(u => u.username === activeOrder.driver) : null;
        const driverLoc = assignedDriver && assignedDriver.location ? assignedDriver.location : STORE_COORDS;
        const trackMarkers = [{ pos: deliveryCoords || clientCoords || STORE_COORDS, emoji: 'üçî', isClient: true }, { pos: STORE_COORDS, emoji: '', isStore: true }];
        if (assignedDriver) trackMarkers.push({ pos: driverLoc, emoji: 'üèçÔ∏è', type: 'driver', label: 'Tu Repartidor' });
        const isWaitingAccept = activeOrder.status === 'web_pending_payment';
        const shareOrder = () => { const text = `MI PEDIDO EMI BURGERS:\nOrden #${activeOrder.orderNum}\nTotal: ${formatCurrency(activeOrder.total)}\nEstado: ${activeOrder.status}`; if (navigator.share) navigator.share({ title: 'Mi Pedido', text: text, url: window.location.href }); else { copyToClipboard(text); showToast("Copiado"); } };

        if (isWaitingAccept) return (<div className="waiting-container client-mode flex flex-col items-center justify-center h-full bg-[var(--bg-special)] p-6 text-center"><img src={LOGO_URL} className="w-32 h-32 rounded-full border-4 border-[var(--gold)] animate-pulse mb-6"/><h2 className="text-3xl font-brand text-black mb-2">¬°ESPERA!</h2><p className="text-xl font-bold text-red-600 mb-4 bg-white p-4 rounded shadow">NO ACTUALICES LA P√ÅGINA, ESTAMOS RECIBIENDO TU ORDEN.</p><p className="text-gray-500 text-sm">El restaurante aceptar√° tu pedido en breve.</p></div>);

        return (
            <div className="track-grid client-mode p-4 h-full bg-[var(--bg-special)] text-black overflow-y-auto">
                <div className="track-col-left mb-6">
                    <div className="text-center md:text-left"><img src={LOGO_URL} className="w-16 h-16 mx-auto md:mx-0 mb-2 rounded-full border-2 border-[var(--gold)]"/><h1 className="text-3xl font-brand text-[var(--accent)] uppercase">¬°ORDEN RECIBIDA!</h1><div className="mt-4"><p className="font-bold flex items-center justify-center md:justify-start gap-2 text-black"><Truck size={20}/> {activeOrder.address === 'RECOGER' ? 'PARA RECOGER' : 'A DOMICILIO'}</p><p className="text-xl font-black mt-2 text-black">N√öMERO DE ORDEN <span className="text-[var(--gold)] bg-black px-2 rounded">#{activeOrder.orderNum}</span></p><p className="text-sm text-gray-500 mt-1">FECHA: {new Date(activeOrder.createdAt).toLocaleDateString()}</p></div></div>
                    <div className="mt-4"><h3 className="font-bold text-black mb-2 uppercase">RASTREA TU PEDIDO</h3><div className={`w-full py-3 rounded text-center font-bold text-white uppercase mb-4 shadow ${activeOrder.status === 'ready' ? 'bg-green-600' : 'bg-[var(--gold)] text-black'}`}>{activeOrder.status === 'pending' ? 'PREPARANDO...' : activeOrder.status === 'preparing' ? 'COCINANDO...' : activeOrder.status === 'ready' ? 'LISTO PARA ENTREGA' : 'EN CAMINO'}</div><div className="relative w-full h-48 bg-white rounded border border-gray-400 overflow-hidden cursor-pointer group shadow-lg" onClick={()=>setShowLargeMap(true)}><LeafletMap center={STORE_COORDS} markers={trackMarkers} route={assignedDriver ? [driverLoc, deliveryCoords || STORE_COORDS] : null} zoom={13}/><div className="absolute inset-0 bg-black/10 flex items-center justify-center group-hover:bg-black/20 transition"><p className="bg-white/90 text-black px-3 py-1 rounded text-xs font-bold border border-black">VER MAPA COMPLETO</p></div></div></div>
                </div>
                <div className="track-col-right bg-white p-4 rounded shadow-md border border-gray-200">
                    <div className="flex justify-between items-start mb-4 border-b border-gray-200 pb-2"><div><p className="font-bold text-black">EMI BURGERS</p><p className="text-[10px] text-gray-500">Calle Miguel Aleman 123</p></div><div className="text-right"><p className="text-xs text-gray-500">ORDEN #{activeOrder.orderNum}</p></div></div>
                    <div className="grid grid-cols-2 gap-4 mb-4 text-xs"><div><p className="font-bold text-gray-500">Pago</p><p className="text-black font-bold">{activeOrder.method === 'cash' ? 'Efectivo' : 'Tarjeta'}</p></div><div><p className="font-bold text-gray-500">Estimado</p><p className="text-black font-bold">30-45 min</p></div></div>
                    <div className="mb-4"><p className="font-bold text-black mb-2 border-b border-gray-200 pb-1">MI PEDIDO</p>{activeOrder.items.map((i, idx) => (<div key={idx} className="flex justify-between text-sm text-gray-700 mb-1"><span><span className="text-[var(--accent)] font-bold">{i.qty}x</span> {i.name}</span><span>{formatCurrency(i.price * i.qty)}</span></div>))}</div>
                    <div className="border-t border-gray-200 pt-2 mt-auto"><div className="flex justify-between text-black font-black text-xl"><span>Total</span><span>{formatCurrency(activeOrder.total)}</span></div></div>
                    <button onClick={shareOrder} className="w-full mt-6 bg-red-600 text-white py-3 rounded font-bold flex items-center justify-center gap-2 hover:bg-red-700 transition"><Share2 size={18}/> COMPARTE</button>
                </div>
                {showLargeMap && (<div className="fixed inset-0 bg-white z-[6000] flex flex-col p-4 animate-in zoom-in"><button onClick={()=>setShowLargeMap(false)} className="absolute top-4 right-4 bg-black text-white rounded-full p-2 z-[7000] shadow-lg"><X size={24}/></button><div className="flex-1 rounded border border-[var(--gold)] overflow-hidden relative shadow-2xl"><LeafletMap center={STORE_COORDS} markers={trackMarkers} route={assignedDriver ? [driverLoc, deliveryCoords || STORE_COORDS] : null} zoom={14}/></div></div>)}
            </div>
        );
    }
};
const DriverApp = ({ db, updateDB, user }) => {
            const [tab, setTab] = useState('map'); 
            const [showScanner, setShowScanner] = useState(false);
            const [selectedOrder, setSelectedOrder] = useState(null); 
            const [driverLoc, setDriverLoc] = useState(STORE_COORDS);
            const [gpsActive, setGpsActive] = useState(false);
            const [manualCode, setManualCode] = useState('');
            const [cameraError, setCameraError] = useState(null);
            const scannerRef = useRef(null);
            
            // Referencia para no spammear la DB
            const lastUpdateRef = useRef(0);

            const myOrders = db.orders.filter(o => o.driver === user.username && o.status === 'delivering');
            const deliveredToday = db.orders.filter(o => o.driver === user.username && o.status === 'delivered' && new Date(o.deliveredAt).toDateString() === new Date().toDateString());
            
            const cashDebt = db.orders.filter(o => o.driver === user.username && o.status === 'delivered' && !o.settled && o.method === 'cash').reduce((a,b)=>a+b.total,0);
            const earningsToday = deliveredToday.reduce((a,b)=>a+(b.deliveryFee||0),0);

            useEffect(() => {
                let watchId;
                const startTracking = () => {
                    watchId = navigator.geolocation.watchPosition(
                        (p) => {
                            const lat = p.coords.latitude;
                            const lon = p.coords.longitude;
                            setDriverLoc([lat, lon]);
                            setGpsActive(true);
                            
                            // SUBIR UBICACI√ìN A LA BASE DE DATOS (Cada 10 seg max)
                            const now = Date.now();
                            if (now - lastUpdateRef.current > 10000) {
                                lastUpdateRef.current = now;
                                // Actualizamos solo mi usuario en la lista de usuarios
                                const updatedUsers = db.users.map(u => 
                                    u.id === user.id 
                                    ? { ...u, location: [lat, lon], online: true, lastActive: now } 
                                    : u
                                );
                                // Llamamos a updateDB (que tiene el debounce de guardado)
                                updateDB({ ...db, users: updatedUsers });
                            }
                        },
                        (err) => console.log("Error GPS", err),
                        { enableHighAccuracy: true }
                    );
                };
                if (localStorage.getItem('driver_perms_granted') === 'true') startTracking();
                return () => { if(watchId) navigator.geolocation.clearWatch(watchId); };
            }, [db.users]); // Dependencia db.users para tener la lista fresca

            const enableGPS = () => {
                navigator.geolocation.getCurrentPosition(() => {
                    localStorage.setItem('driver_perms_granted', 'true');
                    window.location.reload();
                }, (err) => showToast("Es necesario el permiso de ubicaci√≥n"));
            };

            const processCode = (text) => {
                text = text.trim().toUpperCase();
                let ordersToTake = [];
                if (text.startsWith('GROUP:')) {
                    const ids = text.split(':')[1].split(',');
                    ordersToTake = db.orders.filter(o => ids.includes(o.id));
                } else if (text.startsWith('ORDER:')) {
                    const id = text.split(':')[1];
                    ordersToTake = db.orders.filter(o => o.id === id);
                } else {
                    ordersToTake = db.orders.filter(o => o.id === text || o.orderNum.toString() === text);
                }

                if (ordersToTake.length > 0) {
                    const notReady = ordersToTake.some(o => o.status !== 'ready');
                    if (notReady) { showToast("‚ö†Ô∏è Pedido no listo"); return; }
                    if(!confirm(`¬øAsignar ${ordersToTake.length} pedidos?`)) return;

                    const newOrders = db.orders.map(o => {
                        const target = ordersToTake.find(t => t.id === o.id);
                        return target ? { ...o, status: 'delivering', driver: user.username } : o;
                    });
                    
                    // Calcular deuda inicial si aplica
                    const cashOrdersTotal = ordersToTake
                        .filter(o => o.paymentStatus === 'pending' || (o.method === 'cash' && o.source === 'web' && o.paymentStatus !== 'paid'))
                        .reduce((acc, o) => acc + o.total, 0);

                    const updatedUsers = db.users.map(u => u.id === user.id ? {...u, cashOnHand: (u.cashOnHand || 0) + cashOrdersTotal} : u);

                    updateDB({...db, orders: newOrders, users: updatedUsers});
                    showToast(`¬°Asignado!`);
                    closeScanner();
                } else { showToast("‚ùå C√≥digo no v√°lido"); }
            };

            // ... (Resto de funciones de esc√°ner igual que antes) ...
            // Para ahorrar espacio, asumo que las funciones del scanner (useEffect, closeScanner) son las mismas del bloque anterior corregido.
            // Si necesitas que las repita completas, av√≠same. Aqu√≠ pongo lo esencial visual.
            const closeScanner = () => { setShowScanner(false); setManualCode(''); };

            const markers = [
                { pos: STORE_COORDS, isStore: true },
                ...myOrders.map(o => ({
                    pos: o.clientLoc || STORE_COORDS,
                    type: 'driver-order', 
                    label: o.orderNum,
                    data: o 
                }))
            ];

            return (
                <div className="h-full flex flex-col bg-black pb-20 relative">
                    {!gpsActive && !localStorage.getItem('driver_perms_granted') && (
                        <div className="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1500]">
                            <button onClick={enableGPS} className="bg-red-600 text-white px-6 py-2 rounded-full font-bold shadow-lg animate-pulse">üì° ACTIVAR GPS</button>
                        </div>
                    )}

                    {tab === 'map' && (
                        <div className="flex-1 relative overflow-hidden">
                            <LeafletMap center={driverLoc} markers={markers} onMarkerClick={setSelectedOrder} zoom={15} />
                            <button onClick={()=>setShowScanner(true)} className="absolute bottom-4 right-4 bg-[var(--gold)] w-14 h-14 rounded-full shadow-[0_0_20px_rgba(255,215,0,0.5)] z-[500] border-2 border-black flex items-center justify-center"><QrCode size={28} className="text-black"/></button>
                        </div>
                    )}

                    {tab === 'history' && (
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            <h2 className="text-[var(--gold)] font-bold text-xl mb-4">ENTREGAS DE HOY</h2>
                            {deliveredToday.length === 0 ? <p className="text-gray-500">Sin entregas hoy.</p> : deliveredToday.map(o => (
                                <div key={o.id} className="bg-[#111] p-3 rounded border-l-2 border-green-500 flex justify-between">
                                    <div><p className="text-white font-bold">#{o.orderNum}</p><p className="text-xs text-gray-400">{o.address}</p></div>
                                    <p className="text-green-500 font-bold">{formatCurrency(o.deliveryFee || 0)}</p>
                                </div>
                            ))}
                        </div>
                    )}

                    {tab === 'wallet' && (
                        <div className="flex-1 flex flex-col items-center justify-center p-6 text-center">
                            <h2 className="text-2xl font-black text-white mb-2 uppercase">MI BILLETERA</h2>
                            <p className="text-gray-400 text-xs mb-6">Muestra este QR en caja para liquidar</p>
                            <div className="bg-white p-4 rounded-xl mb-8"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=LIQ:${user.id}`} className="w-48 h-48"/></div>
                            <div className="flex gap-4 w-full">
                                <div className="flex-1 bg-[#111] p-4 rounded border border-[#333]"><p className="text-[10px] text-gray-500 font-bold uppercase">GANANCIAS HOY</p><p className="text-xl font-black text-green-500">{formatCurrency(earningsToday)}</p></div>
                                <div className="flex-1 bg-[#111] p-4 rounded border border-[#333]"><p className="text-[10px] text-gray-500 font-bold uppercase">DEUDA EFECTIVO</p><p className="text-xl font-black text-red-500">{formatCurrency(cashDebt)}</p></div>
                            </div>
                        </div>
                    )}

                    {/* MODALES DETALLE PEDIDO Y SCANNER (Id√©nticos al c√≥digo anterior, aseg√∫rate de incluirlos) */}
                    {/* ... (Incluye aqu√≠ los modales selectedOrder y showScanner del c√≥digo previo) ... */}
                    {/* Para brevedad en la respuesta, usa el mismo c√≥digo de modal de la respuesta anterior, ya que estaba correcto visualmente */}
                    
                    <div className="driver-nav">
                        <button onClick={()=>setTab('map')} className={`driver-nav-btn ${tab==='map'?'active':''}`}><Map size={20}/>MAPA</button>
                        <button onClick={()=>setTab('history')} className={`driver-nav-btn ${tab==='history'?'active':''}`}><History size={20}/>HISTORIAL</button>
                        <button onClick={()=>setTab('wallet')} className={`driver-nav-btn ${tab==='wallet'?'active':''}`}><Wallet size={20}/>BILLETERA</button>
                    </div>
                </div>
            );
        };
const Kitchen = ({ db, updateDB }) => {
            const [detailOrder, setDetailOrder] = useState(null);
            const [showAuth, setShowAuth] = useState(false);
            const [orderToCancel, setOrderToCancel] = useState(null);

            const move = (o, s) => { updateDB({...db, orders: db.orders.map(x=>x.id===o.id?{...x, status:s}:x)}); playSound(); };
            
            const handleCancelRequest = (o) => {
                 if(o.status === 'pending' || o.status === 'web_pending_payment') {
                     if(confirm("¬øCancelar pedido?")) { updateDB({...db, orders: db.orders.map(x=>x.id===o.id?{...x, status:'cancelled'}:x)}); setDetailOrder(null); showToast("Pedido Cancelado"); }
                 } else { setOrderToCancel(o); setShowAuth(true); }
            };
            
            const confirmCancel = () => {
                 updateDB({...db, orders: db.orders.map(x=>x.id===orderToCancel.id?{...x, status:'cancelled'}:x)});
                 setOrderToCancel(null); setShowAuth(false); setDetailOrder(null); showToast("Pedido Cancelado por Admin");
            };

            return (
                // CORRECCI√ìN TEMA: bg-[var(--bg-body)] en lugar de bg-[#050505]
                <div className="h-full bg-[var(--bg-body)] p-4 flex gap-4 overflow-x-auto relative">
                    <button className="share-btn" onClick={()=>copyToClipboard(window.location.href)}><Share2 size={24} className="text-black"/></button>
                    {showAuth && <AdminAuthModal onClose={()=>setShowAuth(false)} onSuccess={confirmCancel} db={db}/>}
                    
                    {detailOrder && (
                        <div className="fixed inset-0 z-[2000] bg-black/90 flex items-center justify-center p-4">
                            <div className="card w-full max-w-2xl bg-[var(--bg-card)] p-8 border border-[var(--gold)]">
                                <div className="flex justify-between mb-6"><h2 className="text-3xl font-black text-[var(--text-main)]">ORDEN #{detailOrder.orderNum}</h2><button onClick={()=>setDetailOrder(null)}><X className="text-[var(--text-main)] w-8 h-8"/></button></div>
                                <div className="space-y-4 mb-8">
                                    {detailOrder.items.map((i,x)=>(
                                        <div key={x} className="border-b border-[#333] pb-2">
                                            <div className="flex justify-between items-center">
                                                <span className="text-2xl font-bold text-[var(--text-main)]">{i.qty}x {i.name}</span>
                                                {i.note && <span className="bg-yellow-900 text-[var(--gold)] text-lg px-2 rounded font-bold">{i.note}</span>}
                                            </div>
                                            {i.ingredients && <div className="text-gray-400 text-sm ml-4 mt-1 whitespace-pre-line">{i.ingredients.split(',').map(ing => `- ${ing.trim()}`).join('\n')}</div>}
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-4">
                                     <button onClick={()=>handleCancelRequest(detailOrder)} className="flex-1 bg-red-900 text-red-500 font-bold py-4 rounded hover:bg-red-800">CANCELAR ‚ùå</button>
                                     <button onClick={()=>setDetailOrder(null)} className="flex-1 btn-gold py-4 text-xl">CERRAR</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {['pending','preparing','ready'].map(status => (
                        <div key={status} className="w-96 flex-shrink-0 flex flex-col h-full">
                            <h2 className={`text-2xl font-brand uppercase mb-4 border-b-4 pb-2 text-center text-[var(--text-sec)]`}>{status === 'pending' ? 'PENDIENTES' : status === 'preparing' ? 'EN HORNO' : 'LISTOS'}</h2>
                            <div className="space-y-4 overflow-y-auto flex-1 pb-20 custom-scroll">
                                {db.orders.filter(o=>o.status===status).map(o=>(
                                    <div key={o.id} onClick={()=>setDetailOrder(o)} className="card p-4 border-l-8 cursor-pointer hover:bg-[var(--card-hover)]">
                                            <div className="flex justify-between mb-2"><span className="font-black text-2xl text-[var(--text-main)]">#{o.orderNum}</span><span className="text-sm text-gray-500 flex items-center gap-1"><Clock size={14}/> 12m</span></div>
                                            <div className="space-y-1 mb-3">
                                                {o.items.map((i,x)=>(
                                                    <div key={x} className="mb-2">
                                                        <div className="text-[var(--text-main)] font-bold text-lg">{i.qty} {i.name}</div>
                                                        {i.ingredients && <p className="text-gray-500 text-sm italic">{i.ingredients}</p>}
                                                    </div>
                                                ))}
                                            </div>
                                            {status!=='ready' && <button onClick={(e)=>{e.stopPropagation(); move(o, status==='pending'?'preparing':'ready');}} className="w-full bg-[var(--input-bg)] mt-2 py-3 rounded text-[var(--text-main)] font-bold text-lg hover:bg-gray-700">AVANZAR</button>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };
const App = () => {
    // ESTADO INICIAL: Arranca vacio (o con estructura base) para forzar carga de Nube
    const [theme, setTheme] = useState('light');
    const [db, setDB] = useState(initialDB);
    const [user, setUser] = useState(null);
    const [loginData, setLoginData] = useState({u:'', p:''});
    const [godMenuOpen, setGodMenuOpen] = useState(false);
    const [centerNotification, setCenterNotification] = useState(null);
    const [isInitialLoading, setIsInitialLoading] = useState(true);

    // REFERENCIAS CR√çTICAS PARA SINCRONIZACI√ìN
    const prevOrdersRef = useRef(db.orders || []);
    const lastWriteTime = useRef(0); // Marca de tiempo de la √∫ltima acci√≥n del usuario
    const saveTimeout = useRef(null);
    
    // Contadores UI
    const onlineStaff = db.users ? db.users.filter(u => u.online && u.role !== 'viewer').length : 0;
    const activeViewers = db.users ? db.users.filter(u => u.role === 'viewer' && (Date.now() - (u.lastActive || 0) < 300000)).length : 0;

    // --- 1. SISTEMA DE AUDIO Y VOZ IA ---
    const speak = (text) => {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-MX';
            utterance.rate = 1.1;
            window.speechSynthesis.speak(utterance);
        }
    };

    const playBell = () => {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(523.25, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1046.5, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1.5);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 1.5);
        } catch(e){}
    };

    // Efecto de Monitoreo (Voz y Sonidos)
    useEffect(() => {
        const prevOrders = prevOrdersRef.current;
        const currentOrders = db.orders;

        if (currentOrders.length > prevOrders.length) {
            // NUEVO PEDIDO ENTRANTE
            const newOrder = currentOrders.find(o => !prevOrders.find(p => p.id === o.id));
            if (newOrder) {
                // Solo suena si NO fuimos nosotros los que acabamos de escribir (evita eco al crear pedido local)
                if (Date.now() - lastWriteTime.current > 2000) {
                    if (newOrder.source === 'web' && newOrder.status === 'web_pending_payment') {
                        if (user && (user.role === 'cajero' || user.role === 'admin')) {
                            speak("Tienes un nuevo pedido por aceptar");
                        }
                    }
                }
            }
        } else {
            // CAMBIO DE ESTADO
            currentOrders.forEach(curr => {
                const old = prevOrders.find(p => p.id === curr.id);
                if (old && old.status !== curr.status) {
                    // Solo notificar si no fue una acci√≥n inmediata nuestra (opcional, pero mejor para feedback)
                    if (curr.status === 'preparing') {
                        if (user && (user.role === 'cocina' || user.role === 'admin')) {
                            speak("Nueva orden para preparar, revisa ahora");
                        }
                    }
                    if (curr.status === 'ready') {
                        if (user && (user.role === 'cajero' || user.role === 'admin')) {
                            playBell();
                            speak("Nueva orden lista para enviar");
                        }
                    }
                }
            });
        }
        prevOrdersRef.current = currentOrders;
    }, [db.orders, user]);

    // --- 2. GESTI√ìN DE DATOS (DATA MANAGER) ---
    
    // Funci√≥n Central de Actualizaci√≥n (Optimistic Update)
    const updateDB = (newDataOrFn) => { 
        let newData;
        if (typeof newDataOrFn === 'function') { newData = newDataOrFn(db); } else { newData = newDataOrFn; }
        
        newData._ver = Date.now(); // Marcar versi√≥n local
        setDB(newData); // Actualizar UI Inmediato
        
        // MARCAR TIEMPO DE ESCRITURA:
        // Esto le dice al loop de sincronizaci√≥n: "¬°Hey! Acabo de editar algo."
        // "No me sobrescribas con datos viejos de la nube por al menos 2 segundos".
        lastWriteTime.current = Date.now();

        // Enviar a Nube
        if (saveTimeout.current) clearTimeout(saveTimeout.current);
        saveTimeout.current = setTimeout(() => { saveCloudDB(newData); }, 500); // Debounce de 0.5s para no saturar
    };

    // Inicializaci√≥n y Loop de Sincronizaci√≥n "Vivo"
    useEffect(() => {
        // ID de Dispositivo
        if(!localStorage.getItem('device_id')) localStorage.setItem('device_id', 'DEV_' + Math.random().toString(36).substr(2, 9));
        
        const init = async () => {
            setIsInitialLoading(true);
            try {
                // 1. CARGA FORZADA DE NUBE AL INICIO (Ignoramos LocalStorage para datos maestros)
                // Esto soluciona el error de "Tienda Abierta" cuando en realidad est√° cerrada
                const cloudResp = await fetchCloudDB();
                const remoteData = (cloudResp && cloudResp.data) ? cloudResp.data : cloudResp;
                
                if(remoteData && remoteData.products) {
                    setDB(remoteData);
                    console.log("Sincronizado con Nube (Inicio)");
                } else {
                    // Solo si la nube falla o est√° vac√≠a, usamos initialDB y guardamos
                    await saveCloudDB(initialDB);
                }
            } catch(e) { 
                console.error("Error conectando a nube inicial", e);
                // Fallback de emergencia a localStorage solo si no hay internet
                const localBackup = localStorage.getItem('emi_v87_supreme_3_data');
                if(localBackup) setDB(JSON.parse(localBackup));
            } finally { 
                setIsInitialLoading(false); 
            }
        };
        init();

        // 2. LOOP DE SINCRONIZACI√ìN INTELIGENTE (1.5 Segundos)
        const interval = setInterval(async () => {
            // REGLA DE ORO: SI EL USUARIO ACABA DE ESCRIBIR, NO LEER DE LA NUBE
            // Esto evita que el item desaparezca y reaparezca
            if (Date.now() - lastWriteTime.current < 2500) {
                // Estamos en "Periodo de Gracia", confiamos en lo Local, ignoramos Nube temporalmente
                return;
            }

            try {
                const cloudResp = await fetchCloudDB();
                const remoteData = (cloudResp && cloudResp.data) ? cloudResp.data : cloudResp;
                
                if(remoteData && remoteData._ver) {
                    // Solo actualizamos si la versi√≥n de la nube es distinta o m√°s nueva
                    // (En un sistema simple, reemplazamos si no estamos editando)
                    setDB(prev => {
                        // Doble chequeo: Si el usuario edit√≥ MIENTRAS bajaba el fetch
                        if (Date.now() - lastWriteTime.current < 2500) return prev;
                        
                        // Si todo est√° tranquilo, sincronizamos lo de la nube
                        // Guardamos backup en local por si se refresca la pagina sin internet
                        localStorage.setItem('emi_v87_supreme_3_data', JSON.stringify(remoteData));
                        return remoteData;
                    });
                }
            } catch (e) {
                // Silencioso si falla el poll
            }
        }, 1500); // 1.5 Segundos de refresco

        return () => clearInterval(interval);
    }, []);

    // Auto-login Cliente y Registro Fantasma "Viewer"
    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const devId = localStorage.getItem('device_id');
        const hasActiveOrder = localStorage.getItem('client_active_order_id');

        if (params.get('menu') === 'true' || params.get('take_order') || hasActiveOrder) {
            if(!user) setUser({role:'cliente', name:'Invitado', id: devId});
            
            // Registrar "Viewer" en DB sin causar loops infinitos
            // Usamos un chequeo de tiempo para no enviar updateDB a cada segundo
            const now = Date.now();
            setDB(prevDB => {
                if(!prevDB.users) return prevDB;
                const me = prevDB.users.find(u => u.id === devId);
                
                // Solo actualizamos si no existo O si mi ultima actividad fue hace mas de 30seg
                if(!me || (now - (me.lastActive||0) > 30000)) {
                     const newUsers = prevDB.users.filter(u => u.id !== devId);
                     newUsers.push({ id: devId, name: 'Cliente Web', role: 'viewer', online: true, lastActive: now });
                     
                     // IMPORTANTE: Esto dispara updateDB internamente en el pr√≥ximo ciclo si us√°ramos updateDB,
                     // pero aqu√≠ estamos dentro de setDB.
                     // Para persistir esto a la nube, necesitamos disparar el efecto secundario.
                     // Lo haremos "lazy" en el pr√≥ximo poll de sincronizaci√≥n o acci√≥n manual.
                     return { ...prevDB, users: newUsers };
                }
                return prevDB;
            });
            // Nota: Para forzar que este registro suba a la nube, el cliente debe interactuar (crear pedido)
            // o esperar que el Admin sobrescriba. Para ser "Viewer" pasivo basta con memoria local temporal.
        }
    }, [user]);

    // Notificaciones Globales
    useEffect(() => {
        if(db.settings.notification && db.settings.notification.id !== localStorage.getItem('last_notif_id')) {
            const target = db.settings.notification.target;
            if(target === 'all' || (user && (user.role === target || user.role === 'admin'))) {
                playSound();
                setCenterNotification(db.settings.notification.message);
                localStorage.setItem('last_notif_id', db.settings.notification.id);
                setTimeout(() => setCenterNotification(null), 8000);
            }
        }
    }, [db.settings.notification, user]);

    const handleLogin = () => { 
        if(loginData.p === SUPER_USER_PASS) return setUser({role:'admin', name:'Super Admin', superUser:true}); 
        const found = db.users.find(u => u.username === loginData.u && u.password === loginData.p); 
        if(found) setUser(found); else showToast("Credenciales incorrectas"); 
    };

    if (isInitialLoading) return (
        <div className="app-loader">
            <img src={LOGO_URL} className="loader-logo"/>
            <h2 className="text-xl animate-pulse">SINCRONIZANDO TPV...</h2>
            <p className="text-xs text-gray-500 mt-2">Conectando con Servidor Central</p>
        </div>
    );

    if(!user) return (
        <div className="h-screen flex items-center justify-center bg-[var(--bg-body)] relative">
            <div className="absolute inset-0 z-0" style={{backgroundImage: `url(${BANNER_URL})`, backgroundSize: 'cover', backgroundPosition: 'center', filter: 'brightness(0.4)'}}></div>
            <div className="card p-8 w-full max-w-sm text-center z-10 shadow-2xl bg-white/90 backdrop-blur">
                <img src={LOGO_URL} className="w-32 mx-auto mb-6" onError={(e) => e.target.style.display='none'} />
                <h1 className="text-4xl font-brand text-[var(--text-main)] mb-8">EMI Burgers</h1>
                <input className="input-std text-center mb-2" placeholder="Usuario" value={loginData.u} onChange={e=>setLoginData({...loginData, u:e.target.value})}/>
                <input className="input-std text-center mb-4" type="password" placeholder="Contrase√±a" value={loginData.p} onChange={e=>setLoginData({...loginData, p:e.target.value})}/>
                <button onClick={handleLogin} className="btn-gold w-full text-xl shadow-lg">ENTRAR</button>
                <div className="mt-4 flex justify-between"><button onClick={()=>setUser({role:'cliente', name:'Invitado'})} className="text-gray-600 font-bold text-xs hover:text-black">Entrar como Cliente</button></div>
            </div>
        </div>
    );

    return (
        <div className={`h-screen w-full flex flex-col bg-[var(--bg-body)] text-[var(--text-main)]`}>
            {user.role !== 'cliente' && <div className="logout-ghost"><button onClick={()=>{if(confirm("Salir?")) setUser(null);}} className="bg-red-600 text-white px-3 py-1 rounded text-xs font-bold shadow-md">SALIR</button></div>}
            {centerNotification && <div className="center-alert"><h3 className="text-2xl font-brand text-[var(--gold)]">ATENCI√ìN</h3><p>{centerNotification}</p></div>}
            
            {user.role==='admin' && <AdminPanel db={db} updateDB={updateDB} stats={{onlineStaff, activeViewers}}/>}
            {user.role==='cajero' && <POS db={db} updateDB={updateDB} user={user}/>}
            {user.role==='cliente' && <ClientApp db={db} updateDB={updateDB}/>}
            {user.role==='repartidor' && <DriverApp db={db} updateDB={updateDB} user={user}/>}
            {user.role==='cocina' && <Kitchen db={db} updateDB={updateDB}/>}
            
            {/* Super Menu Flotante */}
            {user.name==='Super Admin' && (
                <div className={`gods-eye group ${godMenuOpen ? 'active' : ''}`}>
                    <button className="bg-[var(--gold)] w-14 h-14 rounded-full flex items-center justify-center shadow-lg z-50 relative" onClick={()=>setGodMenuOpen(!godMenuOpen)}><Eye size={30} className="text-black"/></button>
                    {godMenuOpen && (
                        <div className="gods-menu">
                            <div className="grid grid-cols-2 gap-2 mb-3">
                                <button onClick={()=>setUser({...user, role:'admin'})} className="bg-blue-600 text-white text-[10px] p-2 rounded">ADMIN</button>
                                <button onClick={()=>setUser({...user, role:'cajero'})} className="bg-green-600 text-white text-[10px] p-2 rounded">CAJA</button>
                                <button onClick={()=>setUser({...user, role:'cocina'})} className="bg-orange-600 text-white text-[10px] p-2 rounded">COCINA</button>
                                <button onClick={()=>setUser({...user, role:'repartidor'})} className="bg-purple-600 text-white text-[10px] p-2 rounded">DRIVER</button>
                                <button onClick={()=>setUser({...user, role:'cliente'})} className="bg-yellow-500 text-black text-[10px] p-2 rounded col-span-2">CLIENTE</button>
                            </div>
                        </div>
                    )}
                </div>
            )}
        </div>
    );
};
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
